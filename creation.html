<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Article Creator — Reference Chip Concept</title>
  <!-- Preload templates for faster availability (safe, no UX change) -->
  <link rel="preload" as="fetch" href="templates.json" crossorigin>
  <link rel="stylesheet" href="https://unpkg.com/@wikimedia/codex@2.3.0/dist/codex.style.css">
  <link rel="stylesheet" href="https://unpkg.com/@wikimedia/codex-design-tokens@2.3.0/theme-wikimedia-ui.css">
  <link rel="stylesheet" href="reading-styles.css">
  <style>
    .creator-wrap { max-width: 1100px; margin: 0 auto; padding: 16px 20px; }
    .editor-shell { border: 1px solid var(--border-color-subtle, #eaecf0); border-radius: 4px; background: #fff; padding: 16px; }
    .title-input { width: 100%; font-size: 18px; padding: 8px 0; border: none; border-bottom: 2px solid #a2a9b1; }
    .title-input:focus { outline: none; border-bottom-color: #36c; }
    .chip-row { display: flex; gap: 8px; align-items: center; margin: 12px 0; flex-wrap: wrap; }
    .chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border: 1px solid #a2a9b1; border-radius: 12px; font-size: 12px; cursor: pointer; background: #f8f9fa; }
    .chip.reference { border-color: #36c; color: #36c; background: #eef3ff; }
    .editor { 
      min-height: 260px; 
      outline: none; 
      position: relative;
    }
    .editor[contenteditable="true"]:empty:before { content: attr(data-placeholder); color: #72777d; }

    /* Smart chips that appear below cursor */
    .smart-chips-container {
      position: absolute;
      display: none;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
      z-index: 100;
      max-width: 400px;
    }

    .smart-chips-container.show {
      display: flex;
    }

    .smart-chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border: 1px solid #c8ccd1;
      border-radius: 12px;
      background: #f8f9fa;
      color: #36c;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.15s ease;
      user-select: none;
    }

    .smart-chip:hover {
      background: #eaecf0;
      border-color: #a2a9b1;
    }

    .smart-chip.primary {
      background: #eef3ff;
      border-color: #36c;
      color: #36c;
    }

    .smart-chip-icon {
      font-size: 11px;
    }

    /* Template insertion popup */
    .template-popup {
      position: absolute;
      display: none;
      background: white;
      border: 1px solid #eaecf0;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 8px 0;
      min-width: 200px;
      max-width: 320px;
      z-index: 200;
    }

    .template-popup.show {
      display: block;
    }

    .template-option {
      display: block;
      width: 100%;
      padding: 8px 12px;
      border: none;
      background: white;
      text-align: left;
      cursor: pointer;
      font-size: 13px;
      color: #202122;
    }

    .template-option:hover {
      background: #f8f9fa;
    }

    .template-option-title {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .template-option-desc {
      font-size: 11px;
      color: #72777d;
    }

    /* Template placeholders in content (inline chips) */
    .template-placeholder {
      display: inline-flex;
      align-items: baseline;
      gap: 3px;
      padding: 2px 8px !important;
      margin: 0 !important;
      border: 1px dashed #a2a9b1;
      border-radius: 12px;
      background: #f8f9fa;
      color: #202122;
      cursor: pointer;
      user-select: none;
      font-style: normal;
      position: relative;
      transition: background 0.15s ease, border-color 0.15s ease, color 0.15s ease, box-shadow 0.15s ease;
      vertical-align: baseline;
      line-height: inherit;
      font-size: 1em;
    }

    /* Gentle spacing when chips are adjacent for clearer affordance */
    .template-placeholder + .template-placeholder { margin-left: 6px !important; }
    .template-placeholder + .ref-chip { margin-left: 6px !important; }
    .chip-value + .template-placeholder { margin-left: 6px !important; }
    .ref-chip + .template-placeholder { margin-left: 6px !important; }

    .template-placeholder::before {
      content: '+';
      font-size: 12px;
      color: #36c;
    }

    .template-placeholder:hover {
      background: #eef3ff;
      border-color: #36c;
      color: #2a4b8d;
      box-shadow: 0 0 0 2px #eaf3ff;
    }

    .template-placeholder:focus-visible {
      outline: 2px solid #36c;
      outline-offset: 1px;
    }

    /* Filled chip values: look like text but remain editable on click */
    .chip-value {
      display: inline;
      cursor: pointer;
      text-decoration: none;
      border-bottom: 1px dotted transparent;
    }
    .chip-value:hover, .chip-value:focus-visible {
      border-bottom-color: #a2a9b1;
      outline: none;
    }

    /* Chip suggestion menu */
    .chip-menu {
      position: absolute;
      display: none;
      background: #fff;
      border: none;
      border-radius: 8px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.12);
      width: 460px;
      min-width: 320px;
      max-width: 90vw;
      z-index: 3500;
      padding: 6px 0;
    }
    .chip-menu-header { font-weight: 600; padding: 8px 12px; border-bottom: 1px solid #eaecf0; background: #f8f9fa; font-size: 13px; }
    .chip-menu-item { display:block; width:100%; text-align:left; padding:10px 12px; background:#fff; border:0; cursor:pointer; font-size:13px; }
    .chip-menu-item:hover { background:#f8f9fa; }
    .chip-menu-item[data-chip-submit] { background:#36c; color:#fff; border-radius:4px; }
    .chip-menu-item[data-chip-submit]:hover { background:#2a4b8d; }

    /* Simplified Suggestions panel */
    /* Responsive sizing for assist menu */
    .assist-menu {
      width: 96%;                 /* scale with container */
      max-width: 1000px;          /* wider cap on large screens */
      min-width: 320px;           /* ensure usable on small screens */
      height: auto;               /* grow with content */
      max-height: 75vh;           /* avoid exceeding viewport */
      overflow-y: auto;           /* scroll when content too tall */
      padding: 6px 0;
    }
    .assist-group { padding: 8px 12px; }
    .assist-actions { display:flex; gap:8px; flex-wrap:wrap; margin-bottom: 4px; }
    .assist-actions .action-chip { padding:6px 10px; border-radius:8px; }
    /* Disabled chips: visually muted and default cursor */
    .action-chip[aria-disabled="true"], .action-chip.disabled {
      cursor: default !important;
      opacity: 0.6;
    }
    .assist-list { list-style:none; margin:0; padding:0; }
    .assist-list-item { display:flex; align-items:flex-start; justify-content:space-between; gap:8px; padding:8px 0; }
    .assist-list-item .meta { font-size:12px; color:#555; }
    .assist-list-item .action-chip { white-space:nowrap; }

    /* Source verification indicators */
    .needs-source {
      border-left: 3px solid #fc3;
      padding-left: 8px;
      margin: 4px 0;
      background: #fffbf0;
    }

    .source-reminder {
      font-size: 11px;
      color: #ac6600;
      margin-top: 4px;
      font-style: italic;
    }
    .verify-note { display: none; margin-top: 8px; font-size: 12px; color: #856404; background: #fff3cd; border: 1px solid #ffeaa7; padding: 6px 8px; border-radius: 4px; }
    .verify-note.show { display: block; }
    .ref-dialog-backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.4); z-index: 3000; }
    .ref-dialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: #fff; border: 1px solid #eaecf0; border-radius: 8px; width: 520px; max-width: 92vw; padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.2); }
    .ref-row { margin-bottom: 12px; }
    .ref-row label { display: block; font-size: 13px; margin-bottom: 6px; color: #202122; }
    .ref-row input { width: 100%; height: 34px; border: 1px solid #c8ccd1; border-radius: 4px; padding: 6px 10px; font: inherit; }
    .ref-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
    .badge { display:inline-block; font-size:10px; padding:2px 6px; border-radius:10px; border:1px solid #c8ccd1; color:#72777d; }
    .badge.good { color:#14866d; border-color:#14866d; }
    .badge.warn { color:#ac6600; border-color:#ac6600; }

    /* Reference chip emphasis */
    .ref-chip { border-color:#36c !important; color:#202122 !important; background:#eef3ff !important; font-weight: 600; gap: 4px; margin-right: 6px; }
    .ref-chip .icon { display:inline-flex; align-items:center; justify-content:center; width:14px; height:14px; margin-right:0; color:#202122; }
    .ref-chip .icon svg { width:14px; height:14px; display:block; }

    /* Insert feedback highlight */
    @keyframes insertFlash {
      0% { background-color: #fff7cc; }
      100% { background-color: transparent; }
    }
    .flash-insert { animation: insertFlash 1.2s ease-out; }

    /* Undo toast */
    .undo-toast {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 16px;
      background: #202122;
      color: #fff;
      padding: 8px 12px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      display: none;
      align-items: center;
      gap: 12px;
      z-index: 4000;
      font-size: 13px;
      /* Allow clicks to pass through the toast background so it doesn't block UI beneath. */
      pointer-events: none;
    }
    .undo-toast.show { display: flex; }
    .undo-toast .btn-undo {
      background: #fff;
      color: #202122;
      border: none;
      border-radius: 4px;
      padding: 4px 10px;
      cursor: pointer;
      /* Re-enable pointer events on the button only so it's clickable */
      pointer-events: auto;
    }
    .undo-toast .btn-undo:hover { background: #f0f0f0; }

    .chip.guidance { border-color: #c8ccd1; background: #fff; }
    .hidden { display: none !important; }
    .ac-steps { max-width: 1100px; margin: 0 auto; }
    .ac-step { display: none; border: none; background: #fff; border-radius: 0; padding: 16px; box-shadow: none; }
    .ac-step.active { display: block; }
    .ac-step h3 { margin: 0 0 12px 0; font-size: 1.1rem; }
    
    /* Center Step 1 in viewport */
    #step1.ac-step,
    #creation-step1.ac-step {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: none;
      background: transparent;
      box-shadow: none;
      max-width: 600px;
      width: 90%;
      z-index: 100;
    }
    
    /* Responsive positioning for mobile with keyboard */
    @media (max-height: 600px) {
      #step1.ac-step,
      #creation-step1.ac-step {
        position: fixed;
        top: 30%;
        transform: translate(-50%, -30%);
      }
    }
    
    @media (max-width: 768px) {
      #step1.ac-step,
      #creation-step1.ac-step {
        width: 95%;
        padding: 20px;
      }
      
      /* Adjust for mobile keyboard */
      @media (max-height: 500px) {
        #step1.ac-step,
        #creation-step1.ac-step {
          top: 20%;
          transform: translate(-50%, -20%);
        }
      }
    }
    
    /* Center Step 2 in viewport */
    #step2.ac-step,
    #creation-step2.ac-step {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: none;
      background: transparent;
      box-shadow: none;
      max-width: 700px;
      width: 90%;
      z-index: 100;
    }
    
    /* Responsive positioning for Step 2 */
    @media (max-width: 768px) {
      #step2.ac-step,
      #creation-step2.ac-step {
        width: 95%;
        padding: 20px;
        top: 45%;
        transform: translate(-50%, -45%);
      }
    }
    
    .ac-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
    .ac-actions .btn { height: 34px; padding: 0 12px; border: 1px solid #c8ccd1; border-radius: 4px; background: #fff; cursor: pointer; }
    .ac-actions .btn.primary { background: #36c; color: #fff; border-color: #36c; }
    .category-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; margin: 8px 0 4px; }
    .category-item { border: 1px solid #c8ccd1; border-radius: 4px; padding: 10px; cursor: pointer; background: #fff; }
    .category-item:hover { background: #f8f9fa; }
    .category-item.selected { border-color: #36c; box-shadow: 0 0 0 2px #eaf3ff; }
    .hint { font-size: 12px; color: #72777d; margin-top: 6px; }
    /* Hide the VE chrome by default - show when Step 3 is active */
    .ve-in-step3 #veHeader,
    .ve-in-step3 #veToolbar {
      display: block !important;
    }
    
    /* Mobile-only: Hide header and show footer instead */
    @media (max-width: 768px) {
      .ve-in-step3 #veHeader {
        display: none !important;
      }
      
      .ve-in-step3 #veFooter {
        display: block !important;
      }
      
      /* Footer styling - mobile only */
      .ve-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        border-top: 1px solid var(--border-color-subtle, #eaecf0);
        padding: 8px 16px;
        font-size: 12px;
        color: var(--color-subtle, #54595d);
        z-index: 10;
      }
      
      .ve-footer .status {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1100px;
        margin: 0 auto;
      }
    }
    
    /* Clean layout for Step 3 */
    .ve-in-step3 .creator-wrap {
      max-width: none;
      padding: 0;
    }
    
    .ve-in-step3 #step3 {
      border: none;
      background: transparent;
      padding: 0;
    }
    
    .ve-in-step3 #editor {
      border: none;
      background: transparent;
      min-height: 400px;
      padding: 16px 0;
    }

    /* Comfortable reading line-height for content inside the editor */
    #editor { line-height: 1.9 !important; hyphens: auto; }
    #editor p,
    #editor li,
    #editor blockquote { line-height: inherit; }
    #editor p { margin: 1.2em 0 !important; }
    
    /* Primary button styling for publish/submit buttons */
    .btn.primary {
      background: #36c !important;
      color: #fff !important;
      border-color: #36c !important;
    }
    
    .btn.primary:hover {
      background: #2a4b8d !important;
      border-color: #2a4b8d !important;
    }
    
    /* Prevent publish button text from wrapping to multiple lines */
    .publish-btn {
      white-space: nowrap;
      min-width: auto; /* Allow button to expand as needed */
    }
    
    /* Ensure publish button container has enough space */
    .group:last-child {
      margin-right: 12px; /* Add margin to prevent clipping */
    }
    
    
    
    /* Section suggestion buttons */
    .section-button {
      display: block;
      width: 100%;
      margin-bottom: 12px;
      padding: 12px 14px;
      border: 1px solid #c8ccd1;
      border-radius: 4px;
      background: #fff;
      color: #202122;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .section-button:hover {
      background: #f8f9fa;
      border-color: #a2a9b1;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .section-button.added {
      background: #eaf3ff;
      border-color: #36c;
      color: #36c;
      cursor: default;
    }
    
    .section-button.added::after {
      content: " ✓";
      float: right;
    }
    
    .section-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      display: block;
    }
    
    .section-description {
      font-size: 12px;
      color: #72777d;
      line-height: 1.3;
      display: block;
      margin-bottom: 6px;
    }
    
    
    /* Source button styling */
    .source-button {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #c8ccd1;
      border-radius: 4px;
      background: #f8f9fa;
      color: #202122;
      cursor: pointer;
      transition: all 0.2s ease;
      gap: 10px;
    }
    
    .source-button:hover {
      background: #eaecf0;
      border-color: #a2a9b1;
    }
    
    .source-button-icon {
      font-size: 16px;
    }
    
    .source-button-text {
      font-size: 13px;
      font-weight: 500;
    }
    
    /* Source modal styling */
    .source-modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 3000;
    }
    
    .source-modal-backdrop[aria-hidden="false"] {
      display: block;
    }
    
    .source-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #eaecf0;
      border-radius: 8px;
      width: 640px;
      max-width: 92vw;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    
    .source-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #eaecf0;
      background: #f8f9fa;
    }
    
    .source-modal-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #202122;
    }
    
    .source-modal-content {
      padding: 20px;
    }
    
    .source-input-section label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #202122;
    }
    
    .source-input-section input {
      width: 100%;
      height: 36px;
      border: 1px solid #c8ccd1;
      border-radius: 4px;
      padding: 8px 12px;
      font: inherit;
      margin-bottom: 12px;
    }
    
    .source-note {
      font-size: 12px;
      color: #ac6600;
      background: #fef6e7;
      border: 1px solid #fc3;
      border-radius: 4px;
      padding: 8px 12px;
      margin-bottom: 20px;
    }
    
    .source-verification h4,
    .draft-preview h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
      color: #202122;
    }
    
    .verification-step {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      font-size: 13px;
    }
    
    .step-icon {
      font-size: 14px;
      width: 16px;
    }
    
    .verification-step.completed .step-icon {
      color: #14866d;
    }
    
    .verification-step.completed .step-text {
      color: #14866d;
    }
    
    .source-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .source-badge.reliable {
      background: #d5fdf4;
      color: #14866d;
      border: 1px solid #14866d;
    }
    
    /* Removable section wrapper */
    .section-block { position: relative; }
    .section-dismiss { position: absolute; top: 0; right: 0; transform: translate(50%,-50%); width: 20px; height: 20px; border-radius: 50%; border: 1px solid #eaecf0; background: #fff; color: #72777d; line-height: 18px; text-align: center; cursor: pointer; font-size: 12px; user-select: none; }
    .section-dismiss:hover { background: #f8f9fa; }

    .source-badge.questionable {
      background: #fef6e7;
      color: #ac6600;
      border: 1px solid #fc3;
    }
    
    .reliability-note {
      font-size: 12px;
      color: #54595d;
    }
    
    .draft-warning {
      background: #fef6e7;
      border: 1px solid #fc3;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 12px;
      color: #ac6600;
      margin-bottom: 16px;
      font-weight: 600;
    }
    
    .draft-content {
      background: #f8f9fa;
      border: 1px solid #eaecf0;
      border-radius: 4px;
      padding: 16px;
      font-family: Georgia, serif;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    
    .source-modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      padding: 16px 20px;
      border-top: 1px solid #eaecf0;
      background: #f8f9fa;
    }
    
    .guide-note {
      font-size: 12px;
      color: #72777d;
      margin: 12px 0 16px 0;
      font-style: italic;
    }
    
    /* Sidebar source verification styles */
    .source-input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .source-url-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #a2a9b1;
      border-radius: 2px;
      font-size: 13px;
      font-family: inherit;
    }
    
    .source-url-input:focus {
      border-color: #36c;
      outline: none;
      box-shadow: inset 0 0 0 1px #36c;
    }
    
    .source-check-btn {
      padding: 8px 16px;
      background: #36c;
      color: white;
      border: 1px solid #36c;
      border-radius: 2px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .source-check-btn:hover {
      background: #2a4b8d;
      border-color: #2a4b8d;
    }
    
    .source-check-btn:disabled {
      background: #a2a9b1;
      border-color: #a2a9b1;
      cursor: not-allowed;
    }
    
    .source-warning {
      font-size: 12px;
      line-height: 1.4;
    }
    
    .sidebar-verification-step {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 13px;
    }
    
    .sidebar-step-icon {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #eaecf0;
      color: #72777d;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      flex-shrink: 0;
    }
    
    .sidebar-step-icon.active {
      background: #36c;
      color: white;
    }
    
    .sidebar-step-icon.completed {
      background: #00af89;
      color: white;
    }
    
    .sidebar-source-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 2px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .sidebar-source-badge.reliable {
      background: #d5fdf4;
      color: #00af89;
      border: 1px solid #00af89;
    }
    
    .sidebar-source-badge.questionable {
      background: #fef6e7;
      color: #ac6600;
      border: 1px solid #fc3;
    }
    
    .sidebar-draft-content {
      background: #f8f9fa;
      border: 1px solid #eaecf0;
      border-radius: 2px;
      padding: 12px;
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
      margin-bottom: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .sidebar-action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    
    .sidebar-action-btn {
      padding: 6px 12px;
      border: 1px solid #a2a9b1;
      border-radius: 2px;
      background: white;
      color: #202122;
      font-size: 12px;
      cursor: pointer;
    }
    
    .sidebar-action-btn.primary {
      background: #36c;
      color: white;
      border-color: #36c;
    }
    
    .sidebar-action-btn:hover {
      background: #f8f9fa;
    }
    
    .sidebar-action-btn.primary:hover {
      background: #2a4b8d;
      border-color: #2a4b8d;
    }
    
    /* Eligibility checker styles */
    .eligibility-options {
      display: flex;
      gap: 8px;
    }
    
    .eligibility-btn {
      padding: 6px 12px;
      border: 1px solid #a2a9b1;
      border-radius: 2px;
      background: #f8f9fa;
      color: #222;
      font-size: 13px;
      cursor: pointer;
    }
    
    .eligibility-btn:hover {
      background: #eaecf0;
    }
    
    .eligibility-btn.selected {
      background: #36c;
      color: white;
      border-color: #36c;
    }
    
    /* Hide modal on desktop */
    @media (min-width: 769px) {
      .guide-modal-backdrop {
        display: none !important;
      }
    }
    /* Assistance menu styling */
    .assist-menu {
      width: 96%;
      max-width: 1000px;
      min-width: 320px;
      height: auto;
      max-height: 75vh;
      overflow-y: auto;
      min-height: 200px;
      padding: 0;
      border-radius: 8px;
    }
    /* removed icon styling to simplify headers */
    .assist-menu-header { font-weight: 600; padding: 10px 14px; border-bottom: 1px solid #eaecf0; background: #f8f9fa; font-size: 13px; }
    .assist-item { display: block; width: 100%; text-align: left; padding: 12px 14px; background: #fff; border: none; cursor: pointer; }
    .assist-item:hover { background: #f8f9fa; }
    .assist-sep { height: 1px; background: #eaecf0; margin: 0; }
    .intro-sample { padding: 12px 14px; background: #fff; }
    .intro-sample + .intro-sample { border-top: 1px solid #eaecf0; }
    .intro-text { font-size: 13px; line-height: 1.55; color: #202122; margin-bottom: 8px; }
    .action-row { display: flex; gap: 8px; align-items: center; }
    .action-chip { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border:1px solid #c8ccd1; border-radius:12px; background:#f8f9fa; color:#202122; cursor:pointer; font-size:12px; }
    .action-chip:hover { background:#eef3ff; border-color:#36c; color:#36c; }
    .suggest-badge { display:none !important; }
    span[style*="background:#eaf7ef"] { display:none !important; }

    /* Suggestions floating chip */
    .assist-chip {
      position: absolute;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border: 1px solid #c8ccd1;
      border-radius: 14px;
      background: #f8f9fa;
      color: #202122;
      cursor: pointer;
      box-shadow: none;
      transition: background 0.15s ease, border-color 0.15s ease;
      user-select: none;
      /* hide the inline chip but keep it for anchoring */
      visibility: hidden;
      pointer-events: none;
    }
    .assist-chip:hover {
      background: #f3f4f6;
      border-color: #a2a9b1;
    }
    .assist-chip:focus-visible {
      outline: 2px solid rgba(54,102,204,0.5);
      outline-offset: 1px;
    }
    .assist-chip .icon { font-size: 14px; filter: brightness(0.65); }
    .assist-chip .label { font-size: 12px; font-weight: 500; letter-spacing: .1px; }
    .assist-chip.active {
      background: #eef3ff;
      border-color: #b6c8f0;
      color: #202122;
      box-shadow: none;
    }

    /* One-time intro help block (concept) */
    .intro-help {
      background: #f8f9fa;
      border: 1px solid #eaecf0;
      border-radius: 4px;
      padding: 10px 12px;
      margin: 8px 0 0 0;
      font-size: 12px;
      line-height: 1.45;
      color: #202122;
    }
    .intro-help .title { font-weight: 600; margin: 0 0 2px 0; }
    .intro-help .subtitle { margin: 0; color: #54595d; font-size: 13px; }

    /* Override: ensure VE toolbar does not scroll; clip overflow for stability */
    .ve-bar {
      overflow: hidden !important;
      overflow-x: hidden !important;
    }

  </style>
</head>
<body>

  <!-- Wikipedia-style header (hidden by default, shown in Step 3) -->
  <header class="container page-header" id="veHeader" role="banner" style="display: none;">
    <h1 class="firstHeading" id="veTitle">New Article</h1>
    <div class="page-tabs-wrapper">
      <nav class="ns-tabs" aria-label="Namespace tabs">
        <button class="ns-tab active">Article</button>
        <button class="ns-tab">Talk</button>
      </nav>
      <nav class="page-actions" aria-label="Page actions">
        <button class="action-tab">
          <span class="action-tab-text">Read</span>
          <span class="action-tab-icon cdx-icon" data-icon="cdxIconArticle"></span>
        </button>
        <button class="action-tab active">
          <span class="action-tab-text">Edit</span>
          <span class="action-tab-icon cdx-icon" data-icon="cdxIconEdit"></span>
        </button>
        <button class="action-tab">
          <span class="action-tab-text">View history</span>
          <span class="action-tab-icon cdx-icon" data-icon="cdxIconHistory"></span>
        </button>
        <button class="action-tab star">
          <span class="action-tab-text">⭐</span>
          <span class="action-tab-icon cdx-icon" data-icon="cdxIconStar"></span>
        </button>
      </nav>
    </div>
  </header>

  <!-- VE toolbar (hidden by default, shown in Step 3) -->
  <div class="ve-strip" id="veToolbar" role="region" aria-label="Editing toolbar" style="display: none;">
    <div class="ve-bar">
      <!-- Mobile toolbar -->
      <div class="mobile-toolbar">
        <button class="btn" id="close" title="Close"><span class="cdx-icon" data-icon="cdxIconClose"></span></button>
        <button class="btn" id="undo" title="Undo"><span class="cdx-icon" data-icon="cdxIconUndo"></span></button>
        <div class="dropdown" id="dd-style-mobile">
          <span class="cdx-icon" data-icon="cdxIconTextStyle"></span>
          <span class="caret" aria-hidden="true"></span>
          <div class="menu" id="menu-style-mobile">
            <button data-style="bold">Bold</button>
            <button data-style="italic">Italic</button>
            <button data-style="underline">Underline</button>
            <button data-style="strike">Strikethrough</button>
            <button data-style="clean">Clear styling</button>
          </div>
        </div>
        <button class="btn" id="quote" title="Quote"><span class="cdx-icon" data-icon="cdxIconQuotes"></span></button>
        <button class="btn" id="btn-link-mobile" title="Add link"><span class="cdx-icon" data-icon="cdxIconLink"></span></button>
        <button class="btn" id="guideMeMobile" title="Get suggestions"><span style="font-size: 16px; filter: brightness(0.7);">✨</span></button>
        <button class="btn submit-btn" id="submit" title="Submit" style="margin-left: auto;"><span class="cdx-icon" data-icon="cdxIconNext"></span></button>
      </div>

      <!-- Desktop toolbar -->
      <div class="desktop-toolbar">
        <div class="group tight">
          <button class="btn" id="undo-desktop" title="Undo"><span class="cdx-icon" data-icon="cdxIconUndo"></span></button>
          <button class="btn" id="redo" title="Redo"><span class="cdx-icon" data-icon="cdxIconRedo"></span></button>
        </div>
        <div class="group">
          <div class="dropdown" id="dd-paragraph">
            <span class="cdx-icon" data-icon="cdxIconTextHeading"></span>
            <span class="cdx-button__label">Paragraph</span>
            <span class="caret" aria-hidden="true"></span>
            <div class="menu" id="menu-paragraph">
              <button data-header="">Paragraph</button>
              <button data-header="1">Heading 1</button>
              <button data-header="2">Heading 2</button>
              <button data-header="3">Heading 3</button>
              <button data-header="4">Heading 4</button>
              <button data-header="5">Heading 5</button>
              <button data-header="6">Heading 6</button>
              <button data-header="code">Preformatted</button>
            </div>
          </div>
        </div>
        <div class="group">
          <div class="dropdown" id="dd-style">
            <span class="cdx-icon" data-icon="cdxIconTextStyle"></span>
            <span class="cdx-button__label">A</span>
            <span class="caret" aria-hidden="true"></span>
            <div class="menu" id="menu-style">
              <button data-style="bold">Bold</button>
              <button data-style="italic">Italic</button>
              <button data-style="underline">Underline</button>
              <button data-style="strike">Strikethrough</button>
              <button data-style="clean">Clear styling</button>
            </div>
          </div>
        </div>
        <div class="group tight">
          <button class="btn" data-cmd="ol" title="Numbered list"><span class="cdx-icon" data-icon="cdxIconListNumbered"></span></button>
          <button class="btn" data-cmd="ul" title="Bullet list"><span class="cdx-icon" data-icon="cdxIconListBullet"></span></button>
        </div>
        <div class="group">
          <button class="btn" id="btn-link" title="Add link">
            <span class="cdx-icon" data-icon="cdxIconLink"></span>
            <span class="cdx-button__label">Link</span>
          </button>
          <div class="dropdown" id="dd-cite">
            <span class="cdx-icon" data-icon="cdxIconReference"></span>
            <span class="cdx-button__label">Cite</span>
            <span class="caret"></span>
            <div class="menu" id="menu-cite">
              <button data-cite="web">Cite web… (mock)</button>
              <button data-cite="book">Cite book… (mock)</button>
              <button data-cite="news">Cite news… (mock)</button>
            </div>
          </div>
          <div class="dropdown" id="dd-insert">
            <span class="cdx-icon" data-icon="cdxIconAdd"></span>
            <span class="cdx-button__label">Insert</span>
            <span class="caret"></span>
            <div class="menu" id="menu-insert">
              <button data-insert="image">Media…</button>
              <button data-insert="template">Template… (mock)</button>
              <button data-insert="math">Math… (mock)</button>
              <button data-insert="table">Table… (mock)</button>
              <button data-insert="char">Special character…</button>
            </div>
          </div>
        </div>
        <div class="group tight">
          <button class="btn" id="addSectionBtn" title="Get suggestions"><span style="font-size: 16px; filter: brightness(0.7); margin-right: 6px;">✨</span><span class="cdx-button__label">Suggestions</span></button>
          
          <button class="btn" disabled title="Page options"><span class="cdx-icon" data-icon="cdxIconSettings"></span></button>
          <button class="btn" title="Help"><span class="cdx-icon" data-icon="cdxIconHelp"></span></button>
        </div>
        <div class="group" style="margin-left:auto;border-left:none;padding-right:0">
          <button class="btn publish-btn" id="publish" disabled>Publish</button>
        </div>
      </div>
    </div>
  </div>

  <main class="ve-content-wrap">
    <div class="surface">
      <div class="creator-wrap">
        <div class="ac-steps">
          <section class="ac-step active" id="creation-step1">
            <h3 data-i18n="creation.step1.title">What article would you like to create?</h3>
            <input id="creation-title" class="title-input" placeholder="e.g., Jane Doe / Example Software" aria-label="Proposed title" data-i18n-placeholder="creation.step1.placeholder" data-i18n-attr="placeholder">
            <div class="ac-actions">
              <button class="btn primary" id="creation-toStep2" disabled data-i18n="creation.step1.continue">Continue</button>
            </div>
          </section>
          <section class="ac-step" id="creation-step2">
            <h3 data-i18n="creation.step2.title.static" data-i18n-template='What is "{topic}"?'>Assign a topic category</h3>
            <div class="category-list" id="creation-categoryList">
              <div class="category-item" data-cat="person" data-i18n="creation.cat.person">Person / Biography</div>
              <div class="category-item" data-cat="place" data-i18n="creation.cat.place">Geographic Location</div>
              <div class="category-item" data-cat="species" data-i18n="creation.cat.species">Species / Biology</div>
              <div class="category-item" data-cat="organization" data-i18n="creation.cat.organization">Organization</div>
              <div class="category-item" data-cat="academic" data-i18n="creation.cat.academic">Academic / Concept</div>
              <div class="category-item" data-cat="creative" data-i18n="creation.cat.creative">Creative Work</div>
              <div class="category-item" data-cat="event" data-i18n="creation.cat.event">Event</div>
              <div class="category-item" data-cat="other" data-i18n="creation.cat.other">Other</div>
            </div>
            <div class="hint" data-i18n="creation.step2.hint">This helps us suggest the right structure and policies.</div>
            <div class="ac-actions">
              <button class="btn" id="creation-backTo1" data-i18n="creation.step2.back">Back</button>
              <button class="btn primary" id="creation-toStep3" disabled data-i18n="creation.step2.start">Start editing</button>
            </div>
          </section>
          <section class="ac-step" id="creation-step3">
            <div id="editor" class="editor" contenteditable="true" data-placeholder="Type the lead...">
              <!-- Smart chips container -->
              <div class="smart-chips-container" id="smartChips">
                <div class="smart-chip primary" data-action="template">
                  <span class="smart-chip-icon">📝</span>
                  <span>Template</span>
                </div>
                <div class="smart-chip" data-action="section">
                  <span class="smart-chip-icon">📑</span>
                  <span>Section</span>
                </div>
                <div class="smart-chip" data-action="source">
                  <span class="smart-chip-icon">🔗</span>
                  <span>Source</span>
                </div>
                <div class="smart-chip" data-action="assistance">
                  <span class="smart-chip-icon">✨</span>
                  <span>Help</span>
                </div>
              </div>
              
              <!-- Template popup -->
              <div class="template-popup" id="templatePopup">
                <!-- Will be populated by JavaScript based on context -->
              </div>
            </div>
          </section>
        </div>
      </div>
      
    </div>
  </main>


  <!-- Footer status (shown only in Step 3) -->
  <footer class="ve-footer" id="veFooter" style="display: none;">
    <div class="status"><span>Changes are preview‑only in this demo.</span><span class="badge">Visual Editor</span></div>
  </footer>

  <!-- Source verification modal -->
  <div class="source-modal-backdrop" id="sourceModalBackdrop" aria-hidden="true">
    <div class="source-modal" role="dialog" aria-modal="true" aria-labelledby="sourceModalTitle">
      <div class="source-modal-header">
        <h3 id="sourceModalTitle">Add content from a reliable source</h3>
        <button class="close-btn" id="closeSourceModal" title="Close">×</button>
      </div>
      <div class="source-modal-content">
        <div class="source-input-section">
          <label for="sourceUrl">Source URL</label>
          <input type="url" id="sourceUrl" placeholder="https://example.com/article" />
        </div>
        
        <div class="source-verification" id="sourceVerification" style="display: none;">
          <h4>Source verification</h4>
          <div class="verification-steps" id="verificationSteps">
            <div class="verification-step" id="step1">
              <span class="step-icon">⏳</span>
              <span class="step-text">Checking domain...</span>
            </div>
            <div class="verification-step" id="step2">
              <span class="step-icon">⏳</span>
              <span class="step-text">Verifying reliability...</span>
            </div>
            <div class="verification-step" id="step3">
              <span class="step-icon">⏳</span>
              <span class="step-text">Checking HTTPS security...</span>
            </div>
          </div>
          <div class="source-result" id="sourceResult" style="display: none;">
            <div class="source-badge" id="sourceBadge"></div>
            <div class="reliability-note" id="reliabilityNote"></div>
          </div>
        </div>
        
        <div class="draft-preview" id="draftPreview" style="display: none;">
          <h4>Draft content preview</h4>
          <div class="draft-content" id="draftContent"></div>
        </div>
      </div>
      <div class="source-modal-actions">
        <button class="btn" id="cancelSource">Cancel</button>
        <button class="btn" id="checkSourceBtn">Check source</button>
        <button class="btn primary" id="generateDraftBtn" style="display: none;">Create draft from source</button>
        <button class="btn primary" id="insertDraftBtn" style="display: none;">Insert as draft</button>
      </div>
    </div>
  </div>

  <div class="ref-dialog-backdrop" id="refBackdrop" aria-hidden="true">
    <div class="ref-dialog" role="dialog" aria-modal="true" aria-labelledby="refTitle">
      <div class="ref-row"><strong id="refTitle">Add reference</strong> <span id="refHint" class="badge">unclassified</span></div>
      <div class="ref-row"><label for="refUrl">Source URL</label><input id="refUrl" type="url" placeholder="https://example.com/article"></div>
      <div class="ref-row"><label for="refTitleInput">Title (optional)</label><input id="refTitleInput" type="text" placeholder="Article title"></div>
      <div class="ref-actions">
        <button class="btn" id="refCancel">Cancel</button>
        <button class="btn primary" id="refInsert">Insert cite</button>
      </div>
    </div>
  </div>

  <script>
    // Stub functions to prevent console errors from extensions or external scripts
    window.addMouseUpHandler = window.addMouseUpHandler || function() { /* stub */ };
    window.checkLogin = window.checkLogin || function() { /* stub */ };
    
    // === Codex Icons via MW API ===
    async function loadCodexIcons(iconNames) {
      const url = 'https://www.mediawiki.org/w/api.php?action=query&list=codexicons&format=json&origin=*' +
        '&names=' + encodeURIComponent(iconNames.join('|'));
      const res = await fetch(url);
      const data = await res.json();
      const out = {};
      const map = data?.query?.codexicons || {};
      
      for (const k of Object.keys(map)) {
        const entry = map[k];
        const path = typeof entry === 'string' ? entry : (entry.ltr || entry.default || Object.values(entry.langCodeMap || {})[0] || '');
        out[k] = path;
      }
      return out;
    }

    // Apply icons on load
    (function applyIcons() {
      const nodes = Array.from(document.querySelectorAll('.cdx-icon[data-icon]'));
      const names = Array.from(new Set(nodes.map(n => n.getAttribute('data-icon'))));
      
      loadCodexIcons(names).then(paths => {
        nodes.forEach(n => {
          const name = n.getAttribute('data-icon');
          const p = paths[name];
          if (p) {
            n.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">' + p + '</svg>';
          }
        });
      }).catch(console.error);
    })();

    // === Minimal runtime i18n (language-first JSON) ===
    (function runtimeI18n(){
      // Detect language robustly for GitHub Pages under /<repo>/<lang>/... or direct /<lang>/...
      var segs = location.pathname.split('/').filter(Boolean).map(function(s){ return s.toLowerCase(); });
      var langSeg = segs[1] || segs[0] || 'en';
      var lang = window.currentLang || ((langSeg === 'id' || segs.indexOf('id') !== -1) ? 'id' : ((langSeg === 'en' || segs.indexOf('en') !== -1) ? 'en' : 'en'));
      window.currentLang = lang;

      function getNested(obj, path) {
        try { return path.split('.').reduce(function(acc, k){ return (acc && acc[k] != null) ? acc[k] : undefined; }, obj); } catch(_) { return undefined; }
      }
      function format(str, params){
        try { if (!params) return str; return String(str).replace(/\{(\w+)\}/g, function(_,k){ return (params[k] != null) ? params[k] : _; }); } catch(_) { return str; }
      }
      function aliasKey(key){
        try {
          var k = String(key||'');
          // Map legacy flat keys to nested paths used in translations.json
          // 1) creation.cat.person -> creation.step2.categories.person
          if (k.indexOf('creation.cat.') === 0) {
            return k.replace('creation.cat.', 'creation.step2.categories.');
          }
          // 2) creation.step2.title.static -> creation.step2.title_static
          k = k.replace(/\.title\.(static|template)$/,'_$$1');
          // 3) creation.step2.title.static (redundant safety)
          k = k.replace(/(creation\.step2\.\w+)\.static$/,'$1_static');
          k = k.replace(/(creation\.step2\.\w+)\.template$/,'$1_template');
          return k;
        } catch(_) { return key; }
      }
      function t(key, params, fallback){
        try {
          var dict = (window.translationsByLang && window.translationsByLang[window.currentLang]) || null;
          var v = dict ? getNested(dict, key) : undefined;
          if (v == null) { v = dict ? getNested(dict, aliasKey(key)) : undefined; }
          var out = (v != null) ? v : ((fallback != null) ? fallback : key);
          return format(out, params);
        } catch(_) { return format((fallback != null ? fallback : key), params); }
      }
      window.__i18nGet = t;

      function applyDom(){
        try {
          document.querySelectorAll('[data-i18n]').forEach(function(el){
            var key = el.getAttribute('data-i18n');
            var val = t(key, null, null);
            if (val != null && typeof val === 'string') el.textContent = val;
          });
          document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el){
            var key = el.getAttribute('data-i18n-placeholder');
            var val = t(key, null, null);
            if (val != null && typeof val === 'string') el.setAttribute('placeholder', val);
          });
          document.querySelectorAll('[data-i18n-attr]').forEach(function(el){
            var attr = el.getAttribute('data-i18n-attr');
            var key = el.getAttribute('data-i18n-placeholder') || el.getAttribute('data-i18n-attr-key') || el.getAttribute('data-i18n-attr');
            var val = t(key, null, null);
            if (val != null && typeof val === 'string') el.setAttribute(attr, val);
          });
        } catch(_) {}
      }

      function loadAndApply(){
        // Compute repo root: /<repo>/translations.json on GH Pages, else relative
        var segs = location.pathname.split('/').filter(Boolean);
        var base = segs.length > 0 ? ('/' + segs[0]) : '';
        var url = base ? (base + '/translations.json') : 'translations.json';
        fetch(url).then(function(res){ if (!res.ok) throw new Error('no translations'); return res.json(); }).then(function(json){
          window.translationsByLang = json;
          applyDom();
        }).catch(function(){ /* silent */ });
      }

      if (window.translationsByLang) applyDom(); else loadAndApply();
    })();

    // === Referencing helpers (concept demo) ===
    let referenceCount = 0;
    let lastSourceReminderClicked = null;
    // One-time intro help flag
    window.__introHelpShown = (typeof window.__introHelpShown === 'boolean') ? window.__introHelpShown : false;

    function showIntroHelp(afterEl) {
      try {
        if (window.__introHelpShown) return;
        if (!afterEl || !afterEl.parentNode) return;
        // Create help block
        var help = document.createElement('div');
        help.id = 'introHelp';
        help.className = 'intro-help';
        help.setAttribute('role','note');
        help.setAttribute('contenteditable','false');
        help.innerHTML = '<div class="title">Fill the details</div>'+
                         '<p class="subtitle">Share a reference to fill automatically the details or add them manually</p>';
        afterEl.insertAdjacentElement('afterend', help);
        window.__introHelpShown = true;
      } catch(_) {}
    }

    function hideIntroHelp() {
      try {
        var help = document.getElementById('introHelp');
        if (help && help.parentNode) help.parentNode.removeChild(help);
      } catch(_) {}
    }

    function ensureSelectionInEditor(editor) {
      const sel = window.getSelection();
      if (!sel.rangeCount || !editor.contains(sel.anchorNode)) {
        placeCaretAtEnd(editor);
      }
      try { currentCursorPosition = sel.getRangeAt(0).cloneRange(); } catch (_) {}
    }

    function placeCaretAtEnd(el) {
      el.focus();
      const range = document.createRange();
      range.selectNodeContents(el);
      range.collapse(false);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    }

    // Utility: place caret at start of a contenteditable or element's contents
    function placeCaretAtStart(el) {
      try {
        el.focus();
        const range = document.createRange();
        range.selectNodeContents(el);
        range.collapse(true); // start of contents
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      } catch(_) {}
    }

    // Utility: place caret immediately after a specific node
    function placeCaretAfterNode(node) {
      try {
        var editor = document.getElementById('editor');
        if (editor) editor.focus();
        const range = document.createRange();
        range.setStartAfter(node);
        range.collapse(true);
        const sel = window.getSelection();
        sel.removeAllRanges();
        sel.addRange(range);
      } catch(_) {}
    }

    function insertNodeAtCaret(node, editor) {
      const sel = window.getSelection();
      if (!sel.rangeCount) placeCaretAtEnd(editor);
      const range = sel.getRangeAt(0);
      range.collapse(true);
      range.insertNode(node);
      // Move caret after the inserted node
      range.setStartAfter(node);
      range.collapse(true);
      sel.removeAllRanges();
      sel.addRange(range);
    }

    function ensureReferencesSection() {
      const editor = document.getElementById('editor');
      const hasRefs = editor.innerHTML.includes('<h2') && editor.innerHTML.includes('id="References"');
      if (!hasRefs) {
        const block = document.createElement('div');
        block.innerHTML = (
          '<h2 id="References" style="font-family: Georgia, serif; font-size: 1.5em; font-weight: normal; margin: 2em 0 0.25em 0; padding:0; border-bottom:1px solid #eaecf0; padding-bottom:0.25em;">References</h2>' +
          '<div id="referencesList" style="margin:0.75em 0; font-size:0.9em;"></div>'
        );
        editor.appendChild(block);
      } else {
        // Ensure list container exists
        const refsList = document.getElementById('referencesList');
        if (!refsList) {
          const refsHeader = editor.querySelector('#References');
          const div = document.createElement('div');
          div.id = 'referencesList';
          div.style.margin = '0.75em 0';
          div.style.fontSize = '0.9em';
          refsHeader && refsHeader.insertAdjacentElement('afterend', div);
        }
      }
    }

    function appendReferenceEntry(number, url, title) {
      const list = document.getElementById('referencesList');
      const p = document.createElement('p');
      p.style.margin = '0.25em 0';
      const domain = (() => { try { return new URL(url).hostname; } catch(_) { return ''; } })();
      const today = new Date().toLocaleDateString('en-US', {year:'numeric', month:'long', day:'numeric'});
      const citation = title ? `${title}. ${domain ? domain + '.' : ''} Retrieved ${today}. ${url}` : `${domain ? domain + '.' : ''} Retrieved ${today}. ${url}`;
      p.textContent = `${number}. ${citation}`;
      (list || document.getElementById('References')?.insertAdjacentElement('afterend', (function(){const d=document.createElement('div');d.id='referencesList';return d;})()))?.appendChild(p);
    }

    // === Lightweight undo + feedback ===
    let __lastUndoAction = null;
    function flashElement(el) {
      try { if (!el) return; el.classList.add('flash-insert'); setTimeout(() => el && el.classList && el.classList.remove('flash-insert'), 1500); } catch(_) {}
    }

    // Activate publish/submit UI explicitly (used for non-typing insertions)
    function enablePublishUI() {
      try {
        var publishBtn = document.getElementById('publish');
        if (publishBtn) {
          publishBtn.disabled = false;
          publishBtn.classList.add('primary');
          publishBtn.textContent = 'Publish changes';
        }
        var submitBtn = document.getElementById('submit');
        if (submitBtn) {
          submitBtn.classList.add('primary');
          submitBtn.style.background = '#36c';
          submitBtn.style.color = '#fff';
          submitBtn.style.borderColor = '#36c';
          var icon = submitBtn.querySelector('.cdx-icon svg');
          if (icon) icon.style.color = '#fff';
        }
      } catch(_) {}
    }
    function ensureUndoToastEl() {
      let t = document.getElementById('undoToast');
      if (!t) {
        t = document.createElement('div');
        t.id = 'undoToast';
        t.className = 'undo-toast';
        t.innerHTML = '<span id="undoToastMsg">Change applied</span><button class="btn-undo" id="undoToastBtn">Undo</button>';
        document.body.appendChild(t);
      }
      return t;
    }
    function showUndoToast(message, undoFn, highlightEl) {
      try { flashElement(highlightEl); } catch(_) {}
      const t = ensureUndoToastEl();
      const msg = t.querySelector('#undoToastMsg');
      const btn = t.querySelector('#undoToastBtn');
      if (msg) msg.textContent = message || 'Change applied';
      __lastUndoAction = (typeof undoFn === 'function') ? undoFn : null;
      if (btn) {
        btn.onclick = function(){
          let handled = false;
          try {
            if (__lastUndoAction) {
              const ret = __lastUndoAction();
              handled = (ret === true) || (ret && ret.handledCaret === true);
            }
          } finally {
            // Unless the undo function already managed caret/selection, restore focus at end
            if (!handled) {
              try { var ed = document.getElementById('editor'); if (ed) { ed.focus(); placeCaretAtEnd(ed); } } catch(_) {}
            }
            try { if (typeof reanchorAssistChip === 'function') reanchorAssistChip(); } catch(_) {}
            t.classList.remove('show');
            __lastUndoAction = null;
          }
        };
      }
      t.classList.add('show');
      // Auto-hide after a few seconds if untouched
      setTimeout(function(){ if (t.classList.contains('show')) t.classList.remove('show'); }, 6000);
    }

    // Helper to re-anchor the Suggestions chip after DOM changes
    function reanchorAssistChip() {
      try {
        var chip = document.getElementById('assistChip');
        var editor = document.getElementById('editor');
        if (!editor || !chip) return;

        // Clear any existing frozen state to allow repositioning
        if (typeof window.__assistSetFrozen === 'function') {
          window.__assistSetFrozen(false);
        }

        // Priority 1: Get current active block from selection (safe fallback to top-visible block)
        var activeBlock = null;
        try {
          if (typeof getActiveBlockElement === 'function') activeBlock = getActiveBlockElement();
        } catch(_) {}
        if (!activeBlock) {
          // Fallback: top-most visible block
          var editorRect = editor.getBoundingClientRect();
          var blocksTV = Array.from(editor.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, blockquote'))
            .filter(function(el){ return el.offsetParent !== null; });
          var best = null, bestDelta = Infinity;
          for (var i=0;i<blocksTV.length;i++){
            var r = blocksTV[i].getBoundingClientRect();
            var intersects = r.bottom > editorRect.top && r.top < editorRect.bottom;
            if (!intersects) continue;
            var delta = Math.abs(r.top - editorRect.top);
            if (delta < bestDelta) { bestDelta = delta; best = blocksTV[i]; }
          }
          activeBlock = best || blocksTV[0] || editor;
        }
        if (activeBlock && activeBlock !== editor && editor.contains(activeBlock) && activeBlock.offsetParent !== null) {
          lastAnchorEl = activeBlock;
          if (typeof positionChipBelowElement === 'function') {
            positionChipBelowElement(activeBlock);
          }
          if (typeof showSuggestionsChip === 'function') {
            showSuggestionsChip(activeBlock);
          }
          return;
        }

        // Priority 2: Use last anchor if still valid
        if (lastAnchorEl && editor.contains(lastAnchorEl) && lastAnchorEl.offsetParent !== null) {
          const editorRect = editor.getBoundingClientRect();
          const anchorRect = lastAnchorEl.getBoundingClientRect();
          const isVisible = anchorRect.bottom > editorRect.top && anchorRect.top < editorRect.bottom;

          if (isVisible) {
            if (typeof positionChipBelowElement === 'function') {
              positionChipBelowElement(lastAnchorEl);
            }
            if (typeof showSuggestionsChip === 'function') {
              showSuggestionsChip(lastAnchorEl);
            }
            return;
          }
        }

        // Priority 3: Find the most recent valid block
        var blocks = Array.from(editor.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, blockquote'))
          .filter(function(el){
            return el.offsetParent !== null &&
                   el.id !== 'assistChip' &&
                   el.id !== 'assistMenu' &&
                   !el.closest('#assistChip') &&
                   !el.closest('#assistMenu') &&
                   el.textContent.trim().length > 0; // Only blocks with content
          });

        if (blocks.length > 0) {
          // Use the most recent block (last in DOM)
          var targetBlock = blocks[blocks.length - 1];
          lastAnchorEl = targetBlock;

          if (typeof positionChipBelowElement === 'function') {
            positionChipBelowElement(targetBlock);
          }
          if (typeof showSuggestionsChip === 'function') {
            showSuggestionsChip(targetBlock);
          }
        }
      } catch(error) {
        console.warn('Error in reanchorAssistChip:', error);
      }
    }

    function insertReferenceLink(url, title) {
      const editor = document.getElementById('editor');
      ensureSelectionInEditor(editor);

      // Build <sup> link
      referenceCount += 1;
      const sup = document.createElement('sup');
      sup.className = 'wiki-reference';
      sup.title = url;
      sup.style.color = '#0645ad';
      sup.textContent = `[${referenceCount}]`;

      // Replace last clicked source reminder if present
      if (lastSourceReminderClicked && lastSourceReminderClicked.parentNode) {
        lastSourceReminderClicked.replaceWith(sup);
        lastSourceReminderClicked = null;
      } else {
        insertNodeAtCaret(sup, editor);
      }

      // Ensure and append to References
      ensureReferencesSection();
      appendReferenceEntry(referenceCount, url, title || '');

      // Hide one-time intro help after a reference is added
      try { hideIntroHelp(); } catch(_) {}

      // Reposition chips after insert
      try { if (typeof showSmartChipsAtCursor === 'function') showSmartChipsAtCursor(); } catch(_) {}
      const sc = document.getElementById('smartChips'); if (sc) sc.classList.add('show');

      // Feedback + undo
      try {
        const highlightTarget = sup.closest('p') || sup;
        showUndoToast('Inserted citation', function(){
          try { if (sup && sup.parentNode) sup.parentNode.removeChild(sup); } catch(_){ }
          try { const list = document.getElementById('referencesList'); if (list && list.lastElementChild) list.removeChild(list.lastElementChild); } catch(_){ }
          // If no references left, optionally hide the References heading container spacing
          try {
            const list = document.getElementById('referencesList');
            const empty = list && list.children.length === 0;
            if (empty) {
              const refsHeader = document.getElementById('References');
              if (refsHeader) {
                const next = refsHeader.nextElementSibling;
                if (next && next.id === 'referencesList' && next.children.length === 0) {
                  // Remove both to reclaim space
                  next.remove();
                  refsHeader.remove();
                }
              }
            }
          } catch(_) {}
        }, highlightTarget);
      } catch(_) {}
    }
    // Steps
    var titleInput=document.getElementById('creation-title');
    var toStep2=document.getElementById('creation-toStep2');
    var toStep3=document.getElementById('creation-toStep3');
    var backTo1=document.getElementById('creation-backTo1');
    var step1=document.getElementById('creation-step1');
    var step2=document.getElementById('creation-step2');
    var step3=document.getElementById('creation-step3');
    var categoryList=document.getElementById('creation-categoryList');
    var selectedCat=null;


    titleInput.addEventListener('input', function(){ toStep2.disabled = !(titleInput.value.trim().length>0); });
    toStep2.onclick=function(){ 
      step1.classList.remove('active'); 
      step2.classList.add('active'); 
      
      // Update Step 2 title with the entered topic (localized)
      var step2Title = step2.querySelector('h3');
      var userTopic = titleInput.value.trim();
      if (step2Title && userTopic) {
        var __t = (typeof window.__i18nGet === 'function') ? window.__i18nGet : function(k,p,f){ return f || k; };
        // Prefer explicit template key if provided on element
        var k = step2Title.getAttribute('data-i18n-template-key') || 'creation.step2.title_template';
        var txt = __t(k, { topic: userTopic }, null);
        if (!txt || txt === k) {
          // Try legacy key path or fallback static title
          txt = __t('creation.step2.title_template', { topic: userTopic }, null) || __t('creation.step2.title_static', null, 'Assign a topic category');
          if (txt && txt.indexOf('{topic}') !== -1) txt = txt.replace('{topic}', userTopic);
        }
        step2Title.textContent = txt || ('What is "' + userTopic + '"?');
      }
      
    };
    backTo1 && (backTo1.onclick=function(){ step2.classList.remove('active'); step1.classList.add('active'); });
    categoryList && categoryList.addEventListener('click', function(e){
      var item=e.target.closest('.category-item'); if(!item) return;
      Array.from(categoryList.querySelectorAll('.category-item')).forEach(function(n){n.classList.remove('selected');});
      item.classList.add('selected'); selectedCat=item.getAttribute('data-cat'); 
      // Expose selected category globally for template suggestions
      window.selectedCat = selectedCat;
      
      // Get the button fresh each time to avoid conflicts with smart chips code
      var toStep3Button = document.getElementById('creation-toStep3');
      if (toStep3Button) {
        toStep3Button.disabled=false;
      }
      
      // Update guide content when category changes
      setTimeout(updateGuideContent, 100);
      
      // Preload templates data when category is selected for smoother Step 3 experience
      if (!window.templatesData || window.templatesData === undefined) {
        loadTemplates().then(function() {
          console.log('Templates preloaded for category:', selectedCat);
        }).catch(function() {
          console.warn('Failed to preload templates for category:', selectedCat);
        });
      }
    });
    toStep3 && (toStep3.onclick=function(){
      step2.classList.remove('active');
      step3.classList.add('active');
      
      // Activate VE interface
      document.body.classList.add('ve-in-step3');

      var ed = document.getElementById('editor');
      var t = titleInput.value.trim();
      var safeTitle = (t || 'Untitled').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      // Expose plain title for autofill in templates
      window.articleTitleText = t || 'Untitled';
      
      // Update VE header title
      var veTitle = document.getElementById('veTitle');
      if (veTitle) veTitle.textContent = safeTitle;
      
      // Initialize editor with a visible lead placeholder paragraph that holds the caret
      // Includes inline guidance to use '/' for suggestions
      (function(){ var __t = (typeof window.__i18nGet === 'function') ? window.__i18nGet : function(k,p,f){ return f || k; }; var msg = __t('editor.leadPlaceholder', { topic: safeTitle }, 'Start writing about {topic} or <strong>Press "/" for suggestions</strong>.'); ed.innerHTML = '<p id="leadPlaceholder" class="lead-placeholder" style="margin: 1.1em 0 2.25em 0; color: #72777d; font-style: italic;">'+ msg +'</p>'; })();
      ed.removeAttribute('data-placeholder');
      
      // Insert a single Assistance chip with inline menu (simple concept)
      var __t = (typeof window.__i18nGet === 'function') ? window.__i18nGet : function(k, p, f){ return f || k; };
      var assistHtml = ''+
        '<div id="assistChip" class="assist-chip" role="button" aria-label="'+ __t('ui.suggestions','Suggestions') +'" aria-expanded="false" tabindex="0" style="z-index:150;" contenteditable="false"><span class="icon">✨</span><span class="label">'+ __t('ui.suggestions','Suggestions') +'</span></div>'+
        '<div id="assistMenu" class="assist-menu" style="position:absolute; top:36px; left:4px; z-index:200; display:none; background:#fff; border:none; border-radius:8px; box-shadow:0 1px 2px rgba(0,0,0,0.12); padding:0;" contenteditable="false">'+
          '<div class="assist-menu-header">'+ __t('ui.suggestions','Suggestions') +'</div>'+
          '<button class="assist-item" data-assist="intro"><div class="template-option-title">'+ __t('ui.introduction','Introduction') +'</div><div class="template-option-desc">'+ __t('ui.introductionDesc','Insert a simple opening sentence') +'</div></button>'+ 
          '<div class="assist-sep"></div>'+
          '<button class="assist-item" data-assist="source"><div class="template-option-title">'+ __t('ui.addFromSource','Add from a source') +'</div><div class="template-option-desc">'+ __t('ui.addFromSourceDesc','Open source dialog') +'</div></button>'+ 
          '<div class="assist-sep"></div>'+
          '<button class="assist-item" data-assist="section"><div class="template-option-title">'+ __t('ui.suggestedSection','Suggested section') +'</div><div class="template-option-desc">'+ __t('ui.suggestedSectionDesc','Add a common section') +'</div></button>'+ 
        '</div>';
      ed.insertAdjacentHTML('beforeend', assistHtml);
      initializeAssistanceUI();

      // Ensure chip is properly positioned after initialization
      setTimeout(function() {
        if (typeof reanchorAssistChip === 'function') {
          reanchorAssistChip();
        }
      }, 200);
    
      // Focus editor and place caret at the beginning of the lead placeholder paragraph
      ed.focus();
      (function(){
        var lp = document.getElementById('leadPlaceholder');
        if (lp) {
          try {
            var r = document.createRange();
            var s = window.getSelection();
            // Place caret at the start of the paragraph
            r.selectNodeContents(lp);
            r.collapse(true);
            s.removeAllRanges();
            s.addRange(r);
          } catch(_) {}
        }
      })();
      
      // Ensure that when the lead placeholder becomes active, caret is at the very start
      (function bindLeadPlaceholderCaretStart(){
        try {
          var ed = document.getElementById('editor');
          if (!ed) return;
          var handler = function(e){
            try {
              var lp = document.getElementById('leadPlaceholder');
              if (!lp) return;
              if (e && e.target && (e.target === lp || lp.contains(e.target))) {
                // Defer to avoid interfering with native focus processing
                setTimeout(function(){ placeCaretAtStart(lp); }, 0);
              } else {
                // Also handle cases where the placeholder itself gains focus
                if (document.activeElement === lp) {
                  setTimeout(function(){ placeCaretAtStart(lp); }, 0);
                }
              }
            } catch(_) {}
          };
          // Listen to both focusin and click to cover keyboard/mouse activation
          ed.addEventListener('focusin', handler);
          ed.addEventListener('click', handler);
        } catch(_) {}
      })();

      // Add input listener to activate publish/submit buttons when user starts typing
      ed.addEventListener('input', function() {
        // Use unified placeholder restoration logic
        setTimeout(function() {
          if (window.restorePlaceholderIfEmpty) {
            window.restorePlaceholderIfEmpty();
          }
        }, 0);
        var publishBtn = document.getElementById('publish');
        var submitBtn = document.getElementById('submit');
        
        if (ed.textContent.trim().length > 0) {
          // Desktop publish button
          if (publishBtn) {
            publishBtn.disabled = false;
            publishBtn.classList.add('primary');
            publishBtn.textContent = 'Publish changes';
          }
          
          // Mobile submit button  
          if (submitBtn) {
            submitBtn.classList.add('primary');
            submitBtn.style.background = '#36c';
            submitBtn.style.color = '#fff';
            submitBtn.style.borderColor = '#36c';
            // Make the icon white too
            var icon = submitBtn.querySelector('.cdx-icon svg');
            if (icon) icon.style.color = '#fff';
          }
        } else {
          // Reset buttons when content is empty
          if (publishBtn) {
            publishBtn.disabled = true;
            publishBtn.classList.remove('primary');
            publishBtn.textContent = 'Publish';
          }
          
          if (submitBtn) {
            submitBtn.classList.remove('primary');
            submitBtn.style.background = '';
            submitBtn.style.color = '';
            submitBtn.style.borderColor = '';
            // Reset icon color too
            var icon = submitBtn.querySelector('.cdx-icon svg');
            if (icon) icon.style.color = '';
          }
        }
      });
      
      // Fix superscript formatting sticking after references
      ed.addEventListener('keyup', function(e) {
        var selection = window.getSelection();
        if (selection.rangeCount > 0) {
          var range = selection.getRangeAt(0);
          var container = range.commonAncestorContainer;
          
          // Check if cursor is right after a superscript element
          if (container.nodeType === Node.TEXT_NODE) {
            var parent = container.parentNode;
            if (parent && parent.tagName === 'SUP') {
              // We're inside a sup element, move cursor outside
              var newRange = document.createRange();
              newRange.setStartAfter(parent);
              newRange.collapse(true);
              selection.removeAllRanges();
              selection.addRange(newRange);
              
              // Insert a zero-width space to break formatting
              document.execCommand('insertText', false, '\u200B');
            }
          } else if (container.nodeType === Node.ELEMENT_NODE && container.tagName === 'SUP') {
            // We're at the end of a sup element
            var newRange = document.createRange();
            newRange.setStartAfter(container);
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);
            
            // Insert a zero-width space to break formatting
            document.execCommand('insertText', false, '\u200B');
          }
        }
      });
      
      // Also fix on input to handle pasting
      ed.addEventListener('input', function(e) {
        // Remove any lingering blue color from non-superscript text
        var selection = window.getSelection();
        if (selection.rangeCount > 0) {
          var range = selection.getRangeAt(0);
          var container = range.commonAncestorContainer;
          
          if (container.nodeType === Node.TEXT_NODE) {
            var parent = container.parentNode;
            // If we're in a span with blue color but not in a sup, remove the color
            if (parent && parent.style && parent.style.color === 'rgb(6, 69, 173)' && parent.tagName !== 'SUP') {
              parent.style.color = '';
            }
          }
        }
      });

      // Open guidance automatically when entering editing (Step 3)
      // Desktop only; delay to avoid immediate close from the click event
      if (!isMobile()) {
        setTimeout(function(){ showGuide(); }, 50);
      }
    });

    // Reference dialog
    var openBtn=null;
    var backdrop=document.getElementById('refBackdrop');
    var cancelBtn=document.getElementById('refCancel');
    var insertBtn=document.getElementById('refInsert');
    var urlInput=document.getElementById('refUrl');
    var hint=document.getElementById('refHint');
    var editor=document.getElementById('editor');
    var verify=document.getElementById('verify');
    var refBadges=document.getElementById('refBadges');
    function classify(url){ try{ var h=new URL(url).hostname; if(/\.(gov|gov\.[a-z]{2})$/i.test(h)) return {label:'gov',cls:'good'}; if(/\.(edu|ac\.[a-z]{2})$/i.test(h)) return {label:'edu',cls:'good'}; if(/(reuters|apnews|bbc|nytimes|guardian|bloomberg|washingtonpost|ft\.com)/i.test(h)) return {label:'news',cls:'good'}; if(/(prnewswire|businesswire|globenewswire|newswire|press)/i.test(h)) return {label:'press release',cls:'warn'}; return {label:'unclassified',cls:''}; }catch(e){ return {label:'unclassified',cls:''}; } }
    function openDialog(){ backdrop.style.display='block'; urlInput.focus(); }
    function closeDialog(){ backdrop.style.display='none'; }
    function bindRef(){ openBtn=document.getElementById("openRef"); if(openBtn){ openBtn.onclick=openDialog; }} bindRef(); cancelBtn.onclick=closeDialog; backdrop.addEventListener('click',function(e){ if(e.target===backdrop) closeDialog(); });
    // Delegate: clicking on "Add source" reminder or reference chip opens reference dialog and prepares replacement
    editor.addEventListener('click', function(e){ var target=e.target; var sr = target && (target.closest && (target.closest('.source-reminder') || target.closest('.ref-chip'))); if(sr){ lastSourceReminderClicked = sr; // place caret after it
        var r=document.createRange(); var s=window.getSelection(); r.setStartAfter(sr); r.collapse(true); s.removeAllRanges(); s.addRange(r); openDialog(); }});
    urlInput.addEventListener('input',function(){ var c=classify(urlInput.value.trim()); hint.textContent=c.label; hint.className='badge '+(c.cls||''); });
    insertBtn.onclick=function(){ var url=urlInput.value.trim(); if(!url) return; var titleInput=document.getElementById('refTitleInput'); var title=titleInput && titleInput.value ? titleInput.value.trim() : ''; if(document.activeElement!==editor) editor.focus(); insertReferenceLink(url, title); var c=classify(url); if(refBadges){ refBadges.innerHTML='<span class="badge '+(c.cls||'')+'">'+c.label+'</span>'; } closeDialog(); };

    // Guide Me functionality - Desktop Sidebar & Mobile Modal
    // Sidebar elements removed
    // Sidebar buttons removed
    // Guide content elements removed
    var addedSections = [];
    window.addedSections = addedSections;
    var suggestionsData = null;

    // Function to check if we're on mobile
    function isMobile() {
      return window.innerWidth <= 768;
    }

    

    // Load suggestions data
    async function loadSuggestions() {
      try {
        const response = await fetch((typeof assetUrl==='function'?assetUrl('article-creation-suggestions.json'):'article-creation-suggestions.json'));
        suggestionsData = await response.json();
      } catch (error) {
        console.error('Failed to load suggestions:', error);
        suggestionsData = null;
      }
    }

    // Generate guide content based on selected category
    function generateGuideContent() {
      if (!selectedCat || !suggestionsData || !suggestionsData[selectedCat]) {
        return getDefaultGuideContent();
      }

      const categoryData = suggestionsData[selectedCat];
      let content = '<div class="guide-section">';
      
      // Introduction Accordion
      content += '<div class="accordion-item">';
      content += '<div class="accordion-header" onclick="toggleAccordion(this)" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 8px 0; border-bottom: 1px solid #eaecf0;">';
      content += '<h4 style="margin: 0;">Introduction</h4>';
      content += '<span class="accordion-icon" style="font-size: 14px; transform: rotate(0deg); transition: transform 0.2s;">▼</span>';
      content += '</div>';
      content += '<div class="accordion-content" style="display: block; padding-top: 12px;">';
      content += '<p class="guide-note">Write a clear opening that summarizes the topic, explains why it\'s important, and covers the main points readers will find in the article.</p>';
      
      // Show introduction examples if available
      if (categoryData.introduction && categoryData.introduction.examples) {
        content += '<p class="guide-note" style="margin-top: 12px; font-weight: 500;">Examples from Wikipedia:</p>';
        categoryData.introduction.examples.forEach(function(example) {
          content += '<div class="intro-example" style="background: #f8f9fa; border-left: 3px solid #0645ad; padding: 10px; margin: 8px 0; font-size: 0.9em; line-height: 1.4;">';
          content += '<div class="example-title" style="font-weight: bold; color: #0645ad; margin-bottom: 4px;">' + example.title + '</div>';
          content += '<div class="example-text" style="color: #222;">' + example.text + '</div>';
          content += '</div>';
        });
      }
      content += '</div>';
      content += '</div>';
      
      // Suggested Sections Accordion
      content += '<div class="accordion-item" style="margin-top: 16px;">';
      content += '<div class="accordion-header" onclick="toggleAccordion(this)" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 8px 0; border-bottom: 1px solid #eaecf0;">';
      content += '<h4 style="margin: 0;">Suggested sections</h4>';
      content += '<span class="accordion-icon" style="font-size: 14px; transform: rotate(0deg); transition: transform 0.2s;">▼</span>';
      content += '</div>';
      content += '<div class="accordion-content" style="display: block; padding-top: 12px;">';
      content += '<p class="guide-note">' + categoryData.note + '</p>';
      
      // Show all sections (only 3, no References)
      categoryData.sections.forEach(function(section, index) {
        const sectionName = typeof section === 'string' ? section : section.name;
        const sectionDesc = typeof section === 'string' ? '' : section.description;
        const sectionInclude = typeof section === 'string' ? [] : (section.include || []);
        const isAdded = addedSections.indexOf(sectionName) !== -1;
        const className = isAdded ? 'section-button added' : 'section-button';
        
        content += '<button class="' + className + '" data-section="' + sectionName + '">';
        content += '<span class="section-name">' + sectionName + '</span>';
        if (sectionDesc) {
          content += '<span class="section-description">' + sectionDesc + '</span>';
        }
        
        // Add "What to Include" guidance if include items exist
        if (sectionInclude.length > 0) {
          content += '<div class="include-guidance" style="margin-top: 8px; padding: 8px; background: #f8f9fa; border-radius: 3px; border: 1px solid #eaecf0;">';
          content += '<div style="font-size: 11px; font-weight: 500; color: #54595d; margin-bottom: 4px;">What to include:</div>';
          content += '<ul style="margin: 0; padding-left: 16px; font-size: 11px; color: #54595d; line-height: 1.4;">';
          sectionInclude.forEach(function(item) {
            content += '<li>' + item + '</li>';
          });
          content += '</ul>';
          content += '</div>';
        }
        
        content += '</button>';
      });
      content += '</div>';
      content += '</div>';
      
      // Article Eligibility Check Accordion
      content += '<div class="accordion-item" style="margin-top: 16px;">';
      content += '<div class="accordion-header" onclick="toggleAccordion(this)" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 8px 0; border-bottom: 1px solid #eaecf0;">';
      content += '<h4 style="margin: 0;">Article eligibility check</h4>';
      content += '<span class="accordion-icon" style="font-size: 14px; transform: rotate(0deg); transition: transform 0.2s;">▼</span>';
      content += '</div>';
      content += '<div class="accordion-content" style="display: block; padding-top: 12px;">';
      content += '<p class="guide-note">Quick check: Does your topic have what Wikipedia needs?</p>';
      
      content += '<div class="eligibility-questions">';
      content += '<div class="eligibility-item" style="margin-bottom: 16px;">';
      content += '<div style="font-weight: 500; margin-bottom: 8px;">Has your topic been covered in newspapers or magazines?</div>';
      content += '<div class="eligibility-options">';
      content += '<button class="eligibility-btn" data-question="coverage" data-answer="yes">Yes</button>';
      content += '<button class="eligibility-btn" data-question="coverage" data-answer="maybe">Maybe</button>';
      content += '<button class="eligibility-btn" data-question="coverage" data-answer="no">No</button>';
      content += '</div>';
      content += '</div>';
      
      content += '<div class="eligibility-item" style="margin-bottom: 16px;">';
      content += '<div style="font-weight: 500; margin-bottom: 8px;">Are these sources from well-known news sites or publications?</div>';
      content += '<div class="eligibility-options">';
      content += '<button class="eligibility-btn" data-question="reliable" data-answer="yes">Yes</button>';
      content += '<button class="eligibility-btn" data-question="reliable" data-answer="maybe">Maybe</button>';
      content += '<button class="eligibility-btn" data-question="reliable" data-answer="no">No</button>';
      content += '</div>';
      content += '</div>';
      
      content += '<div class="eligibility-item" style="margin-bottom: 16px;">';
      content += '<div style="font-weight: 500; margin-bottom: 8px;">Were these written by independent journalists (not press releases)?</div>';
      content += '<div class="eligibility-options">';
      content += '<button class="eligibility-btn" data-question="independent" data-answer="yes">Yes</button>';
      content += '<button class="eligibility-btn" data-question="independent" data-answer="maybe">Maybe</button>';
      content += '<button class="eligibility-btn" data-question="independent" data-answer="no">No</button>';
      content += '</div>';
      content += '</div>';
      
      content += '<div class="eligibility-item" style="margin-bottom: 16px;">';
      content += '<div style="font-weight: 500; margin-bottom: 8px;">Do you have at least 2 different sources?</div>';
      content += '<div class="eligibility-options">';
      content += '<button class="eligibility-btn" data-question="multiple" data-answer="yes">Yes</button>';
      content += '<button class="eligibility-btn" data-question="multiple" data-answer="maybe">Maybe</button>';
      content += '<button class="eligibility-btn" data-question="multiple" data-answer="no">No</button>';
      content += '</div>';
      content += '</div>';
      content += '</div>';
      
      content += '<div id="eligibilityResult" style="margin-top: 16px; padding: 12px; border-radius: 4px; font-size: 14px; display: none;"></div>';
      
      content += '</div>';
      content += '</div>';
      
      // Add from Source Accordion
      content += '<div class="accordion-item" style="margin-top: 16px;">';
      content += '<div class="accordion-header" onclick="toggleAccordion(this)" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 8px 0; border-bottom: 1px solid #eaecf0;">';
      content += '<h4 style="margin: 0;">Add from source</h4>';
      content += '<span class="accordion-icon" style="font-size: 14px; transform: rotate(0deg); transition: transform 0.2s;">▼</span>';
      content += '</div>';
      content += '<div class="accordion-content" style="display: block; padding-top: 12px;">';
      content += '<p class="guide-note">Helper for citing reliable sources</p>';
      content += '<div id="sourceVerificationArea">';
      content += '<div class="source-input-group">';
      content += '<input type="url" id="sidebarSourceUrl" placeholder="Enter source URL (e.g., bbc.com/article)" class="source-url-input">';
      content += '<button class="source-check-btn" id="sidebarCheckBtn">Check source</button>';
      content += '</div>';
      content += '<div id="sidebarVerificationSteps" style="display: none; margin-top: 12px;"></div>';
      content += '<div id="sidebarSourceResult" style="display: none; margin-top: 12px;"></div>';
      content += '<div id="sidebarDraftPreview" style="display: none; margin-top: 12px;"></div>';
      content += '</div>';
      content += '</div>';
      content += '</div>';
      
      content += '</div>';
      
      return content;
    }

    // Default content when no category is selected
    function getDefaultGuideContent() {
      return '<div class="guide-section">' +
        '<h4>✨ Getting started</h4>' +
        '<ul>' +
        '<li>Start with a clear opening sentence that defines your topic</li>' +
        '<li>Include key facts in the first paragraph</li>' +
        '<li>Use reliable sources throughout</li>' +
        '</ul>' +
        '<p class="guide-note">Select a category in Step 2 to see specific section suggestions for your article type.</p>' +
        '</div>';
    }

    // Update guide content in both sidebar and modal
    function updateGuideContent() {
      // Sidebar functionality removed
    }

    // Toggle accordion sections
    function toggleAccordion(header) {
      const content = header.nextElementSibling;
      const icon = header.querySelector('.accordion-icon');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(0deg)';
      } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(-90deg)';
      }
    }

    // Clean up extra breaks and empty elements that cause visual separators
    function cleanupExtraBreaks() {
      var editor = document.getElementById('editor');
      if (!editor) return;
      
      var content = editor.innerHTML;
      
      // Remove multiple consecutive BR tags
      content = content.replace(/<br\s*\/?>\s*<br\s*\/?>/g, '<br>');
      
      // Remove BR tags that appear right before H2 elements (causing extra separators)
      content = content.replace(/<br\s*\/?>\s*(<h2)/g, '$1');
      
      // Remove empty divs that might contain only whitespace or BR tags
      content = content.replace(/<div[^>]*>(\s|<br\s*\/?>)*<\/div>/g, '');
      
      // Remove empty paragraphs but PRESERVE those with data-placeholder attribute
      content = content.replace(/<p(?![^>]*data-placeholder)[^>]*>(\s|<br\s*\/?>|&nbsp;)*<\/p>/g, '');
      
      // Update editor content
      editor.innerHTML = content;
    }

    // Get contextual writing prompt for section based on category
    function getWritingPromptForSection(sectionName, category) {
      var prompts = {
        'person': {
          'Early life': 'When and where was this person born? What was their childhood like? What about their education and early influences?',
          'Career': 'What is this person known for professionally? What were their major achievements, works, or contributions?',
          'Background': 'What\'s important to know about this person\'s background? Include birth, education, and early experiences.',
          'Overview': 'What are this person\'s main accomplishments? What makes them notable or significant?'
        },
        'place': {
          'Geography': 'Where exactly is this place located? What are its physical features, climate, and natural characteristics?',
          'History': 'How did this place develop over time? When was it founded or first settled? What major events happened here?',
          'Background': 'What\'s the historical context of this place? How did it come to be what it is today?',
          'Overview': 'What are the key facts about this place? What makes it notable or significant?'
        },
        'species': {
          'Description': 'What does this species look like? What are its distinctive physical features that help identify it?',
          'Habitat': 'Where does this species live? What kind of environment does it need to survive?',
          'Background': 'What\'s the scientific context of this species? How was it discovered or classified?',
          'Overview': 'What are the key characteristics of this species? What makes it unique or important?'
        },
        'organization': {
          'History': 'When and why was this organization founded? Who started it and what were the original goals?',
          'Activities': 'What does this organization actually do? What programs, services, or work does it carry out?',
          'Background': 'What led to the creation of this organization? What problem was it trying to solve?',
          'Overview': 'What are the main things this organization does? What impact does it have?'
        },
        'academic': {
          'Definition': 'What exactly does this concept mean? How would you explain it clearly to someone new to the topic?',
          'Background': 'How did this concept develop? Who were the key people involved in discovering or developing it?',
          'Overview': 'What are the main aspects of this concept? Why is it important in its field?'
        },
        'creative': {
          'Plot': 'What is this work about? Summarize the main story or content without giving away major spoilers.',
          'Production': 'How was this work created? Who made it, when, and what was the creative process like?',
          'Background': 'What inspired this work? What\'s the story behind its creation?',
          'Overview': 'What is this creative work and what makes it significant or notable?'
        },
        'event': {
          'Background': 'What led up to this event? What were the circumstances and causes that made it happen?',
          'Timeline': 'What actually happened during this event? Walk through the key moments in chronological order.',
          'Overview': 'What was this event and why was it important? What were the main outcomes?'
        },
        'other': {
          'Background': 'What\'s the context or history behind this topic? How did it come about or develop?',
          'Overview': 'What are the main aspects or components of this topic? What should readers know about it?'
        }
      };

      // Get category-specific prompts, fallback to 'other' if category not found
      var categoryPrompts = prompts[category] || prompts['other'];
      
      // Return specific prompt for section, or a generic one if not found
      return categoryPrompts[sectionName] || 'Click here to start writing about ' + sectionName.toLowerCase() + '. What should readers know?';
    }

    // Add section to editor
    function addSectionToEditor(sectionName) {
      if (addedSections.indexOf(sectionName) !== -1) return; // Already added
      
      var editor = document.getElementById('editor');
      if (!editor) return;

      // Add section to tracking
      addedSections.push(sectionName);

      // Create Wikipedia-style heading with proper styling
      var currentContent = editor.innerHTML;
      var hasContent = currentContent.trim() !== '';
      
      // Get contextual writing prompt based on section and category
      var writingPrompt = getWritingPromptForSection(sectionName, selectedCategory);
      
      // Create section with Wikipedia-style formatting (no extra breaks)
      var sectionHTML = '';
      sectionHTML += '<h2 id="' + sectionName.replace(/\s+/g, '_') + '" style="';
      sectionHTML += 'font-family: Georgia, serif; ';
      sectionHTML += 'font-size: 1.5em; ';
      sectionHTML += 'font-weight: normal; ';
      sectionHTML += 'margin: ' + (hasContent ? '2em' : '1em') + ' 0 0.25em 0; '; // More top margin if content exists
      sectionHTML += 'padding: 0; ';
      sectionHTML += 'border-bottom: 1px solid #eaecf0; '; // Lighter gray separator
      sectionHTML += 'padding-bottom: 0.25em;';
      sectionHTML += '">' + sectionName + '</h2>';
      sectionHTML += '<p style="margin: 1.1em 0; color: #72777d; font-style: italic;" data-placeholder="' + writingPrompt + '">' + writingPrompt + '</p>';
      
      // Check if References section exists and insert before it
      var referencesMatch = currentContent.match(/<h2[^>]*id="References"[^>]*>/);
      if (referencesMatch && hasContent) {
        var beforeReferences = currentContent.substring(0, referencesMatch.index);
        var referencesAndAfter = currentContent.substring(referencesMatch.index);
        editor.innerHTML = beforeReferences + sectionHTML + referencesAndAfter;
      } else if (hasContent) {
        editor.innerHTML = currentContent + sectionHTML;
      } else {
        editor.innerHTML = sectionHTML;
      }

      // Clean up any extra BR tags or empty divs that might create visual separators
      cleanupExtraBreaks();

      // Position cursor in the newly added section's paragraph
      editor.focus();
      var range = document.createRange();
      var sel = window.getSelection();
      
      // Find the specific paragraph for the newly added section
      var newSectionId = sectionName.replace(/\s+/g, '_');
      var newSection = editor.querySelector('#' + newSectionId);
      var newSectionP = null;
      
      if (newSection) {
        // Find the paragraph immediately after this section heading
        var nextElement = newSection.nextElementSibling;
        while (nextElement && nextElement.tagName.toLowerCase() !== 'p') {
          nextElement = nextElement.nextElementSibling;
        }
        if (nextElement && nextElement.tagName.toLowerCase() === 'p') {
          newSectionP = nextElement;
        }
      }
      
      if (newSectionP) {
        // Set up click handler to clear writing prompt when user clicks to write
        newSectionP.addEventListener('click', function() {
          if (this.style.fontStyle === 'italic' && this.style.color === 'rgb(114, 119, 125)') {
            this.innerHTML = '';
            this.style.color = '';
            this.style.fontStyle = '';
            
            // Position cursor at start
            var range = document.createRange();
            var sel = window.getSelection();
            range.setStart(this, 0);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
          }
        });
        
        range.setStart(newSectionP, 0);
        range.collapse(true);
        sel.removeAllRanges();
        sel.addRange(range);
      }

      // Update content to show new state
      updateGuideContent();
    }

    // Bind click handlers to section buttons
    function bindSectionButtons() {
      var buttons = document.querySelectorAll('.section-button:not(.added)');
      buttons.forEach(function(button) {
        button.addEventListener('click', function(e) {
          var sectionName = this.getAttribute('data-section');
          addSectionToEditor(sectionName);
        });
      });
    }

    // Function to show guide interface (sidebar removed)
    function showGuide() {
      // Sidebar functionality removed
    }

    // Function to hide guide interface (sidebar removed)
    function hideGuide() {
      // Sidebar functionality removed
    }

    // Function to bind article eligibility checker functionality
    function bindEligibilityChecker() {
      const buttons = document.querySelectorAll('.eligibility-btn');
      const resultDiv = document.getElementById('eligibilityResult');
      
      if (buttons.length === 0 || !resultDiv) return;
      
      const answers = {};
      
      buttons.forEach(function(button) {
        button.addEventListener('click', function() {
          const question = this.getAttribute('data-question');
          const answer = this.getAttribute('data-answer');
          
          // Update answer
          answers[question] = answer;
          
          // Update button states
          const questionButtons = document.querySelectorAll(`[data-question="${question}"]`);
          questionButtons.forEach(btn => btn.classList.remove('selected'));
          this.classList.add('selected');
          
          // Check if all questions answered
          if (Object.keys(answers).length === 4) {
            updateEligibilityResult(answers, resultDiv);
          }
        });
      });
      
      function updateEligibilityResult(answers, resultDiv) {
        const yesCount = Object.values(answers).filter(a => a === 'yes').length;
        const maybeCount = Object.values(answers).filter(a => a === 'maybe').length;
        const noCount = Object.values(answers).filter(a => a === 'no').length;
        
        resultDiv.style.display = 'block';
        
        if (yesCount === 4) {
          resultDiv.style.background = '#d5fdf4';
          resultDiv.style.color = '#00af89';
          resultDiv.style.border = '1px solid #00af89';
          resultDiv.innerHTML = '✅ <strong>Excellent!</strong> Your topic looks ready for Wikipedia. You have strong eligibility.';
        } else if (yesCount >= 2 && noCount <= 1) {
          resultDiv.style.background = '#fef6e7';
          resultDiv.style.color = '#ac6600';
          resultDiv.style.border = '1px solid #fc3';
          resultDiv.innerHTML = '⚠️ <strong>Good start!</strong> Consider strengthening the areas you\'re unsure about, or try draft space first.';
        } else {
          resultDiv.style.background = '#fee7e6';
          resultDiv.style.color = '#d33';
          resultDiv.style.border = '1px solid #d33';
          resultDiv.innerHTML = '💡 <strong>More research needed.</strong> Your topic might benefit from finding more sources before creating the article. Consider draft space to build it up.';
        }
      }
    }

    // Desktop Suggestions button
    // Add section button removed

    // Mobile Suggestions button
    // Guide me mobile button removed

    // Sidebar event listeners removed

    // Source verification functionality
    var reliableSourcesData = null;
    var sourceModalBackdrop = document.getElementById('sourceModalBackdrop');
    var sourceUrl = document.getElementById('sourceUrl');
    var checkSourceBtn = document.getElementById('checkSourceBtn');
    var generateDraftBtn = document.getElementById('generateDraftBtn');
    var insertDraftBtn = document.getElementById('insertDraftBtn');
    var closeSourceModal = document.getElementById('closeSourceModal');
    var cancelSource = document.getElementById('cancelSource');
    
    // Load reliable sources data
    async function loadReliableSources() {
      try {
        const response = await fetch((typeof assetUrl==='function'?assetUrl('reliable-sources.json'):'reliable-sources.json'));
        reliableSourcesData = await response.json();
      } catch (error) {
        console.error('Failed to load reliable sources:', error);
        reliableSourcesData = null;
      }
    }
    
    // Open source modal
    function openSourceModal() {
      sourceModalBackdrop.setAttribute('aria-hidden', 'false');
      sourceUrl.focus();
      resetSourceModal();
    }
    
    // Close source modal
    function closeSourceModalDialog() {
      sourceModalBackdrop.setAttribute('aria-hidden', 'true');
      resetSourceModal();
    }
    
    // Reset modal to initial state
    function resetSourceModal() {
      sourceUrl.value = '';
      document.getElementById('sourceVerification').style.display = 'none';
      document.getElementById('draftPreview').style.display = 'none';
      checkSourceBtn.style.display = 'inline-block';
      generateDraftBtn.style.display = 'none';
      insertDraftBtn.style.display = 'none';
    }
    
    // Check source reliability
    function checkSource() {
      var url = sourceUrl.value.trim();
      if (!url) return;
      
      // Show verification section
      document.getElementById('sourceVerification').style.display = 'block';
      checkSourceBtn.style.display = 'none';
      
      // Simulate verification steps
      performVerificationSteps(url);
    }
    
    // Simulate verification animation
    function performVerificationSteps(url) {
      var steps = ['step1', 'step2'];
      var currentStep = 0;
      
      function processStep() {
        if (currentStep < steps.length) {
          var stepElement = document.getElementById(steps[currentStep]);
          var icon = stepElement.querySelector('.step-icon');
          var text = stepElement.querySelector('.step-text');
          
          // Update icon to checkmark and mark as completed
          setTimeout(function() {
            icon.textContent = '✓';
            stepElement.classList.add('completed');
            
            // Update text based on step
            if (currentStep === 0) {
              text.textContent = 'Domain verified: ' + extractDomain(url);
            } else if (currentStep === 1) {
              text.textContent = 'Source reliability checked';
            }
            
            currentStep++;
            if (currentStep < steps.length) {
              setTimeout(processStep, 800);
            } else {
              setTimeout(showSourceResult, 500);
            }
          }, 1000);
        }
      }
      
      processStep();
    }
    
    // Show source verification result
    function showSourceResult() {
      var url = sourceUrl.value.trim();
      var domain = extractDomain(url);
      var sourceType = classifySource(domain);
      
      var resultDiv = document.getElementById('sourceResult');
      var badgeDiv = document.getElementById('sourceBadge');
      var noteDiv = document.getElementById('reliabilityNote');
      
      if (sourceType.reliable) {
        badgeDiv.className = 'source-badge reliable';
        badgeDiv.textContent = '✓ ' + sourceType.label;
        noteDiv.textContent = sourceType.reliability;
      } else {
        badgeDiv.className = 'source-badge questionable';
        badgeDiv.textContent = '⚠️ ' + sourceType.label;
        noteDiv.textContent = sourceType.warning;
      }
      
      resultDiv.style.display = 'block';
      generateDraftBtn.style.display = 'inline-block';
    }
    
    // Extract domain from URL
    function extractDomain(url) {
      try {
        return new URL(url).hostname.replace('www.', '');
      } catch (e) {
        return url.split('/')[0];
      }
    }
    
    // Classify source based on domain
    function classifySource(domain) {
      if (!reliableSourcesData) {
        return {reliable: true, label: 'External source', reliability: 'Source checking available'};
      }
      
      var sources = reliableSourcesData.approved_sources;
      
      // Check each source category
      for (var category in sources) {
        var categoryData = sources[category];
        
        // Check domains
        if (categoryData.domains && categoryData.domains.some(d => domain.includes(d))) {
          return {
            reliable: true,
            label: categoryData.label,
            reliability: categoryData.reliability
          };
        }
        
        // Check suffixes
        if (categoryData.suffixes && categoryData.suffixes.some(s => domain.endsWith(s))) {
          return {
            reliable: true,
            label: categoryData.label,
            reliability: categoryData.reliability
          };
        }
      }
      
      // Check questionable sources
      var questionable = reliableSourcesData.questionable_sources;
      if (questionable.domains && questionable.domains.some(d => domain.includes(d))) {
        return {
          reliable: false,
          label: questionable.label,
          warning: questionable.warning
        };
      }
      
      // Default to external source
      return {
        reliable: true,
        label: 'External source',
        reliability: 'Source information extracted'
      };
    }
    
    // Generate draft content
    function generateDraft() {
      var url = sourceUrl.value.trim();
      var domain = extractDomain(url);
      var sourceType = getSourceTypeForTemplate(domain);
      
      var templates = reliableSourcesData ? reliableSourcesData.draft_templates : null;
      var template = templates && templates[sourceType] ? templates[sourceType] : templates.default;
      
      // Create mock draft content
      var title = generateMockTitle(domain);
      var today = new Date().toLocaleDateString('en-US', {year: 'numeric', month: 'long', day: 'numeric'});
      
      var draftContent = template.stub
        .replace('[SOURCE]', domain.charAt(0).toUpperCase() + domain.slice(1))
        .replace('[TITLE]', title)
        .replace('[DATE]', today)
        .replace('[TOPIC]', 'this subject')
        .replace('[FIELD]', 'relevant field');
        
      var citation = template.citation
        .replace('[AUTHOR]', 'Author Name')
        .replace('[TITLE]', title)
        .replace('[SOURCE]', domain.charAt(0).toUpperCase() + domain.slice(1))
        .replace('[DATE]', today)
        .replace('[TODAY]', today)
        .replace('[URL]', url);
      
      var fullDraft = '== DRAFT: Needs editing ==\n\n' + 
                     draftContent + '\n\n' +
                     '⚠️ This is a draft stub. Please expand with your own analysis and additional sources before publishing.\n\n' +
                     citation;
      
      document.getElementById('draftContent').textContent = fullDraft;
      document.getElementById('draftPreview').style.display = 'block';
      generateDraftBtn.style.display = 'none';
      insertDraftBtn.style.display = 'inline-block';
    }
    
    // Generate mock title based on domain
    function generateMockTitle(domain) {
      var titles = [
        'Recent Developments in Subject Area',
        'Analysis of Current Topic',
        'Overview of Related Field',
        'Background Information on Subject',
        'Context and Development'
      ];
      return titles[Math.floor(Math.random() * titles.length)];
    }
    
    // Get source type for template
    function getSourceTypeForTemplate(domain) {
      if (!reliableSourcesData) return 'default';
      
      var sources = reliableSourcesData.approved_sources;
      for (var category in sources) {
        var categoryData = sources[category];
        if (categoryData.domains && categoryData.domains.some(d => domain.includes(d))) {
          return category;
        }
        if (categoryData.suffixes && categoryData.suffixes.some(s => domain.endsWith(s))) {
          return category;
        }
      }
      return 'default';
    }
    
    // Insert draft into editor
    function insertDraft() {
      try {
        var draftText = document.getElementById('draftContent').textContent;
        // Reuse structured insertion path to match section styling
        if (typeof insertSidebarDraft === 'function') {
          insertSidebarDraft(draftText);
        } else {
          // Fallback: simple paragraph insertion if helper is unavailable
          var editor = document.getElementById('editor');
          if (editor) {
            var paras = draftText.split(/\n\s*\n/).map(function(p){ return '<p>'+escapeHtml(p).replace(/\n/g,'<br>')+'</p>'; }).join('');
            editor.insertAdjacentHTML('beforeend', paras);
            editor.focus();
          }
        }
        try { enablePublishUI(); } catch(_) {}
        try { hideIntroHelp(); } catch(_) {}
      } catch(_) {}
      closeSourceModalDialog();
    }

    // Bind source button click handlers for sidebar
    function bindSourceButton() {
      var checkBtn = document.getElementById('sidebarCheckBtn');
      if (checkBtn) {
        checkBtn.addEventListener('click', function() {
          checkSidebarSource();
        });
      }
    }

    // Check source in sidebar
    function checkSidebarSource() {
      var sourceUrl = document.getElementById('sidebarSourceUrl');
      var checkBtn = document.getElementById('sidebarCheckBtn');
      
      if (!sourceUrl || !sourceUrl.value.trim()) {
        return;
      }
      
      // Disable button and show loading
      checkBtn.disabled = true;
      checkBtn.textContent = 'Checking...';
      
      // Show verification steps
      performSidebarVerificationSteps(sourceUrl.value.trim());
    }

    // Perform verification steps in sidebar
    function performSidebarVerificationSteps(url) {
      var stepsDiv = document.getElementById('sidebarVerificationSteps');
      var steps = [
        'Checking domain...',
        'Verifying source reliability...'
      ];
      
      var stepsHTML = '';
      steps.forEach(function(step, index) {
        stepsHTML += '<div class="sidebar-verification-step" id="sidebarStep' + index + '">';
        stepsHTML += '<div class="sidebar-step-icon" id="sidebarStepIcon' + index + '">' + (index + 1) + '</div>';
        stepsHTML += '<span class="sidebar-step-text" id="sidebarStepText' + index + '">' + step + '</span>';
        stepsHTML += '</div>';
      });
      
      stepsDiv.innerHTML = stepsHTML;
      stepsDiv.style.display = 'block';
      
      var currentStep = 0;
      
      function processStep() {
        if (currentStep < steps.length) {
          var stepElement = document.getElementById('sidebarStep' + currentStep);
          var icon = document.getElementById('sidebarStepIcon' + currentStep);
          var text = document.getElementById('sidebarStepText' + currentStep);
          
          // Mark current step as active
          icon.classList.add('active');
          
          // Update icon to checkmark and mark as completed
          setTimeout(function() {
            icon.textContent = '✓';
            icon.classList.remove('active');
            icon.classList.add('completed');
            
            // Update text based on step
            if (currentStep === 0) {
              text.textContent = 'Domain verified: ' + extractDomain(url);
            } else if (currentStep === 1) {
              text.textContent = 'Source reliability checked';
            }
            
            currentStep++;
            if (currentStep < steps.length) {
              setTimeout(processStep, 800);
            } else {
              setTimeout(showSidebarSourceResult, 500);
            }
          }, 1000);
        }
      }
      
      processStep();
    }

    // Show source verification result in sidebar
    function showSidebarSourceResult() {
      var sourceUrl = document.getElementById('sidebarSourceUrl');
      var checkBtn = document.getElementById('sidebarCheckBtn');
      var resultDiv = document.getElementById('sidebarSourceResult');
      
      var url = sourceUrl.value.trim();
      var domain = extractDomain(url);
      var sourceType = classifySource(domain);
      
      var resultHTML = '';
      if (sourceType.reliable) {
        resultHTML += '<div class="sidebar-source-badge reliable">✓ ' + sourceType.label + '</div>';
        resultHTML += '<p style="font-size: 12px; color: #72777d; margin: 0 0 8px 0;">' + sourceType.reliability + '</p>';
      } else {
        resultHTML += '<div class="sidebar-source-badge questionable">⚠️ ' + sourceType.label + '</div>';
        resultHTML += '<p style="font-size: 12px; color: #72777d; margin: 0 0 8px 0;">' + sourceType.warning + '</p>';
      }
      
      resultHTML += '<div class="sidebar-action-buttons">';
      resultHTML += '<button class="sidebar-action-btn primary" id="sidebarGenerateBtn">Generate draft</button>';
      resultHTML += '</div>';
      
      resultDiv.innerHTML = resultHTML;
      resultDiv.style.display = 'block';
      
      // Re-enable check button
      checkBtn.disabled = false;
      checkBtn.textContent = 'Check source';
      
      // Bind generate button
      var generateBtn = document.getElementById('sidebarGenerateBtn');
      if (generateBtn) {
        generateBtn.addEventListener('click', function() {
          generateSidebarDraft(url);
        });
      }
    }

    // Generate draft in sidebar
    function generateSidebarDraft(url) {
      var domain = extractDomain(url);
      var sourceType = getSourceTypeForTemplate(domain);
      
      var templates = reliableSourcesData ? reliableSourcesData.draft_templates : null;
      var template = templates && templates[sourceType] ? templates[sourceType] : templates.default;
      
      // Create mock draft content
      var title = generateMockTitle(domain);
      var today = new Date().toLocaleDateString('en-US', {year: 'numeric', month: 'long', day: 'numeric'});
      
      var draftContent = template.stub
        .replace('[SOURCE]', domain.charAt(0).toUpperCase() + domain.slice(1))
        .replace('[TITLE]', title)
        .replace('[DATE]', today)
        .replace('[TOPIC]', 'this subject')
        .replace('[FIELD]', 'relevant field');
        
      var citation = template.citation
        .replace('[AUTHOR]', 'Author Name')
        .replace('[TITLE]', title)
        .replace('[SOURCE]', domain.charAt(0).toUpperCase() + domain.slice(1))
        .replace('[DATE]', today)
        .replace('[TODAY]', today)
        .replace('[URL]', url);
      
      var fullDraft = '== DRAFT: Needs editing ==\n\n' + 
                     draftContent + '\n\n' +
                     '⚠️ This is a draft stub. Please expand with your own analysis and additional sources before publishing.\n\n' +
                     citation;
      
      var previewDiv = document.getElementById('sidebarDraftPreview');
      var previewHTML = '';
      previewHTML += '<div class="sidebar-draft-content">' + fullDraft + '</div>';
      previewHTML += '<div class="sidebar-action-buttons">';
      previewHTML += '<button class="sidebar-action-btn primary" id="sidebarInsertBtn">Insert into article</button>';
      previewHTML += '<button class="sidebar-action-btn" id="sidebarCancelBtn">Cancel</button>';
      previewHTML += '</div>';
      
      previewDiv.innerHTML = previewHTML;
      previewDiv.style.display = 'block';
      
      // Bind action buttons
      var insertBtn = document.getElementById('sidebarInsertBtn');
      var cancelBtn = document.getElementById('sidebarCancelBtn');
      
      if (insertBtn) {
        insertBtn.addEventListener('click', function() {
          insertSidebarDraft(fullDraft);
        });
      }
      
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
          resetSidebarSource();
        });
      }
    }

    // Insert draft from sidebar into editor
    function insertSidebarDraft(draftText) {
      var editor = document.getElementById('editor');
      
      if (editor) {
        var currentContent = editor.innerHTML;
        var hasContent = currentContent.trim() !== '';
        
        // Determine domain from sidebar or modal input gracefully
        var urlInput = document.getElementById('sidebarSourceUrl') || document.getElementById('sourceUrl');
        var domain = extractDomain(urlInput && urlInput.value ? urlInput.value : '');
        var sourceType = classifySource(domain);
        var sectionTitle = 'Section title';
        
        // Create realistic Wikipedia content with references
        var content = 'This is where the content from the verified source would appear in the article. ';
        content += 'The information extracted from ' + domain + ' provides additional context and details that support the main article topic.<sup style="color: #0645ad;">[1]</sup> ';
        content += 'Key facts and data points from the source can be integrated here to enhance the encyclopedic coverage. ';
        content += 'This demonstrates how external sources contribute to comprehensive article development.<sup style="color: #0645ad;">[2]</sup>';
        
        // Get citation from original draft
        var lines = draftText.split('\n');
        var citation = '';
        for (var i = 0; i < lines.length; i++) {
          var line = lines[i].trim();
          if (line.startsWith('[1]')) {
            citation = line;
            break;
          }
        }
        
        // Create Wikipedia-style section with proper formatting
        var sectionHTML = '';
        sectionHTML += '<h2 id="Section_title" style="';
        sectionHTML += 'font-family: Georgia, serif; ';
        sectionHTML += 'font-size: 1.5em; ';
        sectionHTML += 'font-weight: normal; ';
        sectionHTML += 'margin: ' + (hasContent ? '2em' : '1em') + ' 0 0.25em 0; ';
        sectionHTML += 'padding: 0; ';
        sectionHTML += 'border-bottom: 1px solid #eaecf0; ';
        sectionHTML += 'padding-bottom: 0.25em;';
        sectionHTML += '">' + sectionTitle + '</h2>';
        
        // Add content paragraph with proper styling
        sectionHTML += '<p>' + content + '</p>';
        
        // Add minimal draft notice (non-editable)
        sectionHTML += '<p class="source-notice" contenteditable="false" style="margin: 0.5em 0; font-size: 0.85em; color: #a2a9b1; font-style: italic; user-select: none;">Section added using source • Expand with additional content</p>';
        
        // Check if References section already exists
        var referencesExists = currentContent.includes('<h2') && currentContent.includes('id="References"');
        
        if (!referencesExists) {
          // Add non-editable References section (wrapped)
          sectionHTML += '<div class="references-block" contenteditable="false">';
          sectionHTML += '<h2 id="References" style="';
          sectionHTML += 'font-family: Georgia, serif; ';
          sectionHTML += 'font-size: 1.5em; ';
          sectionHTML += 'font-weight: normal; ';
          sectionHTML += 'margin: 2em 0 0.25em 0; ';
          sectionHTML += 'padding: 0; ';
          sectionHTML += 'border-bottom: 1px solid #eaecf0; ';
          sectionHTML += 'padding-bottom: 0.25em;';
          sectionHTML += '">References</h2>';
          // Citation content
          sectionHTML += '<div style="margin: 0.75em 0; font-size: 0.9em;">';
          if (citation) {
            sectionHTML += '<p style="margin: 0.25em 0;">1. ' + citation.substring(4) + '</p>';
            sectionHTML += '<p style="margin: 0.25em 0;">2. Additional sources to be added...</p>';
          } else {
            sectionHTML += '<p style="margin: 0.25em 0;">1. "Context and Development". ' + domain.charAt(0).toUpperCase() + domain.slice(1) + '. Retrieved ' + new Date().toLocaleDateString('en-US', {year: 'numeric', month: 'long', day: 'numeric'}) + '.</p>';
            sectionHTML += '<p style="margin: 0.25em 0;">2. Additional sources to be added...</p>';
          }
          sectionHTML += '</div>';
          sectionHTML += '</div>';
        }
        
      if (hasContent) {
        editor.innerHTML = currentContent + sectionHTML;
      } else {
        editor.innerHTML = sectionHTML;
      }

      // Clean up any extra BR tags or empty elements
      cleanupExtraBreaks();

      // Add event listener to hide source notice when user starts editing
      addSourceNoticeHideListener();

      // Ensure publish becomes available even without typing
      try { enablePublishUI(); } catch(_) {}
      // Hide the one-time intro help once another section is added
      try { hideIntroHelp(); } catch(_) {}

      editor.focus();
      }
      
      // Reset source area
      resetSidebarSource();
    }

    // Add event listener to hide source notice when user starts editing content
    function addSourceNoticeHideListener() {
      var editor = document.getElementById('editor');
      if (!editor) return;
      
      // Simple approach: hide source notices after any meaningful editing
      var inputCount = 0;
      var hideNoticesOnEdit = function(event) {
        inputCount++;
        
        // Hide notices after 3 input events (typing 3 characters)
        if (inputCount >= 3) {
          var sourceNotices = editor.querySelectorAll('.source-notice');
          sourceNotices.forEach(function(notice) {
            if (notice && notice.parentNode) {
              notice.style.transition = 'opacity 0.3s ease';
              notice.style.opacity = '0';
              setTimeout(function() {
                if (notice.parentNode) {
                  notice.parentNode.removeChild(notice);
                }
              }, 300);
            }
          });
          
          // Remove the listener after hiding
          editor.removeEventListener('input', hideNoticesOnEdit);
        }
      };
      
      // Add the global listener with a small delay to ensure DOM is ready
      setTimeout(function() {
        editor.addEventListener('input', hideNoticesOnEdit);
      }, 100);
    }

    // Reset sidebar source verification
    function resetSidebarSource() {
      var sourceUrl = document.getElementById('sidebarSourceUrl');
      var stepsDiv = document.getElementById('sidebarVerificationSteps');
      var resultDiv = document.getElementById('sidebarSourceResult');
      var previewDiv = document.getElementById('sidebarDraftPreview');
      
      if (sourceUrl) sourceUrl.value = '';
      if (stepsDiv) stepsDiv.style.display = 'none';
      if (resultDiv) resultDiv.style.display = 'none';
      if (previewDiv) previewDiv.style.display = 'none';
    }

    // Open source verification modal
    function openSourceModalDialog() {
      var backdrop = document.getElementById('sourceModalBackdrop');
      var sourceUrl = document.getElementById('sourceUrl');
      var checkBtn = document.getElementById('checkSourceBtn');
      var generateBtn = document.getElementById('generateDraftBtn');
      var insertBtn = document.getElementById('insertDraftBtn');
      var stepsDiv = document.getElementById('verificationSteps');
      var resultDiv = document.getElementById('sourceResult');
      var previewDiv = document.getElementById('draftPreview');
      
      // Reset modal state
      if (sourceUrl) sourceUrl.value = '';
      if (checkBtn) checkBtn.style.display = 'inline-block';
      if (generateBtn) generateBtn.style.display = 'none';
      if (insertBtn) insertBtn.style.display = 'none';
      if (stepsDiv) stepsDiv.style.display = 'none';
      if (resultDiv) resultDiv.style.display = 'none';
      if (previewDiv) previewDiv.style.display = 'none';
      
      backdrop.classList.add('open');
      backdrop.setAttribute('aria-hidden', 'false');
      
      // Focus on URL input
      setTimeout(function() {
        if (sourceUrl) sourceUrl.focus();
      }, 100);
    }

    // Close source verification modal
    function closeSourceModalDialog() {
      var backdrop = document.getElementById('sourceModalBackdrop');
      backdrop.classList.remove('open');
      backdrop.setAttribute('aria-hidden', 'true');
    }

    // Initialize source modal event handlers
    function initializeSourceModal() {
      var closeBtn = document.getElementById('closeSourceModal');
      var backdrop = document.getElementById('sourceModalBackdrop');
      var checkBtn = document.getElementById('checkSourceBtn');
      var generateBtn = document.getElementById('generateDraftBtn');
      var insertBtn = document.getElementById('insertDraftBtn');
      var cancelBtn = document.getElementById('cancelSource');
      
      // Close button
      if (closeBtn) {
        closeBtn.addEventListener('click', closeSourceModalDialog);
      }
      // Cancel button
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function(e){ e.preventDefault(); closeSourceModalDialog(); });
      }
      
      // Backdrop click to close
      if (backdrop) {
        backdrop.addEventListener('click', function(e) {
          if (e.target === backdrop) {
            closeSourceModalDialog();
          }
        });
      }
      
      // Escape key to close
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && backdrop && backdrop.classList.contains('open')) {
          closeSourceModalDialog();
        }
      });
      
      // Check source button
      if (checkBtn) {
        checkBtn.addEventListener('click', checkSource);
      }
      
      // Generate draft button
      if (generateBtn) {
        generateBtn.addEventListener('click', generateDraft);
      }
      
      // Insert draft button
      if (insertBtn) {
        insertBtn.addEventListener('click', insertDraft);
      }
    }

    // Bring back Suggestions via toolbar buttons
    (function bindSuggestionsToolbar(){
      function openInlineSuggestionsFromToolbar() {
        function isVisible(el){
          try {
            if (!el) return false;
            if (el.style && el.style.display === 'none') return false;
            const r = el.getBoundingClientRect();
            return (r.width > 0 || r.height > 0);
          } catch(_) { return false; }
        }
        try {
          var editor = document.getElementById('editor');
          if (!editor) return;
          // Toggle behavior: if a suggestion menu is already open, close it
          var chipMenu = document.getElementById('chipSuggestMenu');
          if (chipMenu && chipMenu.style.display !== 'none') {
            chipMenu.style.display = 'none';
            return;
          }
          // If assist menu is open, close it and return (true toggle)
          try {
            if (typeof isAssistMenuOpen === 'function' && isAssistMenuOpen()) {
              if (typeof hideSuggestionsChip === 'function') hideSuggestionsChip();
              return;
            }
          } catch(_) {}
          // 1) If a template placeholder is focused or selection is inside one, open chip inline menu
          var active = document.activeElement;
          var focusedPh = (active && active.classList && active.classList.contains('template-placeholder')) ? active : null;
          if (!focusedPh) {
            try {
              var sel = window.getSelection();
              if (sel && sel.rangeCount) {
                var node = sel.getRangeAt(0).startContainer;
                if (node && node.nodeType === Node.TEXT_NODE) node = node.parentElement;
                if (node && node.closest) focusedPh = node.closest('.template-placeholder');
              }
            } catch(_) {}
          }
          if (focusedPh && typeof showChipSuggestMenu === 'function') {
            showChipSuggestMenu(focusedPh);
            return;
          }
          // 2) Otherwise, prefer the inline Suggestions panel at caret (slash-style)
          if (typeof window.showSlashSuggestions === 'function') {
            window.showSlashSuggestions();
            try { window.__assistMenuOpen = true; } catch(_) {}
            return;
          }
          // 3) Fallback to toggling the floating Suggestions chip
          if (typeof toggleSuggestionsChip === 'function') toggleSuggestionsChip();
        } catch(_) {
          // Final fallback
          if (typeof toggleSuggestionsChip === 'function') toggleSuggestionsChip();
        }
      }

      var desktopBtn = document.getElementById('addSectionBtn');
      if (desktopBtn) {
        try { desktopBtn.title = 'Suggestions (press /)'; desktopBtn.setAttribute('aria-keyshortcuts','/'); } catch(_) {}
        // Prevent focus/selection churn that can trigger re-anchoring side effects
        desktopBtn.addEventListener('mousedown', function(e){ e.preventDefault(); e.stopPropagation(); });
        desktopBtn.addEventListener('click', function(e){
          e.preventDefault();
          e.stopPropagation();
          openInlineSuggestionsFromToolbar();
        });
      }
      var srcBtn = document.getElementById('openSourceBtn');
      if (srcBtn) {
        srcBtn.addEventListener('click', function(e){
          e.preventDefault();
          try { if (typeof openSourceModalDialog === 'function') openSourceModalDialog(); else openReferenceDialog(); } catch(_) { openReferenceDialog(); }
        });
      }
      var mobileBtn = document.getElementById('guideMeMobile');
      if (mobileBtn) {
        mobileBtn.addEventListener('click', function(e){
          e.preventDefault();
          openInlineSuggestionsFromToolbar();
        });
      }
    })();

    // Perf/stability feature flag (no UX change). Flip to false to disable.
    window.perfTweaks = (typeof window.perfTweaks === 'boolean') ? window.perfTweaks : true;
    window.__debugPerf = false;
    // UI state: whether to expand all suggested sections inline in main menu
    window.__showAllSectionsInMainMenu = false;

    // Global guard to avoid race conditions during insertion
    var __insertingContent = false;

    // Debounced scheduler to (re)position assist chip/menu once per frame
    var __scheduleId = null;
    function __schedule(fn) {
      try {
        if (!window.perfTweaks) return fn();
        if (__scheduleId) cancelAnimationFrame(__scheduleId);
        __scheduleId = requestAnimationFrame(function(){
          __scheduleId = null;
          try { fn(); } catch(_) {}
        });
      } catch(_) { try { fn(); } catch(__) {} }
    }

    // Local cache hydration for templates.json (instant availability)
    (function hydrateTemplatesFromCache(){
      try {
        if (!window.perfTweaks) return;
        var V = 'v1';
        var key = 'templates.json::' + V;
        var cached = localStorage.getItem(key);
        if (cached && !window.templatesData) {
          try { window.templatesData = JSON.parse(cached); } catch(_) {}
        }
        // After network load, refresh cache in background
        var _oldLoad = (typeof loadTemplates === 'function') ? loadTemplates : null;
        if (_oldLoad && !_oldLoad.__wrapped) {
          var wrapped = function(){
            return _oldLoad().then(function(data){
              try { if (data) localStorage.setItem(key, JSON.stringify(data)); } catch(_) {}
              return data;
            });
          };
          wrapped.__wrapped = true;
          window.loadTemplates = wrapped;
        }
      } catch(_) {}
    })();

    // Load advanced intro templates (read-only)
    function loadTemplates() {
      // Cache templates.json after first load for better performance
      if (window.templatesData !== undefined) {
        return Promise.resolve(window.templatesData);
      }
      return fetch((typeof assetUrl==='function'?assetUrl('templates.json'):'templates.json'))
        .then(function(r){ return r.json(); })
        .then(function(data){ window.templatesData = data; return data; })
        .catch(function(err){ window.templatesData = null; console && console.warn && console.warn('Failed to load templates.json', err); return null; });
    }

    // Initialize suggestions and sources on page load
    Promise.all([loadSuggestions(), loadReliableSources(), loadTemplates()]).then(function() {
      updateGuideContent();
      initializeSourceModal();
      initializeInsertMenu();
    });

    // Generic mousedown suppression on insert triggers to avoid selection churn
    document.addEventListener('mousedown', function(e){
      try {
        if (!window.perfTweaks) return;
        var t = e.target && e.target.closest ? e.target.closest('[data-insert-intro-template],[data-insert-section],.template-option,[data-insert-intro],[data-insert-chip-starter],[data-view-all-sections],[data-view-less-sections]') : null;
        if (t) { e.preventDefault(); }
      } catch(_) {}
    }, true);

    // Basic handlers for the Insert dropdown (image/table/special char)
    function initializeInsertMenu() {
      var menu = document.getElementById('menu-insert');
      if (!menu) return;

      function ensureEditorFocus() {
        try { var ed = document.getElementById('editor'); if (ed) ed.focus(); } catch(_) {}
      }

      menu.querySelectorAll('[data-insert]').forEach(function(btn){
        btn.addEventListener('click', function(e){
          e.preventDefault();
          var editor = document.getElementById('editor');
          var kind = this.getAttribute('data-insert');
          // Make sure we are in the editor before inserting
          if (editor) ensureSelectionInEditor(editor);
          switch(kind) {
            case 'image': {
              var url = prompt('Image URL');
              if (!url) return;
              var html = '<p><img src="'+ url.replace(/"/g,'&quot;') +'" alt="" style="max-width:100%; height:auto;"/></p>';
              insertHTMLAtCursor(html, editor);
              ensureEditorFocus();
              break;
            }
            case 'table': {
              var html = ''+
                '<table style="border-collapse:collapse; width:100%; max-width:100%; margin:8px 0;">'+
                  '<tbody>'+[
                    '<tr><td style="border:1px solid #c8ccd1; padding:6px;">Cell</td><td style="border:1px solid #c8ccd1; padding:6px;">Cell</td></tr>',
                    '<tr><td style="border:1px solid #c8ccd1; padding:6px;">Cell</td><td style="border:1px solid #c8ccd1; padding:6px;">Cell</td></tr>'
                  ].join('') + '</tbody>'+
                '</table>';
              insertHTMLAtCursor(html, editor);
              ensureEditorFocus();
              break;
            }
            case 'char': {
              var ch = prompt('Enter a special character to insert');
              if (!ch) return;
              insertHTMLAtCursor(ch, editor);
              ensureEditorFocus();
              break;
            }
            case 'template':
            case 'math':
            default: {
              alert('This insert is mocked in the demo.');
              break;
            }
          }
        });
      });
    }

    // Smart Chips functionality
    let smartChipsContainer, templatePopup, currentCursorPosition;

    function initializeSmartChips() {
      if (window.__smartChipsInitialized) return; // prevent double-binding if block included twice
      window.__smartChipsInitialized = true;
      smartChipsContainer = document.getElementById('smartChips');
      templatePopup = document.getElementById('templatePopup');
      
      // Disabled in simplified concept

      // Show chips when editor is focused and empty or cursor is at new line
      const editor = document.getElementById('editor');
      editor.addEventListener('keyup', handleEditorKeyup);
      editor.addEventListener('click', handleEditorClick);
      // Prevent caret from entering placeholders/ref chips; open menu/dialog instead
      editor.addEventListener('mousedown', function(e){
        var t = e.target;
        if (t && t.classList && (t.classList.contains('template-placeholder') || t.classList.contains('ref-chip') || t.classList.contains('chip-value'))) {
          e.preventDefault();
        }
      });
      editor.addEventListener('click', function(e){
        var t = e.target;
        if (t && t.classList && t.classList.contains('template-placeholder')) {
          e.preventDefault(); e.stopPropagation();
          try { showChipSuggestMenu(t); } catch(_) {}
          try {
            var blk = t.closest('p, h1, h2, h3, h4, h5, h6, li, blockquote');
            if (blk) { lastAnchorEl = blk; if (typeof positionChipBelowElement === 'function') positionChipBelowElement(blk); }
          } catch(_) {}
          return;
        }
        if (t && t.classList && t.classList.contains('chip-value')) {
          e.preventDefault(); e.stopPropagation();
          try { showChipSuggestMenu(t); } catch(_) {}
          try {
            var blk = t.closest('p, h1, h2, h3, h4, h5, h6, li, blockquote');
            if (blk) { lastAnchorEl = blk; if (typeof positionChipBelowElement === 'function') positionChipBelowElement(blk); }
          } catch(_) {}
          return;
        }
        if (t && t.classList && t.classList.contains('ref-chip')) {
          e.preventDefault(); e.stopPropagation();
          try { if (typeof openSourceModalDialog === 'function') openSourceModalDialog(); else openReferenceDialog(); } catch(_) { openReferenceDialog(); }
          try {
            var blk = t.closest('p, h1, h2, h3, h4, h5, h6, li, blockquote');
            if (blk) { lastAnchorEl = blk; if (typeof positionChipBelowElement === 'function') positionChipBelowElement(blk); }
          } catch(_) {}
          return;
        }
      });

      // Keyboard navigation across chips
      editor.addEventListener('keydown', function(e){
        if (e.key === 'Tab') {
          var chips = Array.from(editor.querySelectorAll('.template-placeholder, .chip-value'));
          if (!chips.length) return;
          var active = document.activeElement;
          var idx = chips.indexOf(active);
          var forward = !e.shiftKey;
          var nextIdx = -1;
          if (idx === -1) nextIdx = forward ? 0 : chips.length - 1;
          else nextIdx = (idx + (forward ? 1 : -1) + chips.length) % chips.length;
          e.preventDefault();
          try { chips[nextIdx].focus(); } catch(_) {}
        }
      });
      // Also show chips when the editor gains focus and conditions match
      editor.addEventListener('focus', function(){
        setTimeout(function(){
          if (shouldShowSmartChips()) {
            showSmartChipsAtCursor();
          }
        }, 0);
      });
      
      // Hide popups when clicking outside chips, popup, editor, and assistance menu
      document.addEventListener('click', function(e) {
        // Respect UI atomic operations; do not auto-hide mid‑insert
        if (window.__uiAtomic && window.__uiAtomic > 0) return;
        if (window.__suppressAssistMenuHide) return;
        var inChips = !!e.target.closest('.smart-chips-container');
        var inPopup = !!e.target.closest('.template-popup');
        var inEditor = !!e.target.closest('#editor');
        var inAssist = !!e.target.closest('#assistChip') || !!e.target.closest('#assistMenu');
        if (!inChips && !inPopup && !inEditor && !inAssist) {
          hideTemplatePopup();
          hideSmartChips();
          var m = document.getElementById('assistMenu'); if (m) m.style.display = 'none';
        }
      });
    }

    // Assistance chip (simple inline menu)
    var suppressChipPositioning = false;
    function initializeAssistanceUI() {
      if (window.__assistUIInitialized) return; // prevent double-binding from duplicate blocks
      window.__assistUIInitialized = true;
      const chip = document.getElementById('assistChip');
      const menu = document.getElementById('assistMenu');
      if (!chip || !menu) return;
      const editor = document.getElementById('editor');
      // Advertise keyboard shortcut for a11y
      try { editor.setAttribute('aria-keyshortcuts','/'); editor.setAttribute('aria-label', (editor.getAttribute('aria-label')||'Editor') + '. Press slash for suggestions.'); } catch(_) {}
      const CHIP_ANCHOR_MODE = 'block'; // 'block' anchors to current paragraph, reducing jitter vs caret
      let rafId = null;
      let frozen = false; // freeze while menu open
      let lastAnchorEl = null; // remember last anchor paragraph for stable re-show

      // Atomic UI helpers to stabilize operations (e.g., inserting sections)
      window.__uiAtomic = window.__uiAtomic || 0;
      function beginAtomic(){ try { window.__uiAtomic = (window.__uiAtomic||0) + 1; } catch(_) {} }
      function endAtomic(){ try { window.__uiAtomic = Math.max(0, (window.__uiAtomic||0) - 1); } catch(_) {} }

      // Setup DOM mutation observer to detect content changes
      setupMutationObserver();

      function setupMutationObserver() {
        if (!editor) return;

        const observer = new MutationObserver(function(mutations) {
          let hasStructuralChanges = false;

          mutations.forEach(function(mutation) {
            // Check for added nodes that are block elements
            if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
              Array.from(mutation.addedNodes).forEach(function(node) {
                if (node.nodeType === Node.ELEMENT_NODE &&
                    ['P', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'LI', 'BLOCKQUOTE'].includes(node.tagName) &&
                    node.textContent.trim().length > 0) {
                  hasStructuralChanges = true;
                }
              });
            }

            // Check for text content changes in existing blocks
            if (mutation.type === 'characterData' && mutation.target.parentElement) {
              const parent = mutation.target.parentElement;
              if (['P', 'H1', 'H2', 'H3', 'H4', 'H5', 'H6', 'LI', 'BLOCKQUOTE'].includes(parent.tagName)) {
                hasStructuralChanges = true;
              }
            }
          });

          // Re-anchor chip after structural changes
          if (hasStructuralChanges) {
            setTimeout(function() {
              if (!frozen) {
                reanchorAssistChip();
              }
            }, 50); // Small delay for DOM stabilization
          }
        });

        observer.observe(editor, {
          childList: true,
          subtree: true,
          characterData: true
        });
      }
      
      // Helper: restore placeholder when editor is empty of user content
      window.restorePlaceholderIfEmpty = function restorePlaceholderIfEmpty() {
        try {
          const ed = document.getElementById('editor');
          if (!ed) return;
          
          // Check if editor has any meaningful content (excluding assist chips and empty paragraphs)
          const blocks = Array.from(ed.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, blockquote'));
          const hasNonEmpty = blocks.some(function(b){ 
            // Filter out assist chip, placeholders, assist menu content, and empty/whitespace-only content
            if (b.id === 'assistChip' || b.id === 'leadPlaceholder' || b.classList.contains('lead-placeholder')) return false;
            if (b.classList.contains('assist-list-item') || b.closest('#assistMenu')) return false;
            const text = (b.textContent || '').trim();
            // Ignore single characters that might be artifacts (like leftover "/")
            if (text.length <= 1 && (text === '/' || text === '' || /^\s*$/.test(text))) return false;
            return text.length > 0; 
          });
          
          // If no blocks exist at all (just assist UI), we definitely need to restore placeholder
          const hasContentBlocks = blocks.some(function(b){ 
            return b.id !== 'assistChip' && 
                   !b.classList.contains('assist-menu') && 
                   !b.classList.contains('assist-list-item') &&
                   !b.classList.contains('lead-placeholder') &&
                   !b.closest('#assistMenu'); // Exclude anything inside assist menu
          });
          
          if (hasNonEmpty) {
            // Remove existing placeholder if content exists
            const existingPlaceholder = document.getElementById('leadPlaceholder');
            if (existingPlaceholder) {
              existingPlaceholder.remove();
            }
            return;
          }
          
          // If no content blocks exist at all (editor only has assist UI), force placeholder creation
          if (!hasContentBlocks) {
            const existingPlaceholder = document.getElementById('leadPlaceholder');
            if (existingPlaceholder) existingPlaceholder.remove();
            
            const title = (window.articleTitleText || 'Untitled');
            const placeholderHTML = (function(){ var __t = (typeof window.__i18nGet === 'function') ? window.__i18nGet : function(k,p,f){ return f || k; }; return __t('editor.leadPlaceholder', { topic: title.replace(/</g,'&lt;').replace(/>/g,'&gt;') }, 'Start writing about {topic} or <strong>Press "/" for suggestions</strong>.'); })();
            
            // Force create at beginning, even if assist elements exist
            ed.insertAdjacentHTML('afterbegin', '<p id="leadPlaceholder" class="lead-placeholder" style="margin: 1.1em 0 2.25em 0; color: #72777d; font-style: italic;">'+placeholderHTML+'</p>');
            
            // Set cursor to beginning of placeholder
            setTimeout(function() {
              const placeholder = document.getElementById('leadPlaceholder');
              if (placeholder) {
                const range = document.createRange();
                const sel = window.getSelection();
                range.selectNodeContents(placeholder);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
              }
            }, 0);
            return;
          }
          
          // Restore placeholder if no content exists
          let lp = document.getElementById('leadPlaceholder');
          const title = (window.articleTitleText || 'Untitled');
          const placeholderHTML = (function(){ var __t = (typeof window.__i18nGet === 'function') ? window.__i18nGet : function(k,p,f){ return f || k; }; return __t('editor.leadPlaceholder', { topic: title.replace(/</g,'&lt;').replace(/>/g,'&gt;') }, 'Start writing about {topic} or <strong>Press "/" for suggestions</strong>.'); })();
          
          if (lp) {
            // Update existing placeholder content if it's empty or cleared
            if (!lp.textContent.trim()) {
              lp.innerHTML = placeholderHTML;
              lp.style.color = '#72777d';
              lp.style.fontStyle = 'italic';
            }
            return; // Already properly set
          }
          
          // Create fresh placeholder at the beginning
          ed.insertAdjacentHTML('afterbegin', '<p id="leadPlaceholder" class="lead-placeholder" style="margin: 1.1em 0 2.25em 0; color: #72777d; font-style: italic;">'+placeholderHTML+'</p>');
          
          // Set cursor to beginning of placeholder
          setTimeout(function() {
            const placeholder = document.getElementById('leadPlaceholder');
            if (placeholder) {
              const range = document.createRange();
              const sel = window.getSelection();
              range.selectNodeContents(placeholder);
              range.collapse(true);
              sel.removeAllRanges();
              sel.addRange(range);
            }
          }, 0);
        } catch(_) {}
      }

      // Menu state helpers
      function isAssistMenuOpen(){
        try {
          var m = document.getElementById('assistMenu');
          if (!m) return false;
          if (window.__assistMenuOpen === true) return true;
          if (m.style && m.style.display === 'none') return false;
          var r = m.getBoundingClientRect();
          return (r.width > 0 || r.height > 0);
        } catch(_) { return false; }
      }
      function closeAssistMenu(){
        try {
          var m = document.getElementById('assistMenu');
          if (!m) return false;
          m.style.display = 'none';
          window.__assistMenuOpen = false;
          frozen = false;
          schedulePosition();
          window.restorePlaceholderIfEmpty();
          return true;
        } catch(_) { return false; }
      }

      // Helpers to hide/show the suggestions chip
      window.hideSuggestionsChip = function() {
        if (menu) menu.style.display = 'none';
        if (chip) {
          chip.style.display = 'none';
          chip.classList.remove('active');
          chip.setAttribute('aria-expanded','false');
        }
        frozen = false;
        // After hiding, if the editor is empty, bring back the placeholder
        window.restorePlaceholderIfEmpty();
        try { window.__assistMenuOpen = false; } catch(_) {}
      };
      window.showSuggestionsChip = function(anchorEl) {
        if (chip) chip.style.display = 'inline-flex';
        const target = anchorEl || lastAnchorEl;
        if (target && typeof positionChipBelowElement === 'function') {
          try { positionChipBelowElement(target); } catch(_) {}
        } else {
          schedulePosition();
        }
        // Only mark menu open when the actual menu is shown; this keeps anchor-only cases neutral.
      };
      // Expose small control for other handlers
      window.__assistSetFrozen = function(v){
        frozen = !!v;
        if (!frozen) {
          // Auto-reset frozen state after 1 second to prevent getting stuck
          setTimeout(function() {
            if (frozen) {
              frozen = false;
              schedulePosition();
            }
          }, 1000);
          schedulePosition();
        }
      };
      
      function getActiveBlockElement() {
        const isChipVisible = () => chip && chip.style.display !== 'none';

        // First priority: current selection if it exists and is valid
        const sel = window.getSelection();
        if (sel.rangeCount > 0) {
          let node = sel.getRangeAt(0).startContainer;
          if (node.nodeType === Node.TEXT_NODE) node = node.parentElement;
          if (node && editor.contains(node)) {
            const block = node.closest('p, h1, h2, h3, h4, h5, h6, li, blockquote');
            if (block && block.offsetParent !== null) {
              // Update lastAnchorEl when we find a valid current block
              lastAnchorEl = block;
              return block;
            }
          }
        }

        // Second priority: last anchor if it's still valid and visible
        if (lastAnchorEl && editor.contains(lastAnchorEl) && lastAnchorEl.offsetParent !== null) {
          const rect = lastAnchorEl.getBoundingClientRect();
          const editorRect = editor.getBoundingClientRect();
          const isVisible = rect.bottom > editorRect.top && rect.top < editorRect.bottom;
          if (isVisible) {
            return lastAnchorEl;
          }
        }

        // Third priority: find the most recent valid block
        const blocks = Array.from(editor.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, blockquote'))
          .filter(function(el){
            return el.offsetParent !== null &&
                   el.id !== 'assistChip' &&
                   el.id !== 'assistMenu' &&
                   !el.closest('#assistChip') &&
                   !el.closest('#assistMenu');
          });

        if (blocks.length > 0) {
          // Return the last (most recent) block
          lastAnchorEl = blocks[blocks.length - 1];
          return lastAnchorEl;
        }

        // Final fallback
        return editor;
      }

      function offsetWithin(el, ancestor) {
        try {
          let x = 0, y = 0, n = el;
          while (n && n !== ancestor) {
            x += n.offsetLeft || 0;
            y += n.offsetTop || 0;
            n = n.offsetParent;
          }
          return { left: x, top: y };
        } catch(_) {
          return { left: 0, top: 0 };
        }
      }

      function schedulePosition() {
        try {
          if (window.perfTweaks && __insertingContent) return; // avoid churn during insert
        } catch(_) {}
        if (rafId) cancelAnimationFrame(rafId);
        if (window.perfTweaks) {
          __schedule(positionChipAtCursor);
        } else {
          rafId = requestAnimationFrame(positionChipAtCursor);
        }
      }

      function positionChipAtCursor() {
        rafId = null;
        if ((typeof suppressChipPositioning !== 'undefined' && suppressChipPositioning) || frozen) return;
        try { if (window.perfTweaks && __insertingContent) return; } catch(_) {}
        const editorRect = editor.getBoundingClientRect();
        let left = 0, top = 0;
        if (CHIP_ANCHOR_MODE === 'block') {
          const isChipVisible = () => chip && chip.style.display !== 'none';
          // Prefer current active block; fall back to last anchor only if it still intersects the editor viewport
          let block = getActiveBlockElement();
          const inView = function(el){
            try {
              if (!el) return false;
              const r = el.getBoundingClientRect();
              return r.bottom > editorRect.top && r.top < editorRect.bottom;
            } catch(_) { return false; }
          };
          if (!block || block === editor) {
            // If no active block, use last anchor if it's still in view
            if (lastAnchorEl && inView(lastAnchorEl)) block = lastAnchorEl;
          }
          if (block && block !== editor) {
            const off = offsetWithin(block, editor);
            left = Math.max(0, off.left);
            top  = Math.max(0, off.top + block.offsetHeight + 8);
          } else {
            const rect = editorRect;
            left = 0;
            top  = 8;
          }
          // Always keep lastAnchorEl in sync with the current block if it's valid/in view
          if (block && block !== editor) {
            lastAnchorEl = block;
          }
        } else {
          const sel = window.getSelection();
          if (!sel.rangeCount) return;
          const range = sel.getRangeAt(0).cloneRange();
          let rect = range.getBoundingClientRect();
          const empty = !rect || ((rect.left === 0 && rect.top === 0 && rect.right === 0 && rect.bottom === 0));
          if (empty) {
            const node = (range.startContainer && range.startContainer.nodeType === Node.TEXT_NODE)
              ? range.startContainer.parentElement
              : range.startContainer;
            const fb = (node && node.getBoundingClientRect) ? node.getBoundingClientRect() : editorRect;
            rect = { left: fb.left, right: fb.right, top: fb.top, bottom: fb.bottom, width: fb.width, height: fb.height };
          }
          left = Math.max(0, rect.left - editorRect.left);
          top  = Math.max(0, rect.bottom - editorRect.top + 24);
        }
        chip.style.left = left + 'px';
        chip.style.top = top + 'px';
        // Keep menu attached to chip if open
        if (menu && menu.style.display !== 'none') {
          menu.style.left = chip.style.left;
          menu.style.top  = (parseInt(chip.style.top || '0', 10) + 32) + 'px';
        }
      }

      function positionChipBelowElement(el) {
        if (!el || !chip) return;

        try {
          const off = offsetWithin(el, editor);
          const editorRect = editor.getBoundingClientRect();
          const elRect = el.getBoundingClientRect();

          // Ensure the element is actually visible
          if (elRect.width === 0 && elRect.height === 0) return;

          let left = Math.max(0, off.left);
          let top = Math.max(0, off.top + el.offsetHeight + 8);

          // Constrain to editor bounds
          const chipWidth = chip.offsetWidth || 120;
          const chipHeight = chip.offsetHeight || 32;
          const maxLeft = Math.max(0, editor.clientWidth - chipWidth - 16);
          const maxTop = Math.max(0, editor.clientHeight - chipHeight - 16);

          left = Math.min(left, maxLeft);
          top = Math.min(top, maxTop);

          chip.style.left = left + 'px';
          chip.style.top = top + 'px';
          lastAnchorEl = el;

          // Ensure chip stays within viewport if editor is scrollable
          const chipRect = chip.getBoundingClientRect();
          if (chipRect.bottom > editorRect.bottom) {
            const scrollTop = editor.scrollTop + (chipRect.bottom - editorRect.bottom) + 16;
            editor.scrollTop = scrollTop;
          }
        } catch (error) {
          console.warn('Error positioning chip:', error);
        }
      }
      
      function buildMainMenu() {
        // Always get fresh menu reference to avoid stale closures
        var currentMenu = document.getElementById('assistMenu');
        if (!currentMenu) return;
        
        // Show loading state if templates not yet loaded
        if (window.templatesData === undefined) {
          currentMenu.innerHTML = '<div class="assist-menu-header">Loading suggestions...</div><div style="padding: 16px; color: #72777d; font-size: 13px;">Loading section suggestions...</div>';
          currentMenu.style.display = 'block';
          // Retry after templates load
          setTimeout(function() {
            if (window.templatesData !== undefined) buildMainMenu();
          }, 100);
          return;
        }
        
        var title = (window.articleTitleText || 'This topic');
        var cat = (window.selectedCat || 'other');
        // Context-aware header: Lead vs current section
        function catToKey(c){ switch(c){ case 'person': return 'PERSON'; case 'place': return 'LOCATION'; case 'species': return 'SPECIES'; case 'organization': return 'ORGANIZATION'; case 'academic': return 'ACADEMIC'; case 'event': return 'EVENT'; case 'creative': return 'CREATIVE'; case 'other': return 'OTHER'; default: return null; } }
        function toId(n){ return String(n||'').trim().replace(/\s+/g,'_'); }
        function sectionExistsByName(nm){
          try{
            var editor = document.getElementById('editor');
            if (!editor) return false;
            var id = toId(nm);
            if (editor.querySelector('h2#'+CSS.escape(id))) return true;
            var n = String(nm||'').trim().toLowerCase();
            var headers = editor.querySelectorAll('h2');
            for (var i=0;i<headers.length;i++){ var t = (headers[i].textContent||'').trim().toLowerCase(); if (t === n) return true; }
            return false;
          }catch(_){ return false; }
        }
        function getCurrentSectionName(){
          try{
            var block = getActiveBlockElement();
            if (!block || block === editor) return 'Lead';
            var editorRect = editor.getBoundingClientRect();
            var bOff = offsetWithin(block, editor).top;
            var headers = Array.from(editor.querySelectorAll('h2'));
            var best = null; var bestTop = -1;
            headers.forEach(function(h){ var off = offsetWithin(h, editor).top; if (off <= bOff && off > bestTop) { bestTop = off; best = h; } });
            return best ? (best.textContent || 'Section').trim() : 'Lead';
          }catch(_) { return 'Lead'; }
        }
        function getSectionMetaByName(name){
          try { var tpl = window.templatesData; var key = catToKey(cat); var list = (tpl && tpl.categories && tpl.categories[key] && Array.isArray(tpl.categories[key].defaultSections)) ? tpl.categories[key].defaultSections : []; var n = String(name||'').trim().toLowerCase(); for (var i=0;i<list.length;i++){ var t = (list[i].title||'').trim().toLowerCase(); if (t === n) return list[i]; } return null; } catch(_) { return null; }
        }
        function getLeadExampleFromSuggestions(cat){
          try{
            var ex = window.suggestionsData && window.suggestionsData[cat] && window.suggestionsData[cat].introduction && Array.isArray(window.suggestionsData[cat].introduction.examples) ? window.suggestionsData[cat].introduction.examples : null;
            if (ex && ex.length) return ex[0].text || null;
            return null;
          }catch(_) { return null; }
        }

        function getWikipediaSectionExample(sectionName, category){
          var ex = {
            'person': {
              'Early life': 'Marie Curie was born Maria Skłodowska on 7 November 1867 in Warsaw, Poland. Her parents were both teachers, and she was the youngest of five children. Despite financial difficulties after her father lost his savings, she excelled in her studies and graduated from gymnasium at age 15.',
              'Career': 'Einstein began his career at the Swiss Patent Office in 1902, where he evaluated patent applications. During this period, he completed his most creative work, publishing four groundbreaking papers in 1905 that would transform physics, including his theory of special relativity.',
              'Background': 'Stephen Hawking came from an academic family. His father was a medical researcher and his mother was one of the first female students at Oxford. The family placed a high value on education, which influenced his later academic pursuits.',
              'Overview': 'Albert Einstein was a theoretical physicist who developed the theory of relativity, one of the two pillars of modern physics. His work influenced the philosophy of science and he received the 1921 Nobel Prize in Physics.'
            },
            'place': {
              'Geography': 'Paris is situated on the Seine River in north-central France, at the center of the Île-de-France region. The city covers an area of 105.4 square kilometers and has an elevation ranging from 28 to 131 meters above sea level.',
              'History': 'London was founded by the Romans around 47 AD as Londinium. After the Roman withdrawal in the 5th century, the city was largely abandoned until it was resettled by the Anglo-Saxons. It grew rapidly during the medieval period and became England\'s largest city.',
              'Background': 'The area now known as New York City was originally inhabited by Algonquian tribes. European exploration began in the 16th century, with the Dutch establishing New Amsterdam in 1624, later renamed New York.',
              'Overview': 'Tokyo is the capital and most populous city of Japan. Located at the head of Tokyo Bay, it is the political, economic, and cultural center of Japan, with a metropolitan area population exceeding 37 million.'
            },
            'species': {
              'Description': 'The giant panda has a distinctive black-and-white coat, with black fur around its eyes, ears, legs, and shoulders. Adults typically measure 1.2 to 1.9 meters in length and weigh between 80 and 125 kilograms.',
              'Habitat': 'Giant pandas live in temperate broadleaf and mixed forests in southwest China, particularly in Sichuan Province, at elevations between 1,200 and 3,400 meters where bamboo grows abundantly.',
              'Background': 'The blue whale was first scientifically described in 1694 by Robert Sibbald. Advances in whaling technology in the 19th century led to widespread hunting until international protection efforts.',
              'Overview': 'The African elephant is the largest living terrestrial animal, distinguished by its large ears and concave back, and plays a crucial role in maintaining the biodiversity of its ecosystems.'
            },
            'organization': {
              'History': 'The Red Cross was founded in 1863 by Henry Dunant and Gustave Moynier in Geneva, Switzerland, as a response to the suffering witnessed at the Battle of Solferino, leading to the first Geneva Convention.',
              'Activities': 'UNICEF works in over 190 countries providing humanitarian aid to children, including emergency relief, promoting child rights, improving healthcare and education, and protecting children from violence and exploitation.',
              'Background': 'NASA was established in 1958 in response to the Soviet launch of Sputnik, replacing NACA and beginning civilian space exploration efforts.',
              'Overview': 'The World Health Organization is a specialized agency of the United Nations responsible for international public health. Established in 1948, it coordinates global health responses and sets health standards.'
            }
          };
          var cat = (category||'').toLowerCase();
          var sec = String(sectionName||'').trim();
          var m = ex[cat] && ex[cat][sec];
          return m || null;
        }

        function buildExampleBlock(isLead, currentSection, cat){
          var text = isLead ? getLeadExampleFromSuggestions(cat) : getWikipediaSectionExample(currentSection, cat);
          if (!text) return '';
          return '<div class="assist-group">'+
                   '<div class="template-option-title" style="margin-bottom:6px; display:flex; align-items:center; gap:8px;"><span class="suggest-badge">Wikipedia example</span></div>'+
                   '<div class="intro-text" style="background:#f8f9fa; border-left:3px solid #36c; padding:10px; line-height:1.5;">'+ escapeHtml(text) +'</div>'+
                 '</div>';
        }

        var currentSection = getCurrentSectionName();
        var isLead = /^lead$/i.test(currentSection);
        var secMeta = isLead ? null : getSectionMetaByName(currentSection);
        
        // Check if intro template already exists
        var hasIntroTemplate = false;
        try {
          var editor = document.getElementById('editor');
          // Only look for intro template paragraph with specific ID (not section paragraphs)
          hasIntroTemplate = !!(editor.querySelector('p[id*="introTpl"]'));
          
          // DEBUG: Log the detection result
          console.log('[INTRO-TEMPLATE] hasIntroTemplate check:', hasIntroTemplate, 'Found intro elements:', editor.querySelectorAll('p[id*="introTpl"]').length);
        } catch(_) {}

        // Show current section context
        var contextBlock = '';
        if (!isLead) {
          contextBlock = '<div class="assist-group">'+
            '<div class="template-option-title" style="margin-bottom:2px;">Section: ' + escapeHtml(currentSection) +'</div>'+
            '<div class="meta">'+ (secMeta && secMeta.description ? escapeHtml(secMeta.description) : 'Add well-sourced, neutral content relevant to this section.') +'</div>'+
            '<div class="assist-actions">'+
              (!sectionExistsByName(currentSection) ? '<button class="action-chip" data-insert-section="'+ escapeHtml(currentSection) +'">Try a section starter</button>' : '')+
            '</div>'+
          '</div>';
        }

        // Always show introduction block (either current context or standalone)
        var leadSectionBlock = '<div class="assist-group">'+
          '<div class="template-option-title" style="margin-bottom:2px;">Introduction</div>'+
          '<div class="meta">Good introductions briefly define the topic and summarize the most important points in a neutral tone, with sources.</div>'+
          buildExampleBlock(true, 'Lead', cat) +
          '<div class="assist-actions">'+
            (!hasIntroTemplate
              ? '<button class="action-chip" data-insert-intro-template>Try an intro template</button>'
              : '<span class="action-chip disabled" aria-disabled="true" tabindex="-1">Added</span>')+
          '</div>'+
        '</div>';

        // Build a simpler, cleaner sections list below
        var sectionBlock = '';
        (function buildSections(){
          var tpl = window.templatesData;
          var catKey = catToKey(cat);
          var tplSections = (tpl && tpl.categories && tpl.categories[catKey] && Array.isArray(tpl.categories[catKey].defaultSections)) ? tpl.categories[catKey].defaultSections : null;
          if (tplSections && tplSections.length) {
            sectionBlock += '<div class="assist-sep"></div>';
            sectionBlock += '<div class="assist-group">';
            sectionBlock += '<div class="template-option-title" style="margin-bottom:6px;">'+
                             '<span class="suggest-badge" style="background:#eaf7ef; border-color:#cdeed8;">Suggested</span> Sections'+
                           '</div>';
            sectionBlock += '<ul class="assist-list">';
            (function(){
              var limit = 2;
              var expandAll = !!window.__showAllSectionsInMainMenu;
              var count = expandAll ? tplSections.length : Math.min(tplSections.length, limit);
              for (var i = 0; i < count; i++) {
                var sec = tplSections[i];
                var name = sec && sec.title ? sec.title : 'Section';
                var desc = sec && sec.description ? sec.description : '';
                var exists = sectionExistsByName(name);
                sectionBlock += '<li class="assist-list-item">'+
                  '<div><div style="font-weight:600;">'+ escapeHtml(name) +'</div>'+
                  (desc ? '<div class="meta">'+ escapeHtml(desc) +'</div>' : '') + '</div>'+
                  (exists ? '<span class="action-chip disabled" aria-disabled="true" tabindex="-1">Added</span>' : '<button class="action-chip" data-insert-section="'+ escapeHtml(name) +'">Insert</button>')+
                '</li>';
              }
            })();
            if (tplSections.length > 2 && !window.__showAllSectionsInMainMenu) {
              var remaining = tplSections.length - 2;
              sectionBlock += '<li class="assist-list-item">'+
                                '<div><div style="font-weight:600;">Show more sections ('+ remaining +' more)</div>'+ 
                                '<div class="meta">Open full list of suggested sections</div></div>'+ 
                                '<button class="action-chip" data-view-all-sections>Show more</button>'+ 
                              '</li>';
            }
            if (window.__showAllSectionsInMainMenu && tplSections.length > 2) {
              sectionBlock += '<li class="assist-list-item">'+
                                '<div><div style="font-weight:600;">Show less sections</div>'+ 
                                '<div class="meta">Collapse to top suggestions</div></div>'+ 
                                '<button class="action-chip" data-view-less-sections>Show less</button>'+ 
                              '</li>';
            }
            sectionBlock += '</ul></div>';
            return;
          }
          // Fallback to legacy suggestionsData (simple list)
          var secList = (window.suggestionsData && window.suggestionsData[cat] && Array.isArray(window.suggestionsData[cat].sections)) ? window.suggestionsData[cat].sections : [];
           if (secList && secList.length) {
             sectionBlock += '<div class="assist-sep"></div>';
             sectionBlock += '<div class="assist-group">';
             sectionBlock += '<div class="template-option-title" style="margin-bottom:6px;">Suggested sections</div>';
             sectionBlock += '<ul class="assist-list">';
            (function(){
              var limit = 2;
              var expandAll = !!window.__showAllSectionsInMainMenu;
              var count = expandAll ? secList.length : Math.min(secList.length, limit);
              for (var i = 0; i < count; i++) {
                var sec = secList[i];
                var name = (typeof sec === 'string') ? sec : (sec.name || 'Section');
                var desc = (typeof sec === 'string') ? '' : (sec.description || '');
                var exists = (function(){ try{ var editor = document.getElementById('editor'); var n = String(name||'').trim().toLowerCase(); var hs = editor.querySelectorAll('h2'); for (var j=0;j<hs.length;j++){ var t=(hs[j].textContent||'').trim().toLowerCase(); if (t===n) return true; } return false; }catch(_){ return false; } })();
                sectionBlock += '<li class="assist-list-item">'+
                  '<div><div style="font-weight:600;">'+ escapeHtml(name) +'</div>'+
                  (desc ? '<div class="meta">'+ escapeHtml(desc) +'</div>' : '') + '</div>'+
                  (exists ? '<span class="action-chip disabled" aria-disabled="true" tabindex="-1">Added</span>' : '<button class="action-chip" data-insert-section="'+ escapeHtml(name) +'">Insert</button>')+
                '</li>';
              }
            })();
              if (secList.length > 2 && !window.__showAllSectionsInMainMenu) {
                var remaining = secList.length - 2;
                sectionBlock += '<li class="assist-list-item">'+
                                  '<div><div style="font-weight:600;">Show more sections ('+ remaining +' more)</div>'+ 
                                  '<div class="meta">Open full list of suggested sections</div></div>'+ 
                                  '<button class="action-chip" data-view-all-sections>Show more</button>'+ 
                                '</li>';
              }
              if (window.__showAllSectionsInMainMenu && secList.length > 2) {
                sectionBlock += '<li class="assist-list-item">'+
                                  '<div><div style="font-weight:600;">Show less sections</div>'+ 
                                  '<div class="meta">Collapse to top suggestions</div></div>'+ 
                                  '<button class="action-chip" data-view-less-sections>Show less</button>'+ 
                                '</li>';
              }
              sectionBlock += '</ul></div>';
           }
        })();

        // Source action block (after Sections)
        var sourceBlock = '';
        (function addSourceAction(){
          sourceBlock += '<div class="assist-sep"></div>';
          sourceBlock += '<div class="assist-group">';
          sourceBlock += '<button class="assist-item" data-open-source>'+
                           '<div class="template-option-title" style="display:flex; align-items:center; gap:4px;">'+
                             '<span aria-hidden="true" style="display:inline-flex; width:16px; height:16px; line-height:0;">\
                               <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" width="16" height="16"><path d="m15 10-2.78-2.78L9.44 10V1H5a2 2 0 00-2 2v14a2 2 0 002 2h10a2 2 0 002-2V3a2 2 0 00-2-2z"></path></svg>'+
                             '</span>'+
                             '<span>Add from source</span>'+
                           '</div>'+
                           '<div class="template-option-desc">Cite a reliable source and insert content</div>'+
                         '</button>';
          sourceBlock += '</div>';
        })();

        var html = ''+
          '<div class="assist-menu-header" style="display:flex;justify-content:space-between;align-items:center;">Suggestions <button id="assistHideBtn" class="action-chip" style="border-radius:8px;">Hide</button></div>'+
          contextBlock +
          leadSectionBlock +
          sectionBlock +
          sourceBlock;
        currentMenu.innerHTML = html;
        // Bind actions - handle multiple intro template buttons
        var tplBtns = currentMenu.querySelectorAll('[data-insert-intro-template]');
        tplBtns.forEach(function(tplBtn) {
          // Prevent focus from moving off the editor
          tplBtn.addEventListener('mousedown', function(e){ e.preventDefault(); });
          tplBtn.addEventListener('click', function(e){
            e.preventDefault();
            e.stopPropagation();
            insertIntroTemplate(title, cat);
            currentMenu.style.display='none';
            if (window.__assistSetFrozen) window.__assistSetFrozen(false);
            // Ensure caret is positioned inside the inserted template
            setTimeout(function(){
              try { if (typeof positionChipAtCursor === 'function') positionChipAtCursor(); } catch(_) {}
              var ed = document.getElementById('editor'); if (ed) ed.focus();
            }, 0);
          });
        });
        var hideBtn = currentMenu.querySelector('#assistHideBtn');
        if (hideBtn) hideBtn.addEventListener('click', function(e){ e.preventDefault(); if (typeof hideSuggestionsChip === 'function') hideSuggestionsChip(); });
        // Bind insert buttons for sections in preview
        currentMenu.querySelectorAll('[data-insert-section]').forEach(function(btn){
          btn.addEventListener('click', function(){
            var name = this.getAttribute('data-insert-section');
            insertSectionSkeleton(name).catch(function(){});
            // Keep the menu open and refresh to reflect the new "Added" state
            setTimeout(function(){
              try {
                // Get fresh menu reference to avoid stale closure issues
                var currentMenu = document.getElementById('assistMenu');
                if (currentMenu && window.buildMainMenu) {
                  window.buildMainMenu();
                  currentMenu.style.display = 'block';
                }
                if (typeof reanchorAssistChip === 'function') reanchorAssistChip();
              } catch(_) {}
            }, 50);
          });
        });
        var viewAllBtn = currentMenu.querySelector('[data-view-all-sections]');
        if (viewAllBtn) viewAllBtn.addEventListener('click', function(e){
          e.preventDefault(); e.stopPropagation();
          try { window.__showAllSectionsInMainMenu = true; } catch(_) {}
          if (window.buildMainMenu) window.buildMainMenu();
          // Keep the menu open and re-anchor
          try { var cm = document.getElementById('assistMenu'); if (cm) cm.style.display = 'block'; } catch(_) {}
          try { if (typeof reanchorAssistChip === 'function') reanchorAssistChip(); } catch(_) {}
        });
        var viewLessBtn = currentMenu.querySelector('[data-view-less-sections]');
        if (viewLessBtn) viewLessBtn.addEventListener('click', function(e){
          e.preventDefault(); e.stopPropagation();
          try { window.__showAllSectionsInMainMenu = false; } catch(_) {}
          if (window.buildMainMenu) window.buildMainMenu();
          try { var cm = document.getElementById('assistMenu'); if (cm) cm.style.display = 'block'; } catch(_) {}
          try { if (typeof reanchorAssistChip === 'function') reanchorAssistChip(); } catch(_) {}
        });
        // Bind source action
        (function bindSourceAction(){
          try {
            var srcBtn = currentMenu.querySelector('[data-open-source]');
            if (!srcBtn) return;
            srcBtn.addEventListener('mousedown', function(e){ e.preventDefault(); });
            srcBtn.addEventListener('click', function(e){
              e.preventDefault();
              try { if (typeof openSourceModalDialog === 'function') openSourceModalDialog(); else openReferenceDialog(); } catch(_) { openReferenceDialog(); }
              try { currentMenu.style.display = 'none'; window.__assistMenuOpen = false; } catch(_) {}
              try { if (typeof reanchorAssistChip === 'function') reanchorAssistChip(); } catch(_) {}
            });
          } catch(_) {}
        })();

        bindMenuHandlers();
        // Active state
        try { chip.classList.add('active'); chip.setAttribute('aria-expanded','true'); } catch(_) {}
      }
      
      function buildSectionMenu() {
        // Always get fresh menu reference to avoid stale closures
        var currentMenu = document.getElementById('assistMenu');
        if (!currentMenu) return;
        
        var cat = (window.selectedCat || 'other');
        function catToKey(c){ switch(c){ case 'person': return 'PERSON'; case 'place': return 'LOCATION'; case 'species': return 'SPECIES'; case 'organization': return 'ORGANIZATION'; case 'academic': return 'ACADEMIC'; case 'event': return 'EVENT'; case 'creative': return 'CREATIVE'; case 'other': return 'OTHER'; default: return null; } }
        var tpl = window.templatesData;
        var catKey = catToKey(cat);
        var tplSections = (tpl && tpl.categories && tpl.categories[catKey] && Array.isArray(tpl.categories[catKey].defaultSections)) ? tpl.categories[catKey].defaultSections : [];
        var html = '<div class="assist-menu-header">Suggested sections</div>';
        if (tplSections && tplSections.length) {
          tplSections.forEach(function(sec, idx){
            var name = sec && sec.title ? sec.title : 'Section';
            var desc = sec && sec.description ? sec.description : '';
            html += '<button class="assist-item" data-insert-section="'+escapeHtml(name)+'"><div class="template-option-title">'+escapeHtml(name)+'</div><div class="template-option-desc">'+ (desc ? escapeHtml(desc) : 'Insert section') +'</div></button>';
            if (idx < tplSections.length - 1) html += '<div class="assist-sep"></div>';
          });
        } else {
          const suggestions = getSectionSuggestions(cat);
          suggestions.forEach(function(name, idx){
            var exists = (function(){ try{ var editor = document.getElementById('editor'); var n = String(name||'').trim().toLowerCase(); var hs = editor.querySelectorAll('h2'); for (var i=0;i<hs.length;i++){ var t=(hs[i].textContent||'').trim().toLowerCase(); if (t===n) return true; } return false; }catch(_){ return false; } })();
            if (!exists) {
              html += '<button class="assist-item" data-insert-section="'+escapeHtml(name)+'"><div class="template-option-title">'+escapeHtml(name)+'</div><div class="template-option-desc">Insert section</div></button>';
              if (idx < suggestions.length - 1) html += '<div class="assist-sep"></div>';
            } else {
              html += '<div class="assist-item" style="cursor:default; opacity:0.7;"><div class="template-option-title">'+escapeHtml(name)+'</div><div class="template-option-desc">Already added</div></div>';
              if (idx < suggestions.length - 1) html += '<div class="assist-sep"></div>';
            }
          });
        }
        html += '<div class="assist-sep"></div><button class="assist-item" data-back="1"><div class="template-option-title">Back</div></button>';
        currentMenu.innerHTML = html;
        bindSectionHandlers();
      }
      
      function bindMenuHandlers() {
        // Get fresh menu reference to avoid stale closures
        var currentMenu = document.getElementById('assistMenu');
        if (!currentMenu) return;
        // Swallow clicks on disabled chips so they don't close the menu
        try {
          currentMenu.addEventListener('click', function(e){
            var disabled = e.target && e.target.closest && e.target.closest('.action-chip[aria-disabled="true"], .action-chip.disabled');
            if (disabled) { e.preventDefault(); e.stopPropagation(); }
          }, true);
        } catch(_) {}
        
        var items = currentMenu.querySelectorAll('[data-assist]');
        items.forEach(function(btn){
          btn.addEventListener('click', function(ev){
            var action = this.getAttribute('data-assist');
            if (action === 'intro') {
              buildIntroMenu();
            } else if (action === 'source') {
              try { if (typeof openSourceModalDialog === 'function') { openSourceModalDialog(); } else { openReferenceDialog(); } } catch(_) { openReferenceDialog(); }
              // Get fresh menu reference for display property
              var menuForHide = document.getElementById('assistMenu');
              if (menuForHide) menuForHide.style.display = 'none';
            } else if (action === 'section') {
              buildSectionMenu();
            }
          });
        });
      }

      function buildIntroMenu() {
        // Always get fresh menu reference to avoid stale closures
        var currentMenu = document.getElementById('assistMenu');
        if (!currentMenu) return;
        
        var title = (window.articleTitleText || 'This topic');
        var cat = (window.selectedCat || 'other');
        var samples = generateSampleIntroductions(title, cat);
        var html = '<div class="assist-menu-header">Introduction samples</div>';
        html += samples.map(function(text, idx){
          return '<div class="intro-sample"><div class="intro-text">'+ escapeHtml(text) +'</div><div class="action-row"><button class="action-chip" data-insert-intro="'+idx+'">Insert</button></div></div>';
        }).join('');
        // Chip-style starter
        html += '<div class="assist-sep"></div>';
        html += '<div class="intro-sample"><div class="intro-text">'+ escapeHtml(getChipStyleStarterPreview(title, cat)) +'</div><div class="action-row"><button class="action-chip" data-insert-chip-starter>Insert</button><button class="action-chip" data-back="1">Back</button></div></div>';
        currentMenu.innerHTML = html;
        // Bind actions
        currentMenu.querySelectorAll('[data-insert-intro]').forEach(function(btn){
          btn.addEventListener('click', function(){
            var idx = parseInt(this.getAttribute('data-insert-intro'), 10);
            insertIntroText(samples[idx]);
            // Get fresh menu reference for display property
            var menuForHide = document.getElementById('assistMenu');
            if (menuForHide) menuForHide.style.display = 'none';
            if (window.__assistSetFrozen) window.__assistSetFrozen(false);
          });
        });
        var chipBtn = currentMenu.querySelector('[data-insert-chip-starter]');
        if (chipBtn) chipBtn.addEventListener('click', function(){ insertChipStyleStarter(title, cat); 
          var menuForHide = document.getElementById('assistMenu');
          if (menuForHide) menuForHide.style.display = 'none';
          if (window.__assistSetFrozen) window.__assistSetFrozen(false); 
        });
        var back = currentMenu.querySelector('[data-back]');
        if (back) back.addEventListener('click', function(){ if (window.buildMainMenu) window.buildMainMenu(); });
      }
      
      function bindSectionHandlers() {
        // Get fresh menu reference to avoid stale closures
        var currentMenu = document.getElementById('assistMenu');
        if (!currentMenu) return;
        
        var items = currentMenu.querySelectorAll('[data-insert-section]');
        items.forEach(function(btn){
          btn.addEventListener('click', function(){
            var name = this.getAttribute('data-insert-section');
            insertSectionSkeleton(name).catch(function(){});
            // Close menu after successful section insertion
            setTimeout(function(){
              try {
                var refreshedMenu = document.getElementById('assistMenu');
                if (refreshedMenu) {
                  refreshedMenu.style.display = 'none';
                  window.__assistMenuOpen = false;
                }
                if (typeof reanchorAssistChip === 'function') reanchorAssistChip();
              } catch(_) {}
            }, 50);
          });
        });
        var back = currentMenu.querySelector('[data-back]');
        if (back) back.addEventListener('click', function(){ if (window.buildMainMenu) window.buildMainMenu(); });
      }
      
      // Freeze on mousedown to prevent selectionchange from moving chip before click
      chip.addEventListener('mousedown', function(ev){
        ev.preventDefault();
        ev.stopPropagation();
        frozen = true;
        // Reset frozen state after a short delay to ensure it's not stuck
        setTimeout(function(){
          if (frozen) {
            frozen = false;
            schedulePosition();
          }
        }, 1000);
      });
      // Keyboard support
      chip.addEventListener('keydown', function(ev){
        if (ev.key === 'Enter' || ev.key === ' ' || ev.key === 'Spacebar') {
          ev.preventDefault();
          try { if (typeof toggleSuggestionsChip === 'function') toggleSuggestionsChip(); } catch(_) {}
        }
      });
      chip.addEventListener('click', function(ev){
        ev.preventDefault(); ev.stopPropagation();
        // Position menu under the chip
        menu.style.left = chip.style.left;
        // Prefer placing menu within editor viewport: if near bottom, pop above
        var chipTop = parseInt(chip.style.top||'0',10);
        var editorRect = editor.getBoundingClientRect();
        var approxMenuHeight = Math.max(menu.offsetHeight || 260, 220);
        var spaceBelow = editor.clientHeight - chipTop;
        if (spaceBelow < approxMenuHeight + 40) {
          menu.style.top = Math.max(0, chipTop - approxMenuHeight - 10) + 'px';
          menu.setAttribute('data-pos','above');
          // Flip arrow to bottom
          var arrow = menu.querySelector('.assist-arrow');
          if (arrow) {
            arrow.style.top = '';
            arrow.style.bottom = '-8px';
            arrow.style.borderBottomColor = 'transparent';
            arrow.style.borderTop = '8px solid #fff';
            arrow.style.filter = 'drop-shadow(0 1px 0 #eaecf0)';
          }
        } else {
          menu.style.top = (chipTop + 32) + 'px';
          menu.setAttribute('data-pos','below');
          // Arrow on top
          var arrow2 = menu.querySelector('.assist-arrow');
          if (arrow2) {
            arrow2.style.bottom = '';
            arrow2.style.top = '-8px';
            arrow2.style.borderTop = 'none';
            arrow2.style.borderBottom = '8px solid #fff';
            arrow2.style.filter = 'drop-shadow(0 -1px 0 #eaecf0)';
          }
        }
        if (menu.style.display === 'none') {
          buildMainMenu();
          menu.style.display = 'block';
          frozen = true;
          try { window.__assistMenuOpen = true; } catch(_) {}
        } else {
          menu.style.display = 'none';
          frozen = false;
          schedulePosition();
          try { window.__assistMenuOpen = false; } catch(_) {}
        }
      });

      // Close menu when clicking outside assist chip/menu
      document.addEventListener('click', function(e){
        // Allow certain programmatic clicks (e.g., auto-focusing placeholders after insert)
        if (window.__suppressAssistMenuHide) return;
        const inAssist = !!e.target.closest('#assistChip') || !!e.target.closest('#assistMenu');
        if (!inAssist && isAssistMenuOpen()) {
          closeAssistMenu();
        }
      }, true);

      // Expose helpers globally for external callers
      window.buildMainMenu = buildMainMenu;
      window.buildSectionMenu = buildSectionMenu;
      window.positionChipBelowElement = positionChipBelowElement;
      window.showSlashSuggestions = showSlashSuggestions;

      // Robust event delegation for section insertion from Suggestions menu
      if (!window.__assistMenuDelegated) {
        window.__assistMenuDelegated = true;
        document.addEventListener('click', function(ev){
          var target = ev.target && ev.target.closest && ev.target.closest('#assistMenu [data-insert-section]');
          if (!target) return;
          ev.preventDefault();
          ev.stopPropagation();
          try {
            if (target.getAttribute('aria-busy') === 'true') return; // ignore re-entrant clicks
            target.setAttribute('aria-busy','true');
            target.style.opacity = '0.7';
            beginAtomic();
            var name = target.getAttribute('data-insert-section');
            if (name && typeof insertSectionSkeleton === 'function') {
              // Avoid auto-hide during insertion and keep menu open after
              try { window.__suppressAssistMenuHide = true; } catch(_) {}
              insertSectionSkeleton(name).then(function(inserted) {
                // Handle successful insertion
                if (inserted && typeof reanchorAssistChip === 'function') reanchorAssistChip();
              }).catch(function(){});
              // Close menu after successful insertion
              setTimeout(function(){
                try {
                  var menu = document.getElementById('assistMenu');
                  if (menu) {
                    menu.style.display = 'none';
                    window.__assistMenuOpen = false;
                  }
                  if (typeof reanchorAssistChip === 'function') reanchorAssistChip();
                } catch(_) {}
              }, 20);
              setTimeout(function(){ 
                try { window.__suppressAssistMenuHide = false; } catch(_) {}
                endAtomic();
                try { target.removeAttribute('aria-busy'); target.style.opacity = ''; } catch(_) {}
              }, 200);
            }
          } catch(_) {}
        }, true);
      }

      // Slash command: open Suggestions (Notion-style)
      function showSlashSuggestions() {
        try {
          const editorRect = editor.getBoundingClientRect();
          // Prefer active block; fallback to top-visible block
          let anchor = null;
          try { if (typeof getActiveBlockElement === 'function') anchor = getActiveBlockElement(); } catch(_) {}
          if (!anchor || anchor === editor) {
            const blocks = Array.from(editor.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, blockquote')).filter(function(el){ return el.offsetParent !== null; });
            let best = null, bestDelta = Infinity;
            for (let i=0;i<blocks.length;i++) {
              const r = blocks[i].getBoundingClientRect();
              const intersects = r.bottom > editorRect.top && r.top < editorRect.bottom;
              if (!intersects) continue;
              const delta = Math.abs(r.top - editorRect.top);
              if (delta < bestDelta) { bestDelta = delta; best = blocks[i]; }
            }
            anchor = best || blocks[0] || editor;
          }
          lastAnchorEl = anchor;
          if (typeof positionChipBelowElement === 'function') positionChipBelowElement(anchor);
          if (typeof showSuggestionsChip === 'function') showSuggestionsChip(anchor);
          const menu = document.getElementById('assistMenu');
          if (menu) {
            if (window.buildMainMenu) window.buildMainMenu();
            menu.style.display = 'block';
            menu.style.left = (document.getElementById('assistChip')?.style.left || '0px');
            menu.style.top = ((parseInt(document.getElementById('assistChip')?.style.top || '0', 10) + 32) + 'px');
            try { menu.style.zIndex = '5001'; } catch(_) {}
            try { window.__assistMenuOpen = true; } catch(_) {}
          }
        } catch(_) {}
      }

      // Reposition chip near caret as user interacts
      editor.addEventListener('focus', function(){ setTimeout(schedulePosition, 0); });
      // Utility to clear the initial lead placeholder before real content is inserted
      function clearLeadPlaceholder(){
        try {
          var editor = document.getElementById('editor');
          var lp = document.getElementById('leadPlaceholder') || (editor && editor.querySelector && editor.querySelector('.lead-placeholder'));
          if (!lp) return false;
          // Clear content first, then place caret inside the paragraph
          lp.innerHTML = '';
          try {
            // Defer caret placement to end of current event loop
            setTimeout(function(){
              try {
                var r = document.createRange();
                var s = window.getSelection();
                r.selectNodeContents(lp);
                r.collapse(true);
                s.removeAllRanges();
                s.addRange(r);
                if (editor) editor.focus();
              } catch(_) {}
            }, 0);
          } catch(_) {}
          // Normalize styling so it's a regular paragraph now
          lp.removeAttribute('id');
          if (lp.classList) lp.classList.remove('lead-placeholder');
          lp.style.fontStyle = '';
          lp.style.color = '';
          return true;
        } catch(_) { return false; }
      }
      editor.addEventListener('keydown', function(e){
        // Only react when focus is within the editor
        try { if (document.activeElement && !editor.contains(document.activeElement)) return; } catch(_) {}
        // If first real input with placeholder visible, intercept, clear, then insert char ourselves
        var hasLP = !!document.getElementById('leadPlaceholder') || !!editor.querySelector('.lead-placeholder');
        if (hasLP && !e.metaKey && !e.ctrlKey && !e.altKey && e.key && e.key.length === 1 && e.key !== '/') {
          e.preventDefault();
          // Clear placeholder and place caret
          clearLeadPlaceholder();
          // Insert the typed character on the next tick to ensure caret is set
          setTimeout(function(){
            try {
              var sel = window.getSelection();
              if (sel && sel.rangeCount) {
                var range = sel.getRangeAt(0);
                var tn = document.createTextNode(e.key);
                range.insertNode(tn);
                range.setStartAfter(tn);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
              }
            } catch(_) {}
          }, 0);
          return;
        }
        if (e.key === '/' && !e.metaKey && !e.ctrlKey && !e.altKey) {
          e.preventDefault();
          
          // Clean up any empty paragraphs or leftover "/" characters first
          setTimeout(function() {
            const editor = document.getElementById('editor');
            if (editor) {
              const emptyPs = Array.from(editor.querySelectorAll('p')).filter(function(p) {
                const text = (p.textContent || '').trim();
                return text === '' || text === '/' && !p.id && !p.classList.contains('lead-placeholder');
              });
              emptyPs.forEach(function(p) { 
                if (p.parentNode) p.parentNode.removeChild(p); 
              });
            }
            
            var menuNow = document.getElementById('assistMenu');
            if (menuNow && menuNow.style.display !== 'none') {
              // Toggle off if already open
              menuNow.style.display = 'none';
              if (window.__assistSetFrozen) window.__assistSetFrozen(false);
              window.restorePlaceholderIfEmpty();
            } else {
              showSlashSuggestions();
            }
          }, 0);
        }
      });
      editor.addEventListener('paste', function(){ clearLeadPlaceholder(); });
      editor.addEventListener('click', function(e){
        // Handle section dismissal
        var dismissBtn = e.target && e.target.closest && e.target.closest('.section-dismiss');
        if (dismissBtn) {
          e.preventDefault(); e.stopPropagation();
          try {
            var block = dismissBtn.closest('.section-block');
            var secName = block && block.getAttribute('data-section');
            var anchor = (block && (block.nextElementSibling || block.previousElementSibling)) || editor;
            if (block && block.parentNode) block.parentNode.removeChild(block);
            // Update addedSections tracking
            if (secName && Array.isArray(window.addedSections)) {
              window.addedSections = window.addedSections.filter(function(n){ return String(n).toLowerCase() !== String(secName).toLowerCase(); });
            }
            // Refresh suggestions panel if open
            var menu = document.getElementById('assistMenu');
            if (menu && menu.style.display !== 'none' && window.buildMainMenu) {
              window.buildMainMenu();
            }
            // Re-anchor chip near the next block
            if (typeof showSuggestionsChip === 'function') showSuggestionsChip(anchor && anchor.querySelector ? (anchor.querySelector('p, h1, h2, h3, h4, h5, h6, li, blockquote') || anchor) : anchor);
          } catch(_) {}
          return;
        }
        var t = e.target;
        // Reference chip opens dialog
        if (t && (t.classList && t.classList.contains('ref-chip'))) {
          e.preventDefault(); e.stopPropagation();
          lastSourceReminderClicked = t;
          openDialog();
          return;
        }
        // Placeholder chip shows suggestions menu
        if (t && t.classList && t.classList.contains('template-placeholder')) {
          e.preventDefault(); e.stopPropagation();
          showChipSuggestMenu(t);
          return;
        }
        setTimeout(schedulePosition, 0);
      });
      editor.addEventListener('keyup', function(){ if (!(window.perfTweaks && __insertingContent)) schedulePosition(); });

      // Enhanced input event handling for better content change detection
      let inputTimeout;
      editor.addEventListener('input', function(e){
        // Clear existing timeout
        clearTimeout(inputTimeout);

        // Check if this is a structural change (new paragraph, etc.)
        const isStructuralChange = e.inputType === 'insertParagraph' ||
                                   e.inputType === 'insertLineBreak' ||
                                   (e.data && e.data.includes('\n'));

        if (isStructuralChange) {
          // Immediate repositioning for structural changes
          setTimeout(function() {
            if (!frozen) {
              reanchorAssistChip();
            }
          }, 10);
        } else {
          // Debounced repositioning for other changes
          inputTimeout = setTimeout(function() {
            if (!frozen) {
              schedulePosition();
            }
          }, 150);
        }
      });
       editor.addEventListener('keyup', function(){ schedulePosition(); });
       editor.addEventListener('input', function(e){
         // Reposition mainly on structural edits; throttle everything else
         schedulePosition();
         // Re-anchor after significant content changes
         if (e.inputType === 'insertParagraph' || e.inputType === 'insertLineBreak' ||
             e.inputType === 'deleteContentBackward' || e.inputType === 'deleteContentForward') {
           setTimeout(function(){
             reanchorAssistChip();
           }, 100);
         }
       });
      document.addEventListener('selectionchange', function(){
        if (window.perfTweaks && __insertingContent) return;
        const sel = window.getSelection();
        if (sel && sel.rangeCount && editor.contains(sel.anchorNode)) {
          // When selection changes inside the editor, prefer the block containing the caret
          try { lastAnchorEl = getActiveBlockElement(); } catch(_) {}
          schedulePosition();
        }
      });
      window.addEventListener('resize', function(){ if (!(window.perfTweaks && __insertingContent)) schedulePosition(); });
      // Reposition on any scroll that may shift editor
      document.addEventListener('scroll', function(){ if (!(window.perfTweaks && __insertingContent)) schedulePosition(); }, true);
      // Chip keyboard handling: open menu/dialog on Enter/Space; Tab navigation among chips
      editor.addEventListener('keydown', function(e){
        var t = e.target;
        var isPlaceholder = t && t.classList && t.classList.contains('template-placeholder');
        var isRefChip = t && t.classList && t.classList.contains('ref-chip');
        if (!(isPlaceholder || isRefChip)) return;
        if (e.key === 'Enter' || e.key === ' ' || e.key === 'Spacebar') {
          e.preventDefault(); e.stopPropagation();
          if (isPlaceholder) { try { showChipSuggestMenu(t); } catch(_) {} }
          if (isRefChip) { try { if (typeof openSourceModalDialog === 'function') openSourceModalDialog(); else openReferenceDialog(); } catch(_) { openReferenceDialog(); } }
          return;
        }
        if (e.key === 'Tab') {
          e.preventDefault();
          var all = Array.from(editor.querySelectorAll('.template-placeholder, .ref-chip'));
          var idx = all.indexOf(t);
          var next = e.shiftKey ? all[idx-1] : all[idx+1];
          if (next) { try { next.focus(); } catch(_) {} }
          return;
        }
      });
       // Initial position
       setTimeout(schedulePosition, 0);

       // Set up mutation observer to detect DOM changes that affect positioning
       const observer = new MutationObserver(function(mutations) {
         let shouldReanchor = false;
         mutations.forEach(function(mutation) {
           // Check for added/removed nodes that could affect positioning
           if (mutation.type === 'childList' &&
               (mutation.addedNodes.length > 0 || mutation.removedNodes.length > 0)) {
             // Check if any added/removed nodes are block elements
             const relevantNodes = Array.from(mutation.addedNodes).concat(Array.from(mutation.removedNodes));
             const hasBlockElements = relevantNodes.some(function(node) {
               return node.nodeType === Node.ELEMENT_NODE &&
                      (node.matches('p, h1, h2, h3, h4, h5, h6, li, blockquote') ||
                       node.querySelector('p, h1, h2, h3, h4, h5, h6, li, blockquote'));
             });
             if (hasBlockElements) {
               shouldReanchor = true;
             }
           }
         });
         if (shouldReanchor) {
           setTimeout(function(){
             reanchorAssistChip();
           }, 50);
         }
       });

       // Start observing the editor for changes
       observer.observe(editor, {
         childList: true,
         subtree: true,
         attributes: false
       });

       // Expose helpers for other modules
       window.__assistGetLastAnchor = function(){ return lastAnchorEl; };
    }

    // Chip suggestion menu logic
    let chipMenuEl = null;
    function ensureChipMenu() {
      if (!chipMenuEl) {
        chipMenuEl = document.createElement('div');
        chipMenuEl.id = 'chipSuggestMenu';
        chipMenuEl.className = 'chip-menu';
        // Ensure roomy width like assist menu
        chipMenuEl.style.width = '460px';
        chipMenuEl.style.maxWidth = '90vw';
        document.body.appendChild(chipMenuEl);
      }
      return chipMenuEl;
    }

    function showChipSuggestMenu(chipEl) {
      const menu = ensureChipMenu();
      const key = (chipEl.getAttribute('data-placeholder') || chipEl.getAttribute('data-key') || '').toLowerCase();
      const cat = (window.selectedCat || 'other');
      const td = window.templatesData || null;
      const headerHint = getChipHeaderHintFromTemplates(td, key);
      let suggestions = getChipSuggestions(key, cat, td);
      // Avoid duplicate Custom option if provided by templates.json
      const normalize = function(s){ return String(s||'').trim().toLowerCase().replace(/…/g,'...'); };
      const hasCustom = suggestions && suggestions.some(function(s){ return normalize(s) === 'custom...'; });
      // Determine if there are any curated (non-Custom) values
      const nonCustomCount = (suggestions || []).filter(function(s){ return normalize(s) !== 'custom...'; }).length;
      // Friendly guidance when only Custom is available
      const getCustomHint = function(k){
        switch(k){
          case 'pronunciation': return 'Enter pronunciation (IPA or phonetic), e.g., EE-lon';
          case 'birth_date': return 'Enter full birth date, e.g., June 28, 1971';
          case 'birth_place': return 'Enter city, region, country';
          case 'known_for': return 'Add a short phrase describing what they are known for';
          case 'current_status': return 'Describe current role/status in present tense';
          case 'recognition': return 'Add notable awards, honors, or rankings';
          default: return 'Type a value for this field, then click Insert';
        }
      };
      const customHint = getCustomHint(key);
      let html = '<div class="chip-menu-header">'+ (headerHint || ('Suggestions for '+ escapeHtml(key.replace(/_/g,' ')))) +'</div>';
      suggestions.forEach(function(opt){
        if (normalize(opt) === 'custom...') {
          html += '<button class="chip-menu-item" data-chip-custom>Custom…</button>';
        } else {
          html += '<button class="chip-menu-item" data-chip-value="'+ escapeHtml(opt) +'">'+ escapeHtml(opt) +'</button>';
        }
      });
      if (!hasCustom) {
        html += '<div class="assist-sep"></div><button class="chip-menu-item" data-chip-custom>Custom…</button>';
      }
      // If no curated suggestions, show a friendly hint block
      if (nonCustomCount === 0) {
        html += '<div class="assist-sep"></div>'+
                '<div class="chip-guidance" style="padding:10px 12px; font-size:12px; color:#54595d;">'+ escapeHtml(customHint) +'</div>';
      }
      menu.innerHTML = html;

      // Position near chip
      const rect = chipEl.getBoundingClientRect();
      menu.style.left = rect.left + 'px';
      menu.style.top = (rect.bottom + 6) + 'px';
      menu.style.display = 'block';
      try { menu.style.zIndex = '5002'; } catch(_) {}

      // Handlers
      menu.querySelectorAll('[data-chip-value]').forEach(function(btn){
        btn.addEventListener('click', function(e){
          e.preventDefault();
          var val = this.getAttribute('data-chip-value') || '';
          // If a value is "Custom..." treat as custom entry instead of literal text
          if (normalize(val) === 'custom...') {
            // delegate to custom handler
            const customBtn = menu.querySelector('[data-chip-custom]');
            if (customBtn) customBtn.click(); else {
              // fallback: inline-edit
              chipEl.setAttribute('contenteditable', 'true');
              chipEl.textContent = '';
              chipEl.focus();
              // Hide help when user starts typing into the chip directly
              try {
                var once = function(){ try { hideIntroHelp(); } catch(_) {} try { chipEl.removeEventListener('input', once); } catch(_) {} };
                chipEl.addEventListener('input', once);
              } catch(_) {}
            }
            menu.style.display = 'none';
            return;
          }
          // Replace chip with a filled, editable value span
          var filled = document.createElement('span');
          filled.className = 'chip-value';
          filled.setAttribute('data-placeholder', (chipEl.getAttribute('data-placeholder')||key).toUpperCase());
          filled.setAttribute('data-key', key);
          filled.setAttribute('contenteditable','false');
          filled.setAttribute('role','button');
          filled.setAttribute('tabindex','0');
          filled.textContent = val;
          if (chipEl && chipEl.parentNode) {
            var original = chipEl.cloneNode(true);
            var parent = chipEl.parentNode;
            parent.replaceChild(filled, chipEl);
            try { hideIntroHelp(); } catch(_) {}
            // Feedback + undo
            try {
              var block = parent.closest ? parent.closest('p, li, h1, h2, h3, h4, blockquote') : parent;
              showUndoToast('Filled "'+ (key.replace(/_/g,' ')) +'"', function(){
                try {
                  if (filled && filled.parentNode) filled.parentNode.replaceChild(original, filled);
                  // Restore caret and placeholder selection
                  try { var ed=document.getElementById('editor'); if (ed) ed.focus(); } catch(_) {}
              try { if (original && original.focus) original.focus(); } catch(_) {}
                  return true; // handled caret
                } catch(_) { return false; }
              }, block || parent);
            } catch(_) {}
          }
          try { if (key === 'occupation' || key === 'work_type') updateArticleHeuristic(filled); } catch(_) {}
          try { tidyLeadPunctuation(filled); } catch(_) {}
          menu.style.display = 'none';
        });
      });
      const customBtns = menu.querySelectorAll('[data-chip-custom]');
      customBtns.forEach(function(customBtn){
        customBtn.addEventListener('click', function(e){
          e.preventDefault();
          // Show inline custom input inside the menu instead of editing the chip
          var existing = menu.querySelector('.chip-custom-entry');
          if (!existing) {
            menu.insertAdjacentHTML('beforeend',
              '<div class="assist-sep"></div>'+
              '<div class="chip-custom-entry" style="padding:10px 12px;">'+
                '<div style="font-size:12px; color:#555; margin-bottom:6px;">Enter a custom value — '+ escapeHtml(customHint) +'</div>'+
                '<input type="text" id="chipCustomInput" style="width:100%; height:32px; border:1px solid #c8ccd1; border-radius:4px; padding:6px 8px; font: inherit;" placeholder="'+ escapeHtml(customHint) +'" />'+
                '<div style="display:flex; gap:8px; margin-top:8px;">'+
                  '<button class="chip-menu-item" data-chip-submit style="width:auto; display:inline-block;">Insert</button>'+
                  '<button class="chip-menu-item" data-chip-cancel style="width:auto; display:inline-block;">Cancel</button>'+
                '</div>'+
              '</div>'
            );
          }
          var input = menu.querySelector('#chipCustomInput');
          if (input) {
            // Prefill with empty (remove default label like "add …")
            input.value = '';
            input.focus();
            input.select();
            var submit = function(){
              var val = (input.value || '').trim();
              if (!val) { input.focus(); return; }
              var filled = document.createElement('span');
              filled.className = 'chip-value';
              filled.setAttribute('data-placeholder', (chipEl.getAttribute('data-placeholder')||key).toUpperCase());
              filled.setAttribute('data-key', key);
              filled.setAttribute('contenteditable','false');
              filled.setAttribute('role','button');
              filled.setAttribute('tabindex','0');
              filled.textContent = val;
              if (chipEl && chipEl.parentNode) {
                var original = chipEl.cloneNode(true);
                var parent = chipEl.parentNode;
                parent.replaceChild(filled, chipEl);
                try { hideIntroHelp(); } catch(_) {}
                // Feedback + undo
                try {
                  var block = parent.closest ? parent.closest('p, li, h1, h2, h3, h4, blockquote') : parent;
                  showUndoToast('Filled "'+ (key.replace(/_/g,' ')) +'"', function(){
                    try {
                      if (filled && filled.parentNode) filled.parentNode.replaceChild(original, filled);
                      try { var ed=document.getElementById('editor'); if (ed) ed.focus(); } catch(_) {}
                      try { if (original && original.focus) original.focus(); } catch(_) {}
                      return true; // handled caret
                    } catch(_) { return false; }
                  }, block || parent);
                } catch(_) {}
              }
              try { if (key === 'occupation' || key === 'work_type') updateArticleHeuristic(filled); } catch(_) {}
              try { tidyLeadPunctuation(filled); } catch(_) {}
              menu.style.display = 'none';
            };
            var cancel = function(){
              var wrap = menu.querySelector('.chip-custom-entry');
              if (wrap && wrap.parentNode) wrap.parentNode.removeChild(wrap);
              input.removeEventListener('keydown', onKey);
            };
            var onKey = function(ev){ if (ev.key === 'Enter') { ev.preventDefault(); submit(); } };
            input.addEventListener('keydown', onKey);
            var submitBtn = menu.querySelector('[data-chip-submit]');
            var cancelBtn = menu.querySelector('[data-chip-cancel]');
            if (submitBtn) submitBtn.addEventListener('click', function(ev){ ev.preventDefault(); submit(); });
            if (cancelBtn) cancelBtn.addEventListener('click', function(ev){ ev.preventDefault(); cancel(); });
          }
        });
      });

      // Auto-open the custom input when there are no curated values, so users can type immediately
      if (nonCustomCount === 0) {
        const firstCustom = menu.querySelector('[data-chip-custom]');
        if (firstCustom) { try { firstCustom.click(); } catch(_) {} }
      }

      // Close on outside click
      const closeFn = function(ev){
        if (!menu.contains(ev.target) && ev.target !== chipEl) {
          menu.style.display = 'none';
          document.removeEventListener('click', closeFn, true);
        }
      };
      setTimeout(function(){ document.addEventListener('click', closeFn, true); }, 0);
    }

    function getChipSuggestions(key, category, templatesData) {
      // Try templates.json explicit values first (placeholderValues or category-specific suggestionValues)
      var out = [];
      try {
        var K = key.toUpperCase();
        var kLower = key.toLowerCase();
        // Key alias map to tolerate template/key drift
        var aliases = {
          'current_status': ['current_position','current_role','career_status','industry_status'],
          'major_achievements': ['major_contributions','career_highlights','notable_contributions'],
          'recognition': ['recognition_awards','awards','awards_and_honors','honors']
        };
        var candidates = [kLower].concat(aliases[kLower] || []);
        if (templatesData) {
          // 1) New userInteractionValues with category nesting support
          if (templatesData.userInteractionValues) {
            // a) Category-scoped values e.g., userInteractionValues.PERSON.birth_date
            var catKey = (function(c){ switch(c){ case 'person': return 'PERSON'; case 'place': return 'LOCATION'; case 'species': return 'SPECIES'; case 'organization': return 'ORGANIZATION'; case 'academic': return 'ACADEMIC'; case 'event': return 'EVENT'; default: return null; } })(category);
            if (catKey && templatesData.userInteractionValues[catKey]) {
              var catMap = templatesData.userInteractionValues[catKey];
              for (var i=0;i<candidates.length && (!out || out.length===0);i++) {
                var cc = candidates[i];
                if (Array.isArray(catMap[cc])) {
                  out = catMap[cc].slice(0, 8);
                }
              }
            }
            // b) Global values at root (lowercase keys)
            if (!out || out.length===0) {
              for (var j=0;j<candidates.length && (!out || out.length===0);j++) {
                var c2 = candidates[j];
                if (Array.isArray(templatesData.userInteractionValues[c2])) {
                  out = templatesData.userInteractionValues[c2].slice(0, 8);
                }
              }
            }
          }
          // 2) Legacy placeholderValues (UPPERCASE keys)
          if ((!out || out.length === 0) && templatesData.placeholderValues && Array.isArray(templatesData.placeholderValues[K])) {
            out = templatesData.placeholderValues[K].slice(0, 8);
          }
          // 3) Legacy placeholderMappings.userInteractionValues (UPPERCASE keys)
          if ((!out || out.length === 0) && templatesData.placeholderMappings && templatesData.placeholderMappings.userInteractionValues) {
            var uv = templatesData.placeholderMappings.userInteractionValues[K];
            if (Array.isArray(uv)) out = uv.slice(0, 8);
          }
          // Category-specific suggestionValues support
          var catKey = (function(c){ switch(c){ case 'person': return 'PERSON'; case 'place': return 'LOCATION'; case 'species': return 'SPECIES'; case 'organization': return 'ORGANIZATION'; case 'academic': return 'ACADEMIC'; case 'event': return 'EVENT'; default: return null; } })(category);
          if ((!out || out.length===0) && catKey && templatesData.categories && templatesData.categories[catKey]) {
            var catData = templatesData.categories[catKey];
            // Prefer lowercase keys at category level, else UPPERCASE
            if (catData.suggestionValues && (Array.isArray(catData.suggestionValues[kLower]) || Array.isArray(catData.suggestionValues[K]))) {
              out = (catData.suggestionValues[kLower] || catData.suggestionValues[K]).slice(0, 8);
            }
          }
        }
      } catch(_) {}
      if (out && out.length) return out;
      // Fallback static suggestions
      switch(key) {
        case 'current_status': return ['has been the wealthiest person in the world','is the third richest person in the world','serves as chairman and CEO','plays for Inter Miami','Custom...'];
        case 'major_achievements': return ['pioneering research in machine learning','breakthroughs in electric vehicles and reusable rockets','landmark albums and chart-topping singles','multiple championship titles and MVP awards','Custom...'];
        case 'recognition': return ['recipient of the Nobel Prize','inducted into the Hall of Fame','awarded the Presidential Medal of Freedom','recipient of multiple Grammy Awards','Custom...'];
        case 'pronunciation': return ['EE-lon','MUSK','BAY-zohss','lə-BRON','Custom...'];
        case 'birth_date': return ['June 28, 1971','October 28, 1955','January 12, 1964','December 13, 1989','December 30, 1984','Custom...'];
        case 'known_for': return ['known for his leadership of Tesla, SpaceX, and X','best known as the founder of Amazon','known for autobiographical songwriting','Custom...'];
        case 'nationality': return ['American','British','Indian','French','German'];
        case 'occupation': return ['scientist','artist','politician','entrepreneur','athlete'];
        case 'achievement': return ['pioneering research','notable inventions','influential works','groundbreaking discoveries'];
        case 'type': return category==='place' ? ['city','town','region','capital'] : ['organization','concept','event'];
        case 'region': return ['United States','Europe','India','Asia','Africa'];
        case 'feature': return ['historic architecture','cultural heritage','economic significance','natural beauty'];
        case 'year': return ['1990','2000','2010','2020'];
        case 'location': return ['New York','London','Delhi','Paris'];
        case 'field': return ['physics','biology','computer science','economics'];
        case 'taxon_rank': return ['species','genus','family','order'];
        case 'habitat': return ['forests','wetlands','grasslands','mountains'];
        case 'purpose': return ['education','research','community service','innovation'];
        case 'significance': return ['wide impact','historical importance','scientific relevance'];
        case 'definition': return ['a key idea','a widely used concept','a foundational principle'];
        case 'importance': return ['influences many areas','guides current practice','shaped modern thinking'];
        case 'date': return ['1 January 2000','15 August 1995','20 June 2010'];
        default:
          // No generic placeholders; return empty so UI can show only Custom…
          return [];
      }
    }

    function getChipHeaderHintFromTemplates(templatesData, key) {
      try {
        if (!templatesData || !templatesData.placeholderMappings || !templatesData.placeholderMappings.userInteractionValues) return null;
        var v = templatesData.placeholderMappings.userInteractionValues[key.toUpperCase()];
        if (typeof v === 'string') return v; // use descriptive hint as header
        return null;
      } catch(_) { return null; }
    }

    // Toggle Suggestions chip via toolbar button
    function toggleSuggestionsChip() {
      var chip = document.getElementById('assistChip');
      var menu = document.getElementById('assistMenu');
      if (!chip) return;
      var editor = document.getElementById('editor');
      function selectionInsideEditor() {
        var sel = window.getSelection();
        return !!(sel && sel.rangeCount && editor && editor.contains(sel.anchorNode));
      }
      function getTopVisibleBlockInEditor() {
        if (!editor) return null;
        var editorRect = editor.getBoundingClientRect();
        var blocks = Array.from(editor.querySelectorAll('p, h1, h2, h3, h4, h5, h6, li, blockquote'))
          .filter(function(el){ return el.id !== 'assistChip' && el.id !== 'assistMenu' && el.offsetParent !== null; });
        var best = null; var bestDelta = Infinity;
        for (var i=0;i<blocks.length;i++) {
          var r = blocks[i].getBoundingClientRect();
          // consider only blocks intersecting editor viewport region
          var intersects = r.bottom > editorRect.top && r.top < editorRect.bottom;
          if (!intersects) continue;
          var delta = Math.abs(r.top - editorRect.top);
          if (delta < bestDelta) { bestDelta = delta; best = blocks[i]; }
        }
        // fallback to first child paragraph-like if nothing intersected
        if (!best) best = blocks.find(function(el){ return el.tagName === 'P'; }) || blocks[0] || null;
        return best;
      }
      // Open when menu is not visible; otherwise close
      function isVisible(el){
        try {
          if (!el) return false;
          if (el.style && el.style.display === 'none') return false;
          const r = el.getBoundingClientRect();
          return (r.width > 0 || r.height > 0);
        } catch(_) { return false; }
      }
      var isMenuOpen = (typeof isAssistMenuOpen === 'function') ? isAssistMenuOpen() : isVisible(menu);
      if (!isMenuOpen) {
        var editor = document.getElementById('editor');
        var lastAnchor = (typeof window.__assistGetLastAnchor === 'function') ? window.__assistGetLastAnchor() : null;
        var anchor = null;
        // Prefer a valid last anchor inside the editor for stability
        if (lastAnchor && editor && editor.contains(lastAnchor)) {
          anchor = lastAnchor;
        } else if (selectionInsideEditor()) {
          // derive current block from selection
          var sel = window.getSelection();
          var node = sel.getRangeAt(0).startContainer;
          if (node.nodeType === Node.TEXT_NODE) node = node.parentElement;
          anchor = node && node.closest ? node.closest('p, h1, h2, h3, h4, h5, h6, li, blockquote') : null;
        }
        if (!anchor) {
          anchor = getTopVisibleBlockInEditor();
        }
        showSuggestionsChip(anchor);
        // Also open the menu for convenience
        if (menu) {
          if (window.buildMainMenu) window.buildMainMenu();
          menu.style.display = 'block';
          menu.style.left = chip.style.left;
          menu.style.top = (parseInt(chip.style.top||'0',10)+32)+'px';
          // Keep chip/menu responsive; do not freeze positioning while menu is open
          try { menu.style.zIndex = '5001'; } catch(_) {}
          if (window.__assistSetFrozen) window.__assistSetFrozen(false);
        }
      } else {
        hideSuggestionsChip();
        if (window.__assistSetFrozen) window.__assistSetFrozen(false);
      }
    }

    function insertSimpleIntroduction() {
      if (window.perfTweaks) { try { ensureSelectionInEditor(document.getElementById('editor')); } catch(_) {} }
      if (window.perfTweaks) __insertingContent = true;
      var editor = document.getElementById('editor');
      var title = (window.articleTitleText || 'This topic');
      var category = (window.selectedCat || 'other');
      var text = (typeof generateTopicSentence === 'function') ? generateTopicSentence(title, category) : (title + ' — introduction.');
      var pid = 'simpleIntro-' + Date.now();
      var html = '<p id="'+pid+'">'+ text +'</p>';
      // Always place intro at the top (before any sections), or replace the lead placeholder if present
      var lead = document.getElementById('leadPlaceholder');
      if (lead && lead.parentNode === editor) {
        lead.outerHTML = html;
      } else {
        var firstH2 = editor.querySelector('h2');
        if (firstH2) {
          firstH2.insertAdjacentHTML('beforebegin', html);
        } else {
          editor.insertAdjacentHTML('afterbegin', html);
        }
      }
      editor.focus();
      // Anchor chip to the newly inserted paragraph and keep it visible when appropriate
      var el = document.getElementById(pid);
      if (el) {
        var chip = document.getElementById('assistChip');
        var chipVisible = chip && chip.style.display !== 'none';
        var hadSectionsBefore = editor.querySelectorAll('h2').length > 0;
        var shouldReanchor = (!chipVisible) || (!hadSectionsBefore);
        if (shouldReanchor) {
          try { if (typeof positionChipBelowElement === 'function') positionChipBelowElement(el); } catch(_) {}
          try { if (typeof showSuggestionsChip === 'function') showSuggestionsChip(el); } catch(_) {}
        }
        try { window.lastIntroId = pid; } catch(_) {}
        // Place caret after the Reference chip (end of paragraph)
        try {
          var elNode = document.getElementById(pid);
          var refChip2 = elNode && elNode.querySelector('.ref-chip');
          if (refChip2) { placeCaretAfterNode(refChip2); }
          else if (elNode) { placeCaretAtEnd(elNode); }
        } catch(_) {}
        // Feedback + undo
        try {
          showUndoToast('Inserted introduction', function(){ 
            var x=document.getElementById(pid); 
            if (x && x.parentNode) x.parentNode.removeChild(x); 
            try { hideIntroHelp(); } catch(_) {}
            // Restore placeholder if editor becomes empty
            setTimeout(function() { 
              if (window.restorePlaceholderIfEmpty) window.restorePlaceholderIfEmpty(); 
            }, 0);
          }, el);
        } catch(_) {}
      }
      if (window.perfTweaks) __schedule(function(){ __insertingContent = false; });
    }

    function insertIntroText(text) {
      if (window.perfTweaks) { try { ensureSelectionInEditor(document.getElementById('editor')); } catch(_) {} }
      if (window.perfTweaks) __insertingContent = true;
      var editor = document.getElementById('editor');
      var pid = 'introText-' + Date.now();
      var html = '<p id="'+pid+'">'+ escapeHtml(text) +'</p>';
      insertHTMLAtCursor(html, editor);
      editor.focus();
      var el = document.getElementById(pid);
      if (el) {
        var chip = document.getElementById('assistChip');
        var chipVisible = chip && chip.style.display !== 'none';
        var hadSectionsBefore = editor.querySelectorAll('h2').length > 0;
        var shouldReanchor = (!chipVisible) || (!hadSectionsBefore);
        if (shouldReanchor) {
          try { if (typeof positionChipBelowElement === 'function') positionChipBelowElement(el); } catch(_) {}
          try { if (typeof showSuggestionsChip === 'function') showSuggestionsChip(el); } catch(_) {}
        }
        try { window.lastIntroId = pid; } catch(_) {}
        // Feedback + undo
        try {
          showUndoToast('Inserted introduction', function(){ 
            var x=document.getElementById(pid); 
            if (x && x.parentNode) x.parentNode.removeChild(x); 
            // Restore placeholder if editor becomes empty
            setTimeout(function() { 
              if (window.restorePlaceholderIfEmpty) window.restorePlaceholderIfEmpty(); 
            }, 0);
          }, el);
        } catch(_) {}
      }
      if (window.perfTweaks) __schedule(function(){ __insertingContent = false; });
    }

    function insertChipStyleStarter(title, category) {
      if (window.perfTweaks) { try { ensureSelectionInEditor(document.getElementById('editor')); } catch(_) {} }
      if (window.perfTweaks) __insertingContent = true;
      var editor = document.getElementById('editor');
      var base = title + ' is ' + '[DEFINITION]' + '. It is significant because ' + '[IMPORTANCE]' + '.';
      // Turn into placeholders like other templates
      var html = base.replace(/\[([^\]]+)\]/g, function(_, key){
        var label = (function prettify(k){ try { return k.replace(/_/g,' ').toLowerCase(); } catch(_) { return k; } })(key);
        return '<span class="template-placeholder" data-placeholder="'+key+'" contenteditable="false" role="button" tabindex="0">'+label+'</span>';
      });
      // Append a Reference chip to encourage sourcing
      var pid = 'introTpl-'+Date.now();
      html = '<p id="'+pid+'">' + html + ' <span class="ref-chip action-chip" contenteditable="false" role="button" tabindex="0"><span class="icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="m15 10-2.78-2.78L9.44 10V1H5a2 2 0 00-2 2v14a2 2 0 002 2h10a2 2 0 002-2V3a2 2 0 00-2-2z"></path></svg></span>Reference</span></p>';
      var lead = document.getElementById('leadPlaceholder');
      if (lead && lead.parentNode === editor) {
        lead.outerHTML = html;
      } else {
        var firstH2 = editor.querySelector('h2');
        if (firstH2) {
          firstH2.insertAdjacentHTML('beforebegin', html);
        } else {
          editor.insertAdjacentHTML('afterbegin', html);
        }
      }
      editor.focus();
      var el = document.getElementById(pid);
      if (el) {
        var chip = document.getElementById('assistChip');
        var chipVisible = chip && chip.style.display !== 'none';
        var hadSectionsBefore = editor.querySelectorAll('h2').length > 0;
        var shouldReanchor = (!chipVisible) || (!hadSectionsBefore);
        if (shouldReanchor) {
          try { if (typeof positionChipBelowElement === 'function') positionChipBelowElement(el); } catch(_) {}
          try { if (typeof showSuggestionsChip === 'function') showSuggestionsChip(el); } catch(_) {}
        }
        // One-time help below the inserted intro template (chip-style)
        try { showIntroHelp(el); } catch(_) {}
        try { window.lastIntroId = pid; } catch(_) {}
        // Feedback + undo
        try {
          showUndoToast('Inserted template starter', function(){ 
            var x=document.getElementById(pid); 
            if (x && x.parentNode) x.parentNode.removeChild(x); 
            try { hideIntroHelp(); } catch(_) {}
            // Restore placeholder if editor becomes empty
            setTimeout(function() { 
              if (window.restorePlaceholderIfEmpty) window.restorePlaceholderIfEmpty(); 
            }, 0);
          }, el);
        } catch(_) {}
        // Ensure publish becomes available even without typing
        try { enablePublishUI(); } catch(_) {}
      }
      if (window.perfTweaks) __schedule(function(){ __insertingContent = false; });
    }

    // Insert an editable introduction template with inline chips and a Reference chip
    function insertIntroTemplate(title, category) {
      if (window.perfTweaks) { try { ensureSelectionInEditor(document.getElementById('editor')); } catch(_) {} }
      if (window.perfTweaks) __insertingContent = true;
      var editor = document.getElementById('editor');
      // Deterministic insert (no selection).
      var chip = document.getElementById('assistChip');
      var chipVisible = chip && chip.style.display !== 'none';
      var hadSectionsBefore = editor.querySelectorAll('h2').length > 0;
      var hadLeadPlaceholder = !!document.getElementById('leadPlaceholder');
      var base = getIntroTemplateBase(title, category);
      var htmlBody = base.replace(/\[([^\]]+)\]/g, function(_, key){
        var label = (function prettify(k){ try { return k.replace(/_/g,' ').toLowerCase(); } catch(_) { return k; } })(key);
        return '<span class="template-placeholder" data-placeholder="'+key+'" contenteditable="false" role="button" tabindex="0">'+label+'</span>';
      });
      var pid = 'introTpl-' + Date.now();
      var __tR = (typeof window.__i18nGet === 'function') ? window.__i18nGet : function(k,p,f){ return f||k; };
      var html = '<p id="'+pid+'">' + htmlBody + ' <span class="ref-chip action-chip" contenteditable="false" role="button" tabindex="0"><span class="icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="m15 10-2.78-2.78L9.44 10V1H5a2 2 0 00-2 2v14a2 2 0 002 2h10a2 2 0 002-2V3a2 2 0 00-2-2z"></path></svg></span>'+ __tR('chips.reference','Reference') +'</span></p>';
      suppressChipPositioning = true;
      var lead = document.getElementById('leadPlaceholder');
      if (lead && lead.parentNode === editor) {
        lead.outerHTML = html;
      } else {
        // ALWAYS insert intro at the very beginning of the editor, before any existing content
        editor.insertAdjacentHTML('afterbegin', html);
      }
      // After insertion, run simple punctuation cleanup and article heuristic
      try {
        var __introEl = document.getElementById(pid);
        if (__introEl) { updateArticleHeuristic(__introEl); tidyLeadPunctuation(__introEl); }
      } catch(_) {}
      // Position chip/menu below the inserted paragraph without using selection
      setTimeout(function(){
        var el = document.getElementById(pid);
        try {
          // Only re-anchor to intro if no sections existed or chip isn't visible yet
          var shouldReanchor = (!chipVisible) || (!hadSectionsBefore) || hadLeadPlaceholder;
          if (shouldReanchor) {
            if (typeof positionChipBelowElement === 'function') positionChipBelowElement(el);
            if (typeof showSuggestionsChip === 'function') showSuggestionsChip(el);
          }
          // One-time help below the inserted intro template
          try { showIntroHelp(el); } catch(_) {}
          // Place caret after the Reference chip (end of paragraph)
          try {
            var refChip = el && el.querySelector('.ref-chip');
            if (refChip) { placeCaretAfterNode(refChip); }
            else { placeCaretAtEnd(el); }
          } catch(_) {}
          try { window.lastIntroId = pid; } catch(_) {}
          // Feedback + undo
          try { showUndoToast('Inserted intro template', function(){ 
            var x=document.getElementById(pid); 
            if (x && x.parentNode) x.parentNode.removeChild(x); 
            try { hideIntroHelp(); } catch(_) {}
            // Restore placeholder if editor becomes empty
            setTimeout(function() { 
              if (window.restorePlaceholderIfEmpty) window.restorePlaceholderIfEmpty(); 
            }, 0);
          }, el); } catch(_) {}
          // Ensure publish becomes available even without typing
          try { enablePublishUI(); } catch(_) {}
        } catch(_) {}
        suppressChipPositioning = false;
        if (window.perfTweaks) __schedule(function(){ __insertingContent = false; });
      }, 0);
      // Keep chip visible; menu was already closed by the click handler
    }

    function getIntroTemplateBase(title, category) {
      var t = title || 'This topic';
      // Prefer structured templates from templates.json if available
      var base = getIntroTemplateBaseFromTemplatesJson(t, category);
      if (base) return base;
      switch(category) {
        case 'person':
          return t + ' ([BIRTH_YEAR]' + ' – ' + '[DEATH_YEAR]' + ') was a [NATIONALITY] [OCCUPATION] who [ACHIEVEMENT].';
        case 'place':
          return t + ' is the [TYPE] in [REGION], with [POPULATION] and known for [FEATURE].';
        case 'organization':
          return t + ' is a [TYPE] of the [AFFILIATION] established in [YEAR], headquartered in [LOCATION], responsible for [PURPOSE].';
        case 'species':
          return 'The ' + t + ' ([SCIENTIFIC_NAME]) is a [TAXON_RANK] native to [HABITAT], noted for [FEATURE].';
        case 'academic':
          return t + ' is a fundamental theory in [FIELD] that [DEFINITION].';
        case 'event':
          return t + ' was the [TYPE] that took place in [LOCATION] on [DATE], noted for [SIGNIFICANCE].';
        default:
          return t + ' is [DEFINITION] and is significant because [IMPORTANCE].';
      }
    }

    function getIntroTemplateBaseFromTemplatesJson(title, category) {
      try {
        var data = window.templatesData;
        if (!data || !data.categories) return null;
        var catKey = (function(c){
          switch(c){
            case 'person': return 'PERSON';
            case 'place': return 'LOCATION';
            case 'species': return 'SPECIES';
            case 'organization': return 'ORGANIZATION';
            case 'academic': return 'ACADEMIC';
            case 'event': return 'EVENT';
            case 'creative': return 'CREATIVE';
            case 'other': return 'OTHER';
            default: return null;
          }
        })(category);
        if (!catKey || !data.categories[catKey]) return null;
        var cat = data.categories[catKey];
        // Try subcategory detection using simple keyword match on the title
        var tpl = null;
        try {
          if (cat.subcategories) {
            var t = String(title||'').toLowerCase();
            var keys = Object.keys(cat.subcategories);
            for (var i=0;i<keys.length;i++) {
              var sc = cat.subcategories[keys[i]];
              var kws = (sc && Array.isArray(sc.detectionKeywords)) ? sc.detectionKeywords : [];
              var hit = kws.some(function(k){ return t.indexOf(String(k||'').toLowerCase()) !== -1; });
              if (hit) { tpl = (sc.introductionTemplates && sc.introductionTemplates.formal) || null; break; }
            }
          }
        } catch(_) {}
        if (!tpl) tpl = (cat.defaultTemplate && cat.defaultTemplate.formal) || null;
        if (!tpl) return null;
        // Convert {{KEY}} syntax to our [KEY] chips, with a couple direct replacements
        var out = tpl;
        out = out.replace(/\{\{FULL_NAME\}\}/g, title);
        // Insert an adjustable article token (a/an)
        out = out.replace(/\{\{ARTICLE\}\}/g, '<span class="article-chip" contenteditable="false" data-article="a">a</span>');
        out = out.replace(/\{\{([A-Z0-9_]+)\}\}/g, function(_, key){ return '['+key+']'; });
        return out;
      } catch(_) { return null; }
    }

    // Heuristic: compute a/an for ARTICLE spans based on following term
    function updateArticleHeuristic(scopeEl) {
      try {
        var root = scopeEl || document;
        var art = root.querySelector('.article-chip');
        if (!art) return;
        function chooseArticle(word){
          if (!word) return 'a';
          var w = String(word).trim();
          var first = w.charAt(0).toLowerCase();
          var anList = ['a','e','i','o','u'];
          var specialAn = [/^honest/i, /^hour/i, /^heir/i, /^herb/i];
          var specialA = [/^uni(\b|[^a-z])/i, /^use/i, /^euro/i];
          if (specialA.some(function(r){return r.test(w);})){ return 'a'; }
          if (specialAn.some(function(r){return r.test(w);})){ return 'an'; }
          return anList.indexOf(first) !== -1 ? 'an' : 'a';
        }
        // Prefer a filled chip-value sibling, otherwise fallback to placeholder key
        var val = '';
        // Check immediate next siblings in paragraph order
        var node = art.nextSibling;
        while (node && node.nodeType === Node.TEXT_NODE && !node.textContent.trim()) node = node.nextSibling;
        if (node && node.nodeType === Node.ELEMENT_NODE && node.classList.contains('chip-value')) {
          val = node.textContent || '';
        } else {
          var p = art.closest('p');
          if (p) {
            var ph = p.querySelector('.template-placeholder[data-placeholder="OCCUPATION"]') || p.querySelector('.template-placeholder[data-placeholder="WORK_TYPE"]');
            if (ph) val = (ph.getAttribute('data-placeholder')||'').replace(/_/g,' ').toLowerCase();
          }
        }
        var chosen = chooseArticle(val);
        art.textContent = chosen;
        art.setAttribute('data-article', chosen);
      } catch(_) {}
    }

    // Simple punctuation tidy for lead parenthesis (no external lookups)
    function tidyLeadPunctuation(scopeEl){
      try {
        var p = scopeEl && scopeEl.closest ? scopeEl.closest('p') : document.querySelector('#editor p');
        if (!p) return;
        var html = p.innerHTML;
        html = html.replace(/\s+([,;:.])/g, '$1').replace(/\(\s+/g,'(').replace(/\s+\)/g,')').replace(/\s{2,}/g,' ');
        // Drop ";" after opening paren if there is no pronunciation chip/value
        var hasPron = /data-placeholder="PRONUNCIATION"|data-key="pronunciation"|data-prop="P898"|ipa/i.test(html);
        if (!hasPron) html = html.replace(/\(\s*;\s*/,'(');
        p.innerHTML = html;
      } catch(_) {}
    }

    function getChipStyleStarterPreview(title, category) {
      return title + ' is [definition]. It is significant because [importance].';
    }

    function generateSampleIntroductions(title, category) {
      var t = title || 'This topic';
      switch(category) {
        case 'person':
          return [
            t + ' (' + new Date().getFullYear() + ') is a notable figure known for contributions in their field.',
            t + ' is best known for significant achievements that have influenced their area of work.'
          ];
        case 'place':
          return [
            t + ' is a city recognized for its history, culture, and regional significance.',
            'Located in a notable region, ' + t + ' has developed as a center of activity and heritage.'
          ];
        case 'organization':
          return [
            t + ' is an organization established to advance specific goals and activities.',
            'Founded to address important needs, ' + t + ' operates across relevant domains.'
          ];
        case 'species':
          return [
            'The ' + t + ' is a species noted for its distinctive characteristics and habitat.',
            t + ' is recognized for key traits and its role within its ecosystem.'
          ];
        case 'academic':
          return [
            t + ' is a concept that describes a key idea within its academic field.',
            'In academic contexts, ' + t + ' refers to a foundational principle with wide applications.'
          ];
        case 'event':
          return [
            t + ' was an event of importance that shaped subsequent developments.',
            'Occurring within a specific context, ' + t + ' had notable impact and outcomes.'
          ];
        default:
          return [
            t + ' is an encyclopedic topic of interest with broader relevance.',
            'This article introduces ' + t + ' and summarizes key aspects readers should know.'
          ];
      }
    }

    function escapeHtml(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function getSectionSuggestions(cat) {
      switch(cat) {
        case 'person': return ['Background','Career'];
        case 'place': return ['History','Geography'];
        case 'species': return ['Description','Habitat'];
        case 'organization': return ['History','Activities'];
        default: return ['Background','Overview'];
      }
    }

    // Monotonic counter to build unique IDs for inserted paragraphs
    window.__sectionInsertSeq = window.__sectionInsertSeq || 0;

    // Global insertion queue to prevent race conditions during rapid section additions
    window.__sectionInsertionQueue = window.__sectionInsertionQueue || [];
    window.__sectionInsertionActive = window.__sectionInsertionActive || false;

    function insertSectionSkeleton(name) {
      // Queue this insertion to prevent race conditions
      console.log('[SECTION-INSERT] 🚀 Queueing section:', name, 'Queue length:', window.__sectionInsertionQueue.length, 'Active:', window.__sectionInsertionActive);
      return new Promise(function(resolve) {
        var startTime = performance.now();
        window.__sectionInsertionQueue.push({ name: name, resolve: resolve, startTime: startTime });
        
        // Process queue if not already processing
        if (!window.__sectionInsertionActive) {
          console.log('[SECTION-INSERT] 🎬 Starting queue processing');
          processInsertionQueue();
        }
      });
    }

    function processInsertionQueue() {
      if (window.__sectionInsertionQueue.length === 0) {
        console.log('[SECTION-INSERT] 🏁 Queue empty, stopping processing');
        window.__sectionInsertionActive = false;
        return;
      }
      
      window.__sectionInsertionActive = true;
      var next = window.__sectionInsertionQueue.shift();
      var queueTime = performance.now() - next.startTime;
      console.log('[SECTION-INSERT] 🔄 Processing:', next.name, 'Queue time:', Math.round(queueTime) + 'ms', 'Remaining:', window.__sectionInsertionQueue.length);
      
      // Execute the original insertion logic
      var insertStart = performance.now();
      var result = actualInsertSectionSkeleton(next.name);
      var insertTime = performance.now() - insertStart;
      console.log('[SECTION-INSERT] ⚡ Insert completed:', next.name, 'Insert time:', Math.round(insertTime) + 'ms');
      
      // Continue processing queue after a brief delay to ensure DOM settles
      setTimeout(function() {
        var totalTime = performance.now() - next.startTime;
        console.log('[SECTION-INSERT] ✅ Total time for', next.name + ':', Math.round(totalTime) + 'ms');
        next.resolve(result);
        processInsertionQueue();
      }, 10);
    }

    function actualInsertSectionSkeleton(name) {
      console.log('[SECTION-INSERT] 🔍 Starting actualInsertSectionSkeleton for:', name);
      var editor = document.getElementById('editor');
      if (!editor) {
        console.log('[SECTION-INSERT] ❌ No editor found');
        return null;
      }
      // Prevent the assist menu from auto-hiding due to outside-click logic during insertion
      try { window.__suppressAssistMenuHide = true; } catch(_) {}
      // Prevent duplicates: if a section with the same title already exists, don't insert again
      console.log('[SECTION-INSERT] 🔎 Checking for duplicate sections');
      try {
        var normName = String(name||'').trim().toLowerCase();
        var headers = Array.from(editor.querySelectorAll('h2'));
        console.log('[SECTION-INSERT] 📊 Found', headers.length, 'existing h2 headers');
        for (var i=0;i<headers.length;i++){
          var t = (headers[i].textContent||'').trim().toLowerCase();
          if (t === normName) {
            console.log('[SECTION-INSERT] ♻️ Section exists — converting first paragraph to template:', name);
            // If section exists, interpret reinsertion as request to apply the template
            var headerEl = headers[i];
            var p = headerEl.nextElementSibling;
            // If there's no paragraph right after header, create one
            if (!p || p.tagName.toLowerCase() !== 'p') {
              headerEl.insertAdjacentHTML('afterend', '<p></p>');
              p = headerEl.nextElementSibling;
            }
            try { insertSectionTemplateAtParagraph(p, name); } catch(_) {}
            // Anchor assist UI to that paragraph
            if (typeof positionChipBelowElement === 'function') positionChipBelowElement(p);
            if (typeof showSuggestionsChip === 'function') showSuggestionsChip(p);
            // Clear suppression shortly after
            setTimeout(function(){ try { window.__suppressAssistMenuHide = false; } catch(_) {} }, 120);
            return headerEl.closest('.section-block') || p || headerEl;
          }
        }
      } catch(_) {}
      console.log('[SECTION-INSERT] 🏗️ Building HTML for new section:', name);
      var id = name.replace(/\s+/g,'_');
      var heading = '<h2 id="'+id+'" style="font-family: Georgia, serif; font-size:1.5em; font-weight:normal; margin:2em 0 0.25em 0; padding:0; border-bottom:1px solid #eaecf0; padding-bottom:0.25em;">'+escapeHtml(name)+'</h2>';
      var paraStart = performance.now();
      var para = buildSectionParagraphWithChips(name);
      var paraTime = performance.now() - paraStart;
      console.log('[SECTION-INSERT] 📝 buildSectionParagraphWithChips time:', Math.round(paraTime) + 'ms');
      // Concept: Section Helper. When enabled, insert a plain placeholder paragraph first,
      // and offer an inline helper to optionally insert the template.
      try {
        if (window.__sectionHelperEnabled === undefined) window.__sectionHelperEnabled = true; // feature flag
        if (window.__sectionHelperEnabled) {
          var __t = (typeof window.__i18nGet === 'function') ? window.__i18nGet : function(k,p,f){ return f || k; };
          var promptTxt = (function(){ try { return getWritingPromptForSection(name, (window.selectedCat||'other')); } catch(_) { return __t('editor.sectionPlaceholder',{ section: name.toLowerCase() }, 'Click here to start writing about {section}.'); } })();
          // Defer ID injection to later code path (we replace <p> with id afterward)
          para = '<p style="margin: 1.1em 0; color:#72777d; font-style:italic;" data-placeholder="'+ escapeHtml(promptTxt) +'">'+
                   '<span class="sh-placeholder">'+ escapeHtml(promptTxt) +'</span>'+
                 '</p>';
        }
      } catch(_) {}
      // Ensure we can reference the new paragraph element after insertion
      window.__sectionInsertSeq += 1;
      var newParaId = 'sectionPara-' + Date.now() + '-' + window.__sectionInsertSeq;
      console.log('[SECTION-INSERT] 🆔 Generated para ID:', newParaId);
      // Replace <p> or <p > with <p id="...">
      if (para.indexOf('<p>') !== -1) {
        para = para.replace('<p>', '<p id="'+newParaId+'">');
      } else if (para.indexOf('<p ') !== -1) {
        para = para.replace('<p ', '<p id="'+newParaId+'" ');
      }
      var html = '<div class="section-block" data-section="'+escapeHtml(name)+'" data-section-id="'+id+'">'+
                   '<button class="section-dismiss" title="Remove section" aria-label="Remove section" contenteditable="false">×</button>'+
                   heading + para +
                 '</div>';
      // Placement: respect templates.json defaultSections order when available
      console.log('[SECTION-INSERT] 📍 Determining placement for:', name);
      var placed = false;
      var placementStart = performance.now();
      try {
        function norm(s){ return String(s||'').trim().toLowerCase(); }
        function catToKey(c){ switch(c){ case 'person': return 'PERSON'; case 'place': return 'LOCATION'; case 'species': return 'SPECIES'; case 'organization': return 'ORGANIZATION'; case 'academic': return 'ACADEMIC'; case 'event': return 'EVENT'; case 'creative': return 'CREATIVE'; case 'other': return 'OTHER'; default: return null; } }
        var cat = (window.selectedCat || 'other');
        var catKey = catToKey(cat);
        var tdata = window.templatesData;
        var ordered = (tdata && tdata.categories && tdata.categories[catKey] && Array.isArray(tdata.categories[catKey].defaultSections)) ? tdata.categories[catKey].defaultSections.map(function(s){ return norm(s.title||''); }) : [];
        var targetIdx = ordered.indexOf(norm(name));
        if (targetIdx >= 0 && ordered.length) {
          var headers = Array.from(editor.querySelectorAll('h2'));
          var existing = [];
          headers.forEach(function(h){
            var tx = norm(h.textContent||'');
            var idx = ordered.indexOf(tx);
            if (idx >= 0) existing.push({ idx: idx, el: h });
          });
          var next = null; var minHigher = Infinity;
          existing.forEach(function(e){ if (e.idx > targetIdx && e.idx < minHigher) { minHigher = e.idx; next = e.el; } });
          if (next) {
            console.log('[SECTION-INSERT] 📌 Placing before existing section:', next.textContent);
            next.insertAdjacentHTML('beforebegin', html);
            placed = true;
          } else {
            var refs = editor.querySelector('#References');
            if (refs) { 
              console.log('[SECTION-INSERT] 📌 Placing before References section');
              refs.insertAdjacentHTML('beforebegin', html); 
              placed = true; 
            }
          }
        }
      } catch(e) { console.log('[SECTION-INSERT] ❌ Placement error:', e); }
      var placementTime = performance.now() - placementStart;
      console.log('[SECTION-INSERT] ⏱️ Placement logic time:', Math.round(placementTime) + 'ms');
      if (!placed) {
        console.log('[SECTION-INSERT] 🔄 Using fallback placement');
        // Fallback deterministic placement:
        // - before References if present
        // - else append at end if any sections already exist
        // - else after lead placeholder if present
        var refs = editor.querySelector('#References');
        if (refs) {
          console.log('[SECTION-INSERT] 📌 Fallback: before References');
          refs.insertAdjacentHTML('beforebegin', html);
        } else {
          var existingH2 = editor.querySelectorAll('h2').length;
          if (existingH2 > 0) {
            console.log('[SECTION-INSERT] 📌 Fallback: append at end (', existingH2, 'existing sections)');
            editor.insertAdjacentHTML('beforeend', html);
          } else {
            var lead = document.getElementById('leadPlaceholder');
            if (lead && lead.parentNode === editor) {
              console.log('[SECTION-INSERT] 📌 Fallback: after lead placeholder');
              lead.insertAdjacentHTML('afterend', html);
            } else {
              console.log('[SECTION-INSERT] 📌 Fallback: append at very end');
              editor.insertAdjacentHTML('beforeend', html);
            }
          }
        }
      }
      // Keep lead placeholder available - only remove when user actually writes intro content
      // This ensures "Insert intro template" remains accessible even after adding sections
      console.log('[SECTION-INSERT] 📝 Keeping leadPlaceholder available for intro template access');
      // Track section as added
      try {
        if (Array.isArray(window.addedSections)) {
          if (window.addedSections.indexOf(name) === -1) window.addedSections.push(name);
        }
      } catch(_) {}
      // Move caret into the new section paragraph (first placeholder if available) and keep chip visible
      console.log('[SECTION-INSERT] 🎯 Setting up focus and positioning');
      try {
        requestAnimationFrame(function(){
          console.log('[SECTION-INSERT] 🎬 RequestAnimationFrame callback executing');
          try {
            var insertedPara = document.querySelector('#'+newParaId);
            if (!insertedPara) return;
            var firstPh = insertedPara.querySelector('.template-placeholder');
            if (firstPh && firstPh.focus && !window.__sectionHelperEnabled) {
              try { window.__suppressAssistMenuHide = true; } catch(_) {}
              firstPh.focus();
              setTimeout(function(){ try { window.__suppressAssistMenuHide = false; } catch(_) {} }, 50);
            } else {
              // Focus the placeholder paragraph and place caret
              insertedPara.setAttribute('contenteditable', 'true');
              insertedPara.focus();
              var sel = window.getSelection(); sel.removeAllRanges();
              var rg = document.createRange(); rg.selectNodeContents(insertedPara);
              // For the concept helper, start at the beginning of the placeholder text
              if (window.__sectionHelperEnabled) { rg.collapse(true); } else { rg.collapse(false); }
              sel.addRange(rg);
            }
            if (typeof positionChipBelowElement === 'function') positionChipBelowElement(insertedPara);
            if (typeof showSuggestionsChip === 'function') showSuggestionsChip(insertedPara);
            // Show the inline helper if feature is enabled and the paragraph is empty/placeholder
            try {
              if (window.__sectionHelperEnabled && typeof showSectionHelper === 'function') {
                showSectionHelper(insertedPara, name);
              }
            } catch(_) {}
          } catch(_) {}
        });
        
        // Feedback + undo (find block immediately after insertion)  
        try {
          setTimeout(function() {
            var insertedParaForUndo = document.querySelector('#'+newParaId);
            var block = insertedParaForUndo ? insertedParaForUndo.closest('.section-block') : null;
            if (block) {
              showUndoToast('Inserted section: '+ name, function(){ 
                if (block && block.parentNode) block.parentNode.removeChild(block); 
                // Restore placeholder if editor becomes empty
                setTimeout(function() { 
                  if (window.restorePlaceholderIfEmpty) window.restorePlaceholderIfEmpty(); 
                }, 0);
              }, block);
            }
          }, 10); // Quick timeout to ensure DOM is ready
        } catch(_) {}
      } catch(_) {}
      // Hide one-time intro help when any section is successfully inserted
      try { hideIntroHelp(); } catch(_) {}
      // Ensure publish becomes available even without typing
      try { enablePublishUI(); } catch(_) {}
      editor.focus();
      // Keep chip visible after insertion
      // Clear suppression a bit later in case any async focus happens
      setTimeout(function(){ try { window.__suppressAssistMenuHide = false; } catch(_) {} }, 50);
      try { return document.querySelector('#'+newParaId)?.closest('.section-block') || document.querySelector('#'+newParaId) || null; } catch(_) { return null; }
    }

    function buildSectionParagraphWithChips(sectionName) {
      var title = (window.articleTitleText || 'This topic');
      var category = (window.selectedCat || 'other');
      // Prefer templates.json contentTemplate/templateVariations
      var tpl = getSectionTemplateFromTemplates(sectionName, category);
      if (tpl) {
        // Replace {{NAME}}/{{FULL_NAME}} with title
        tpl = tpl.replace(/\{\{(NAME|FULL_NAME)\}\}/g, title);
        // Default ARTICLE to 'a'
        tpl = tpl.replace(/\{\{ARTICLE\}\}/g, 'a');
        // Convert remaining placeholders to chips
        var htmlBody = tpl.replace(/\{\{([^}]+)\}\}/g, function(_, key){
          return '<span class="template-placeholder" data-placeholder="'+key+'" contenteditable="false" role="button" tabindex="0">'+prettifyPlaceholder(key)+'</span>';
        });
          var __tR = (typeof window.__i18nGet === 'function') ? window.__i18nGet : function(k,p,f){ return f||k; };
          return '<p>'+ htmlBody + ' <span class="ref-chip action-chip" contenteditable="false" role="button" tabindex="0"><span class="icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="m15 10-2.78-2.78L9.44 10V1H5a2 2 0 00-2 2v14a2 2 0 002 2h10a2 2 0 002-2V3a2 2 0 00-2-2z"></path></svg></span>'+ __tR('chips.reference','Reference') +'</span></p>';
      }
      // Fallback: use suggestionsData include list to create chip prompts
      try{
        var secMeta = (window.suggestionsData && window.suggestionsData[category] && window.suggestionsData[category].sections) ? window.suggestionsData[category].sections : [];
        var match = null;
        for (var i=0;i<secMeta.length;i++) {
          var s = secMeta[i];
          var n = (typeof s === 'string') ? s : (s.name||'');
          if (n.toLowerCase() === sectionName.toLowerCase()) { match = s; break; }
        }
        var chips = [];
        if (match && typeof match !== 'string' && Array.isArray(match.include)) {
          chips = match.include.slice(0,4).map(function(label){
            var key = label.toUpperCase().replace(/[^A-Z0-9]+/g,'_');
            return '<span class="template-placeholder" data-placeholder="'+key+'" contenteditable="false" role="button" tabindex="0">'+prettifyPlaceholder(key)+'</span>';
          });
        }
        var __t = (typeof window.__i18nGet === 'function') ? window.__i18nGet : function(k,p,f){ return f || k; };
        var prompt = chips.length ? chips.join(' ') : __t('editor.sectionPlaceholder',{ section: sectionName.toLowerCase() }, 'Click here to start writing about {section}.');
        if (chips.length) {
          var __tR = (typeof window.__i18nGet === 'function') ? window.__i18nGet : function(k,p,f){ return f||k; };
          return '<p>'+ prompt + ' <span class="ref-chip action-chip" contenteditable="false" role="button" tabindex="0"><span class="icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="m15 10-2.78-2.78L9.44 10V1H5a 2 2 0 00-2 2v14a 2 2 0 002 2h10a 2 2 0 00-2-2z"></path></svg></span>'+ __tR('chips.reference','Reference') +'</span></p>';
        } else {
          return '<p style="margin:0.75em 0; color:#72777d; font-style:italic;">'+ escapeHtml(prompt) +'</p>';
        }
      } catch(_) {
        var __t = (typeof window.__i18nGet === 'function') ? window.__i18nGet : function(k,p,f){ return f || k; };
        var ptxt = __t('editor.sectionPlaceholder',{ section: sectionName.toLowerCase() }, 'Click here to start writing about {section}.');
        return '<p style="margin:0.75em 0; color:#72777d; font-style:italic;">'+ escapeHtml(ptxt) +'</p>';
      }
    }

    // === Section Helper (Concept) ===
    // Lightweight inline helper that appears after inserting a section.
    // Offers: Template starter, Add from source, Examples, Dismiss.
      (function sectionHelperConcept(){
      // CSS (scoped inline to avoid external file changes)
      try {
        if (!document.getElementById('sectionHelperStyles')) {
          var st = document.createElement('style');
          st.id = 'sectionHelperStyles';
          st.textContent = '\n.section-helper{margin:6px 0 0 0; display:flex; gap:6px; flex-wrap:wrap; align-items:center;}\n.section-helper [data-sh-btn]{border:1px solid #c8ccd1; background:#fff; border-radius:14px; padding:4px 10px; font-size:12px; cursor:pointer;}\n.section-helper [data-sh-btn]:hover{background:#f8f9fa;}\n.section-helper [data-sh-btn][aria-disabled="true"]{opacity:.6; cursor:default;}\n.section-helper .sep{margin:0 2px; color:#a2a9b1;}\n';
          document.head.appendChild(st);
        }
      } catch(_) {}

      window.showSectionHelper = function showSectionHelper(p, sectionName){
        try {
          if (!p || !p.parentNode) return;
          // Avoid duplicates
          if (p.nextElementSibling && p.nextElementSibling.classList && p.nextElementSibling.classList.contains('section-helper')) return;
          // Only show for empty/placeholder paragraphs
          var txt = (p.textContent||'').trim();
          if (txt.length > 0 && !p.hasAttribute('data-placeholder')) return;
          var container = document.createElement('div');
          container.className = 'section-helper';
          container.setAttribute('contenteditable','false');
          container.setAttribute('role','region');
          container.setAttribute('aria-label','Section helper');

          function hasTemplate(){ try { return !!getSectionTemplateFromTemplates(sectionName, (window.selectedCat||'other')); } catch(_) { return false; } }

          var __t = (typeof window.__i18nGet === 'function') ? window.__i18nGet : function(k,p,f){ return f || k; };
          container.innerHTML = ''+
            '<button type="button" data-sh-btn="tpl"'+ (hasTemplate()? '' : ' aria-disabled="true"') +'>' + __t('helper.templateStarter', null, 'Template starter') + '</button>'+
            '<button type="button" data-sh-btn="src">' + __t('helper.addFromSource', null, 'Add from source') + '</button>';

          // Insert after the paragraph
          p.insertAdjacentElement('afterend', container);

          // Helpers to manage placeholder state
          function isEmptyText(s){ try { return String(s||'').replace(/[\u200B\u200A\uFEFF]/g,'').trim().length === 0; } catch(_) { return true; } }
          function setPlaceholder(){
            try {
              var txt = (p.getAttribute('data-placeholder')||'');
              // Add a ZWSP prefix to keep paragraph from collapsing in WebKit/Safari
              p.innerHTML = '\u200B<span class="sh-placeholder">'+ escapeHtml(txt) +'</span>';
              p.style.color = '#72777d'; p.style.fontStyle = 'italic';
            } catch(_) {}
          }
          function clearPlaceholder(){
            try {
              var ph = p.querySelector('.sh-placeholder');
              if (ph && ph.parentNode) ph.parentNode.removeChild(ph);
              p.style.color = '';
              p.style.fontStyle = '';
              p.removeAttribute('data-placeholder');
            } catch(_) {}
          }
          function placeCaretAtStartInParagraph(el){
            try {
              if (!el) return;
              el.setAttribute('contenteditable','true');
              // Ensure a text node exists so caret can live inside the paragraph on Safari
              if (!el.firstChild) {
                el.appendChild(document.createTextNode(''));
              }
              var sel = window.getSelection(); sel.removeAllRanges();
              var rg = document.createRange();
              rg.setStart(el.firstChild, 0);
              rg.collapse(true);
              sel.addRange(rg);
              try { el.focus(); } catch(_) {}
            } catch(_) {}
          }
          function insertTextAtStart(el, text){
            try {
              if (!el) return;
              if (!el.firstChild) el.appendChild(document.createTextNode(''));
              var tn = document.createTextNode(text || '');
              el.insertBefore(tn, el.firstChild);
              var sel = window.getSelection(); sel.removeAllRanges();
              var rg = document.createRange(); rg.setStartAfter(tn); rg.collapse(true); sel.addRange(rg);
            } catch(_) {}
          }

          // Input monitor: hide helper when user types; restore if text becomes empty again
          function onInput(){
            try {
              var val = (p.textContent||'');
              var hasContent = !isEmptyText(val);
              if (hasContent) {
                if (container && container.parentNode) container.parentNode.removeChild(container);
              } else {
                // If cleared, restore placeholder and helper
                var promptTxt = (function(){ try { return getWritingPromptForSection(sectionName, (window.selectedCat||'other')); } catch(_) { return 'Click here to start writing about '+ sectionName.toLowerCase()+'.'; } })();
                p.setAttribute('data-placeholder', promptTxt);
                setPlaceholder();
                if (!p.nextElementSibling || !p.nextElementSibling.classList || !p.nextElementSibling.classList.contains('section-helper')) {
                  showSectionHelper(p, sectionName);
                }
                // Keep caret anchored in the paragraph
                setTimeout(function(){ try { placeCaretAtStartInParagraph(p); } catch(_) {} }, 0);
              }
            } catch(_) {}
          }
          setTimeout(function(){
            try { p.addEventListener('input', onInput, true); } catch(_) {}
            // Observe content changes even if selection leaves the paragraph
            try {
              var mo = new MutationObserver(function(){ onInput(); });
              mo.observe(p, { childList:true, characterData:true, subtree:true });
            } catch(_) {}
          }, 0);

          // Prefer robust 'beforeinput' to intercept first input, including IME/composition
          try {
            p.addEventListener('beforeinput', function(ev){
              if (ev.inputType && ev.inputType.indexOf('insert') === 0 && p.hasAttribute('data-placeholder')) {
                ev.preventDefault();
                try { ev.stopPropagation(); if (ev.stopImmediatePropagation) ev.stopImmediatePropagation(); } catch(_) {}
                var data = ev.data || '';
                clearPlaceholder();
                placeCaretAtStartInParagraph(p);
                if (data) { insertTextAtStart(p, data); }
                if (container && container.parentNode) container.parentNode.removeChild(container);
              }
            }, true);
            // Fallback for keyboards that may skip beforeinput
            p.addEventListener('keydown', function(ev){
              if (ev.metaKey || ev.ctrlKey || ev.altKey) return;
              if (!p.hasAttribute('data-placeholder')) {
                if (ev.key === 'Escape') { if (container && container.parentNode) container.parentNode.removeChild(container); }
                return;
              }
              if (ev.key && ev.key.length === 1) {
                ev.preventDefault();
                try { ev.stopPropagation(); if (ev.stopImmediatePropagation) ev.stopImmediatePropagation(); } catch(_) {}
                clearPlaceholder();
                placeCaretAtStartInParagraph(p);
                insertTextAtStart(p, ev.key);
                if (container && container.parentNode) container.parentNode.removeChild(container);
              } else if (ev.key === 'Escape') {
                if (container && container.parentNode) container.parentNode.removeChild(container);
              }
            }, true);
            // Clear placeholder on composition start (IME)
            p.addEventListener('compositionstart', function(){ if (p.hasAttribute('data-placeholder')) { clearPlaceholder(); if (container && container.parentNode) container.parentNode.removeChild(container); } }, true);
          } catch(_) {}

          // Paste over placeholder
          try {
            p.addEventListener('paste', function(ev){
              if (!p.hasAttribute('data-placeholder')) return;
              ev.preventDefault();
              var text = (ev.clipboardData && ev.clipboardData.getData && ev.clipboardData.getData('text/plain')) || '';
              clearPlaceholder();
              var sel = window.getSelection(); sel.removeAllRanges();
              var rg = document.createRange(); rg.selectNodeContents(p); rg.collapse(true); sel.addRange(rg);
              try { document.execCommand('insertText', false, text); } catch(_) {
                var tn = document.createTextNode(text); rg.insertNode(tn); rg.setStartAfter(tn); rg.collapse(true); sel.removeAllRanges(); sel.addRange(rg);
              }
              if (container && container.parentNode) container.parentNode.removeChild(container);
            });
          } catch(_) {}

          // Hide on Esc while focus is in paragraph (handled above too)
          try {
            var onKey = function(ev){ if (ev.key === 'Escape') { ev.preventDefault(); ev.stopPropagation(); if (container && container.parentNode) container.parentNode.removeChild(container); p.removeEventListener('keydown', onKey); } };
            p.addEventListener('keydown', onKey);
          } catch(_) {}

          // Button handlers
          container.addEventListener('click', function(e){
            var btn = e.target && e.target.closest && e.target.closest('[data-sh-btn]');
            if (!btn) return;
            e.preventDefault();
            e.stopPropagation();
            var kind = btn.getAttribute('data-sh-btn');
            if (btn.getAttribute('aria-disabled') === 'true') return;
            if (kind === 'tpl') {
              insertSectionTemplateAtParagraph(p, sectionName);
              if (container && container.parentNode) container.parentNode.removeChild(container);
              return;
            }
            if (kind === 'src') {
              try { if (typeof openSourceModalDialog === 'function') openSourceModalDialog(); else openReferenceDialog(); } catch(_) { openReferenceDialog(); }
              // Keep helper until user starts typing (auto-hide via input listener)
              return;
            }
          }, true);
        } catch(_) {}
      };

      window.insertSectionTemplateAtParagraph = function insertSectionTemplateAtParagraph(p, sectionName){
        try {
          if (!p) return;
          var category = (window.selectedCat || 'other');
          var tpl = getSectionTemplateFromTemplates(sectionName, category);
          if (!tpl) return; // nothing to insert
          var title = (window.articleTitleText || 'This topic');
          tpl = tpl.replace(/\{\{(NAME|FULL_NAME)\}\}/g, title);
          tpl = tpl.replace(/\{\{ARTICLE\}\}/g, 'a');
          var inner = tpl.replace(/\{\{([^}]+)\}\}/g, function(_, key){
            return '<span class="template-placeholder" data-placeholder="'+key+'" contenteditable="false" role="button" tabindex="0">'+prettifyPlaceholder(key)+'</span>';
          }) + ' <span class="ref-chip action-chip" contenteditable="false" role="button" tabindex="0"><span class="icon" aria-hidden="true"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path d="m15 10-2.78-2.78L9.44 10V1H5a2 2 0 00-2 2v14a2 2 0 002 2h10a2 2 0 002-2V3a2 2 0 00-2-2z"></path></svg></span>Reference</span>';
          ;
          var prev = p.innerHTML;
          // Normalize paragraph: remove placeholder styling/flags and any ZWSP remnants
          try {
            p.removeAttribute('data-placeholder');
            p.style.color = '';
            p.style.fontStyle = '';
            // Remove placeholder span if present
            var ph = p.querySelector('.sh-placeholder');
            if (ph && ph.parentNode) ph.parentNode.removeChild(ph);
            // Strip leading zero-width characters from the first text node
            if (p.firstChild && p.firstChild.nodeType === Node.TEXT_NODE) {
              p.firstChild.nodeValue = (p.firstChild.nodeValue || '').replace(/^\u200B+/, '');
            }
            // Remove helper block if it is still present
            try { var next = p.nextElementSibling; if (next && next.classList && next.classList.contains('section-helper')) next.parentNode.removeChild(next); } catch(_) {}
          } catch(_) {}
          p.innerHTML = inner;
          try { tidyLeadPunctuation(p); } catch(_) {}
          // Place caret after ref chip
          try { var rc = p.querySelector('.ref-chip'); if (rc) { placeCaretAfterNode(rc); } else { placeCaretAtEnd(p); } } catch(_) {}
          // Undo toast
          try {
            showUndoToast('Inserted section template', function(){
              try { p.innerHTML = prev; placeCaretAtEnd(p); } catch(_) {}
              return true; // caret handled
            }, p);
          } catch(_) {}
          // Ensure publish button enables
          try { enablePublishUI(); } catch(_) {}
        } catch(_) {}
      };

      // Global fallback handlers to guarantee placeholder clearing across browsers
      try {
        if (!window.__sectionHelperGlobalsBound) {
          window.__sectionHelperGlobalsBound = true;
          var root = document.getElementById('editor');
          function placeCaretAtStartInParagraph(el){
            try {
              if (!el) return;
              el.setAttribute('contenteditable','true');
              if (!el.firstChild) { el.appendChild(document.createTextNode('')); }
              var sel = window.getSelection(); sel.removeAllRanges();
              var rg = document.createRange(); rg.setStart(el.firstChild, 0); rg.collapse(true);
              sel.addRange(rg);
              try { el.focus(); } catch(_) {}
            } catch(_) {}
          }
          function insertTextAtStart(el, text){
            try {
              if (!el) return;
              if (!el.firstChild) el.appendChild(document.createTextNode(''));
              var tn = document.createTextNode(text || '');
              el.insertBefore(tn, el.firstChild);
              var sel = window.getSelection(); sel.removeAllRanges();
              var rg = document.createRange(); rg.setStartAfter(tn); rg.collapse(true); sel.addRange(rg);
            } catch(_) {}
          }
          function getActivePlaceholderPara(){
            try {
              var sel = window.getSelection(); if (!sel || !sel.rangeCount) return null;
              var node = sel.getRangeAt(0).startContainer;
              if (node && node.nodeType === Node.TEXT_NODE) node = node.parentElement;
              if (!node) return null;
              var p = node.closest('p');
              if (p && p.hasAttribute('data-placeholder')) return p;
              // If caret is in an H2, consider the next paragraph as candidate
              if (node.tagName && node.tagName.toLowerCase() === 'h2') {
                var nx = node.nextElementSibling;
                if (nx && nx.tagName && nx.tagName.toLowerCase() === 'p' && (nx.hasAttribute('data-placeholder') || (nx.textContent||'').replace(/[\u200B\u200A\uFEFF]/g,'').trim().length===0)) return nx;
              }
              return null;
            } catch(_) { return null; }
          }
          function removeHelperNextTo(p){ try { var n = p.nextElementSibling; if (n && n.classList && n.classList.contains('section-helper')) n.parentNode.removeChild(n); } catch(_) {} }
          function clearPh(p){
            try {
              var ph = p.querySelector('.sh-placeholder');
              if (ph && ph.parentNode) ph.parentNode.removeChild(ph);
              p.style.color = '';
              p.style.fontStyle = '';
              p.removeAttribute('data-placeholder');
            } catch(_) {}
          }
          // beforeinput (capture)
          root.addEventListener('beforeinput', function(ev){
            var p = getActivePlaceholderPara();
            if (!p) return;
            if (ev.inputType && ev.inputType.indexOf('insert') === 0) {
              ev.preventDefault();
              try { ev.stopPropagation(); if (ev.stopImmediatePropagation) ev.stopImmediatePropagation(); } catch(_) {}
              var data = ev.data || '';
              clearPh(p);
              placeCaretAtStartInParagraph(p);
              if (data) { insertTextAtStart(p, data); }
              removeHelperNextTo(p);
            } else if (ev.inputType === 'deleteContentBackward') {
              // If user backspaces from the H2 into the paragraph, keep caret in paragraph
              ev.preventDefault();
              try { ev.stopPropagation(); if (ev.stopImmediatePropagation) ev.stopImmediatePropagation(); } catch(_) {}
              // If paragraph is empty, restore placeholder + helper
              var text = (p.textContent||'').replace(/[\u200B\u200A\uFEFF]/g,'');
              if (text.trim().length === 0 && !p.querySelector('.sh-placeholder')) {
                var sectionName = getSectionNameForParagraph(p);
                var promptTxt = (function(){ try { return getWritingPromptForSection(sectionName, (window.selectedCat||'other')); } catch(_) { return 'Click here to start writing about '+ sectionName.toLowerCase()+'.'; } })();
                p.setAttribute('data-placeholder', promptTxt);
                p.innerHTML = '\u200B<span class="sh-placeholder">'+ escapeHtml(promptTxt) +'</span>';
                p.style.color = '#72777d'; p.style.fontStyle = 'italic';
                removeHelperNextTo(p); showSectionHelper(p, sectionName);
              }
              placeCaretAtStartInParagraph(p);
            }
          }, true);
          // keydown (capture) fallback
          root.addEventListener('keydown', function(ev){
            var p = getActivePlaceholderPara();
            if (!p) return;
            if (ev.metaKey || ev.ctrlKey || ev.altKey) return;
            if (ev.key && ev.key.length === 1) {
              ev.preventDefault();
              try { ev.stopPropagation(); if (ev.stopImmediatePropagation) ev.stopImmediatePropagation(); } catch(_) {}
              clearPh(p);
              placeCaretAtStartInParagraph(p);
              insertTextAtStart(p, ev.key);
              removeHelperNextTo(p);
            }
          }, true);
          // paste (capture)
          root.addEventListener('paste', function(ev){
            var p = getActivePlaceholderPara();
            if (!p) return;
            ev.preventDefault();
            try { ev.stopPropagation(); if (ev.stopImmediatePropagation) ev.stopImmediatePropagation(); } catch(_) {}
            var text = (ev.clipboardData && ev.clipboardData.getData && ev.clipboardData.getData('text/plain')) || '';
            clearPh(p);
            placeCaretAtStartInParagraph(p);
            insertTextAtStart(p, text);
            removeHelperNextTo(p);
          }, true);
          // compositionstart (capture)
          root.addEventListener('compositionstart', function(){
            var p = getActivePlaceholderPara();
            if (!p) return;
            clearPh(p);
            removeHelperNextTo(p);
          }, true);

          // input (capture): if a section paragraph becomes empty, restore placeholder and helper
          root.addEventListener('input', function(){
            try {
              var sel = window.getSelection(); if (!sel || !sel.rangeCount) return;
              var node = sel.getRangeAt(0).startContainer;
              if (node && node.nodeType === Node.TEXT_NODE) node = node.parentElement;
              if (!node) return;
              var p = node.closest('p');
              if (!p || p.id === 'leadPlaceholder') return;
              // Only care about the immediate paragraph after an H2 or within a section block
              var blk = p.closest('.section-block');
              if (!blk && (!p.previousElementSibling || (p.previousElementSibling.tagName||'').toLowerCase() !== 'h2')) return;
              var hasContent = (p.textContent||'').trim().length > 0;
              var hasPH = !!p.querySelector('.sh-placeholder');
              if (!hasContent && !hasPH) {
                var sectionName = getSectionNameForParagraph(p);
                var promptTxt = (function(){ try { return getWritingPromptForSection(sectionName, (window.selectedCat||'other')); } catch(_) { return 'Click here to start writing about '+ sectionName.toLowerCase()+'.'; } })();
                p.setAttribute('data-placeholder', promptTxt);
                // Insert placeholder span and helper, and anchor caret
                p.innerHTML = '<span class="sh-placeholder">'+ escapeHtml(promptTxt) +'</span>';
                p.style.color = '#72777d'; p.style.fontStyle = 'italic';
                removeHelperNextTo(p); // avoid duplicates
                showSectionHelper(p, sectionName);
                placeCaretAtStartInParagraph(p);
              }
            } catch(_) {}
          }, true);
        }
      } catch(_) {}
    })();

    function getSectionTemplateFromTemplates(sectionName, category) {
      try {
        var data = window.templatesData; if (!data || !data.categories) return null;
        var catKey = (function(c){
          switch(c){
            case 'person': return 'PERSON';
            case 'place': return 'LOCATION';
            case 'species': return 'SPECIES';
            case 'organization': return 'ORGANIZATION';
            case 'academic': return 'ACADEMIC';
            case 'event': return 'EVENT';
            default: return null;
          }
        })(category);
        if (!catKey || !data.categories[catKey]) return null;
        var cat = data.categories[catKey];
        // Search defaultSections first
        if (Array.isArray(cat.defaultSections)) {
          for (var i=0;i<cat.defaultSections.length;i++) {
            var sec = cat.defaultSections[i];
            if ((sec.title||'').toLowerCase() === sectionName.toLowerCase()) {
              return sec.contentTemplate || (sec.templateVariations && sec.templateVariations[0]) || null;
            }
          }
        }
        // Search subcategories
        if (cat.subcategories) {
          var subs = Object.keys(cat.subcategories);
          for (var j=0;j<subs.length;j++) {
            var sc = cat.subcategories[subs[j]];
            if (Array.isArray(sc.sections)) {
              for (var k=0;k<sc.sections.length;k++) {
                var sec2 = sc.sections[k];
                if ((sec2.title||'').toLowerCase() === sectionName.toLowerCase()) {
                  return sec2.contentTemplate || (sec2.templateVariations && sec2.templateVariations[0]) || null;
                }
              }
            }
          }
        }
        return null;
      } catch(_) { return null; }
    }

    let __smartChipsTimer = null;
    function scheduleSmartChipsUpdate() {
      if (__smartChipsTimer) { try { clearTimeout(__smartChipsTimer); } catch(_) {} }
      __smartChipsTimer = setTimeout(function(){
        if (shouldShowSmartChips()) { showSmartChipsAtCursor(); } else { hideSmartChips(); }
      }, 60);
    }
    function handleEditorKeyup(e) { scheduleSmartChipsUpdate(); }

    function handleEditorClick(e) { scheduleSmartChipsUpdate(); }

    function shouldShowSmartChips() {
      const editor = document.getElementById('editor');
      const selection = window.getSelection();
      
      if (!selection.rangeCount) return false;
      
      const range = selection.getRangeAt(0);
      const container = range.startContainer;
      
      // Show if editor is empty
      if (editor.textContent.trim() === '') return true;
      
      // Show if at the beginning of a new paragraph
      if (container.nodeType === Node.TEXT_NODE) {
        const text = container.textContent;
        const offset = range.startOffset;
        
        // At start of paragraph or after line break
        if (offset === 0 || text.charAt(offset - 1) === '\n') {
          return true;
        }
      }
      
      return false;
    }

    function showSmartChipsAtCursor() {
      const selection = window.getSelection();
      if (!selection.rangeCount) return;
      
      // Clone to avoid mutating the actual caret while measuring
      const range = selection.getRangeAt(0).cloneRange();
      currentCursorPosition = range.cloneRange();
      
      const editor = document.getElementById('editor');
      if (!editor || !smartChipsContainer) return;
      const editorRect = editor.getBoundingClientRect();
      
      // Helper to get a reliable rect even when the range is at start/empty
      function getCaretRect(rng) {
        let r = rng.getBoundingClientRect();
        const empty = !r || ((r.left === 0 && r.top === 0 && r.right === 0 && r.bottom === 0));
        if (empty) {
          const node = (rng.startContainer && rng.startContainer.nodeType === Node.TEXT_NODE)
            ? rng.startContainer.parentElement
            : rng.startContainer;
          if (node && node.getBoundingClientRect) {
            r = node.getBoundingClientRect();
          } else {
            r = editorRect;
          }
        }
        return r;
      }
      
      const rect = getCaretRect(range);
      // Compute position relative to editor, clamp inside
      let left = rect.left - editorRect.left;
      let top = rect.bottom - editorRect.top + 4;
      const approxWidth = smartChipsContainer.offsetWidth || 220;
      const maxLeft = Math.max(0, editor.clientWidth - approxWidth);
      left = Math.max(0, Math.min(left, maxLeft));
      top = Math.max(0, top);
      
      smartChipsContainer.style.left = left + 'px';
      smartChipsContainer.style.top = top + 'px';
      smartChipsContainer.classList.add('show');
    }

    function hideSmartChips() {
      smartChipsContainer.classList.remove('show');
    }

    function handleSmartChipClick(e) {
      e.preventDefault();
      e.stopPropagation();
      
      const action = this.dataset.action;
      
      switch(action) {
        case 'template':
          showTemplatePopup();
          break;
        case 'section':
          insertNewSection();
          break;
        case 'source':
          openReferenceDialog();
          break;
        case 'assistance':
          showGuideInterface();
          break;
      }
    }

    function showTemplatePopup() {
      const templates = getContextualTemplates();
      
      let html = '';
      templates.forEach(template => {
        html += `
          <button class="template-option" data-template="${template.id}">
            <div class="template-option-title">${template.title}</div>
            <div class="template-option-desc">${template.description}</div>
          </button>
        `;
      });
      
      templatePopup.innerHTML = html;
      
      // Position popup relative to smart chips
      const rect = smartChipsContainer.getBoundingClientRect();
      const editor = document.getElementById('editor');
      const editorRect = editor.getBoundingClientRect();
      
      templatePopup.style.left = (rect.left - editorRect.left) + 'px';
      templatePopup.style.top = (rect.bottom - editorRect.top + 8) + 'px';
      templatePopup.classList.add('show');
      
      // Add click handlers to template options
      const options = templatePopup.querySelectorAll('.template-option');
      options.forEach(option => {
        // Prevent focus/selection loss caused by mousedown
        option.addEventListener('mousedown', function(e){ e.preventDefault(); });
        option.addEventListener('click', function(e) {
          e.preventDefault();
          e.stopPropagation();
          insertTemplate(this.dataset.template);
          hideTemplatePopup();
        });
      });
    }

    function hideTemplatePopup() {
      templatePopup.classList.remove('show');
    }

    function getContextualTemplates() {
      const category = selectedCat || 'other';
      const editor = document.getElementById('editor');
      const isEmpty = editor.textContent.trim() === '';
      
      let templates = [];
      
      if (isEmpty) {
        // Lead paragraph templates
        switch(category) {
          case 'person':
            templates.push({
              id: 'person-lead',
              title: 'Biography introduction',
              description: 'Template for introducing a person'
            });
            break;
          case 'place':
            templates.push({
              id: 'place-lead',
              title: 'Location introduction',
              description: 'Template for introducing a place'
            });
            break;
          case 'organization':
            templates.push({
              id: 'org-lead',
              title: 'Organization introduction',
              description: 'Template for introducing an organization'
            });
            break;
          default:
            templates.push({
              id: 'generic-lead',
              title: 'Generic introduction',
              description: 'Basic introduction template'
            });
        }
      } else {
        // Section templates
        templates.push({
          id: 'basic-paragraph',
          title: 'Paragraph starter',
          description: 'Template for a new paragraph'
        });
      }
      
      return templates;
    }

    function insertTemplate(templateId) {
      const editor = document.getElementById('editor');
      if (window.perfTweaks) __insertingContent = true;
      const template = getTemplateContent(templateId);
      
      // Ensure selection is inside editor, else move caret to end
      ensureSelectionInEditor(editor);

      // Insert template with placeholders using DOM APIs (avoid execCommand)
      const templateHTML = createTemplateHTML(template, templateId);
      insertHTMLAtCursor(templateHTML, editor);
      
      // Focus first placeholder
      setTimeout(() => {
        const firstPlaceholder = editor.querySelector('.template-placeholder');
        if (firstPlaceholder && firstPlaceholder.focus) {
          firstPlaceholder.focus();
        }
        // Keep chips visible and reposition near current caret after insertion
        try {
          if (typeof showSmartChipsAtCursor === 'function') {
            showSmartChipsAtCursor();
          }
          if (smartChipsContainer) {
            smartChipsContainer.classList.add('show');
          }
        } catch (_) {}
        if (window.perfTweaks) __schedule(function(){ __insertingContent = false; });
      }, 10);
    }

    // Utility: ensure selection is within the editor; if not, place at end
    function ensureSelectionInEditor(editor) {
      const sel = window.getSelection();
      if (!sel.rangeCount || !editor.contains(sel.anchorNode)) {
        placeCaretAtEnd(editor);
      }
      // Also refresh stored cursor position
      try {
        const r = sel.getRangeAt(0);
        currentCursorPosition = r.cloneRange();
      } catch (_) {}
    }

    // Utility: place caret at end of a contenteditable
    function placeCaretAtEnd(el) {
      el.focus();
      const range = document.createRange();
      range.selectNodeContents(el);
      range.collapse(false);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    }

    // Utility: insert HTML at current caret using DOM APIs
    function insertHTMLAtCursor(html, editor) {
      const sel = window.getSelection();
      if (!sel.rangeCount) { placeCaretAtEnd(editor); }
      const range = sel.getRangeAt(0);
      // Prepare fragment
      const t = document.createElement('template');
      t.innerHTML = html;
      const frag = t.content.cloneNode(true);
      // Insert
      range.deleteContents();
      range.insertNode(frag);
    }

    function getTemplateContent(templateId) {
      const templates = {
        'person-lead': {
          text: '[NAME] was born on [DATE] in [LOCATION]. [He/She] is known for [MAIN_ACHIEVEMENT]. [Additional context about significance].',
          needsSource: true
        },
        'place-lead': {
          text: '[PLACE_NAME] is a [TYPE] located in [LOCATION]. It is known for [MAIN_FEATURE] and has a population of [POPULATION].',
          needsSource: true
        },
        'org-lead': {
          text: '[ORGANIZATION_NAME] is a [TYPE] founded in [YEAR] in [LOCATION]. The organization focuses on [MAIN_PURPOSE].',
          needsSource: true
        },
        'generic-lead': {
          text: '[TOPIC] is [DEFINITION]. It is significant because [IMPORTANCE].',
          needsSource: true
        },
        'basic-paragraph': {
          text: '[TOPIC_SENTENCE]. [Supporting details]. [Conclusion or transition].',
          needsSource: true
        }
      };
      
      return templates[templateId] || templates['generic-lead'];
    }

    function createTemplateHTML(template, templateId) {
      let html = template.text;
      const title = (window.articleTitleText || '').toString();
      const category = (window.selectedCat || 'other');

      // Autofill common placeholders with article title
      if (title) {
        html = html.replace(/\[(NAME|TOPIC|PLACE_NAME|ORGANIZATION_NAME|COMMON_NAME)\]/g, title);
      }

      // Provide a sensible default topic sentence for paragraph starter
      if (templateId === 'basic-paragraph') {
        const topicSentence = generateTopicSentence(title, category);
        html = html.replace(/\[TOPIC_SENTENCE\]/g, topicSentence);
      }

      // Replace remaining placeholders with clickable, friendly chips
      html = html.replace(/\[([^\]]+)\]/g, function(_, key){
        const label = prettifyPlaceholder(key);
        return '<span class="template-placeholder" data-placeholder="'+key+'" contenteditable="false" role="button" tabindex="0">'+label+'</span>';
      });

      if (template.needsSource) {
        var __t = (typeof window.__i18nGet === 'function') ? window.__i18nGet : function(k,p,f){ return f||k; };
        html += ' <span class="source-reminder">'+ __t('ui.addSource','Add source') +'</span>';
      }
      
      return html;
    }

    function prettifyPlaceholder(raw){
      try{
        var __t = (typeof window.__i18nGet === 'function') ? window.__i18nGet : function(k,p,f){ return f || k; };
        var k = String(raw||'');
        var up = k.toUpperCase();
        // Primary: chips.UPPERCASE
        var val = __t('chips.'+up, null, null);
        if (val && val !== 'chips.'+up) return val;
        // Secondary: chips.lowercase
        val = __t('chips.'+k.toLowerCase(), null, null);
        if (val && val !== 'chips.'+k.toLowerCase()) return val;
        // Fallback: humanize
        return k.replace(/_/g,' ').toLowerCase();
      }catch(_) { return String(raw||''); }
    }

    function generateTopicSentence(title, category){
      const t = title || 'this topic';
      switch(category){
        case 'person': return t + ' — background and overview.';
        case 'place': return 'Overview of '+t+': location, history, and significance.';
        case 'organization': return t + ' — purpose, history, and key activities.';
        case 'species': return t + ' — description, habitat, and notable traits.';
        case 'academic': return 'Definition and context for '+t+'.';
        case 'creative': return t + ' — summary and production details.';
        case 'event': return t + ' — context, timeline, and impact.';
        default: return 'Introduction to '+t+'.';
      }
    }

    function selectPlaceholder(placeholder) {
      const selection = window.getSelection();
      const range = document.createRange();
      range.selectNodeContents(placeholder);
      selection.removeAllRanges();
      selection.addRange(range);
      
      // Add click handler to replace placeholder
      placeholder.addEventListener('click', function() {
        selectPlaceholder(this);
      });
    }

    function insertNewSection() {
      // Open the inline Suggestions panel focused on Sections
      try {
        // Ensure the chip is anchored near the current block for correct positioning
        var anchor = null;
        try { if (typeof getActiveBlockElement === 'function') anchor = getActiveBlockElement(); } catch(_) {}
        if (typeof showSuggestionsChip === 'function') showSuggestionsChip(anchor);
        var menu = document.getElementById('assistMenu');
        if (menu) {
          // Build the main menu, then switch to the sections view directly
          if (typeof window.buildMainMenu === 'function') window.buildMainMenu();
          if (typeof window.buildSectionMenu === 'function') window.buildSectionMenu();
          // Position menu under the chip for a tidy inline feel
          var chip = document.getElementById('assistChip');
          if (chip) {
            menu.style.left = chip.style.left;
            menu.style.top = ((parseInt(chip.style.top || '0', 10) + 32) + 'px');
          }
          menu.style.display = 'block';
          if (window.__assistSetFrozen) window.__assistSetFrozen(false);
          return;
        }
      } catch(_) {}
      // Fallback: prompt for a section name and insert skeleton directly
      try {
        var name = prompt('Section name');
        if (name && typeof insertSectionSkeleton === 'function') insertSectionSkeleton(name).catch(function(){});
      } catch(_) {}
    }

    function openReferenceDialog() {
      // Use existing reference dialog
      const refDialog = document.getElementById('refBackdrop');
      if (refDialog) {
        refDialog.style.display = 'block';
        var url = document.getElementById('refUrl');
        if (url) url.focus();
      }
    }

    function showGuideInterface() {
          function getSectionNameForParagraph(p){
            try {
              var blk = p.closest && p.closest('.section-block');
              if (blk && blk.dataset && blk.dataset.section) return blk.dataset.section;
              // Fallback: search previous siblings for H2
              var el = p.previousElementSibling; 
              while (el) { if (el.tagName && el.tagName.toLowerCase() === 'h2') return (el.textContent||'').trim(); el = el.previousElementSibling; }
              return 'Section';
            } catch(_) { return 'Section'; }
          }
      // Open sidebar or modal with guidance
      insertNewSection();
    }

    // Initialize smart chips when Step 3 becomes active
    const originalToStep3 = window.toStep3;
    window.toStep3 = function() {
      if (originalToStep3) originalToStep3();
      setTimeout(initializeSmartChips, 100);
    };

    // Also initialize if we're already in step 3
    if (document.getElementById('step3').classList.contains('active')) {
      initializeSmartChips();
      initializeAssistanceUI && initializeAssistanceUI();
      // Ensure chip is properly positioned after initialization
      setTimeout(function() {
        if (typeof reanchorAssistChip === 'function') {
          reanchorAssistChip();
        }
      }, 200);
    }

    // Inline hint to teach '/'
    // Removed separate inline '/' hint in favor of placeholder text.
  </script>
</body>
</html>
