<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Article Creator — Reference Chip Concept</title>
  <link rel="stylesheet" href="https://unpkg.com/@wikimedia/codex@2.3.0/dist/codex.style.css">
  <link rel="stylesheet" href="https://unpkg.com/@wikimedia/codex-design-tokens@2.3.0/theme-wikimedia-ui.css">
  <link rel="stylesheet" href="reading-styles.css">
  <style>
    .creator-wrap { max-width: 1100px; margin: 0 auto; padding: 16px 20px; }
    .editor-shell { border: 1px solid var(--border-color-subtle, #eaecf0); border-radius: 4px; background: #fff; padding: 16px; }
    .title-input { width: 100%; font-size: 18px; padding: 8px 0; border: none; border-bottom: 2px solid #a2a9b1; }
    .title-input:focus { outline: none; border-bottom-color: #36c; }
    .chip-row { display: flex; gap: 8px; align-items: center; margin: 12px 0; flex-wrap: wrap; }
    .chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border: 1px solid #a2a9b1; border-radius: 12px; font-size: 12px; cursor: pointer; background: #f8f9fa; }
    .chip.reference { border-color: #36c; color: #36c; background: #eef3ff; }
    .editor { min-height: 260px; outline: none; }
    .editor[contenteditable="true"]:empty:before { content: attr(data-placeholder); color: #72777d; }
    .verify-note { display: none; margin-top: 8px; font-size: 12px; color: #856404; background: #fff3cd; border: 1px solid #ffeaa7; padding: 6px 8px; border-radius: 4px; }
    .verify-note.show { display: block; }
    .ref-dialog-backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.4); z-index: 3000; }
    .ref-dialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: #fff; border: 1px solid #eaecf0; border-radius: 8px; width: 520px; max-width: 92vw; padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.2); }
    .ref-row { margin-bottom: 12px; }
    .ref-row label { display: block; font-size: 13px; margin-bottom: 6px; color: #202122; }
    .ref-row input { width: 100%; height: 34px; border: 1px solid #c8ccd1; border-radius: 4px; padding: 6px 10px; font: inherit; }
    .ref-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
    .badge { display:inline-block; font-size:10px; padding:2px 6px; border-radius:10px; border:1px solid #c8ccd1; color:#72777d; }
    .badge.good { color:#14866d; border-color:#14866d; }
    .badge.warn { color:#ac6600; border-color:#ac6600; }
  
    .chip.guidance { border-color: #c8ccd1; background: #fff; }
    .ac-steps { max-width: 1100px; margin: 0 auto; }
    .ac-step { display: none; border: 1px solid var(--border-color-subtle, #eaecf0); background: #fff; border-radius: 6px; padding: 16px; }
    .ac-step.active { display: block; }
    .ac-step h3 { margin: 0 0 12px 0; font-size: 1.1rem; }
    
    /* Center Step 1 in viewport */
    #step1.ac-step {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: none;
      background: transparent;
      box-shadow: none;
      max-width: 600px;
      width: 90%;
      z-index: 100;
    }
    
    /* Responsive positioning for mobile with keyboard */
    @media (max-height: 600px) {
      #step1.ac-step {
        position: fixed;
        top: 30%;
        transform: translate(-50%, -30%);
      }
    }
    
    @media (max-width: 768px) {
      #step1.ac-step {
        width: 95%;
        padding: 20px;
      }
      
      /* Adjust for mobile keyboard */
      @media (max-height: 500px) {
        #step1.ac-step {
          top: 20%;
          transform: translate(-50%, -20%);
        }
      }
    }
    
    /* Center Step 2 in viewport */
    #step2.ac-step {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: none;
      background: transparent;
      box-shadow: none;
      max-width: 700px;
      width: 90%;
      z-index: 100;
    }
    
    /* Responsive positioning for Step 2 */
    @media (max-width: 768px) {
      #step2.ac-step {
        width: 95%;
        padding: 20px;
        top: 45%;
        transform: translate(-50%, -45%);
      }
    }
    
    .ac-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
    .ac-actions .btn { height: 34px; padding: 0 12px; border: 1px solid #c8ccd1; border-radius: 4px; background: #fff; cursor: pointer; }
    .ac-actions .btn.primary { background: #36c; color: #fff; border-color: #36c; }
    .category-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; margin: 8px 0 4px; }
    .category-item { border: 1px solid #c8ccd1; border-radius: 4px; padding: 10px; cursor: pointer; background: #fff; }
    .category-item:hover { background: #f8f9fa; }
    .category-item.selected { border-color: #36c; box-shadow: 0 0 0 2px #eaf3ff; }
    .hint { font-size: 12px; color: #72777d; margin-top: 6px; }
    /* Hide the VE chrome by default - show when Step 3 is active */
    .ve-in-step3 #veHeader,
    .ve-in-step3 #veToolbar {
      display: block !important;
    }
    
    /* Mobile-only: Hide header and show footer instead */
    @media (max-width: 768px) {
      .ve-in-step3 #veHeader {
        display: none !important;
      }
      
      .ve-in-step3 #veFooter {
        display: block !important;
      }
      
      /* Footer styling - mobile only */
      .ve-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        border-top: 1px solid var(--border-color-subtle, #eaecf0);
        padding: 8px 16px;
        font-size: 12px;
        color: var(--color-subtle, #54595d);
        z-index: 10;
      }
      
      .ve-footer .status {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1100px;
        margin: 0 auto;
      }
    }
    
    /* Clean layout for Step 3 */
    .ve-in-step3 .creator-wrap {
      max-width: none;
      padding: 0;
    }
    
    .ve-in-step3 #step3 {
      border: none;
      background: transparent;
      padding: 0;
    }
    
    .ve-in-step3 #editor {
      border: none;
      background: transparent;
      min-height: 400px;
      padding: 16px 0;
    }
    
    /* Primary button styling for publish/submit buttons */
    .btn.primary {
      background: #36c !important;
      color: #fff !important;
      border-color: #36c !important;
    }
    
    .btn.primary:hover {
      background: #2a4b8d !important;
      border-color: #2a4b8d !important;
    }
  </style>
</head>
<body>

  <!-- Wikipedia-style header (hidden by default, shown in Step 3) -->
  <header class="container page-header" id="veHeader" role="banner" style="display: none;">
    <h1 class="firstHeading" id="veTitle">New Article</h1>
    <div class="page-tabs-wrapper">
      <nav class="ns-tabs" aria-label="Namespace tabs">
        <button class="ns-tab active">Article</button>
        <button class="ns-tab">Talk</button>
      </nav>
      <nav class="page-actions" aria-label="Page actions">
        <button class="action-tab">
          <span class="action-tab-text">Read</span>
          <span class="action-tab-icon cdx-icon" data-icon="cdxIconArticle"></span>
        </button>
        <button class="action-tab active">
          <span class="action-tab-text">Edit</span>
          <span class="action-tab-icon cdx-icon" data-icon="cdxIconEdit"></span>
        </button>
        <button class="action-tab">
          <span class="action-tab-text">View history</span>
          <span class="action-tab-icon cdx-icon" data-icon="cdxIconHistory"></span>
        </button>
        <button class="action-tab star">
          <span class="action-tab-text">⭐</span>
          <span class="action-tab-icon cdx-icon" data-icon="cdxIconStar"></span>
        </button>
      </nav>
    </div>
  </header>

  <!-- VE toolbar (hidden by default, shown in Step 3) -->
  <div class="ve-strip" id="veToolbar" role="region" aria-label="Editing toolbar" style="display: none;">
    <div class="ve-bar">
      <!-- Mobile toolbar -->
      <div class="mobile-toolbar">
        <button class="btn" id="close" title="Close"><span class="cdx-icon" data-icon="cdxIconClose"></span></button>
        <button class="btn" id="undo" title="Undo"><span class="cdx-icon" data-icon="cdxIconUndo"></span></button>
        <div class="dropdown" id="dd-style-mobile">
          <span class="cdx-icon" data-icon="cdxIconTextStyle"></span>
          <span class="caret" aria-hidden="true"></span>
          <div class="menu" id="menu-style-mobile">
            <button data-style="bold">Bold</button>
            <button data-style="italic">Italic</button>
            <button data-style="underline">Underline</button>
            <button data-style="strike">Strikethrough</button>
            <button data-style="clean">Clear styling</button>
          </div>
        </div>
        <button class="btn" id="quote" title="Quote"><span class="cdx-icon" data-icon="cdxIconQuotes"></span></button>
        <button class="btn" id="btn-link-mobile" title="Add link"><span class="cdx-icon" data-icon="cdxIconLink"></span></button>
        <button class="btn submit-btn" id="submit" title="Submit" style="margin-left: auto;"><span class="cdx-icon" data-icon="cdxIconNext"></span></button>
      </div>

      <!-- Desktop toolbar -->
      <div class="desktop-toolbar">
        <div class="group tight">
          <button class="btn" id="undo-desktop" title="Undo"><span class="cdx-icon" data-icon="cdxIconUndo"></span></button>
          <button class="btn" id="redo" title="Redo"><span class="cdx-icon" data-icon="cdxIconRedo"></span></button>
        </div>
        <div class="group">
          <div class="dropdown" id="dd-paragraph">
            <span class="cdx-icon" data-icon="cdxIconTextHeading"></span>
            <span class="cdx-button__label">Paragraph</span>
            <span class="caret" aria-hidden="true"></span>
            <div class="menu" id="menu-paragraph">
              <button data-header="">Paragraph</button>
              <button data-header="1">Heading 1</button>
              <button data-header="2">Heading 2</button>
              <button data-header="3">Heading 3</button>
              <button data-header="4">Heading 4</button>
              <button data-header="5">Heading 5</button>
              <button data-header="6">Heading 6</button>
              <button data-header="code">Preformatted</button>
            </div>
          </div>
        </div>
        <div class="group">
          <div class="dropdown" id="dd-style">
            <span class="cdx-icon" data-icon="cdxIconTextStyle"></span>
            <span class="cdx-button__label">A</span>
            <span class="caret" aria-hidden="true"></span>
            <div class="menu" id="menu-style">
              <button data-style="bold">Bold</button>
              <button data-style="italic">Italic</button>
              <button data-style="underline">Underline</button>
              <button data-style="strike">Strikethrough</button>
              <button data-style="clean">Clear styling</button>
            </div>
          </div>
        </div>
        <div class="group tight">
          <button class="btn" data-cmd="ol" title="Numbered list"><span class="cdx-icon" data-icon="cdxIconListNumbered"></span></button>
          <button class="btn" data-cmd="ul" title="Bullet list"><span class="cdx-icon" data-icon="cdxIconListBullet"></span></button>
        </div>
        <div class="group">
          <button class="btn" id="btn-link" title="Add link">
            <span class="cdx-icon" data-icon="cdxIconLink"></span>
            <span class="cdx-button__label">Link</span>
          </button>
          <div class="dropdown" id="dd-cite">
            <span class="cdx-icon" data-icon="cdxIconReference"></span>
            <span class="cdx-button__label">Cite</span>
            <span class="caret"></span>
            <div class="menu" id="menu-cite">
              <button data-cite="web">Cite web… (mock)</button>
              <button data-cite="book">Cite book… (mock)</button>
              <button data-cite="news">Cite news… (mock)</button>
            </div>
          </div>
          <div class="dropdown" id="dd-insert">
            <span class="cdx-icon" data-icon="cdxIconAdd"></span>
            <span class="cdx-button__label">Insert</span>
            <span class="caret"></span>
            <div class="menu" id="menu-insert">
              <button data-insert="image">Media…</button>
              <button data-insert="template">Template… (mock)</button>
              <button data-insert="math">Math… (mock)</button>
              <button data-insert="table">Table… (mock)</button>
              <button data-insert="char">Special character…</button>
            </div>
          </div>
        </div>
        <div class="group tight">
          <button class="btn" id="addSectionBtn" title="Add section"><span class="cdx-icon" data-icon="cdxIconAdd"></span><span class="cdx-button__label">Add section</span></button>
          <button class="btn" disabled title="Page options"><span class="cdx-icon" data-icon="cdxIconSettings"></span></button>
          <button class="btn" title="Help"><span class="cdx-icon" data-icon="cdxIconHelp"></span></button>
        </div>
        <div class="group" style="margin-left:auto;border-left:none;padding-right:0">
          <button class="btn publish-btn" id="publish" disabled>Publish</button>
        </div>
      </div>
    </div>
  </div>

  <main class="ve-content-wrap">
    <div class="surface">
      <div class="creator-wrap">
        <div class="ac-steps">
          <section class="ac-step active" id="step1">
            <h3>What article would you like to create?</h3>
            <input id="title" class="title-input" placeholder="e.g., Jane Doe / Example Software" aria-label="Proposed title">
            <div class="ac-actions">
              <button class="btn primary" id="toStep2" disabled>Continue</button>
            </div>
          </section>
          <section class="ac-step" id="step2">
            <h3>Assign a topic category</h3>
            <div class="category-list" id="categoryList">
              <div class="category-item" data-cat="person">Person / Biography</div>
              <div class="category-item" data-cat="place">Geographic Location</div>
              <div class="category-item" data-cat="species">Species / Biology</div>
              <div class="category-item" data-cat="organization">Organization</div>
              <div class="category-item" data-cat="academic">Academic / Concept</div>
              <div class="category-item" data-cat="creative">Creative Work</div>
              <div class="category-item" data-cat="event">Event</div>
            </div>
            <div class="hint">This helps us suggest the right structure and policies.</div>
            <div class="ac-actions">
              <button class="btn" id="backTo1">Back</button>
              <button class="btn primary" id="toStep3" disabled>Start editing</button>
            </div>
          </section>
          <section class="ac-step" id="step3">
            <div id="editor" class="editor" contenteditable="true" data-placeholder="Type the lead..."></div>
          </section>
        </div>
      </div>
      
    </div>
  </main>

  <!-- Footer status (shown only in Step 3) -->
  <footer class="ve-footer" id="veFooter" style="display: none;">
    <div class="status"><span>Changes are preview‑only in this demo.</span><span class="badge">Visual Editor</span></div>
  </footer>

  <div class="ref-dialog-backdrop" id="refBackdrop" aria-hidden="true">
    <div class="ref-dialog" role="dialog" aria-modal="true" aria-labelledby="refTitle">
      <div class="ref-row"><strong id="refTitle">Add reference</strong> <span id="refHint" class="badge">unclassified</span></div>
      <div class="ref-row"><label for="refUrl">Source URL</label><input id="refUrl" type="url" placeholder="https://example.com/article"></div>
      <div class="ref-row"><label for="refTitleInput">Title (optional)</label><input id="refTitleInput" type="text" placeholder="Article title"></div>
      <div class="ref-actions">
        <button class="btn" id="refCancel">Cancel</button>
        <button class="btn primary" id="refInsert">Insert cite</button>
      </div>
    </div>
  </div>

  <script>
    // === Codex Icons via MW API ===
    async function loadCodexIcons(iconNames) {
      const url = 'https://www.mediawiki.org/w/api.php?action=query&list=codexicons&format=json&origin=*' +
        '&names=' + encodeURIComponent(iconNames.join('|'));
      const res = await fetch(url);
      const data = await res.json();
      const out = {};
      const map = data?.query?.codexicons || {};
      
      for (const k of Object.keys(map)) {
        const entry = map[k];
        const path = typeof entry === 'string' ? entry : (entry.ltr || entry.default || Object.values(entry.langCodeMap || {})[0] || '');
        out[k] = path;
      }
      return out;
    }

    // Apply icons on load
    (function applyIcons() {
      const nodes = Array.from(document.querySelectorAll('.cdx-icon[data-icon]'));
      const names = Array.from(new Set(nodes.map(n => n.getAttribute('data-icon'))));
      
      loadCodexIcons(names).then(paths => {
        nodes.forEach(n => {
          const name = n.getAttribute('data-icon');
          const p = paths[name];
          if (p) {
            n.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">' + p + '</svg>';
          }
        });
      }).catch(console.error);
    })();
    // Steps
    var titleInput=document.getElementById('title');
    var toStep2=document.getElementById('toStep2');
    var toStep3=document.getElementById('toStep3');
    var backTo1=document.getElementById('backTo1');
    var step1=document.getElementById('step1');
    var step2=document.getElementById('step2');
    var step3=document.getElementById('step3');
    var categoryList=document.getElementById('categoryList');
    var selectedCat=null;

    titleInput.addEventListener('input', function(){ toStep2.disabled = !(titleInput.value.trim().length>0); });
    toStep2.onclick=function(){ 
      step1.classList.remove('active'); 
      step2.classList.add('active'); 
      
      // Update Step 2 title with the entered topic
      var step2Title = step2.querySelector('h3');
      var userTopic = titleInput.value.trim();
      if (step2Title && userTopic) {
        step2Title.textContent = 'What is "' + userTopic + '"?';
      }
    };
    backTo1 && (backTo1.onclick=function(){ step2.classList.remove('active'); step1.classList.add('active'); });
    categoryList && categoryList.addEventListener('click', function(e){
      var item=e.target.closest('.category-item'); if(!item) return;
      Array.from(categoryList.querySelectorAll('.category-item')).forEach(function(n){n.classList.remove('selected');});
      item.classList.add('selected'); selectedCat=item.getAttribute('data-cat'); toStep3.disabled=false;
    });
    toStep3 && (toStep3.onclick=function(){
      step2.classList.remove('active');
      step3.classList.add('active');
      
      // Activate VE interface
      document.body.classList.add('ve-in-step3');
      
      var ed = document.getElementById('editor');
      var t = titleInput.value.trim();
      var safeTitle = (t || 'Untitled').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      
      // Update VE header title
      var veTitle = document.getElementById('veTitle');
      if (veTitle) veTitle.textContent = safeTitle;
      
      // Initialize editor with just placeholder and cursor
      ed.innerHTML = '';
      ed.setAttribute('data-placeholder', 'Start writing about ' + safeTitle + '...');
      
      // Focus editor to show blinking cursor
      ed.focus();
      
      // Add input listener to activate publish/submit buttons when user starts typing
      ed.addEventListener('input', function() {
        var publishBtn = document.getElementById('publish');
        var submitBtn = document.getElementById('submit');
        
        if (ed.textContent.trim().length > 0) {
          // Desktop publish button
          if (publishBtn) {
            publishBtn.disabled = false;
            publishBtn.classList.add('primary');
            publishBtn.textContent = 'Publish changes';
          }
          
          // Mobile submit button  
          if (submitBtn) {
            submitBtn.classList.add('primary');
            submitBtn.style.background = '#36c';
            submitBtn.style.color = '#fff';
            submitBtn.style.borderColor = '#36c';
            // Make the icon white too
            var icon = submitBtn.querySelector('.cdx-icon svg');
            if (icon) icon.style.color = '#fff';
          }
        } else {
          // Reset buttons when content is empty
          if (publishBtn) {
            publishBtn.disabled = true;
            publishBtn.classList.remove('primary');
            publishBtn.textContent = 'Publish';
          }
          
          if (submitBtn) {
            submitBtn.classList.remove('primary');
            submitBtn.style.background = '';
            submitBtn.style.color = '';
            submitBtn.style.borderColor = '';
            // Reset icon color too
            var icon = submitBtn.querySelector('.cdx-icon svg');
            if (icon) icon.style.color = '';
          }
        }
      });
    });

    // Reference dialog
    var openBtn=null;
    var backdrop=document.getElementById('refBackdrop');
    var cancelBtn=document.getElementById('refCancel');
    var insertBtn=document.getElementById('refInsert');
    var urlInput=document.getElementById('refUrl');
    var hint=document.getElementById('refHint');
    var editor=document.getElementById('editor');
    var verify=document.getElementById('verify');
    var refBadges=document.getElementById('refBadges');
    function classify(url){ try{ var h=new URL(url).hostname; if(/\.(gov|gov\.[a-z]{2})$/i.test(h)) return {label:'gov',cls:'good'}; if(/\.(edu|ac\.[a-z]{2})$/i.test(h)) return {label:'edu',cls:'good'}; if(/(reuters|apnews|bbc|nytimes|guardian|bloomberg|washingtonpost|ft\.com)/i.test(h)) return {label:'news',cls:'good'}; if(/(prnewswire|businesswire|globenewswire|newswire|press)/i.test(h)) return {label:'press release',cls:'warn'}; return {label:'unclassified',cls:''}; }catch(e){ return {label:'unclassified',cls:''}; } }
    function openDialog(){ backdrop.style.display='block'; urlInput.focus(); }
    function closeDialog(){ backdrop.style.display='none'; }
    function bindRef(){ openBtn=document.getElementById("openRef"); if(openBtn){ openBtn.onclick=openDialog; }} bindRef(); cancelBtn.onclick=closeDialog; backdrop.addEventListener('click',function(e){ if(e.target===backdrop) closeDialog(); });
    urlInput.addEventListener('input',function(){ var c=classify(urlInput.value.trim()); hint.textContent=c.label; hint.className='badge '+(c.cls||''); });
    insertBtn.onclick=function(){ var url=urlInput.value.trim(); if(!url) return; if(document.activeElement!==editor) editor.focus(); document.execCommand('insertText', false, ' [1]'); var c=classify(url); refBadges.innerHTML='<span class="badge '+(c.cls||'')+'">'+c.label+'</span>'; closeDialog(); };
  </script>
</body>
</html>
