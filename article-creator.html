<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Article Creator — Reference Chip Concept</title>
  <link rel="stylesheet" href="https://unpkg.com/@wikimedia/codex@2.3.0/dist/codex.style.css">
  <link rel="stylesheet" href="https://unpkg.com/@wikimedia/codex-design-tokens@2.3.0/theme-wikimedia-ui.css">
  <link rel="stylesheet" href="reading-styles.css">
  <style>
    .creator-wrap { max-width: 1100px; margin: 0 auto; padding: 16px 20px; }
    .editor-shell { border: 1px solid var(--border-color-subtle, #eaecf0); border-radius: 4px; background: #fff; padding: 16px; }
    .title-input { width: 100%; font-size: 18px; padding: 8px 0; border: none; border-bottom: 2px solid #a2a9b1; }
    .title-input:focus { outline: none; border-bottom-color: #36c; }
    .chip-row { display: flex; gap: 8px; align-items: center; margin: 12px 0; flex-wrap: wrap; }
    .chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border: 1px solid #a2a9b1; border-radius: 12px; font-size: 12px; cursor: pointer; background: #f8f9fa; }
    .chip.reference { border-color: #36c; color: #36c; background: #eef3ff; }
    .editor { min-height: 260px; outline: none; }
    .editor[contenteditable="true"]:empty:before { content: attr(data-placeholder); color: #72777d; }
    /* Fix for H2 border issues in contenteditable */
    .editor h2 { 
      font-family: Georgia, serif;
      font-size: 1.5em;
      font-weight: normal;
      margin: 2em 0 0.25em 0;
      padding: 0 0 0.25em 0;
      border-bottom: 1px solid #eaecf0;
      position: relative;
    }
    .editor h2:first-child { margin-top: 1em; }
    /* Wiki section heading styles */
    .wiki-section-heading {
      font-family: Georgia, serif !important;
      font-size: 1.5em !important;
      font-weight: normal !important;
      margin: 2em 0 0.25em 0 !important;
      padding: 0 0 0.25em 0 !important;
      border-bottom: 1px solid #eaecf0 !important;
      position: relative !important;
      display: block !important;
    }
    .wiki-section-heading:first-child { margin-top: 1em !important; }
    /* Prevent duplicate borders and clean up contenteditable issues */
    .editor div:empty { border: none !important; display: none !important; }
    .editor div { border: none !important; border-bottom: none !important; }
    .editor p { border: none !important; border-bottom: none !important; }
    .editor br { display: block; margin: 0; padding: 0; border: none !important; }
    .editor hr { display: none !important; } /* Hide any stray HR elements */
    /* Only H2 elements should have borders */
    .editor h2.wiki-section-heading { 
      border-bottom: 1px solid #eaecf0 !important; 
    }
    /* Any other element trying to have a border-bottom should not */
    .editor *:not(h2) { 
      border-bottom: none !important; 
    }
    .verify-note { display: none; margin-top: 8px; font-size: 12px; color: #856404; background: #fff3cd; border: 1px solid #ffeaa7; padding: 6px 8px; border-radius: 4px; }
    .verify-note.show { display: block; }
    .ref-dialog-backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.4); z-index: 3000; }
    .ref-dialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: #fff; border: 1px solid #eaecf0; border-radius: 8px; width: 520px; max-width: 92vw; padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.2); }
    .ref-row { margin-bottom: 12px; }
    .ref-row label { display: block; font-size: 13px; margin-bottom: 6px; color: #202122; }
    .ref-row input { width: 100%; height: 34px; border: 1px solid #c8ccd1; border-radius: 4px; padding: 6px 10px; font: inherit; }
    .ref-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
    .badge { display:inline-block; font-size:10px; padding:2px 6px; border-radius:10px; border:1px solid #c8ccd1; color:#72777d; }
    .badge.good { color:#14866d; border-color:#14866d; }
    .badge.warn { color:#ac6600; border-color:#ac6600; }
  
    .chip.guidance { border-color: #c8ccd1; background: #fff; }
    .ac-steps { max-width: 1100px; margin: 0 auto; }
    .ac-step { display: none; border: 1px solid var(--border-color-subtle, #eaecf0); background: #fff; border-radius: 6px; padding: 16px; }
    .ac-step.active { display: block; }
    .ac-step h3 { margin: 0 0 12px 0; font-size: 1.1rem; }

    /* Q3 (Sources) — styles copied from creation.html for consistency */
    /* Center like other steps */
    #creation-stepSources.ac-step {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: none;
      background: transparent;
      box-shadow: none;
      max-width: 600px;
      width: 90%;
      z-index: 1000; /* ensure above chrome */
    }
    @media (max-width: 768px) {
      #creation-stepSources.ac-step {
        width: 95%;
        padding: 20px;
        top: 45%;
        transform: translate(-50%, -45%);
      }
    }
    #creation-stepSources h3 { font-size: 1.4rem; line-height: 1.35; margin-bottom: 8px; }
    #creation-stepSources > .hint:first-of-type {
      font-size: 15px;
      line-height: 1.6;
      color: #202122;
      margin: 4px 0 6px 0;
    }
    #creation-stepSources .source-url-input {
      flex: 1; width: auto; min-width: 0; height: 36px; box-sizing: border-box;
      padding: 8px 12px; border: 1px solid #a2a9b1; border-radius: 8px;
      background: #fff; font-size: 14px;
    }
    #creation-stepSources .source-chip-row { display: flex; align-items: center; gap: 8px; position: relative; }
    #creation-stepSources .source-url-input:focus {
      border-color: #36c; outline: none; box-shadow: inset 0 0 0 1px #36c;
    }
    #creation-stepSources .remove-source {
      background: none; border: none; color: #72777d; font-size: 20px;
      width: auto; height: auto; line-height: 1; padding: 4px; cursor: pointer;
    }
    #creation-stepSources .remove-source:hover { color: #202122; }
    #creation-stepSources .readiness-line { display:flex; align-items:center; gap:8px; padding-top:0; }
    #creation-stepSources .readiness-label { font-size:13px; color:#555; }
    #creation-stepSources .readiness-status { font-size:13px; font-weight:600; color:#666; }
    #creation-stepSources .readiness-count { font-size:13px; color:#72777d; }
    #creation-stepSources .readiness-status.state-ready { color:#14866d; }
    #creation-stepSources .readiness-status.state-mid { color:#ac6600; }
    #creation-stepSources .readiness-status.state-low { color:#666; }
    #creation-stepSources .source-status { display:none; margin-top:0; font-size:12px; }
    #creation-stepSources .source-group { display:flex; flex-direction:column; gap:4px; }
    #creation-stepSources .status-chip { display:inline-flex; align-items:center; gap:6px; padding:4px 8px; border-radius:6px; }
    #creation-stepSources .status-validating { background:#f3f4f6; color:#555; }
    #creation-stepSources .status-verified { background:#d5fdf4; color:#14866d; font-weight:600; }
    #creation-stepSources .spinner { width:12px; height:12px; border:2px solid #d0d5dd; border-top-color:#36c; border-radius:50%; animation:spin .8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    #creation-stepSources .add-source-btn {
      display:inline-flex; align-items:center; gap:6px; padding:8px 14px;
      border:1px solid #c8ccd1; border-radius:6px; background:#f8f9fa; color:#202122; font-size:13px; cursor:pointer;
    }
    #creation-stepSources .add-source-btn:hover { background:#eef3ff; border-color:#b6c8f0; }
    
    /* Center Step 1 in viewport */
    #step1.ac-step {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: none;
      background: transparent;
      box-shadow: none;
      max-width: 600px;
      width: 90%;
      z-index: 100;
    }
    
    /* Responsive positioning for mobile with keyboard */
    @media (max-height: 600px) {
      #step1.ac-step {
        position: fixed;
        top: 30%;
        transform: translate(-50%, -30%);
      }
    }
    
    @media (max-width: 768px) {
      #step1.ac-step {
        width: 95%;
        padding: 20px;
      }
      
      /* Adjust for mobile keyboard */
      @media (max-height: 500px) {
        #step1.ac-step {
          top: 20%;
          transform: translate(-50%, -20%);
        }
      }
    }
    
    /* Center Step 2 in viewport */
    #step2.ac-step {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: none;
      background: transparent;
      box-shadow: none;
      max-width: 700px;
      width: 90%;
      z-index: 100;
    }
    
    /* Responsive positioning for Step 2 */
    @media (max-width: 768px) {
      #step2.ac-step {
        width: 95%;
        padding: 20px;
        top: 45%;
        transform: translate(-50%, -45%);
      }
    }
    
    .ac-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
    .ac-actions .btn { height: 34px; padding: 0 12px; border: 1px solid #c8ccd1; border-radius: 4px; background: #fff; cursor: pointer; }
    .ac-actions .btn.primary { background: #36c; color: #fff; border-color: #36c; }
    .category-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; margin: 8px 0 4px; }
    .category-item { border: 1px solid #c8ccd1; border-radius: 4px; padding: 10px; cursor: pointer; background: #fff; }
    .category-item:hover { background: #f8f9fa; }
    .category-item.selected { border-color: #36c; box-shadow: 0 0 0 2px #eaf3ff; }
    .hint { font-size: 12px; color: #72777d; margin-top: 6px; }
    /* Hide the VE chrome by default - show when Step 3 is active */
    .ve-in-step3 #veHeader,
    .ve-in-step3 #veToolbar {
      display: block !important;
    }
    
    /* Mobile-only: Hide header and show footer instead */
    @media (max-width: 768px) {
      .ve-in-step3 #veHeader {
        display: none !important;
      }
      
      .ve-in-step3 #veFooter {
        display: block !important;
      }
      
      /* Footer styling - mobile only */
      .ve-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        border-top: 1px solid var(--border-color-subtle, #eaecf0);
        padding: 8px 16px;
        font-size: 12px;
        color: var(--color-subtle, #54595d);
        z-index: 10;
      }
      
      .ve-footer .status {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1100px;
        margin: 0 auto;
      }
    }
    
    /* Clean layout for Step 3 */
    .ve-in-step3 .creator-wrap {
      max-width: none;
      padding: 0;
    }
    
    .ve-in-step3 #step3 {
      border: none;
      background: transparent;
      padding: 0;
    }
    
    .ve-in-step3 #editor {
      border: none;
      background: transparent;
      min-height: 400px;
      padding: 16px 0;
    }
    
    /* Primary button styling for publish/submit buttons */
    .btn.primary {
      background: #36c !important;
      color: #fff !important;
      border-color: #36c !important;
    }
    
    .btn.primary:hover {
      background: #2a4b8d !important;
      border-color: #2a4b8d !important;
    }
    
    /* Guide Me Sidebar */
    .guide-sidebar {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100vh;
      background: #fff;
      border-left: 1px solid var(--border-color-subtle, #eaecf0);
      box-shadow: -2px 0 8px rgba(0,0,0,0.1);
      z-index: 1000;
      transition: right 0.3s ease;
      overflow-y: auto;
    }
    
    .guide-sidebar.open {
      right: 0;
    }
    
    .guide-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color-subtle, #eaecf0);
      background: #f8f9fa;
    }
    
    .guide-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #202122;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #72777d;
      padding: 4px;
      border-radius: 4px;
    }
    
    .close-btn:hover {
      background: #eaecf0;
      color: #202122;
    }
    
    .section-close-btn:hover {
      background: #f0f0f0;
      color: #d33;
    }
    
    .guide-content {
      padding: 20px;
    }
    
    .guide-section {
      margin-bottom: 24px;
    }
    
    .guide-section h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
      color: #202122;
    }
    
    .guide-section ul {
      margin: 0;
      padding-left: 20px;
      list-style-type: disc;
    }
    
    .guide-section li {
      margin-bottom: 8px;
      font-size: 13px;
      line-height: 1.4;
      color: #54595d;
    }
    
    .guide-section li strong {
      color: #202122;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      .guide-sidebar {
        display: none; /* Hide sidebar on mobile, use modal instead */
      }
    }
    
    /* Guide Me Modal Drawer (Mobile) */
    .guide-modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
    }
    
    .guide-modal-backdrop.open {
      display: block;
    }
    
    .guide-modal-drawer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      max-height: 70vh;
      overflow-y: auto;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }
    
    .guide-modal-backdrop.open .guide-modal-drawer {
      transform: translateY(0);
    }
    
    .guide-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color-subtle, #eaecf0);
      background: #f8f9fa;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }
    
    .guide-modal-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #202122;
    }
    
    .guide-modal-content {
      padding: 20px;
    }
    
    /* Section suggestion buttons - simplified design */
    .section-button {
      display: block;
      width: 100%;
      margin-bottom: 12px;
      padding: 12px;
      border: 1px solid #c8ccd1;
      border-radius: 4px;
      background: #fff;
      color: #202122;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .section-button:hover {
      background: #f8f9fa;
      border-color: #36c;
    }
    
    .section-button.added {
      background: #eaf3ff;
      border-color: #36c;
      opacity: 0.7;
      cursor: default;
    }
    
    .section-info {
      display: block;
    }
    
    .section-name {
      font-size: 13px;
      font-weight: 500;
      display: block;
    }
    
    .section-description {
      font-size: 11px;
      color: #72777d;
      line-height: 1.3;
      display: block;
      margin-top: 2px;
    }
    
    .section-action {
      display: block;
      font-size: 12px;
      color: #36c;
      font-weight: 500;
      margin-top: 8px;
    }
    
    .section-button.added .section-action {
      color: #14866d;
    }
    
    
    /* Source button styling */
    .source-button {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #c8ccd1;
      border-radius: 4px;
      background: #f8f9fa;
      color: #202122;
      cursor: pointer;
      transition: all 0.2s ease;
      gap: 10px;
    }

    /* References section formatting (match creation.html) */
    .references { margin: 1.25em 0; }
    .references h2 { font-family: Georgia, serif; font-size: 1.5em; font-weight: 400; margin: 2em 0 0.35em 0; padding-bottom: 0.25em; border-bottom: 1px solid #eaecf0; }
    .references ol { margin-left: 0; padding-left: 1.5rem; }
    .references li { padding-left: .5rem; text-indent: -.5rem; margin: 0.25em 0; line-height: 1.5; }
    .references em { font-style: italic; }
    .references a { color: #0645ad; word-break: break-word; overflow-wrap: anywhere; }
    
    .source-button:hover {
      background: #eaecf0;
      border-color: #a2a9b1;
    }
    
    .source-button-icon {
      font-size: 16px;
    }
    
    .source-button-text {
      font-size: 13px;
      font-weight: 500;
    }
    
    /* Source modal styling */
    .source-modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 3000;
    }
    
    .source-modal-backdrop[aria-hidden="false"] {
      display: block;
    }
    
    .source-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #eaecf0;
      border-radius: 8px;
      width: 600px;
      max-width: 92vw;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    
    .source-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #eaecf0;
      background: #f8f9fa;
    }
    
    .source-modal-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #202122;
    }
    
    .source-modal-content {
      padding: 20px;
    }
    
    .source-input-section label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #202122;
    }
    
    .source-input-section input {
      width: 100%;
      height: 36px;
      border: 1px solid #c8ccd1;
      border-radius: 4px;
      padding: 8px 12px;
      font: inherit;
      margin-bottom: 12px;
    }
    
    .source-note {
      font-size: 12px;
      color: #ac6600;
      background: #fef6e7;
      border: 1px solid #fc3;
      border-radius: 4px;
      padding: 8px 12px;
      margin-bottom: 20px;
    }
    
    .source-verification h4,
    .draft-preview h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
      color: #202122;
    }
    
    .verification-step {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      font-size: 13px;
    }
    
    .step-icon {
      font-size: 14px;
      width: 16px;
    }
    
    .verification-step.completed .step-icon {
      color: #14866d;
    }
    
    .verification-step.completed .step-text {
      color: #14866d;
    }
    
    .source-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .source-badge.reliable {
      background: #d5fdf4;
      color: #14866d;
      border: 1px solid #14866d;
    }
    
    .source-badge.questionable {
      background: #fef6e7;
      color: #ac6600;
      border: 1px solid #fc3;
    }
    
    .reliability-note {
      font-size: 12px;
      color: #54595d;
    }
    
    .draft-warning {
      background: #fef6e7;
      border: 1px solid #fc3;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 12px;
      color: #ac6600;
      margin-bottom: 16px;
      font-weight: 600;
    }
    
    .draft-content {
      background: #f8f9fa;
      border: 1px solid #eaecf0;
      border-radius: 4px;
      padding: 16px;
      font-family: Georgia, serif;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    
    .source-modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      padding: 16px 20px;
      border-top: 1px solid #eaecf0;
      background: #f8f9fa;
    }
    
    .guide-note {
      font-size: 14px;
      color: #72777d;
      margin: 12px 0 16px 0;
      font-style: italic;
    }
    
    /* Sidebar source verification styles */
    .source-input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .source-url-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #a2a9b1;
      border-radius: 2px;
      font-size: 13px;
      font-family: inherit;
    }
    
    .source-url-input:focus {
      border-color: #36c;
      outline: none;
      box-shadow: inset 0 0 0 1px #36c;
    }
    
    .source-check-btn {
      padding: 8px 16px;
      background: #36c;
      color: white;
      border: 1px solid #36c;
      border-radius: 2px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .source-check-btn:hover {
      background: #2a4b8d;
      border-color: #2a4b8d;
    }
    
    .source-check-btn:disabled {
      background: #a2a9b1;
      border-color: #a2a9b1;
      cursor: not-allowed;
    }
    
    .source-warning {
      font-size: 12px;
      line-height: 1.4;
    }
    
    .sidebar-verification-step {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 13px;
    }
    
    .sidebar-step-icon {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #eaecf0;
      color: #72777d;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      flex-shrink: 0;
    }
    
    .sidebar-step-icon.active {
      background: #36c;
      color: white;
    }
    
    .sidebar-step-icon.completed {
      background: #00af89;
      color: white;
    }
    
    .sidebar-source-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 2px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .sidebar-source-badge.reliable {
      background: #d5fdf4;
      color: #00af89;
      border: 1px solid #00af89;
    }
    
    .sidebar-source-badge.questionable {
      background: #fef6e7;
      color: #ac6600;
      border: 1px solid #fc3;
    }
    
    .sidebar-draft-content {
      background: #f8f9fa;
      border: 1px solid #eaecf0;
      border-radius: 2px;
      padding: 12px;
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
      margin-bottom: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .sidebar-action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    
    .sidebar-action-btn {
      padding: 6px 12px;
      border: 1px solid #a2a9b1;
      border-radius: 2px;
      background: white;
      color: #202122;
      font-size: 12px;
      cursor: pointer;
    }
    
    .sidebar-action-btn.primary {
      background: #36c;
      color: white;
      border-color: #36c;
    }
    
    .sidebar-action-btn:hover {
      background: #f8f9fa;
    }
    
    .sidebar-action-btn.primary:hover {
      background: #2a4b8d;
      border-color: #2a4b8d;
    }
    
    /* Eligibility checker styles */
    .eligibility-options {
      display: flex;
      gap: 8px;
    }
    
    .eligibility-btn {
      padding: 6px 12px;
      border: 1px solid #a2a9b1;
      border-radius: 2px;
      background: #f8f9fa;
      color: #222;
      font-size: 13px;
      cursor: pointer;
    }
    
    .eligibility-btn:hover {
      background: #eaecf0;
    }
    
    .eligibility-btn.selected {
      background: #36c;
      color: white;
      border-color: #36c;
    }
    
    /* Hide modal on desktop */
    @media (min-width: 769px) {
      .guide-modal-backdrop {
        display: none !important;
      }
    }
    /* Match vertical spacing between rows (Q3) */
    #creation-sourcesList { display: flex; flex-direction: column; gap: 16px; }
  </style>
</head>
<body>

  <!-- Wikipedia-style header (hidden by default, shown in Step 3) -->
  <header class="container page-header" id="veHeader" role="banner" style="display: none;">
    <h1 class="firstHeading" id="veTitle">New Article</h1>
    <div class="page-tabs-wrapper">
      <nav class="ns-tabs" aria-label="Namespace tabs">
        <button class="ns-tab active">Article</button>
        <button class="ns-tab">Talk</button>
      </nav>
      <nav class="page-actions" aria-label="Page actions">
        <button class="action-tab">
          <span class="action-tab-text">Read</span>
          <span class="action-tab-icon cdx-icon" data-icon="cdxIconArticle"></span>
        </button>
        <button class="action-tab active">
          <span class="action-tab-text">Edit</span>
          <span class="action-tab-icon cdx-icon" data-icon="cdxIconEdit"></span>
        </button>
        <button class="action-tab">
          <span class="action-tab-text">View history</span>
          <span class="action-tab-icon cdx-icon" data-icon="cdxIconHistory"></span>
        </button>
        <button class="action-tab star">
          <span class="action-tab-text">⭐</span>
          <span class="action-tab-icon cdx-icon" data-icon="cdxIconStar"></span>
        </button>
      </nav>
    </div>
  </header>

  <!-- VE toolbar (hidden by default, shown in Step 3) -->
  <div class="ve-strip" id="veToolbar" role="region" aria-label="Editing toolbar" style="display: none;">
    <div class="ve-bar">
      <!-- Mobile toolbar -->
      <div class="mobile-toolbar">
        <button class="btn" id="close" title="Close"><span class="cdx-icon" data-icon="cdxIconClose"></span></button>
        <button class="btn" id="undo" title="Undo"><span class="cdx-icon" data-icon="cdxIconUndo"></span></button>
        <div class="dropdown" id="dd-style-mobile">
          <span class="cdx-icon" data-icon="cdxIconTextStyle"></span>
          <span class="caret" aria-hidden="true"></span>
          <div class="menu" id="menu-style-mobile">
            <button data-style="bold">Bold</button>
            <button data-style="italic">Italic</button>
            <button data-style="underline">Underline</button>
            <button data-style="strike">Strikethrough</button>
            <button data-style="clean">Clear styling</button>
          </div>
        </div>
        <button class="btn" id="quote" title="Quote"><span class="cdx-icon" data-icon="cdxIconQuotes"></span></button>
        <button class="btn" id="btn-link-mobile" title="Add link"><span class="cdx-icon" data-icon="cdxIconLink"></span></button>
        <button class="btn" id="guideMeMobile" title="Get suggestions"><span style="font-size: 16px; filter: brightness(0.7);">✨</span></button>
        <button class="btn submit-btn" id="submit" title="Submit" style="margin-left: auto;"><span class="cdx-icon" data-icon="cdxIconNext"></span></button>
      </div>

      <!-- Desktop toolbar -->
      <div class="desktop-toolbar">
        <div class="group tight">
          <button class="btn" id="undo-desktop" title="Undo"><span class="cdx-icon" data-icon="cdxIconUndo"></span></button>
          <button class="btn" id="redo" title="Redo"><span class="cdx-icon" data-icon="cdxIconRedo"></span></button>
        </div>
        <div class="group">
          <div class="dropdown" id="dd-paragraph">
            <span class="cdx-icon" data-icon="cdxIconTextHeading"></span>
            <span class="cdx-button__label">Paragraph</span>
            <span class="caret" aria-hidden="true"></span>
            <div class="menu" id="menu-paragraph">
              <button data-header="">Paragraph</button>
              <button data-header="1">Heading 1</button>
              <button data-header="2">Heading 2</button>
              <button data-header="3">Heading 3</button>
              <button data-header="4">Heading 4</button>
              <button data-header="5">Heading 5</button>
              <button data-header="6">Heading 6</button>
              <button data-header="code">Preformatted</button>
            </div>
          </div>
        </div>
        <div class="group">
          <div class="dropdown" id="dd-style">
            <span class="cdx-icon" data-icon="cdxIconTextStyle"></span>
            <span class="cdx-button__label">A</span>
            <span class="caret" aria-hidden="true"></span>
            <div class="menu" id="menu-style">
              <button data-style="bold">Bold</button>
              <button data-style="italic">Italic</button>
              <button data-style="underline">Underline</button>
              <button data-style="strike">Strikethrough</button>
              <button data-style="clean">Clear styling</button>
            </div>
          </div>
        </div>
        <div class="group tight">
          <button class="btn" data-cmd="ol" title="Numbered list"><span class="cdx-icon" data-icon="cdxIconListNumbered"></span></button>
          <button class="btn" data-cmd="ul" title="Bullet list"><span class="cdx-icon" data-icon="cdxIconListBullet"></span></button>
        </div>
        <div class="group">
          <button class="btn" id="btn-link" title="Add link">
            <span class="cdx-icon" data-icon="cdxIconLink"></span>
            <span class="cdx-button__label">Link</span>
          </button>
          <div class="dropdown" id="dd-cite">
            <span class="cdx-icon" data-icon="cdxIconReference"></span>
            <span class="cdx-button__label">Cite</span>
            <span class="caret"></span>
            <div class="menu" id="menu-cite">
              <button data-cite="web">Cite web… (mock)</button>
              <button data-cite="book">Cite book… (mock)</button>
              <button data-cite="news">Cite news… (mock)</button>
            </div>
          </div>
          <div class="dropdown" id="dd-insert">
            <span class="cdx-icon" data-icon="cdxIconAdd"></span>
            <span class="cdx-button__label">Insert</span>
            <span class="caret"></span>
            <div class="menu" id="menu-insert">
              <button data-insert="image">Media…</button>
              <button data-insert="template">Template… (mock)</button>
              <button data-insert="math">Math… (mock)</button>
              <button data-insert="table">Table… (mock)</button>
              <button data-insert="char">Special character…</button>
            </div>
          </div>
        </div>
        <div class="group tight">
          <button class="btn" id="addSectionBtn" title="Get suggestions"><span style="font-size: 16px; filter: brightness(0.7); margin-right: 6px;">✨</span><span class="cdx-button__label">Suggestions</span></button>
          <button class="btn" disabled title="Page options"><span class="cdx-icon" data-icon="cdxIconSettings"></span></button>
          <button class="btn" title="Help"><span class="cdx-icon" data-icon="cdxIconHelp"></span></button>
        </div>
        <div class="group" style="margin-left:auto;border-left:none;padding-right:0">
          <button class="btn publish-btn" id="publish" disabled>Publish</button>
        </div>
      </div>
    </div>
  </div>

  <main class="ve-content-wrap">
    <div class="surface">
      <div class="creator-wrap">
        <div class="ac-steps">
          <section class="ac-step active" id="step1">
            <h3 data-i18n="steps.step1.title">What article would you like to create?</h3>
            <input id="title" class="title-input" placeholder="e.g., Jane Doe / Example Software" data-i18n-placeholder="steps.step1.placeholder" aria-label="Proposed title">
            <div class="ac-actions">
              <button class="btn primary" id="toStep2" disabled data-i18n="steps.step1.continue">Continue</button>
            </div>
          </section>
          <section class="ac-step" id="step2">
            <h3 data-i18n="steps.step2.title">Assign a topic category</h3>
            <div class="category-list" id="categoryList">
              <div class="category-item" data-cat="person">Person / Biography</div>
              <div class="category-item" data-cat="place">Geographic Location</div>
              <div class="category-item" data-cat="species">Species / Biology</div>
              <div class="category-item" data-cat="organization">Organization</div>
              <div class="category-item" data-cat="academic">Academic / Concept</div>
              <div class="category-item" data-cat="creative">Creative Work</div>
              <div class="category-item" data-cat="event">Event</div>
              <div class="category-item" data-cat="other">Other</div>
            </div>
            <div class="hint" data-i18n="steps.step2.helper">This helps us suggest the right structure and policies.</div>
            <div class="ac-actions">
              <button class="btn" id="backTo1">Back</button>
              <button class="btn primary" id="toStep3" disabled data-i18n="steps.step2.continue">Continue</button>
            </div>
          </section>
          <!-- Optional Sources Step (Q3) — exact markup parity with creation.html -->
          <section class="ac-step" id="creation-stepSources">
            <h3 data-i18n="creation.sourcesStep.title">Do you have at least two independent, reliable sources for "d"?</h3>
            <p class="hint" data-i18n="creation.sourcesStep.subtext">Strong sources help articles survive review and deletion.</p>
            <div id="creation-readiness-line" class="readiness-line is-hidden" aria-live="polite">
              <span class="readiness-label" data-i18n="creation.sourcesStep.readiness.label">Readiness:</span>
              <span id="creation-readiness-status" class="readiness-status" data-i18n="creation.sourcesStep.readiness.notReady">Not ready</span>
              <span id="creation-readiness-count" class="readiness-count">(0/2 <span data-i18n="creation.sourcesStep.readiness.countSuffix">verified sources</span>)</span>
            </div>
            <div id="creation-sourcesList">
              <div class="source-group">
                <div class="source-chip-row" data-index="0">
                  <input type="url" class="source-url-input" placeholder="https://example.com/article" data-i18n-placeholder="creation.sourcesStep.urlPlaceholder" aria-label="Source URL">
                  <button type="button" class="sidebar-action-btn remove-source" aria-label="Remove" title="Remove">×</button>
                </div>
                <div class="source-status" aria-live="polite"></div>
              </div>
              <div class="source-group">
                <div class="source-chip-row" data-index="1">
                  <input type="url" class="source-url-input" placeholder="https://example.com/article" data-i18n-placeholder="creation.sourcesStep.urlPlaceholder" aria-label="Source URL">
                  <button type="button" class="sidebar-action-btn remove-source" aria-label="Remove" title="Remove">×</button>
                </div>
                <div class="source-status" aria-live="polite"></div>
              </div>
            </div>
            <p id="creation-sources-readiness" class="readiness is-hidden" aria-live="polite" data-i18n="creation.sourcesStep.readiness.notReady">Not ready</p>
            <p id="creation-sources-hint" class="hint"></p>
            <div style="margin:10px 0 2px 0;">
              <button class="add-source-btn" id="creation-addSourceChip" data-i18n="creation.sourcesStep.addAnother">Add another</button>
            </div>
            <div class="ac-actions">
              <button class="btn" id="creation-sourcesBack" data-i18n="creation.sourcesStep.actions.back">Back</button>
              <button class="btn" id="creation-sourcesSkip" data-i18n="creation.sourcesStep.actions.skip">Skip for now</button>
              <button class="btn primary" id="creation-sourcesContinue" data-i18n="creation.sourcesStep.actions.continue">Start editing</button>
            </div>
          </section>
          <section class="ac-step" id="step3">
            <div id="editor" class="editor" contenteditable="true" data-placeholder="Type the lead..."></div>
          </section>
        </div>
      </div>
      
    </div>
  </main>

  <!-- Guide Me Sidebar -->
  <div class="guide-sidebar" id="guideSidebar">
    <div class="guide-header">
      <h3>Writing guidance</h3>
      <button class="close-btn" id="closeSidebar" title="Close">×</button>
    </div>
    <div class="guide-content" id="guideContent">
      <!-- Content will be dynamically loaded here -->
    </div>
  </div>

  <!-- Guide Me Modal Drawer (Mobile) -->
  <div class="guide-modal-backdrop" id="guideModalBackdrop">
    <div class="guide-modal-drawer" id="guideModalDrawer">
      <div class="guide-modal-header">
        <h3>Writing guidance</h3>
        <button class="close-btn" id="closeModalDrawer" title="Close">×</button>
      </div>
      <div class="guide-modal-content" id="guideModalContent">
        <!-- Content will be dynamically loaded here -->
      </div>
    </div>
  </div>

  <!-- Footer status (shown only in Step 3) -->
  <footer class="ve-footer" id="veFooter" style="display: none;">
    <div class="status"><span>Changes are preview‑only in this demo.</span><span class="badge">Visual Editor</span></div>
  </footer>

  <!-- Source verification modal -->
  <div class="source-modal-backdrop" id="sourceModalBackdrop" aria-hidden="true">
    <div class="source-modal" role="dialog" aria-modal="true" aria-labelledby="sourceModalTitle">
      <div class="source-modal-header">
        <h3 id="sourceModalTitle">Add content from a reliable source</h3>
        <button class="close-btn" id="closeSourceModal" title="Close">×</button>
      </div>
      <div class="source-modal-content">
        <div class="source-input-section">
          <label for="sourceUrl">Source URL</label>
          <input type="url" id="sourceUrl" placeholder="https://example.com/article" />
        </div>
        
        <div class="source-verification" id="sourceVerification" style="display: none;">
          <h4>Source verification</h4>
          <div class="verification-steps" id="verificationSteps">
            <div class="verification-step" id="step1">
              <span class="step-icon">⏳</span>
              <span class="step-text">Checking domain...</span>
            </div>
            <div class="verification-step" id="step2">
              <span class="step-icon">⏳</span>
              <span class="step-text">Verifying reliability...</span>
            </div>
            <div class="verification-step" id="step3">
              <span class="step-icon">⏳</span>
              <span class="step-text">Checking HTTPS security...</span>
            </div>
          </div>
          <div class="source-result" id="sourceResult" style="display: none;">
            <div class="source-badge" id="sourceBadge"></div>
            <div class="reliability-note" id="reliabilityNote"></div>
          </div>
        </div>
        
        <div class="draft-preview" id="draftPreview" style="display: none;">
          <h4>Draft content preview</h4>
          <div class="draft-content" id="draftContent"></div>
        </div>
      </div>
      <div class="source-modal-actions">
        <button class="btn" id="cancelSource">Cancel</button>
        <button class="btn" id="checkSourceBtn">Check source</button>
        <button class="btn primary" id="generateDraftBtn" style="display: none;">Create draft from source</button>
        <button class="btn primary" id="insertDraftBtn" style="display: none;">Insert as draft</button>
      </div>
    </div>
  </div>

  <div class="ref-dialog-backdrop" id="refBackdrop" aria-hidden="true">
    <div class="ref-dialog" role="dialog" aria-modal="true" aria-labelledby="refTitle">
      <div class="ref-row"><strong id="refTitle">Add reference</strong> <span id="refHint" class="badge">unclassified</span></div>
      <div class="ref-row"><label for="refUrl">Source URL</label><input id="refUrl" type="url" placeholder="https://example.com/article"></div>
      <div class="ref-row"><label for="refTitleInput">Title (optional)</label><input id="refTitleInput" type="text" placeholder="Article title"></div>
      <div class="ref-actions">
        <button class="btn" id="refCancel">Cancel</button>
        <button class="btn primary" id="refInsert">Insert cite</button>
      </div>
    </div>
  </div>

  <script>
    // === Minimal runtime i18n (applies data-i18n and placeholders) ===
    (function runtimeI18n(){
      try {
        var segs = location.pathname.split('/').filter(Boolean).map(function(s){ return s.toLowerCase(); });
        var qp = new URLSearchParams(location.search);
        var langQ = (qp.get('lang')||'').toLowerCase();
        // Repo-aware detection: /<repo>/<lang>/...
        var repoSeg = segs[0] || '';
        var pathLang = (segs[1] === 'id' || segs[1] === 'en') ? segs[1] : ((segs[0] === 'id' || segs[0] === 'en') ? segs[0] : '');
        var lang = (langQ === 'id' || langQ === 'en') ? langQ : (pathLang || 'en');
        window.currentLang = lang;
        function getNested(obj, path){ try { return path.split('.').reduce(function(a,k){ return (a && a[k]!=null)?a[k]:undefined; }, obj); } catch(_) { return undefined; } }
        function applyDom(){
          try {
            document.querySelectorAll('[data-i18n]').forEach(function(el){ var k=el.getAttribute('data-i18n'); var v=getNested(window.translationsByLang[window.currentLang]||{}, k); if (typeof v==='string') el.textContent=v; });
            document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el){ var k=el.getAttribute('data-i18n-placeholder'); var v=getNested(window.translationsByLang[window.currentLang]||{}, k); if (typeof v==='string') el.setAttribute('placeholder', v); });
          } catch(_){}
        }
        var cands = ['./translations.json','../translations.json','../../translations.json','/translations.json'];
        (function next(){
          if (!cands.length) { return; }
          var u = cands.shift();
          fetch(u+'?v='+(Date.now()))
            .then(function(r){ if(!r.ok) throw 0; return r.json(); })
            .then(function(j){ window.translationsByLang=j; applyDom(); })
            .catch(function(){ next(); });
        })();
      } catch(_){}
    })();

    // === Codex Icons via MW API ===
    async function loadCodexIcons(iconNames) {
      const url = 'https://www.mediawiki.org/w/api.php?action=query&list=codexicons&format=json&origin=*' +
        '&names=' + encodeURIComponent(iconNames.join('|'));
      const res = await fetch(url);
      const data = await res.json();
      const out = {};
      const map = data?.query?.codexicons || {};
      
      for (const k of Object.keys(map)) {
        const entry = map[k];
        const path = typeof entry === 'string' ? entry : (entry.ltr || entry.default || Object.values(entry.langCodeMap || {})[0] || '');
        out[k] = path;
      }
      return out;
    }

    // Apply icons on load
    (function applyIcons() {
      const nodes = Array.from(document.querySelectorAll('.cdx-icon[data-icon]'));
      const names = Array.from(new Set(nodes.map(n => n.getAttribute('data-icon'))));
      
      loadCodexIcons(names).then(paths => {
        nodes.forEach(n => {
          const name = n.getAttribute('data-icon');
          const p = paths[name];
          if (p) {
            n.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">' + p + '</svg>';
          }
        });
      }).catch(console.error);
    })();
    // Steps
    var titleInput=document.getElementById('title');
    var toStep2=document.getElementById('toStep2');
    var toStep3=document.getElementById('toStep3');
    var backTo1=document.getElementById('backTo1');
    var step1=document.getElementById('step1');
    var step2=document.getElementById('step2');
    var step3=document.getElementById('step3');
    var categoryList=document.getElementById('categoryList');
    var selectedCat=null;

    titleInput.addEventListener('input', function(){ 
      toStep2.disabled = !(titleInput.value.trim().length>0); 
      
      // Update sister project content when title changes
      setTimeout(function() {
        updateGuideContent();
      }, 300); // Small delay for better performance
    });
    toStep2.onclick=function(){ 
      step1.classList.remove('active'); 
      step2.classList.add('active'); 
      
      // Update Step 2 title with the entered topic
      var step2Title = step2.querySelector('h3');
      var userTopic = titleInput.value.trim();
      if (step2Title && userTopic) {
        step2Title.textContent = 'What is "' + userTopic + '"?';
      }
    };
    backTo1 && (backTo1.onclick=function(){ step2.classList.remove('active'); step1.classList.add('active'); });
    categoryList && categoryList.addEventListener('click', function(e){
      var item=e.target.closest('.category-item'); if(!item) return;
      Array.from(categoryList.querySelectorAll('.category-item')).forEach(function(n){n.classList.remove('selected');});
      item.classList.add('selected'); selectedCat=item.getAttribute('data-cat'); toStep3.disabled=false;
      
      // Update guide content when category changes
      setTimeout(updateGuideContent, 100);
    });

    // Step 2 Continue: go to Q3 or editor
    toStep3 && (toStep3.onclick=function(){
      var sourcesStep = document.getElementById('creation-stepSources');
      if (sourcesStep) {
        step2.classList.remove('active');
        sourcesStep.classList.add('active');
        try {
          var h = sourcesStep.querySelector('h3');
          var userTopic = (titleInput.value || '').trim();
          if (h && userTopic) {
            h.textContent = 'Do you have at least two independent, reliable sources for "' + userTopic + '"?';
          }
        } catch(_) {}
        setupSourcesStep();
        return;
      }
      goToEditor();
    });

    function goToEditor(){
      try { var ss = document.getElementById('creation-stepSources'); if (ss) ss.classList.remove('active'); } catch(_) {}
      step3.classList.add('active');
      step2.classList.remove('active');
      document.body.classList.add('ve-in-step3');
      var ed = document.getElementById('editor');
      var t = titleInput.value.trim();
      var safeTitle = (t || 'Untitled').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      var veTitle = document.getElementById('veTitle'); if (veTitle) veTitle.textContent = safeTitle;
      ed.innerHTML = '';
      ed.setAttribute('data-placeholder', 'Start writing about ' + safeTitle + '...');
      ed.focus();
      try { if (typeof applyEligibilityAutoFromSources === 'function') applyEligibilityAutoFromSources(); } catch(_) {}
    }

    // === Q3 Sources Step (ported from creation.html) ===
    function setupSourcesStep(){
      try {
        var list = document.getElementById('creation-sourcesList');
        if (!list) return;
        // Bind rows
        Array.from(list.querySelectorAll('.source-chip-row')).forEach(function(row){
          var input = row.querySelector('input.source-url-input');
          var removeBtn = row.querySelector('.remove-source');
          var status = row.nextElementSibling;
          if (!status || !status.classList || !status.classList.contains('source-status')) {
            status = document.createElement('div'); status.className = 'source-status'; row.insertAdjacentElement('afterend', status);
          }
          if (input) {
            input.addEventListener('input', function(){
              var raw = input.value.trim();
              var canon = canonicalizeUrl(raw);
              if (!canon) { status.style.display='none'; status.textContent=''; updateNotabilityPreview(); return; }
              var domain = extractDomain(canon);
              if (!domain) { status.style.display='none'; status.textContent=''; updateNotabilityPreview(); return; }
              showRowStatus(status, 'validating');
              if (row.__timer) clearTimeout(row.__timer);
              row.__timer = setTimeout(function(){
                var res = classifySource(domain);
                if (res && res.reliable) {
                  status.style.display='block'; status.innerHTML = '<span class="status-chip status-verified">Likely reliable</span>';
                } else { status.style.display='none'; status.textContent=''; }
                updateNotabilityPreview();
              }, 300);
            });
          }
          if (removeBtn) removeBtn.addEventListener('click', function(){ var g=row.parentNode; if (g && g.classList && g.classList.contains('source-group')) g.remove(); else row.remove(); updateNotabilityPreview(); });
        });
        var addBtn = document.getElementById('creation-addSourceChip');
        if (addBtn) addBtn.onclick = function(){
          var idx = list.querySelectorAll('.source-chip-row').length;
          var grp = document.createElement('div'); grp.className = 'source-group';
          var div = document.createElement('div'); div.className='source-chip-row'; div.setAttribute('data-index', String(idx));
          div.innerHTML = '\n            <input type="url" class="source-url-input" placeholder="https://example.com/article" aria-label="Source URL" />\n            <button type="button" class="sidebar-action-btn remove-source" aria-label="Remove" title="Remove">×</button>';
          var status = document.createElement('div'); status.className='source-status'; status.setAttribute('aria-live','polite');
          grp.appendChild(div); grp.appendChild(status); list.appendChild(grp);
          // bind
          var input = div.querySelector('input.source-url-input'); var removeBtn = div.querySelector('.remove-source');
          if (input) input.addEventListener('input', function(){
            var raw = input.value.trim(); var canon = canonicalizeUrl(raw);
            if (!canon) { status.style.display='none'; status.textContent=''; updateNotabilityPreview(); return; }
            var domain = extractDomain(canon);
            showRowStatus(status, 'validating');
            if (div.__timer) clearTimeout(div.__timer);
            div.__timer = setTimeout(function(){ var res = classifySource(domain); if (res && res.reliable) { status.style.display='block'; status.innerHTML='<span class="status-chip status-verified">Likely reliable</span>'; } else { status.style.display='none'; status.textContent=''; } updateNotabilityPreview(); }, 300);
          });
          if (removeBtn) removeBtn.addEventListener('click', function(){ var g=div.parentNode; if (g && g.classList && g.classList.contains('source-group')) g.remove(); else div.remove(); updateNotabilityPreview(); });
        };
        // nav
        var back = document.getElementById('creation-sourcesBack'); var skip = document.getElementById('creation-sourcesSkip'); var cont = document.getElementById('creation-sourcesContinue');
        if (back) back.onclick = function(){ document.getElementById('creation-stepSources').classList.remove('active'); step2.classList.add('active'); };
        if (skip) skip.onclick = goToEditor;
        if (cont) cont.onclick = function(){
          try {
            var arr = [];
            var rows = document.querySelectorAll('#creation-sourcesList .source-chip-row');
            rows.forEach(function(r){ var i = r.querySelector('input'); var raw = i ? (i.value||'').trim() : ''; if (!raw) return; var url = canonicalizeUrl(raw) || raw; var domain = extractDomain(url); var res = classifySource(domain||''); arr.push({ url: url, title: '', reliabilityHint: (res && res.reliable) ? 'Likely reliable' : '' }); });
            if (arr.length) window.creationSources = arr;
          } catch(_) {}
          goToEditor();
        };
        updateNotabilityPreview();
      } catch(_){}
    }

    function canonicalizeUrl(u){
      try { if (!u) return ''; return new URL(u).href; } catch(_){ try { if (u && u.indexOf(' ')===-1 && /\./.test(u) && !/^\w[\w.+-]*:/.test(u)) return new URL('https://'+u).href; } catch(__){} return ''; }
    }
    function showRowStatus(container, state){ if (!container) return; if (state==='validating'){ container.style.display='block'; container.innerHTML='<span class="status-chip status-validating"><span class="spinner" aria-hidden="true"></span><span>Checking...</span></span>'; } }
    function updateNotabilityPreview(){
      try {
        var list = document.getElementById('creation-sourcesList'); var line = document.getElementById('creation-readiness-line'); var statusEl = document.getElementById('creation-readiness-status'); var countEl = document.getElementById('creation-readiness-count');
        if (!list || !line || !statusEl || !countEl) return;
        var rows = Array.from(list.querySelectorAll('.source-chip-row'));
        var urls = [];
        rows.forEach(function(r){ var i=r.querySelector('input'); var raw = i ? (i.value||'').trim() : ''; var canon = canonicalizeUrl(raw); if (canon) urls.push(canon); });
        function uniq(a){ return Array.from(new Set(a)); }
        var hosts = uniq(urls.map(function(u){ return extractDomain(u); }).filter(Boolean));
        var sources = urls.length; var independent = hosts.length;
        if (sources === 0) { line.classList.add('is-hidden'); statusEl.textContent='Not ready'; countEl.textContent='(0 sources)'; statusEl.classList.remove('state-ready','state-mid','state-low'); statusEl.classList.add('state-low'); return; }
        line.classList.remove('is-hidden');
        var ready = (sources>=2 && independent>=2);
        var stateKey = ready ? 'ready' : (sources>0 ? 'gettingThere' : 'notReady');
        statusEl.textContent = ready ? 'Ready' : (sources>0 ? 'Getting there' : 'Not ready');
        statusEl.classList.remove('state-ready','state-mid','state-low');
        statusEl.classList.add(stateKey==='ready' ? 'state-ready' : (stateKey==='gettingThere' ? 'state-mid' : 'state-low'));
        countEl.textContent = '('+sources+' sources · '+independent+' independent)';
      } catch(_){}
    }
    toStep3 && (toStep3.onclick=function(){
      var sourcesStep = document.getElementById('creation-stepSources');
      if (sourcesStep) {
        step2.classList.remove('active');
        sourcesStep.classList.add('active');
        // Update Q3 title with the entered topic (fallback without param i18n)
        try {
          var h = sourcesStep.querySelector('h3');
          var userTopic = (titleInput.value || '').trim();
          if (h && userTopic) {
            h.textContent = 'Do you have at least two independent, reliable sources for "' + userTopic + '"?';
          }
        } catch(_) {}
        setupSourcesStep();
        return;
      }
      // Fallback straight to editor
      step2.classList.remove('active');
      step3.classList.add('active');
      document.body.classList.add('ve-in-step3');
      var ed = document.getElementById('editor');
      var t = titleInput.value.trim();
      var safeTitle = (t || 'Untitled').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      var veTitle = document.getElementById('veTitle');
      if (veTitle) veTitle.textContent = safeTitle;
      ed.innerHTML = '';
      ed.setAttribute('data-placeholder', 'Start writing about ' + safeTitle + '...');
      ed.focus();
      try { if (typeof applyEligibilityAutoFromSources === 'function') applyEligibilityAutoFromSources(); } catch(_) {}
      // Set up MutationObserver to watch for and remove phantom elements (but not valid sections)
      var observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
          // Check all added nodes
          mutation.addedNodes.forEach(function(node) {
            if (node.nodeType === 1 && node.tagName !== 'H2') { // Element node, but not H2
              // Only remove borders from non-H2 elements
              if (node.style) {
                node.style.borderBottom = 'none';
                node.style.border = 'none';
              }
              // Only remove if it's truly empty (no text, no child elements, no buttons)
              if (node.textContent.trim() === '' && !node.querySelector('*') && node.tagName !== 'P') {
                setTimeout(function() {
                  if (node.parentNode) {
                    node.remove();
                  }
                }, 50);
              }
            } else if (node.nodeType === 1 && node.tagName === 'H2' && node.classList && node.classList.contains('wiki-section-heading')) {
              // Remove empty H2s that appear due to native splits
              var hasText = false;
              for (var i = 0; i < node.childNodes.length; i++) {
                var n = node.childNodes[i];
                if (n.nodeType === Node.TEXT_NODE && n.textContent.replace(/\u200B/g, '').trim() !== '') {
                  hasText = true; break;
                }
              }
              if (!hasText && node.parentNode) {
                node.parentNode.removeChild(node);
              }
            }
          });
        });
      });
      
      // Start observing the editor (reduced scope)
      observer.observe(ed, {
        childList: true,
        subtree: true
      });
      
      // Add gentle cleanup on Enter key only
      ed.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
          setTimeout(function() {
            // Only remove borders from non-H2 elements, don't remove elements
            var allElements = ed.querySelectorAll('*:not(h2)');
            allElements.forEach(function(el) {
              if (el.style) {
                el.style.borderBottom = 'none';
                el.style.border = 'none';
              }
            });
            // Clean up stray empty headings that create extra separators
            cleanupEmptyHeadings();
          }, 100);
        }
      });

      // Intercept Enter/Backspace around H2 to avoid stray separators
      ed.addEventListener('keydown', function(e) {
        var sel = window.getSelection();
        if (!sel || sel.rangeCount === 0) return;
        var range = sel.getRangeAt(0);
        if (!range.collapsed) return; // handle caret only

        // Find closest H2 heading
        var node = range.startContainer;
        var element = (node.nodeType === Node.TEXT_NODE) ? node.parentNode : node;
        var h2 = element.closest ? element.closest('h2.wiki-section-heading') : null;
        if (!h2) return;

        // Helper: is caret at the very start of the H2 text (ignoring zero-width spaces/whitespace)
        var atStart = (function() {
          try {
            var pre = range.cloneRange();
            pre.selectNodeContents(h2);
            pre.setEnd(range.startContainer, range.startOffset);
            var txt = pre.toString().replace(/\u200B/g, '').trim();
            return txt.length === 0;
          } catch (err) {
            // Fallback: if startOffset is 0 and we're in or on the H2
            return range.startOffset === 0;
          }
        })();

        // Helper: detect empty paragraph
        function isEmptyParagraph(el) {
          if (!el || !el.tagName || el.tagName.toLowerCase() !== 'p') return false;
          var inner = (el.innerHTML || '').trim();
          var text = (el.textContent || '').replace(/\u200B/g, '').trim();
          var onlyBrs = /^(?:<br\s*\/?\s*)*$/.test(inner);
          return text.length === 0 && (inner === '' || onlyBrs);
        }

        // Helper: does H2 have real text (not just a button or whitespace)
        function h2HasText(el) {
          if (!el) return false;
          for (var i = 0; i < el.childNodes.length; i++) {
            var n = el.childNodes[i];
            if (n.nodeType === Node.TEXT_NODE && n.textContent.replace(/\u200B/g, '').trim() !== '') {
              return true;
            }
          }
          return false;
        }

        // ENTER anywhere inside H2: prevent native split and insert paragraph
        if (e.key === 'Enter') {
          e.preventDefault();
          var p = document.createElement('p');
          p.innerHTML = '<br>';
          if (atStart) {
            h2.parentNode.insertBefore(p, h2);
          } else {
            // Insert after H2
            if (h2.nextSibling) {
              h2.parentNode.insertBefore(p, h2.nextSibling);
            } else {
              h2.parentNode.appendChild(p);
            }
          }
          // Place caret inside the new paragraph
          var r = document.createRange();
          r.selectNodeContents(p);
          r.collapse(true);
          sel.removeAllRanges();
          sel.addRange(r);
          return;
        }

        // BACKSPACE at start of H2: remove preceding empty paragraph to "move back" without altering H2
        if (e.key === 'Backspace' && atStart) {
          var prev = h2.previousElementSibling;
          if (prev) {
            var removed = false;
            if (isEmptyParagraph(prev)) {
              prev.parentNode.removeChild(prev);
              removed = true;
            } else if (prev.tagName && prev.tagName.toLowerCase() === 'h2' && prev.classList.contains('wiki-section-heading') && !h2HasText(prev)) {
              prev.parentNode.removeChild(prev);
              removed = true;
            }
            if (removed) {
              e.preventDefault();
              var r2 = document.createRange();
              r2.selectNodeContents(h2);
              r2.collapse(true);
              sel.removeAllRanges();
              sel.addRange(r2);
              return;
            }
          }
        }
      });
      
      // Add input listener to activate publish/submit buttons when user starts typing
      ed.addEventListener('input', function() {
        var publishBtn = document.getElementById('publish');
        var submitBtn = document.getElementById('submit');
        
        if (ed.textContent.trim().length > 0) {
          // Desktop publish button
          if (publishBtn) {
            publishBtn.disabled = false;
            publishBtn.classList.add('primary');
            publishBtn.textContent = 'Publish changes';
          }
          
          // Mobile submit button  
          if (submitBtn) {
            submitBtn.classList.add('primary');
            submitBtn.style.background = '#36c';
            submitBtn.style.color = '#fff';
            submitBtn.style.borderColor = '#36c';
            // Make the icon white too
            var icon = submitBtn.querySelector('.cdx-icon svg');
            if (icon) icon.style.color = '#fff';
          }
        } else {
          // Reset buttons when content is empty
          if (publishBtn) {
            publishBtn.disabled = true;
            publishBtn.classList.remove('primary');
            publishBtn.textContent = 'Publish';
          }
          
          if (submitBtn) {
            submitBtn.classList.remove('primary');
            submitBtn.style.background = '';
            submitBtn.style.color = '';
            submitBtn.style.borderColor = '';
            // Reset icon color too
            var icon = submitBtn.querySelector('.cdx-icon svg');
            if (icon) icon.style.color = '';
          }
        }
      });
      
      // Fix superscript formatting sticking after references
      ed.addEventListener('keyup', function(e) {
        var selection = window.getSelection();
        if (selection.rangeCount > 0) {
          var range = selection.getRangeAt(0);
          var container = range.commonAncestorContainer;
          
          // Check if cursor is right after a superscript element
          if (container.nodeType === Node.TEXT_NODE) {
            var parent = container.parentNode;
            if (parent && parent.tagName === 'SUP') {
              // We're inside a sup element, move cursor outside
              var newRange = document.createRange();
              newRange.setStartAfter(parent);
              newRange.collapse(true);
              selection.removeAllRanges();
              selection.addRange(newRange);
              
              // Insert a zero-width space to break formatting
              document.execCommand('insertText', false, '\u200B');
            }
          } else if (container.nodeType === Node.ELEMENT_NODE && container.tagName === 'SUP') {
            // We're at the end of a sup element
            var newRange = document.createRange();
            newRange.setStartAfter(container);
            newRange.collapse(true);
            selection.removeAllRanges();
            selection.addRange(newRange);
            
            // Insert a zero-width space to break formatting
            document.execCommand('insertText', false, '\u200B');
          }
        }
      });
      
      // Also fix on input to handle pasting
      ed.addEventListener('input', function(e) {
        // Remove any lingering blue color from non-superscript text
        var selection = window.getSelection();
        if (selection.rangeCount > 0) {
          var range = selection.getRangeAt(0);
          var container = range.commonAncestorContainer;
          
          if (container.nodeType === Node.TEXT_NODE) {
            var parent = container.parentNode;
            // If we're in a span with blue color but not in a sup, remove the color
            if (parent && parent.style && parent.style.color === 'rgb(6, 69, 173)' && parent.tagName !== 'SUP') {
              parent.style.color = '';
            }
          }
        }
      });

      // Open guidance automatically when entering editing (Step 3)
      // Desktop only; delay to avoid immediate close from the click event
      if (!isMobile()) {
        setTimeout(function(){ showGuide(); }, 50);
      }
    });

    // Reference dialog
    var openBtn=null;
    var backdrop=document.getElementById('refBackdrop');
    var cancelBtn=document.getElementById('refCancel');
    var insertBtn=document.getElementById('refInsert');
    var urlInput=document.getElementById('refUrl');
    var hint=document.getElementById('refHint');
    var editor=document.getElementById('editor');
    var verify=document.getElementById('verify');
    var refBadges=document.getElementById('refBadges');
    function classify(url){ try{ var h=new URL(url).hostname; if(/\.(gov|gov\.[a-z]{2})$/i.test(h)) return {label:'gov',cls:'good'}; if(/\.(edu|ac\.[a-z]{2})$/i.test(h)) return {label:'edu',cls:'good'}; if(/(reuters|apnews|bbc|nytimes|guardian|bloomberg|washingtonpost|ft\.com)/i.test(h)) return {label:'news',cls:'good'}; if(/(prnewswire|businesswire|globenewswire|newswire|press)/i.test(h)) return {label:'press release',cls:'warn'}; return {label:'unclassified',cls:''}; }catch(e){ return {label:'unclassified',cls:''}; } }
    function openDialog(){ backdrop.style.display='block'; urlInput.focus(); }
    function closeDialog(){ backdrop.style.display='none'; }
    function bindRef(){ openBtn=document.getElementById("openRef"); if(openBtn){ openBtn.onclick=openDialog; }} bindRef(); cancelBtn.onclick=closeDialog; backdrop.addEventListener('click',function(e){ if(e.target===backdrop) closeDialog(); });
    urlInput.addEventListener('input',function(){ var c=classify(urlInput.value.trim()); hint.textContent=c.label; hint.className='badge '+(c.cls||''); });
    insertBtn.onclick=function(){ var url=urlInput.value.trim(); if(!url) return; if(document.activeElement!==editor) editor.focus(); document.execCommand('insertText', false, ' [1]'); var c=classify(url); refBadges.innerHTML='<span class="badge '+(c.cls||'')+'">'+c.label+'</span>'; closeDialog(); };

    // Guide Me functionality - Desktop Sidebar & Mobile Modal
    var guideSidebar = document.getElementById('guideSidebar');
    var guideModalBackdrop = document.getElementById('guideModalBackdrop');
    var addSectionBtn = document.getElementById('addSectionBtn');
    var guideMeMobileBtn = document.getElementById('guideMeMobile');
    var closeSidebarBtn = document.getElementById('closeSidebar');
    var closeModalBtn = document.getElementById('closeModalDrawer');
    var guideContent = document.getElementById('guideContent');
    var guideModalContent = document.getElementById('guideModalContent');
    var addedSections = [];
    var suggestionsData = null;

    // Function to check if we're on mobile
    function isMobile() {
      return window.innerWidth <= 768;
    }

    // Load suggestions data
    async function loadSuggestions() {
      try {
        const response = await fetch('article-creation-suggestions.json');
        suggestionsData = await response.json();
      } catch (error) {
        console.error('Failed to load suggestions:', error);
        suggestionsData = null;
      }
    }

    // Generate guide content based on selected category
    function generateGuideContent() {
      if (!selectedCat || !suggestionsData || !suggestionsData[selectedCat]) {
        return getDefaultGuideContent();
      }

      const categoryData = suggestionsData[selectedCat];
      let content = '<div class="guide-section">';
      
      // Introduction Accordion
      content += '<div class="accordion-item">';
      content += '<div class="accordion-header" onclick="toggleAccordion(this)" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 8px 0; border-bottom: 1px solid #eaecf0;">';
      content += '<h4 style="margin: 0;">Introduction</h4>';
      content += '<span class="accordion-icon" style="font-size: 14px; transform: rotate(0deg); transition: transform 0.2s;">▼</span>';
      content += '</div>';
      content += '<div class="accordion-content" style="display: block; padding-top: 12px;">';
      content += '<p class="guide-note">Write a clear opening that summarizes the topic, explains why it\'s important, and covers the main points readers will find in the article.</p>';
      
      // Show introduction examples if available
      if (categoryData.introduction && categoryData.introduction.examples) {
        content += '<p class="guide-note" style="margin-top: 12px; font-weight: 500;">Examples from Wikipedia:</p>';
        categoryData.introduction.examples.forEach(function(example) {
          content += '<div class="intro-example" style="background: #f8f9fa; border-left: 3px solid #0645ad; padding: 10px; margin: 8px 0; font-size: 0.9em; line-height: 1.4;">';
          content += '<div class="example-title" style="font-weight: bold; color: #0645ad; margin-bottom: 4px;">' + example.title + '</div>';
          content += '<div class="example-text" style="color: #222;">' + example.text + '</div>';
          content += '</div>';
        });
      }
      
      // Show introduction template based on category
      content += '<p class="guide-note" style="margin-top: 16px; font-weight: 500;">Template structure:</p>';
      var template = getIntroductionTemplate(selectedCat);
      content += '<div class="intro-template" style="background: #f0f8ff; border-left: 3px solid #36c; padding: 12px; margin: 8px 0; font-size: 0.9em; line-height: 1.4;">';
      content += '<div style="color: #54595d; font-style: italic; margin-bottom: 8px;">Typically, introduction sections have this structure:</div>';
      content += '<div style="color: #222; font-family: monospace; background: #fff; padding: 8px; border-radius: 3px; border: 1px solid #c8ccd1;">' + template + '</div>';
      content += '</div>';
      
      content += '</div>';
      content += '</div>';
      
      // Suggested Sections Accordion
      content += '<div class="accordion-item" style="margin-top: 16px;">';
      content += '<div class="accordion-header" onclick="toggleAccordion(this)" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 8px 0; border-bottom: 1px solid #eaecf0;">';
      content += '<h4 style="margin: 0;">Suggested sections</h4>';
      content += '<span class="accordion-icon" style="font-size: 14px; transform: rotate(-90deg); transition: transform 0.2s;">▼</span>';
      content += '</div>';
      content += '<div class="accordion-content" style="display: none; padding-top: 12px;">';
      content += '<p class="guide-note">' + categoryData.note + '</p>';
      
      // Show all sections (only 3, no References)
      categoryData.sections.forEach(function(section, index) {
        const sectionName = typeof section === 'string' ? section : section.name;
        const sectionDesc = typeof section === 'string' ? '' : section.description;
        const sectionInclude = typeof section === 'string' ? [] : (section.include || []);
        const isAdded = addedSections.indexOf(sectionName) !== -1;
        const className = isAdded ? 'section-button added' : 'section-button';
        
        content += '<button class="' + className + '" data-section="' + sectionName + '" onclick="addSectionToEditor(\'' + sectionName.replace(/'/g, "\\'") + '\')">';
        content += '<div class="section-info">';
        content += '<span class="section-name">' + sectionName + '</span>';
        if (sectionDesc) {
          content += '<span class="section-description">' + sectionDesc + '</span>';
        }
        
        // Always show template structure for this section
        var sectionTemplate = getSectionTemplate(sectionName, selectedCat);
        content += '<div style="margin-top: 6px; padding: 6px; background: #f0f8ff; border-left: 2px solid #36c; border-radius: 2px;">';
        content += '<div style="font-size: 10px; color: #54595d; margin-bottom: 3px; font-style: italic;">Example structure:</div>';
        content += '<div style="font-size: 10px; color: #222; font-family: monospace; line-height: 1.3;">' + sectionTemplate.substring(0, 100) + '...</div>';
        content += '</div>';
        
        // Add Wikipedia example if available
        var wikipediaExample = getWikipediaExample(sectionName, selectedCat);
        if (wikipediaExample) {
          content += '<div style="margin-top: 6px; padding: 6px; background: #f8f9fa; border-left: 2px solid #72777d; border-radius: 2px;">';
          content += '<div style="font-size: 10px; color: #54595d; margin-bottom: 3px; font-style: italic;">Wikipedia example:</div>';
          content += '<div style="font-size: 10px; color: #222; line-height: 1.4;">' + wikipediaExample.substring(0, 120) + '...</div>';
          content += '</div>';
        }
        
        content += '</div>';
        content += '<span class="section-action">' + (isAdded ? 'Added ✓' : 'Insert') + '</span>';
        content += '</button>';
      });
      // Sister projects (compact) under suggested sections
      (function(){
        try {
          var tEl = document.getElementById('title');
          var at = (tEl && tEl.value ? tEl.value.trim() : '');
          if (!at) { return; }
          var sp = (typeof getSisterProjectData === 'function') ? getSisterProjectData(at) : null;
          // Heuristics to ensure relevance to selected category + title tokens
          function tokens(s){ try { return String(s||'').toLowerCase().split(/[^a-z0-9]+/).filter(function(w){ return w && w.length>3; }); } catch(_) { return []; } }
          var titleTokens = tokens(at);
          function hasTitleToken(text){ var t=tokens(text); for (var i=0;i<titleTokens.length;i++){ if (t.indexOf(titleTokens[i])!==-1) return true; } return false; }
          var cat = (typeof selectedCat !== 'undefined' && selectedCat) ? selectedCat : 'other';
          var catPatterns = {
            person: /(born|died|biograph|career|occupation|writer|scientist|athlete|actor|singer|politician|award|notable)/i,
            place: /(city|town|village|located|population|area|region|province|capital|geograph)/i,
            species: /(species|habitat|taxonomy|genus|population|conservation|animal|plant|insect|marine)/i,
            organization: /(company|organization|founded|headquarters|employees|non[- ]profit|institution|subsidiar|industry)/i,
            academic: /(concept|theory|definition|term|framework|method|discipline|academic|research)/i,
            creative: /(film|movie|book|novel|album|song|release|cast|director|author|publication)/i,
            event: /(occurred|happened|date|timeline|impact|casualties|damage|magnitude|protest|election|festival)/i,
            other: /(topic|subject|overview|background|context|notable)/i
          };
          function relevantFact(f){ var txt = String((f && f.text) || ''); return hasTitleToken(txt) && (catPatterns[cat] ? catPatterns[cat].test(txt) : true); }
          function relevantImage(img){ var title = String((img && img.title) || ''); return hasTitleToken(title) || (catPatterns[cat] ? catPatterns[cat].test(title) : false); }

          var items = [];
          if (sp && Array.isArray(sp.facts)) {
            for (var i=0; i<sp.facts.length && items.length<2; i++) {
              var f = sp.facts[i];
              if (relevantFact(f)) {
                items.push({ type: 'fact', text: f.text, source: f.source });
              }
            }
          }
          if (sp && Array.isArray(sp.images) && items.length < 3 && sp.images.length > 0) {
            for (var j=0; j<sp.images.length && items.length<3; j++) {
              var img = sp.images[j];
              if (relevantImage(img)) {
                items.push({ type: 'image', title: img.title });
                break;
              }
            }
          }
          // Fallback: if nothing matched filters, show up to 2 facts + 1 image (so the block isn't empty)
          if ((!items || items.length === 0) && sp) {
            try {
              if (Array.isArray(sp.facts)) {
                for (var k=0; k<sp.facts.length && items.length<2; k++) {
                  var f2 = sp.facts[k];
                  items.push({ type: 'fact', text: f2.text, source: f2.source });
                }
              }
              if (Array.isArray(sp.images) && items.length < 3 && sp.images.length > 0) {
                items.push({ type: 'image', title: sp.images[0].title });
              }
            } catch(_) {}
          }
          if (items.length) {
            content += '<div style="border-top: 1px solid #eaecf0; margin: 12px 0; padding-top: 12px;"></div>';
            content += '<p class="guide-note" style="margin: 0 0 8px 0; font-weight: 500;">From Wikipedia and sister projects</p>';
            items.forEach(function(it){
              if (it.type === 'fact') {
                content += '<div style="background:#f8f9fa; border:1px solid #eaecf0; border-radius:4px; padding:8px;">'+
                           '<div style="font-size:12px; color:#54595d; margin-bottom:2px;">Fact</div>'+
                           '<div style="font-size:13px; color:#222;">'+ it.text +'</div>'+
                           '<div style="font-size:12px; color:#666; margin-top:4px;">Source: '+ it.source +'</div>'+
                           '</div>';
              } else if (it.type === 'image') {
                content += '<div style="background:#fff; border:1px solid #eaecf0; border-radius:4px; padding:8px;">'+
                           '<div style="font-size:12px; color:#54595d; margin-bottom:2px;">Image suggestion</div>'+
                           '<div style="font-size:13px; color:#222;">'+ it.title +'</div>'+
                           '</div>';
              }
            });
          }
        } catch(_) {}
      })();

      content += '</div>';
      content += '</div>';
      
      // Article Eligibility Check Accordion
      content += '<div class="accordion-item" style="margin-top: 16px;">';
      content += '<div class="accordion-header" onclick="toggleAccordion(this)" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 8px 0; border-bottom: 1px solid #eaecf0;">';
      content += '<h4 style="margin: 0;">Article eligibility check</h4>';
      content += '<span class="accordion-icon" style="font-size: 14px; transform: rotate(-90deg); transition: transform 0.2s;">▼</span>';
      content += '</div>';
      content += '<div class="accordion-content" style="display: none; padding-top: 12px;">';
      content += '<p class="guide-note">Quick check: Does your topic have what Wikipedia needs?</p>';
      
      content += '<div class="eligibility-questions">';
      content += '<div class="eligibility-item" style="margin-bottom: 16px;">';
      content += '<div style="font-weight: 500; margin-bottom: 8px;">Has your topic been covered in newspapers or magazines?</div>';
      content += '<div class="eligibility-options">';
      content += '<button class="eligibility-btn" data-question="coverage" data-answer="yes">Yes</button>';
      content += '<button class="eligibility-btn" data-question="coverage" data-answer="maybe">Maybe</button>';
      content += '<button class="eligibility-btn" data-question="coverage" data-answer="no">No</button>';
      content += '</div>';
      content += '</div>';
      
      content += '<div class="eligibility-item" style="margin-bottom: 16px;">';
      content += '<div style="font-weight: 500; margin-bottom: 8px;">Are these sources from well-known news sites or publications?</div>';
      content += '<div class="eligibility-options">';
      content += '<button class="eligibility-btn" data-question="reliable" data-answer="yes">Yes</button>';
      content += '<button class="eligibility-btn" data-question="reliable" data-answer="maybe">Maybe</button>';
      content += '<button class="eligibility-btn" data-question="reliable" data-answer="no">No</button>';
      content += '</div>';
      content += '</div>';
      
      content += '<div class="eligibility-item" style="margin-bottom: 16px;">';
      content += '<div style="font-weight: 500; margin-bottom: 8px;">Were these written by independent journalists (not press releases)?</div>';
      content += '<div class="eligibility-options">';
      content += '<button class="eligibility-btn" data-question="independent" data-answer="yes">Yes</button>';
      content += '<button class="eligibility-btn" data-question="independent" data-answer="maybe">Maybe</button>';
      content += '<button class="eligibility-btn" data-question="independent" data-answer="no">No</button>';
      content += '</div>';
      content += '</div>';
      
      content += '<div class="eligibility-item" style="margin-bottom: 16px;">';
      content += '<div style="font-weight: 500; margin-bottom: 8px;">Do you have at least 2 different sources?</div>';
      content += '<div class="eligibility-options">';
      content += '<button class="eligibility-btn" data-question="multiple" data-answer="yes">Yes</button>';
      content += '<button class="eligibility-btn" data-question="multiple" data-answer="maybe">Maybe</button>';
      content += '<button class="eligibility-btn" data-question="multiple" data-answer="no">No</button>';
      content += '</div>';
      content += '</div>';
      content += '</div>';
      
      content += '<div id="eligibilityResult" style="margin-top: 16px; padding: 12px; border-radius: 4px; font-size: 14px; display: none;"></div>';
      
      content += '</div>';
      content += '</div>';
      
      // Add from Source Accordion (simplified)
      content += '<div class="accordion-item" style="margin-top: 16px;">';
      content += '<div class="accordion-header" onclick="toggleAccordion(this)" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 8px 0; border-bottom: 1px solid #eaecf0;">';
      content += '<h4 style="margin: 0;">Add from a source</h4>';
      content += '<span class="accordion-icon" style="font-size: 14px; transform: rotate(-90deg); transition: transform 0.2s;">▼</span>';
      content += '</div>';
      content += '<div class="accordion-content" style="display: none; padding-top: 12px;">';
      content += '<p class="guide-note">Paste a reliable source URL (news, .edu, .gov). We’ll check it and help draft a paragraph you can edit.</p>';
      content += '<div id="sourceVerificationArea">';
      
      // Existing manual source entry
      content += '<div class="source-input-group">';
      content += '<input type="url" id="sidebarSourceUrl" placeholder="e.g., bbc.com/article" class="source-url-input" aria-label="Source URL">';
      content += '<button class="source-check-btn" id="sidebarCheckBtn">Check source</button>';
      content += '</div>';
      
      // Saved sources from earlier (session/localStorage/Q3)
      content += '<div id="sidebarSavedSection" style="display:none; margin: 8px 0 12px 0;">';
      content += '  <p class="guide-note" style="margin: 0 0 6px 0; font-weight: 500;">Use sources you added earlier</p>';
      content += '  <div id="sidebarSavedList"></div>';
      content += '</div>';
      content += '<div id="sidebarVerificationSteps" style="display: none; margin-top: 12px;"></div>';
      content += '<div id="sidebarSourceResult" style="display: none; margin-top: 12px;"></div>';
      content += '<div id="sidebarDraftPreview" style="display: none; margin-top: 12px;"></div>';
      content += '</div>';
      content += '</div>';
      content += '</div>';
      
      content += '</div>';
      
      return content;
    }

    // Default content when no category is selected
    function getDefaultGuideContent() {
      return '<div class="guide-section">' +
        '<h4>✨ Getting started</h4>' +
        '<ul>' +
        '<li>Start with a clear opening sentence that defines your topic</li>' +
        '<li>Include key facts in the first paragraph</li>' +
        '<li>Use reliable sources throughout</li>' +
        '</ul>' +
        '<p class="guide-note">Select a category in Step 2 to see specific section suggestions for your article type.</p>' +
        '</div>';
    }

    // Sister Project Integration - Dynamic content based on article title
    function getSisterProjectContent() {
      const titleInput = document.getElementById('title');
      const articleTitle = titleInput ? titleInput.value.trim() : '';
      
      if (!articleTitle) {
        return '<p class="guide-note" style="font-style: italic; color: #666;">Sister project data will appear when you enter an article title above.</p>';
      }
      
      const projectData = getSisterProjectData(articleTitle);
      let content = '';
      
      // Quick Facts Section
      if (projectData.facts && projectData.facts.length > 0) {
        content += '<div style="margin-bottom: 16px;">';
        content += '<p class="guide-note" style="margin-bottom: 8px;">🎯 <strong>Quick facts for "' + articleTitle + '"</strong></p>';
        content += '<p style="font-size: 15px; color: #666; margin-bottom: 12px;">We found key facts from reliable sources:</p>';
        
        // Show facts as reference information
        content += '<div style="background: #f8f9fa; padding: 12px; border-radius: 4px; border-left: 3px solid #0645ad;">';
        for (let i = 0; i < Math.min(2, projectData.facts.length); i++) {
          const fact = projectData.facts[i];
          content += '<div style="margin-bottom: 8px; font-size: 15px;">';
          content += '<strong>' + fact.text + '</strong>';
          content += '<br><span style="font-size: 13px; color: #666;">Source: ' + fact.source + '</span>';
          content += '</div>';
        }
        
        // Show more facts if available
        if (projectData.facts.length > 2) {
          content += '<div id="moreFacts" style="display: none;">';
          for (let i = 2; i < projectData.facts.length; i++) {
            const fact = projectData.facts[i];
            content += '<div style="margin-bottom: 8px; font-size: 15px;">';
            content += '<strong>' + fact.text + '</strong>';
            content += '<br><span style="font-size: 13px; color: #666;">Source: ' + fact.source + '</span>';
            content += '</div>';
          }
          content += '</div>';
          content += '<button onclick="toggleMoreFacts()" style="background: none; border: none; color: #0645ad; cursor: pointer; font-size: 14px; text-decoration: underline;">Show ' + (projectData.facts.length - 2) + ' more facts ▼</button>';
        }
        content += '</div>';
        content += '<p style="font-size: 14px; color: #666; margin-top: 8px;"><strong>Tip:</strong> Use these verified facts as reference when writing your article</p>';
        content += '</div>';
      }
      
      // Images Section
      if (projectData.images && projectData.images.length > 0) {
        content += '<div style="margin-bottom: 16px;">';
        content += '<p class="guide-note" style="margin-bottom: 8px;"><strong>Images available from Wikimedia Commons</strong></p>';
        content += '<div style="display: flex; flex-wrap: wrap; gap: 8px;">';
        
        for (let i = 0; i < Math.min(3, projectData.images.length); i++) {
          const image = projectData.images[i];
          content += '<div style="border: 1px solid #ddd; border-radius: 4px; padding: 8px; width: 120px; height: 80px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; font-size: 11px; color: #666; text-align: center;">';
          content += image.title;
          content += '</div>';
        }
        
        if (projectData.images.length > 3) {
          content += '<div style="border: 1px solid #ddd; border-radius: 4px; padding: 8px; width: 120px; height: 80px; background: #f5f5f5; display: flex; align-items: center; justify-content: center; font-size: 11px; color: #666;">+' + (projectData.images.length - 3) + ' more</div>';
        }
        content += '</div>';
        content += '<p style="font-size: 14px; color: #666; margin-top: 8px;"><strong>Note:</strong> These images would be available for your article with proper licensing</p>';
        content += '</div>';
      }
      
      // Additional context section - only if helpful
      if (projectData.additionalContext) {
        content += '<div style="margin-bottom: 16px;">';
        content += '<p class="guide-note" style="margin-bottom: 8px;"><strong>Writing tip</strong></p>';
        content += '<p style="font-size: 15px; color: #666; background: #fffbf0; padding: 8px; border-radius: 4px; border-left: 3px solid #f0ad4e;">';
        content += projectData.additionalContext;
        content += '</p>';
        content += '</div>';
      }
      
      return content;
    }

    // Generate synthetic sister project data based on article title
    function getSisterProjectData(title) {
      const lowerTitle = title.toLowerCase();
      
      // Natural disasters/events pattern (floods, earthquakes, hurricanes, etc.)
      if (lowerTitle.includes('flood') || lowerTitle.includes('earthquake') || lowerTitle.includes('hurricane') || lowerTitle.includes('tsunami') || lowerTitle.includes('cyclone') || lowerTitle.includes('disaster')) {
        const year = new Date().getFullYear();
        const location = extractLocationFromTitle(title);
        return {
          facts: [
            { text: 'Date: ' + generateRecentDate(), source: 'Wikidata' },
            { text: 'Location: ' + (location || 'Multiple regions affected'), source: 'Wikidata' },
            { text: 'Casualties: ' + getRandomCasualties(), source: 'Government reports' },
            { text: 'Economic Impact: $' + getRandomDamage() + ' million', source: 'World Bank' },
            { text: 'Response: International aid mobilized', source: 'UN OCHA' }
          ],
          images: [
            { title: 'Satellite imagery of affected area' },
            { title: 'Rescue operations' },
            { title: 'Damage assessment photos' },
            { title: 'Relief distribution' }
          ],
          additionalContext: 'For disaster articles, focus on timeline, impact, and response. Include human stories but be sensitive to victims. Government and UN sources are particularly reliable.'
        };
      }
      
      // Space missions pattern
      if (lowerTitle.includes('mission') || lowerTitle.includes('chandrayaan') || lowerTitle.includes('apollo') || lowerTitle.includes('space') || lowerTitle.includes('satellite') || lowerTitle.includes('rover')) {
        return {
          facts: [
            { text: 'Launch Date: ' + generateRecentDate(), source: 'Wikidata' },
            { text: 'Agency: ' + getRandomSpaceAgency(), source: 'Wikidata' },
            { text: 'Mission Cost: $' + getRandomMissionCost() + ' million', source: 'Wikidata' },
            { text: 'Launch Vehicle: ' + getRandomRocket(), source: 'Wikidata' },
            { text: 'Mission Status: ' + getRandomMissionStatus(), source: 'Wikidata' }
          ],
          images: [
            { title: 'Mission patch logo' },
            { title: 'Launch vehicle photo' },
            { title: 'Mission control center' },
            { title: 'Spacecraft diagram' }
          ],
          additionalContext: 'Space mission articles should include technical details, objectives, and outcomes. Official space agency websites and press releases are excellent sources.'
        };
      }
      
      // Person/Biography pattern - much more restrictive
      if (isPersonName(title)) {
        return {
          facts: [
            { text: 'Born: ' + generateRandomDate(1950, 2000), source: 'Wikidata' },
            { text: 'Nationality: ' + getRandomNationality(), source: 'Wikidata' },
            { text: 'Occupation: ' + getRandomOccupation(), source: 'Wikidata' },
            { text: 'Known for: ' + getRandomAchievement(), source: 'Wikidata' }
          ],
          images: [
            { title: 'Official portrait' },
            { title: 'Awards ceremony photo' },
            { title: 'Professional headshot' }
          ],
          languages: getRandomLanguages(),
          languageNote: 'International recognition and coverage'
        };
      }
      
      // Location pattern
      if (isLocation(title)) {
        return {
          facts: [
            { text: 'Population: ' + getRandomPopulation(), source: 'Wikidata' },
            { text: 'Area: ' + getRandomArea() + ' km²', source: 'Wikidata' },
            { text: 'Founded: ' + generateRandomDate(1000, 1900), source: 'Wikidata' },
            { text: 'Time Zone: ' + getRandomTimezone(), source: 'Wikidata' }
          ],
          images: [
            { title: 'City skyline' },
            { title: 'Historical landmarks' },
            { title: 'Geographic map' },
            { title: 'Cultural sites' }
          ],
          languages: getRandomLanguages(),
          languageNote: 'Local history and cultural significance'
        };
      }
      
      // Organizations/Companies pattern
      if (lowerTitle.includes('company') || lowerTitle.includes('corporation') || lowerTitle.includes('organization') || lowerTitle.includes('foundation') || lowerTitle.includes('institute')) {
        return {
          facts: [
            { text: 'Founded: ' + generateRandomDate(1950, 2020), source: 'Wikidata' },
            { text: 'Headquarters: ' + getRandomLocation(), source: 'Wikidata' },
            { text: 'Type: ' + getRandomOrgType(), source: 'Wikidata' },
            { text: 'Employees: ' + getRandomEmployeeCount(), source: 'Company reports' }
          ],
          images: [
            { title: 'Company headquarters' },
            { title: 'Logo and branding' },
            { title: 'Key executives' }
          ],
          languages: getRandomLanguages(),
          languageNote: 'Business and trade publications'
        };
      }
      
      // Generic fallback for unclear topics
      return {
        facts: [
          { text: 'First documented: ' + generateRandomDate(1900, 2020), source: 'Wikidata' },
          { text: 'Category: ' + getRandomGenericType(), source: 'Wikidata' },
          { text: 'Notable for: ' + getRandomNotability(), source: 'Various sources' }
        ],
        images: [
          { title: 'Main illustration' },
          { title: 'Related diagram' },
          { title: 'Historical context' }
        ],
        languages: ['German', 'French', 'Spanish'],
        languageNote: 'Additional international sources available'
      };
    }

    // Helper functions for pattern matching and random data
    function isPersonName(title) {
      // Much more restrictive - only if it clearly looks like a person's name
      const namePatterns = /^(dr\.?|mr\.?|ms\.?|mrs\.?|professor|sir|dame)\s+\w+|\w+\s+(jr\.?|sr\.?|ii|iii|iv)$|^[A-Z][a-z]+\s+[A-Z][a-z]+$/;
      const lowerTitle = title.toLowerCase();
      
      // Exclude obvious non-person patterns
      if (lowerTitle.includes('flood') || lowerTitle.includes('earthquake') || lowerTitle.includes('mission') || 
          lowerTitle.includes('company') || lowerTitle.includes('city') || lowerTitle.includes('disaster') ||
          lowerTitle.includes('university') || lowerTitle.includes('college') || lowerTitle.includes('school')) {
        return false;
      }
      
      return namePatterns.test(title) && !isLocation(title);
    }

    function isLocation(title) {
      const locationKeywords = ['city', 'town', 'village', 'state', 'province', 'country', 'river', 'mountain', 'lake', 'park', 'university', 'college', 'school'];
      return locationKeywords.some(keyword => title.toLowerCase().includes(keyword));
    }

    function extractLocationFromTitle(title) {
      // Try to extract location from disaster titles like "Punjab floods" or "California earthquake"
      const words = title.split(' ');
      if (words.length >= 2) {
        return words[0]; // First word is likely the location
      }
      return null;
    }

    function generateRecentDate() {
      const currentYear = new Date().getFullYear();
      const year = currentYear - Math.floor(Math.random() * 3); // Within last 3 years
      const month = Math.floor(Math.random() * 12) + 1;
      const day = Math.floor(Math.random() * 28) + 1;
      return month + '/' + day + '/' + year;
    }

    function getRandomCasualties() {
      const casualties = ['12 killed, 50 injured', '5 deaths reported', 'No casualties reported', '25+ missing', '100+ evacuated'];
      return casualties[Math.floor(Math.random() * casualties.length)];
    }

    function getRandomDamage() {
      return Math.floor(Math.random() * 500) + 50; // 50-550 million
    }

    function getRandomSpaceAgency() {
      const agencies = ['NASA', 'ESA', 'ISRO', 'JAXA', 'SpaceX', 'Roscosmos', 'CNSA'];
      return agencies[Math.floor(Math.random() * agencies.length)];
    }

    function getRandomMissionCost() {
      return Math.floor(Math.random() * 2000) + 100; // 100-2100 million
    }

    function getRandomRocket() {
      const rockets = ['Falcon 9', 'Atlas V', 'LVM3', 'Ariane 5', 'Long March 5', 'Proton-M'];
      return rockets[Math.floor(Math.random() * rockets.length)];
    }

    function getRandomMissionStatus() {
      const statuses = ['Active', 'Completed successfully', 'In progress', 'Launched', 'Planned'];
      return statuses[Math.floor(Math.random() * statuses.length)];
    }

    function getRandomOrgType() {
      const types = ['Technology company', 'Non-profit organization', 'Research institute', 'Government agency', 'Educational institution'];
      return types[Math.floor(Math.random() * types.length)];
    }

    function getRandomEmployeeCount() {
      const counts = ['500-1,000', '1,000-5,000', '10,000+', '50-500', '100-1,000'];
      return counts[Math.floor(Math.random() * counts.length)];
    }

    function getRandomGenericType() {
      const types = ['Concept', 'Event', 'Phenomenon', 'Theory', 'Process', 'System'];
      return types[Math.floor(Math.random() * types.length)];
    }

    function getRandomNotability() {
      const reasons = ['Historical significance', 'Cultural impact', 'Scientific importance', 'Economic influence', 'Social relevance'];
      return reasons[Math.floor(Math.random() * reasons.length)];
    }

    function generateRandomDate(startYear, endYear) {
      const year = Math.floor(Math.random() * (endYear - startYear + 1)) + startYear;
      const month = Math.floor(Math.random() * 12) + 1;
      const day = Math.floor(Math.random() * 28) + 1;
      return month + '/' + day + '/' + year;
    }

    function getRandomNationality() {
      const nationalities = ['American', 'British', 'Indian', 'German', 'French', 'Canadian', 'Australian', 'Japanese'];
      return nationalities[Math.floor(Math.random() * nationalities.length)];
    }

    function getRandomOccupation() {
      const occupations = ['Scientist', 'Engineer', 'Artist', 'Writer', 'Politician', 'Business Leader', 'Academic', 'Researcher'];
      return occupations[Math.floor(Math.random() * occupations.length)];
    }

    function getRandomAchievement() {
      const achievements = ['Scientific breakthrough', 'Literary contributions', 'Social activism', 'Technical innovation', 'Cultural impact', 'Educational reform'];
      return achievements[Math.floor(Math.random() * achievements.length)];
    }

    function getRandomPopulation() {
      const populations = ['50,000', '125,000', '300,000', '750,000', '1.2 million', '2.5 million'];
      return populations[Math.floor(Math.random() * populations.length)];
    }

    function getRandomArea() {
      return Math.floor(Math.random() * 500) + 50;
    }

    function getRandomTimezone() {
      const timezones = ['UTC+1', 'UTC-5', 'UTC+8', 'UTC-8', 'UTC+2', 'UTC+5:30'];
      return timezones[Math.floor(Math.random() * timezones.length)];
    }

    function getRandomType() {
      const types = ['Organization', 'Institution', 'Company', 'Non-profit', 'Government Agency', 'Research Center'];
      return types[Math.floor(Math.random() * types.length)];
    }

    function getRandomLocation() {
      const locations = ['New York, USA', 'London, UK', 'Tokyo, Japan', 'Berlin, Germany', 'Toronto, Canada', 'Sydney, Australia'];
      return locations[Math.floor(Math.random() * locations.length)];
    }

    function getRandomLanguages() {
      const allLanguages = ['Spanish', 'French', 'German', 'Italian', 'Portuguese', 'Russian', 'Chinese', 'Japanese', 'Arabic'];
      const count = Math.floor(Math.random() * 3) + 2; // 2-4 languages
      const selected = [];
      for (let i = 0; i < count; i++) {
        const lang = allLanguages[Math.floor(Math.random() * allLanguages.length)];
        if (!selected.includes(lang)) selected.push(lang);
      }
      return selected;
    }

    // Interactive functions for sister project features
    function toggleMoreFacts() {
      const moreFacts = document.getElementById('moreFacts');
      const toggleBtn = event.target;
      
      if (moreFacts.style.display === 'none') {
        moreFacts.style.display = 'block';
        toggleBtn.innerHTML = 'Show fewer facts ▲';
      } else {
        moreFacts.style.display = 'none';
        toggleBtn.innerHTML = 'Show ' + (document.querySelectorAll('#moreFacts .sister-fact-btn').length) + ' more facts ▼';
      }
    }

    function insertFactWithCitation(factText, source) {
      const editor = document.getElementById('editor');
      if (editor) {
        // Insert the fact with a citation
        const citation = '<ref>Source: ' + source + '</ref>';
        const textToInsert = factText + citation + ' ';
        
        // Simple insertion at cursor position or end
        const selection = window.getSelection();
        if (selection.rangeCount > 0 && editor.contains(selection.anchorNode)) {
          const range = selection.getRangeAt(0);
          range.deleteContents();
          range.insertNode(document.createTextNode(textToInsert));
        } else {
          editor.innerHTML += textToInsert;
        }
        
        // Visual feedback
        event.target.style.background = '#d4edda';
        event.target.innerHTML = '✓ Inserted';
        setTimeout(() => {
          event.target.style.background = '#f8f9fa';
          event.target.innerHTML = factText;
        }, 2000);
      }
    }

    function insertImage(imageTitle) {
      alert('Image insertion: ' + imageTitle + '\n\nIn a real implementation, this would insert the image with proper licensing.');
      
      // Visual feedback
      event.target.style.background = '#d4edda';
      event.target.innerHTML = '✓ ' + imageTitle;
      setTimeout(() => {
        event.target.style.background = '#f0f8ff';
        event.target.innerHTML = imageTitle;
      }, 2000);
    }

    // Update guide content in both sidebar and modal
    function updateGuideContent() {
      const content = generateGuideContent();
      if (guideContent) guideContent.innerHTML = content;
      if (guideModalContent) guideModalContent.innerHTML = content;
      
      // Add click handlers to section buttons
      bindSectionButtons();
      
      // Bind source button
      bindSourceButton();
      buildSidebarSavedList();
      
      // Bind eligibility checker
      bindEligibilityChecker();
    }

    // Toggle accordion sections
    function toggleAccordion(header) {
      const content = header.nextElementSibling;
      const icon = header.querySelector('.accordion-icon');
      
      if (content.style.display === 'none') {
        content.style.display = 'block';
        icon.style.transform = 'rotate(0deg)';
      } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(-90deg)';
      }
    }

    // Clean up extra breaks and empty elements that cause visual separators
    function cleanupExtraBreaks() {
      var editor = document.getElementById('editor');
      if (!editor) return;
      
      var content = editor.innerHTML;
      
      // Remove multiple consecutive BR tags
      content = content.replace(/<br\s*\/?>\s*<br\s*\/?>/g, '<br>');
      
      // Remove BR tags that appear right before H2 elements (causing extra separators)
      content = content.replace(/<br\s*\/?>\s*(<h2)/g, '$1');
      
      // Remove empty divs that might contain only whitespace or BR tags
      content = content.replace(/<div[^>]*>(\s|<br\s*\/?>)*<\/div>/g, '');
      
      // Remove empty paragraphs but PRESERVE those with data-placeholder attribute
      content = content.replace(/<p(?![^>]*data-placeholder)[^>]*>(\s|<br\s*\/?>|&nbsp;)*<\/p>/g, '');
      
      // Remove any empty H2 elements that might have been created
      content = content.replace(/<h2[^>]*>(\s|&nbsp;)*<\/h2>/g, '');
      
      // Remove any H2 elements that only contain buttons (phantom sections)
      content = content.replace(/<h2[^>]*>(\s*<button[^>]*>.*?<\/button>\s*)*<\/h2>/g, '');
      
      // Remove any elements with border-bottom styles that aren't H2
      content = content.replace(/<(?!h2)[^>]+style="[^"]*border-bottom[^"]*"[^>]*>/g, function(match) {
        return match.replace(/border-bottom[^;"]*;?/g, '');
      });
      
      // Update editor content
      editor.innerHTML = content;
      
      // After updating, force remove borders from all non-H2 elements
      var allElements = editor.querySelectorAll('*:not(h2)');
      allElements.forEach(function(el) {
        if (el.style) {
          el.style.borderBottom = 'none';
          el.style.border = 'none';
        }
        // Remove border-bottom from style attribute if it exists
        if (el.hasAttribute('style')) {
          var styleAttr = el.getAttribute('style');
          if (styleAttr.includes('border-bottom')) {
            styleAttr = styleAttr.replace(/border-bottom[^;]*;?/g, '');
            el.setAttribute('style', styleAttr);
          }
        }
      });

      // Finally, remove any stray empty headings
      cleanupEmptyHeadings();
    }

    // Remove stray empty section headings that create visual dividers
    function cleanupEmptyHeadings() {
      var ed = document.getElementById('editor');
      if (!ed) return;
      var h2s = ed.querySelectorAll('h2.wiki-section-heading');
      h2s.forEach(function(h) {
        // Determine if there's any real text node content in the H2 (ignoring whitespace/ZWSP)
        var hasText = false;
        for (var i = 0; i < h.childNodes.length; i++) {
          var n = h.childNodes[i];
          if (n.nodeType === Node.TEXT_NODE && n.textContent.replace(/\u200B/g, '').trim() !== '') {
            hasText = true;
            break;
          }
        }
        if (!hasText) {
          // Empty heading — remove it to avoid duplicate separators
          if (h.parentNode) h.parentNode.removeChild(h);
        }
      });
    }

    // Get template for specific sections based on category
    function getSectionTemplate(sectionName, category) {
      var templates = {
        'person': {
          'Early life': '[Person\'s Name] was born on [Date] in [Location]. Their parents were [Parents\' details]. They attended [Education details] where they [notable achievements or experiences].',
          'Career': '[Person\'s Name] began their career in [Year] as [Initial position]. They later became known for [Major achievements]. Their notable works include [List key works or contributions].',
          'Background': '[Person\'s Name] comes from [Background context]. Their early experiences with [relevant field] began when [context]. This led to their later work in [area of expertise].',
          'Overview': '[Person\'s Name] is primarily known for [main achievements]. They have [quantifiable accomplishments] and are recognized for [specific contributions to their field].'
        },
        'place': {
          'Geography': '[Place Name] is located at [coordinates/description] in [broader geographic area]. The terrain is characterized by [physical features]. The climate is [climate description] with [seasonal patterns].',
          'History': '[Place Name] was first [settled/established] in [year] by [people/group]. Major historical events include [key events]. The area developed significantly during [time period] due to [factors].',
          'Background': 'The area now known as [Place Name] has been [historical context]. Early development was influenced by [factors]. Today it is known for [current significance].',
          'Overview': '[Place Name] is a [type of place] with [key statistics]. It is notable for [main features] and serves as [primary function or significance].'
        },
        'species': {
          'Description': 'The [Species Name] typically measures [size] and weighs [weight]. It is characterized by [distinctive features]. Key identifying features include [specific characteristics that distinguish it].',
          'Habitat': 'The [Species Name] is found primarily in [geographic range]. It prefers [habitat type] with [environmental conditions]. Its distribution is [distribution pattern].',
          'Background': 'The [Species Name] was first [discovered/described] in [year] by [scientist]. It belongs to the [taxonomic classification] and is related to [related species].',
          'Overview': 'The [Species Name] is a [type of organism] known for [key characteristics]. It plays an important role in [ecological role] and is [conservation status].'
        },
        'organization': {
          'History': '[Organization Name] was founded in [Year] by [Founder(s)] with the mission to [original mission]. It began as [initial form] and has grown to [current scope].',
          'Activities': '[Organization Name] primarily focuses on [main activities]. Their key programs include [list programs]. They serve [target population] through [methods].',
          'Background': '[Organization Name] was established in response to [need or problem]. The founders recognized that [rationale] and created the organization to [solution approach].',
          'Overview': '[Organization Name] is a [type of organization] that [main function]. It operates in [scope/geography] and is known for [key achievements or focus areas].'
        },
        'other': {
          'Background': '[Topic] has its origins in [historical context]. It developed from [early forms] and became [current form] through [process or evolution].',
          'Overview': '[Topic] is [definition] that [key characteristics]. It is significant because [importance] and is used for [applications or purposes].'
        }
      };
      
      var categoryTemplates = templates[category] || templates['other'];
      return categoryTemplates[sectionName] || templates['other']['Background'];
    }

    // Get introduction template based on category
    function getIntroductionTemplate(category) {
      var templates = {
        'person': "[Person's Name] was born on [Date] and is known for [notable achievements]. They are [brief description of what makes them notable].",
        'place': '[Place Name] is [type of location] located in [geographic area]. It has a population of [number] and is known for [key features or significance].',
        'species': 'The [common name] ([Scientific name]) is a [type of organism] that [key characteristics]. It is [distinctive features or behaviors].',
        'organization': '[Organization Name] is a [type of organization] founded in [year] by [founder]. It [main purpose or mission].',
        'academic': '[Term/Concept] is [definition] that [main characteristics or applications]. It was [development or discovery context].',
        'creative': '[Title] is a [type of work] [created/written/directed] by [creator] in [year]. It [brief description of content or significance].',
        'event': '[Event Name] was [type of event] that occurred on [date] in [location]. It [significance or impact].',
        'other': '[Topic Name] is [definition or description] that [key characteristics or significance]. It [additional context].'
      };
      
      return templates[category] || templates['other'];
    }

    // Get Wikipedia examples for sections
    function getWikipediaExample(sectionName, category) {
      var examples = {
        'person': {
          'Early life': 'Marie Curie was born Maria Skłodowska on 7 November 1867 in Warsaw, Poland. Her parents were both teachers, and she was the youngest of five children. Despite facing financial difficulties after her father lost his savings, she excelled in her studies and graduated from gymnasium at age 15.',
          'Career': 'Einstein began his career at the Swiss Patent Office in 1902, where he evaluated patent applications. During this period, he completed his most creative work, publishing four groundbreaking papers in 1905 that would transform physics, including his theory of special relativity.',
          'Background': 'Stephen Hawking came from an academic family. His father was a medical researcher and his mother was one of the first female students at Oxford. The family placed a high value on education, which influenced his later academic pursuits.',
          'Overview': 'Albert Einstein was a theoretical physicist who developed the theory of relativity, one of the two pillars of modern physics. His work is known for its influence on the philosophy of science and he received the 1921 Nobel Prize in Physics.'
        },
        'place': {
          'Geography': 'Paris is situated on the Seine River in north-central France, at the center of the Île-de-France region. The city covers an area of 105.4 square kilometers and has an elevation ranging from 28 to 131 meters above sea level.',
          'History': 'London was founded by the Romans around 47 AD as Londinium. After the Roman withdrawal in the 5th century, the city was largely abandoned until it was resettled by the Anglo-Saxons. It grew rapidly during the medieval period and became England\'s largest city.',
          'Background': 'The area now known as New York City was originally inhabited by Algonquian tribes. European exploration began in the 16th century, with the Dutch establishing New Amsterdam in 1624, which the English later renamed New York.',
          'Overview': 'Tokyo is the capital and most populous city of Japan. Located at the head of Tokyo Bay, it is the political, economic, and cultural center of Japan, with a metropolitan area population exceeding 37 million.'
        },
        'species': {
          'Description': 'The giant panda has a distinctive black-and-white coat, with black fur around its eyes, ears, legs, and shoulders. Adults typically measure 1.2 to 1.9 meters in length and weigh between 80 and 125 kilograms. Their thick, woolly coat keeps them warm in their cool mountain homes.',
          'Habitat': 'Giant pandas live in temperate broadleaf and mixed forests in southwest China, particularly in Sichuan Province. They are found at elevations between 1,200 and 3,400 meters, where bamboo grows abundantly beneath the forest canopy.',
          'Background': 'The blue whale was first described by Robert Sibbald in 1694. For centuries, it was too large and fast to hunt effectively, but advances in whaling technology in the 19th century led to widespread hunting.',
          'Overview': 'The African elephant is the largest living terrestrial animal. Distinguished by its large ears and concave back, it plays a crucial role in maintaining the biodiversity of the ecosystems in which it lives.'
        },
        'organization': {
          'History': 'The Red Cross was founded in 1863 by Henry Dunant and Gustave Moynier in Geneva, Switzerland. It began as a response to the suffering Dunant witnessed at the Battle of Solferino, leading to the first Geneva Convention.',
          'Activities': 'UNICEF works in over 190 countries providing humanitarian aid to children. Its activities include emergency relief, promoting child rights, improving healthcare and education, and protecting children from violence and exploitation.',
          'Background': 'NASA was established in 1958 in response to the Soviet Union\'s launch of Sputnik. It replaced the National Advisory Committee for Aeronautics and began civilian space exploration efforts.',
          'Overview': 'The World Health Organization is a specialized agency of the United Nations responsible for international public health. Established in 1948, it coordinates global health responses and sets health standards.'
        }
      };
      
      return (examples[category] && examples[category][sectionName]) || null;
    }

    // Get contextual writing prompt for section based on category
    function getWritingPromptForSection(sectionName, category) {
      var prompts = {
        'person': {
          'Early life': 'When and where was this person born? What was their childhood like? What about their education and early influences?',
          'Career': 'What is this person known for professionally? What were their major achievements, works, or contributions?',
          'Background': 'What\'s important to know about this person\'s background? Include birth, education, and early experiences.',
          'Overview': 'What are this person\'s main accomplishments? What makes them notable or significant?'
        },
        'place': {
          'Geography': 'Where exactly is this place located? What are its physical features, climate, and natural characteristics?',
          'History': 'How did this place develop over time? When was it founded or first settled? What major events happened here?',
          'Background': 'What\'s the historical context of this place? How did it come to be what it is today?',
          'Overview': 'What are the key facts about this place? What makes it notable or significant?'
        },
        'species': {
          'Description': 'What does this species look like? What are its distinctive physical features that help identify it?',
          'Habitat': 'Where does this species live? What kind of environment does it need to survive?',
          'Background': 'What\'s the scientific context of this species? How was it discovered or classified?',
          'Overview': 'What are the key characteristics of this species? What makes it unique or important?'
        },
        'organization': {
          'History': 'When and why was this organization founded? Who started it and what were the original goals?',
          'Activities': 'What does this organization actually do? What programs, services, or work does it carry out?',
          'Background': 'What led to the creation of this organization? What problem was it trying to solve?',
          'Overview': 'What are the main things this organization does? What impact does it have?'
        },
        'academic': {
          'Definition': 'What exactly does this concept mean? How would you explain it clearly to someone new to the topic?',
          'Background': 'How did this concept develop? Who were the key people involved in discovering or developing it?',
          'Overview': 'What are the main aspects of this concept? Why is it important in its field?'
        },
        'creative': {
          'Plot': 'What is this work about? Summarize the main story or content without giving away major spoilers.',
          'Production': 'How was this work created? Who made it, when, and what was the creative process like?',
          'Background': 'What inspired this work? What\'s the story behind its creation?',
          'Overview': 'What is this creative work and what makes it significant or notable?'
        },
        'event': {
          'Background': 'What led up to this event? What were the circumstances and causes that made it happen?',
          'Timeline': 'What actually happened during this event? Walk through the key moments in chronological order.',
          'Overview': 'What was this event and why was it important? What were the main outcomes?'
        },
        'other': {
          'Background': 'What\'s the context or history behind this topic? How did it come about or develop?',
          'Overview': 'What are the main aspects or components of this topic? What should readers know about it?'
        }
      };

      // Get category-specific prompts, fallback to 'other' if category not found
      var categoryPrompts = prompts[category] || prompts['other'];
      
      // Return specific prompt for section, or a generic one if not found
      return categoryPrompts[sectionName] || 'Click here to start writing about ' + sectionName.toLowerCase() + '. What should readers know?';
    }

    // Add section to editor
    function addSectionToEditor(sectionName) {
      if (addedSections.indexOf(sectionName) !== -1) return; // Already added
      
      var editor = document.getElementById('editor');
      if (!editor) return;

      // Add section to tracking
      addedSections.push(sectionName);

      // Create Wikipedia-style heading with proper styling
      var currentContent = editor.innerHTML;
      var hasContent = currentContent.trim() !== '';
      
      // Get contextual writing prompt based on section and category
      var writingPrompt = getWritingPromptForSection(sectionName, selectedCat);
      
      // Create section with Wikipedia-style formatting (no extra breaks)
      var sectionHTML = '';
      sectionHTML += '<h2 id="' + sectionName.replace(/\s+/g, '_') + '" class="wiki-section-heading">' + sectionName;
      sectionHTML += '<button class="section-close-btn" onclick="removeSectionFromEditor(\'' + sectionName + '\')" style="';
      sectionHTML += 'position: absolute; right: 420px; top: 50%; transform: translateY(-50%); ';
      sectionHTML += 'background: #fff; border: 1px solid #c8ccd1; font-size: 16px; color: #72777d; cursor: pointer; ';
      sectionHTML += 'padding: 2px 8px; border-radius: 3px; transition: color 0.2s, background 0.2s, border-color 0.2s;" ';
      sectionHTML += 'title="Remove this section">';
      sectionHTML += '×';
      sectionHTML += '</button>';
      sectionHTML += '</h2>';
      sectionHTML += '<p style="margin: 0.75em 0; line-height: 1.6; color: #72777d; font-style: italic;" data-placeholder="' + writingPrompt + '">' + writingPrompt + '</p>';
      
      // Check if References section exists and insert before it
      var referencesMatch = currentContent.match(/<h2[^>]*id="References"[^>]*>/);
      if (referencesMatch && hasContent) {
        var beforeReferences = currentContent.substring(0, referencesMatch.index);
        var referencesAndAfter = currentContent.substring(referencesMatch.index);
        editor.innerHTML = beforeReferences + sectionHTML + referencesAndAfter;
      } else if (hasContent) {
        editor.innerHTML = currentContent + sectionHTML;
      } else {
        editor.innerHTML = sectionHTML;
      }

      // Clean up any extra BR tags or empty divs that might create visual separators (but not immediately after section insertion)
      setTimeout(function() {
        cleanupExtraBreaks();
      }, 100);

      // Position cursor in the newly added section's paragraph
      editor.focus();
      var range = document.createRange();
      var sel = window.getSelection();
      
      // Find the specific paragraph for the newly added section
      var newSectionId = sectionName.replace(/\s+/g, '_');
      var newSection = editor.querySelector('#' + newSectionId);
      var newSectionP = null;
      
      if (newSection) {
        // Find the paragraph immediately after this section heading
        var nextElement = newSection.nextElementSibling;
        while (nextElement && nextElement.tagName.toLowerCase() !== 'p') {
          nextElement = nextElement.nextElementSibling;
        }
        if (nextElement && nextElement.tagName.toLowerCase() === 'p') {
          newSectionP = nextElement;
        }
      }
      
      if (newSectionP) {
        // Set up click handler to clear writing prompt when user clicks to write
        newSectionP.addEventListener('click', function() {
          if (this.style.fontStyle === 'italic' && this.style.color === 'rgb(114, 119, 125)') {
            this.innerHTML = '';
            this.style.color = '';
            this.style.fontStyle = '';
            
            // Position cursor at start
            var range = document.createRange();
            var sel = window.getSelection();
            range.setStart(this, 0);
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
          }
        });
        
        range.setStart(newSectionP, 0);
        range.collapse(true);
        sel.removeAllRanges();
        sel.addRange(range);
      }

      // Update content to show new state
      updateGuideContent();
    }

    // Remove section from editor
    function removeSectionFromEditor(sectionName) {
      var editor = document.getElementById('editor');
      if (!editor) return;
      
      // First, clean up any phantom elements
      cleanupExtraBreaks();
      
      // Remove from tracking array
      var index = addedSections.indexOf(sectionName);
      if (index !== -1) {
        addedSections.splice(index, 1);
      }
      
      // Find and remove the section from editor
      var sectionId = sectionName.replace(/\s+/g, '_');
      var sectionElement = editor.querySelector('#' + sectionId);
      
      // Also look for any H2 elements that contain this section name (in case ID is missing)
      if (!sectionElement) {
        var allH2s = editor.querySelectorAll('h2');
        for (var i = 0; i < allH2s.length; i++) {
          if (allH2s[i].textContent.includes(sectionName)) {
            sectionElement = allH2s[i];
            break;
          }
        }
      }
      
      if (sectionElement) {
        // Find all elements that belong to this section (heading + following content until next heading)
        var elementsToRemove = [sectionElement];
        var nextElement = sectionElement.nextElementSibling;
        
        while (nextElement && nextElement.tagName.toLowerCase() !== 'h2') {
          elementsToRemove.push(nextElement);
          nextElement = nextElement.nextElementSibling;
        }
        
        // Remove all elements belonging to this section
        elementsToRemove.forEach(function(element) {
          if (element && element.parentNode) {
            element.parentNode.removeChild(element);
          }
        });
        
        // Clean up any extra breaks and phantom elements again
        setTimeout(function() {
          cleanupExtraBreaks();
        }, 10);
      }
      
      // Update guide content to reflect changes
      updateGuideContent();
    }

    // Bind click handlers to section buttons
    function bindSectionButtons() {
      var buttons = document.querySelectorAll('.section-button:not(.added)');
      buttons.forEach(function(button) {
        button.addEventListener('click', function(e) {
          var sectionName = this.getAttribute('data-section');
          addSectionToEditor(sectionName);
        });
      });
    }

    // Function to show guide interface
    function showGuide() {
      // Update content before showing
      updateGuideContent();
      
      if (isMobile()) {
        guideModalBackdrop.classList.add('open');
      } else {
        guideSidebar.classList.add('open');
      }
    }

    // Function to hide guide interface
    function hideGuide() {
      guideSidebar.classList.remove('open');
      guideModalBackdrop.classList.remove('open');
    }

    // Function to bind article eligibility checker functionality
    function bindEligibilityChecker() {
      const buttons = document.querySelectorAll('.eligibility-btn');
      const resultDiv = document.getElementById('eligibilityResult');
      
      if (buttons.length === 0 || !resultDiv) return;
      
      const answers = {};

      // Auto-compute from captured sources (if any)
      try { applyEligibilityAutoFromSources(); } catch(_) {}
      
      buttons.forEach(function(button) {
        button.addEventListener('click', function() {
          const question = this.getAttribute('data-question');
          const answer = this.getAttribute('data-answer');
          
          // Update answer
          answers[question] = answer;
          
          // Update button states
          const questionButtons = document.querySelectorAll(`[data-question="${question}"]`);
          questionButtons.forEach(btn => btn.classList.remove('selected'));
          this.classList.add('selected');
          
          // Check if all questions answered
          if (Object.keys(answers).length === 4) {
            updateEligibilityResult(answers, resultDiv);
          }
        });
      });
      
      function updateEligibilityResult(answers, resultDiv) {
        const yesCount = Object.values(answers).filter(a => a === 'yes').length;
        const maybeCount = Object.values(answers).filter(a => a === 'maybe').length;
        const noCount = Object.values(answers).filter(a => a === 'no').length;
        
        resultDiv.style.display = 'block';
        
        if (yesCount === 4) {
          resultDiv.style.background = '#d5fdf4';
          resultDiv.style.color = '#00af89';
          resultDiv.style.border = '1px solid #00af89';
          resultDiv.innerHTML = '✅ <strong>Excellent!</strong> Your topic looks ready for Wikipedia. You have strong eligibility.';
        } else if (yesCount >= 2 && noCount <= 1) {
          resultDiv.style.background = '#fef6e7';
          resultDiv.style.color = '#ac6600';
          resultDiv.style.border = '1px solid #fc3';
          resultDiv.innerHTML = '⚠️ <strong>Good start!</strong> Consider strengthening the areas you\'re unsure about, or try draft space first.';
        } else {
          resultDiv.style.background = '#fee7e6';
          resultDiv.style.color = '#d33';
          resultDiv.style.border = '1px solid #d33';
          resultDiv.innerHTML = '<strong>More research needed.</strong> Your topic might benefit from finding more sources before creating the article. Consider draft space to build it up.';
        }
      }
    }

    // Compute eligibility defaults from captured sources (if present)
    function computeEligibilityFromSources() {
      try {
        var src = (Array.isArray(window.creationSources) ? window.creationSources : []);
        if (!src.length) return null; // treat as skipped
        // Normalize and classify
        function uniq(arr){ return Array.from(new Set(arr)); }
        var urls = src.map(function(s){ return (s && s.url) ? s.url : ''; }).filter(Boolean);
        if (!urls.length) return null;
        var domains = urls.map(function(u){ try { return extractDomain(u); } catch(_) { return ''; } }).filter(Boolean);
        var uniqueDomains = uniq(domains);
        var cls = domains.map(function(d){ try { var r = classifySource(d); return (r && r.reliable===true) ? 'reliable' : ((r && r.reliable===false)? 'questionable':'unknown'); } catch(_) { return 'unknown'; } });
        var reliableCount = cls.filter(function(x){ return x==='reliable'; }).length;
        var questionableCount = cls.filter(function(x){ return x==='questionable'; }).length;
        // Map to answers
        var answers = {};
        answers.coverage = urls.length > 0 ? 'yes' : 'no';
        if (reliableCount > 0 && questionableCount === 0) { answers.reliable = 'yes'; }
        else if (reliableCount > 0 && questionableCount > 0) { answers.reliable = 'maybe'; }
        else { answers.reliable = 'no'; }
        answers.independent = uniqueDomains.length >= 2 ? 'yes' : (urls.length>0 ? 'maybe' : 'no');
        answers.multiple = urls.length >= 2 ? 'yes' : (urls.length===1 ? 'maybe' : 'no');
        return answers;
      } catch(_) { return null; }
    }

    function applyEligibilityAutoFromSources(){
      try {
        var auto = computeEligibilityFromSources();
        if (!auto) return;
        Object.keys(auto).forEach(function(q){
          var val = auto[q];
          var qBtns = document.querySelectorAll('[data-question="'+ q +'"]');
          qBtns.forEach(function(btn){ btn.classList.remove('selected'); });
          var sel = document.querySelector('[data-question="'+ q +'"][data-answer="'+ val +'"]');
          if (sel) sel.classList.add('selected');
        });
        var resultDiv = document.getElementById('eligibilityResult');
        if (resultDiv) {
          var answers = auto;
          // Update result
          (function(){
            const yesCount = Object.values(answers).filter(a => a === 'yes').length;
            const noCount = Object.values(answers).filter(a => a === 'no').length;
            resultDiv.style.display = 'block';
            if (yesCount === 4) {
              resultDiv.style.background = '#d5fdf4'; resultDiv.style.color = '#00af89'; resultDiv.style.border = '1px solid #00af89';
              resultDiv.innerHTML = '✅ <strong>Excellent!</strong> Your topic looks ready for Wikipedia. You have strong eligibility.';
            } else if (yesCount >= 2 && noCount <= 1) {
              resultDiv.style.background = '#fef6e7'; resultDiv.style.color = '#ac6600'; resultDiv.style.border = '1px solid #fc3';
              resultDiv.innerHTML = '⚠️ <strong>Good start!</strong> Consider strengthening the areas you\'re unsure about, or try draft space first.';
            } else {
              resultDiv.style.background = '#fee7e6'; resultDiv.style.color = '#d33'; resultDiv.style.border = '1px solid #d33';
              resultDiv.innerHTML = '<strong>More research needed.</strong> Your topic might benefit from finding more sources before creating the article. Consider draft space to build it up.';
            }
          })();
          var noteId = 'eligibilityAutoNote';
          if (!document.getElementById(noteId)) {
            resultDiv.insertAdjacentHTML('beforebegin', '<p id="'+noteId+'" class="guide-note" style="margin: 8px 0 8px 0;">Auto-assessed from your sources (you can adjust)</p>');
          }
        }
      } catch(_) {}
    }

    // Desktop Suggestions button
    if (addSectionBtn) {
      addSectionBtn.addEventListener('click', showGuide);
    }

    // Mobile Suggestions button
    if (guideMeMobileBtn) {
      guideMeMobileBtn.addEventListener('click', showGuide);
    }

    // Close buttons
    if (closeSidebarBtn) {
      closeSidebarBtn.addEventListener('click', hideGuide);
    }
    if (closeModalBtn) {
      closeModalBtn.addEventListener('click', hideGuide);
    }

    // Removed auto-hide when clicking outside - sidebar stays open until manually closed

    // Hide modal when clicking backdrop (mobile only)
    if (guideModalBackdrop) {
      guideModalBackdrop.addEventListener('click', function(e) {
        if (e.target === guideModalBackdrop) {
          hideGuide();
        }
      });
    }

    // Source verification functionality
    var reliableSourcesData = null;
    var sourceModalBackdrop = document.getElementById('sourceModalBackdrop');
    var sourceUrl = document.getElementById('sourceUrl');
    var checkSourceBtn = document.getElementById('checkSourceBtn');
    var generateDraftBtn = document.getElementById('generateDraftBtn');
    var insertDraftBtn = document.getElementById('insertDraftBtn');
    var closeSourceModal = document.getElementById('closeSourceModal');
    var cancelSource = document.getElementById('cancelSource');
    
    // Load reliable sources data
    async function loadReliableSources() {
      try {
        const response = await fetch('reliable-sources.json');
        reliableSourcesData = await response.json();
      } catch (error) {
        console.error('Failed to load reliable sources:', error);
        reliableSourcesData = null;
      }
    }
    
    // Open source modal
    function openSourceModal() {
      sourceModalBackdrop.setAttribute('aria-hidden', 'false');
      sourceUrl.focus();
      resetSourceModal();
    }
    
    // Close source modal
    function closeSourceModalDialog() {
      sourceModalBackdrop.setAttribute('aria-hidden', 'true');
      resetSourceModal();
    }
    
    // Reset modal to initial state
    function resetSourceModal() {
      sourceUrl.value = '';
      document.getElementById('sourceVerification').style.display = 'none';
      document.getElementById('draftPreview').style.display = 'none';
      checkSourceBtn.style.display = 'inline-block';
      generateDraftBtn.style.display = 'none';
      insertDraftBtn.style.display = 'none';
    }
    
    // Check source reliability
    function checkSource() {
      var url = sourceUrl.value.trim();
      if (!url) return;
      
      // Show verification section
      document.getElementById('sourceVerification').style.display = 'block';
      checkSourceBtn.style.display = 'none';
      
      // Simulate verification steps
      performVerificationSteps(url);
    }
    
    // Simulate verification animation
    function performVerificationSteps(url) {
      var steps = ['step1', 'step2'];
      var currentStep = 0;
      
      function processStep() {
        if (currentStep < steps.length) {
          var stepElement = document.getElementById(steps[currentStep]);
          var icon = stepElement.querySelector('.step-icon');
          var text = stepElement.querySelector('.step-text');
          
          // Update icon to checkmark and mark as completed
          setTimeout(function() {
            icon.textContent = '✓';
            stepElement.classList.add('completed');
            
            // Update text based on step
            if (currentStep === 0) {
              text.textContent = 'Domain verified: ' + extractDomain(url);
            } else if (currentStep === 1) {
              text.textContent = 'Source reliability checked';
            }
            
            currentStep++;
            if (currentStep < steps.length) {
              setTimeout(processStep, 800);
            } else {
              setTimeout(showSourceResult, 500);
            }
          }, 1000);
        }
      }
      
      processStep();
    }
    
    // Show source verification result
    function showSourceResult() {
      var url = sourceUrl.value.trim();
      var domain = extractDomain(url);
      var sourceType = classifySource(domain);
      
      var resultDiv = document.getElementById('sourceResult');
      var badgeDiv = document.getElementById('sourceBadge');
      var noteDiv = document.getElementById('reliabilityNote');
      
      if (sourceType.reliable) {
        badgeDiv.className = 'source-badge reliable';
        badgeDiv.textContent = '✓ ' + sourceType.label;
        noteDiv.textContent = sourceType.reliability;
      } else {
        badgeDiv.className = 'source-badge questionable';
        badgeDiv.textContent = '⚠️ ' + sourceType.label;
        noteDiv.textContent = sourceType.warning;
      }
      
      resultDiv.style.display = 'block';
      generateDraftBtn.style.display = 'inline-block';
    }
    
    // Extract domain from URL
    function extractDomain(url) {
      try {
        return new URL(url).hostname.replace('www.', '');
      } catch (e) {
        return url.split('/')[0];
      }
    }
    
    // Classify source based on domain
    function classifySource(domain) {
      if (!reliableSourcesData) {
        return {reliable: true, label: 'External source', reliability: 'Source checking available'};
      }
      
      var sources = reliableSourcesData.approved_sources;
      
      // Check each source category
      for (var category in sources) {
        var categoryData = sources[category];
        
        // Check domains
        if (categoryData.domains && categoryData.domains.some(d => domain.includes(d))) {
          return {
            reliable: true,
            label: categoryData.label,
            reliability: categoryData.reliability
          };
        }
        
        // Check suffixes
        if (categoryData.suffixes && categoryData.suffixes.some(s => domain.endsWith(s))) {
          return {
            reliable: true,
            label: categoryData.label,
            reliability: categoryData.reliability
          };
        }
      }
      
      // Check questionable sources
      var questionable = reliableSourcesData.questionable_sources;
      if (questionable.domains && questionable.domains.some(d => domain.includes(d))) {
        return {
          reliable: false,
          label: questionable.label,
          warning: questionable.warning
        };
      }
      
      // Default to external source
      return {
        reliable: true,
        label: 'External source',
        reliability: 'Source information extracted'
      };
    }
    
    // Generate draft content
    function generateDraft() {
      var url = sourceUrl.value.trim();
      var domain = extractDomain(url);
      var sourceType = getSourceTypeForTemplate(domain);
      
      var templates = reliableSourcesData ? reliableSourcesData.draft_templates : null;
      var template = templates && templates[sourceType] ? templates[sourceType] : templates.default;
      
      // Create mock draft content
      var title = generateMockTitle(domain);
      var today = new Date().toLocaleDateString('en-US', {year: 'numeric', month: 'long', day: 'numeric'});
      
      var draftContent = template.stub
        .replace('[SOURCE]', domain.charAt(0).toUpperCase() + domain.slice(1))
        .replace('[TITLE]', title)
        .replace('[DATE]', today)
        .replace('[TOPIC]', 'this subject')
        .replace('[FIELD]', 'relevant field');
        
      var citation = template.citation
        .replace('[AUTHOR]', 'Author Name')
        .replace('[TITLE]', title)
        .replace('[SOURCE]', domain.charAt(0).toUpperCase() + domain.slice(1))
        .replace('[DATE]', today)
        .replace('[TODAY]', today)
        .replace('[URL]', url);
      
      var fullDraft = '== DRAFT: Needs editing ==\n\n' + 
                     draftContent + '\n\n' +
                     '⚠️ This is a draft stub. Please expand with your own analysis and additional sources before publishing.\n\n' +
                     citation;
      
      document.getElementById('draftContent').textContent = fullDraft;
      document.getElementById('draftPreview').style.display = 'block';
      generateDraftBtn.style.display = 'none';
      insertDraftBtn.style.display = 'inline-block';
    }
    
    // Generate mock title based on domain
    function generateMockTitle(domain) {
      var titles = [
        'Recent Developments in Subject Area',
        'Analysis of Current Topic',
        'Overview of Related Field',
        'Background Information on Subject',
        'Context and Development'
      ];
      return titles[Math.floor(Math.random() * titles.length)];
    }
    
    // Get source type for template
    function getSourceTypeForTemplate(domain) {
      if (!reliableSourcesData) return 'default';
      
      var sources = reliableSourcesData.approved_sources;
      for (var category in sources) {
        var categoryData = sources[category];
        if (categoryData.domains && categoryData.domains.some(d => domain.includes(d))) {
          return category;
        }
        if (categoryData.suffixes && categoryData.suffixes.some(s => domain.endsWith(s))) {
          return category;
        }
      }
      return 'default';
    }
    
    // Insert draft into editor
    function insertDraft() {
      var draftText = document.getElementById('draftContent').textContent;
      var editor = document.getElementById('editor');
      
      if (editor) {
        var currentContent = editor.innerHTML;
        var draftHTML = draftText.replace(/\n/g, '<br>');
        
        if (currentContent.trim() === '') {
          editor.innerHTML = '<div style="margin-bottom: 2em;">' + draftHTML + '</div>';
        } else {
          editor.innerHTML = currentContent + '<div style="margin-top: 2em;">' + draftHTML + '</div>';
        }
        
        editor.focus();
      }
      
      closeSourceModalDialog();
    }

    // Bind source button click handlers for sidebar
    function bindSourceButton() {
      var checkBtn = document.getElementById('sidebarCheckBtn');
      if (checkBtn) {
        checkBtn.addEventListener('click', function() {
          checkSidebarSource();
        });
      }
    }

    // Check source in sidebar
    function checkSidebarSource() {
      var sourceUrl = document.getElementById('sidebarSourceUrl');
      var checkBtn = document.getElementById('sidebarCheckBtn');
      
      if (!sourceUrl || !sourceUrl.value.trim()) {
        return;
      }
      try { saveSidebarSource(sourceUrl.value.trim()); buildSidebarSavedList(); } catch(_) {}
      
      // If user picked a saved Q3 source marked as likely reliable, skip verification animation
      if (window.__sourceSelectedFromSaved && window.__sourceSelectedFromSavedReliable) {
        var url = sourceUrl.value.trim();
        var resultDiv = document.getElementById('sidebarSourceResult');
        var domain = extractDomain(url);
        var sourceType = classifySource(domain);
        var resultHTML = '';
        if (!sourceType || sourceType.reliable) {
          resultHTML += '<div class="sidebar-source-badge reliable">✓ ' + (sourceType && sourceType.label ? sourceType.label : 'Likely reliable') + '</div>';
          resultHTML += '<p style="font-size: 12px; color: #72777d; margin: 0 0 8px 0;">' + ((sourceType && (sourceType.reliability||'')) || 'Likely reliable') + '</p>';
        } else {
          resultHTML += '<div class="sidebar-source-badge questionable">⚠️ ' + sourceType.label + '</div>';
          resultHTML += '<p style="font-size: 12px; color: #72777d; margin: 0 0 8px 0;">' + (sourceType.warning||'') + '</p>';
        }
        resultHTML += '<div style="margin-top:8px; display:flex; gap:8px;">'
          + '<button class="sidebar-action-btn primary" id="sidebarGenerateBtn">Create draft from source</button>'
          + '<button class="sidebar-action-btn" id="sidebarCancelBtn">Cancel</button>'
          + '</div>';
        resultDiv.innerHTML = resultHTML;
        resultDiv.style.display = 'block';
        try { window.__suppressSourceNotice = true; } catch(_) {}
        // Bind actions
        var gbtn = document.getElementById('sidebarGenerateBtn');
        var cbtn = document.getElementById('sidebarCancelBtn');
        if (gbtn) gbtn.addEventListener('click', function(){ generateSidebarDraft(url); });
        if (cbtn) cbtn.addEventListener('click', function(){ resetSidebarSource(); });
        // Reset selection flags
        try { window.__sourceSelectedFromSaved = false; window.__sourceSelectedFromSavedReliable = false; } catch(_) {}
        return;
      }

      // Otherwise run the verification steps (with animation)
      checkBtn.disabled = true;
      checkBtn.textContent = 'Checking...';
      performSidebarVerificationSteps(sourceUrl.value.trim());
    }

    // Perform verification steps in sidebar
    function performSidebarVerificationSteps(url) {
      var stepsDiv = document.getElementById('sidebarVerificationSteps');
      var steps = [
        'Checking domain...',
        'Verifying source reliability...'
      ];
      
      var stepsHTML = '';
      steps.forEach(function(step, index) {
        stepsHTML += '<div class="sidebar-verification-step" id="sidebarStep' + index + '">';
        stepsHTML += '<div class="sidebar-step-icon" id="sidebarStepIcon' + index + '">' + (index + 1) + '</div>';
        stepsHTML += '<span class="sidebar-step-text" id="sidebarStepText' + index + '">' + step + '</span>';
        stepsHTML += '</div>';
      });
      
      stepsDiv.innerHTML = stepsHTML;
      stepsDiv.style.display = 'block';
      
      var currentStep = 0;
      
      function processStep() {
        if (currentStep < steps.length) {
          var stepElement = document.getElementById('sidebarStep' + currentStep);
          var icon = document.getElementById('sidebarStepIcon' + currentStep);
          var text = document.getElementById('sidebarStepText' + currentStep);
          
          // Mark current step as active
          icon.classList.add('active');
          
          // Update icon to checkmark and mark as completed
          setTimeout(function() {
            icon.textContent = '✓';
            icon.classList.remove('active');
            icon.classList.add('completed');
            
            // Update text based on step
            if (currentStep === 0) {
              text.textContent = 'Domain verified: ' + extractDomain(url);
            } else if (currentStep === 1) {
              text.textContent = 'Source reliability checked';
            }
            
            currentStep++;
            if (currentStep < steps.length) {
              setTimeout(processStep, 800);
            } else {
              setTimeout(showSidebarSourceResult, 500);
            }
          }, 1000);
        }
      }
      
      processStep();
    }

    // Show source verification result in sidebar
    function showSidebarSourceResult() {
      var sourceUrl = document.getElementById('sidebarSourceUrl');
      var checkBtn = document.getElementById('sidebarCheckBtn');
      var resultDiv = document.getElementById('sidebarSourceResult');
      
      var url = sourceUrl.value.trim();
      var domain = extractDomain(url);
      var sourceType = classifySource(domain);
      
      var resultHTML = '';
      if (sourceType.reliable) {
        resultHTML += '<div class="sidebar-source-badge reliable">✓ ' + sourceType.label + '</div>';
        resultHTML += '<p style="font-size: 12px; color: #72777d; margin: 0 0 8px 0;">' + sourceType.reliability + '</p>';
      } else {
        resultHTML += '<div class="sidebar-source-badge questionable">⚠️ ' + sourceType.label + '</div>';
        resultHTML += '<p style="font-size: 12px; color: #72777d; margin: 0 0 8px 0;">' + sourceType.warning + '</p>';
      }
      
      // Add explicit next actions
      resultHTML += '<div style="margin-top:8px; display:flex; gap:8px;">'
        + '<button class="sidebar-action-btn primary" id="sidebarGenerateBtn">Create draft from source</button>'
        + '<button class="sidebar-action-btn" id="sidebarCancelBtn">Cancel</button>'
        + '</div>';
      resultDiv.innerHTML = resultHTML;
      resultDiv.style.display = 'block';
      
      try { saveSidebarSource(url, (sourceType.reliable ? (sourceType.reliability||'') : (sourceType.warning||''))); buildSidebarSavedList(); } catch(_) {}

      // Re-enable check button
      checkBtn.disabled = false;
      checkBtn.textContent = 'Check source';
      
      // Bind actions
      var gbtn = document.getElementById('sidebarGenerateBtn');
      var cbtn = document.getElementById('sidebarCancelBtn');
      if (gbtn) gbtn.addEventListener('click', function(){ generateSidebarDraft(url); });
      if (cbtn) cbtn.addEventListener('click', function(){ resetSidebarSource(); });
    }

    // Persist and display saved sources in sidebar
    function getTopicKey() {
      try {
        var t = '';
        var veTitle = document.getElementById('veTitle');
        if (veTitle && veTitle.textContent.trim()) t = veTitle.textContent.trim();
        if (!t) {
          var ti = document.getElementById('title');
          if (ti && ti.value.trim()) t = ti.value.trim();
        }
        t = t || 'untitled';
        return 'articleCreatorSavedSources:' + t.toLowerCase().replace(/\s+/g,'-').replace(/[^a-z0-9_-]/g,'');
      } catch(_) { return 'articleCreatorSavedSources:untitled'; }
    }
    function getSavedSourcesArray() {
      try {
        var key = getTopicKey();
        var raw = sessionStorage.getItem(key);
        var arr = raw ? JSON.parse(raw) : [];
        if (!Array.isArray(arr)) return [];
        return arr;
      } catch(_) { return []; }
    }
    function saveSavedSourcesArray(arr) {
      try { sessionStorage.setItem(getTopicKey(), JSON.stringify(arr.slice(0, 20))); } catch(_) {}
    }
    function normalizeUrl(u){ try { return new URL(u).href; } catch(_){ try { return new URL('https://'+u).href; } catch(__){ return (u||'').trim(); } } }
    function addToSaved(arr, url, hint, origin) {
      var canon = normalizeUrl(url);
      if (!canon) return arr;
      var exist = arr.find(function(s){ return (s && s.url) === canon; });
      if (exist) {
        if (hint && !exist.reliabilityHint) exist.reliabilityHint = hint;
        if (origin && !exist.origin) exist.origin = origin;
        return arr;
      }
      arr.unshift({ url: canon, title: '', reliabilityHint: hint||'', origin: origin||'manual' });
      return arr;
    }
    function mergeCreationSources(arr) {
      try {
        var seed = Array.isArray(window.creationSources) ? window.creationSources : (Array.isArray(window.__creationSources) ? window.__creationSources : []);
        seed.forEach(function(s){ if (s && s.url) { addToSaved(arr, s.url, s.reliabilityHint||'', 'q3'); } });
      } catch(_) {}
      return arr;
    }
    function saveSidebarSource(url, hint) {
      var arr = getSavedSourcesArray();
      addToSaved(arr, url, hint, 'manual');
      saveSavedSourcesArray(arr);
    }
    function buildSidebarSavedList() {
      var section = document.getElementById('sidebarSavedSection');
      var list = document.getElementById('sidebarSavedList');
      if (!section || !list) return;
      var arr = mergeCreationSources(getSavedSourcesArray());
      if (!arr || arr.length === 0) { section.style.display = 'none'; return; }
      section.style.display = 'block';
      var html = '';
      html += '<div style="display:flex; align-items:center; justify-content:space-between; margin: 0 0 6px 0;">';
      html += '  <span style="font-size: 12px; color:#72777d;">Saved for this article</span>';
      html += '  <button id="sidebarClearSaved" class="sidebar-action-btn" style="font-size:12px;">Clear</button>';
      html += '</div>';
      arr.slice(0, 10).forEach(function(s, idx){
        var url = s.url || '';
        var host = (function(u){ try { return new URL(u).host.replace(/^www\./,''); } catch(_) { return u; } })(url);
        var label = s.title && s.title.trim() ? s.title.trim() : host;
        var hint = (s.reliabilityHint||'').trim();
        var reliable = /Likely\s+reliable|Verified\s*source/i.test(hint);
        var origin = (s.origin||'').toString();
        html += '<div class="source-item" data-url="'+ (url.replace(/"/g,'&quot;')) +'" data-reliable="'+(reliable?'true':'false')+'" data-origin="'+origin+'" style="display:flex; align-items:center; justify-content:space-between; gap:8px; padding:8px 10px; border:1px solid #eaecf0; border-radius:6px; margin-bottom:6px;">';
        html += '  <div style="min-width:0;">';
        html += '    <div style="font-size:13px; font-weight:500; color:#202122; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">'+ label +'</div>';
        html += '    <div style="font-size:12px; color:#72777d; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">'+ host + (hint? ' · '+ hint : '') +'</div>';
        html += '  </div>';
        html += '  <div style="display:flex; gap:6px;">';
        html += '    <button class="sidebar-action-btn" data-action="use" style="white-space:nowrap;">Use</button>';
        html += '  </div>';
        html += '</div>';
      });
      list.innerHTML = html;
      // Bind click handlers
      // No row-click behavior; only Use triggers an action
      Array.from(list.querySelectorAll('button[data-action="use"]')).forEach(function(btn){
        btn.addEventListener('click', function(e){
          e.stopPropagation();
          var row = btn.closest('.source-item'); if (!row) return;
          var url = row.getAttribute('data-url')||'';
          var input = document.getElementById('sidebarSourceUrl');
          if (input){ input.value=url; input.focus(); }
          try { window.__sourceSelectedFromSaved = true; window.__sourceSelectedFromSavedReliable = (row.getAttribute('data-reliable')==='true') && (row.getAttribute('data-origin')==='q3'); } catch(_) {}
          // If Q3-likely reliable, show result with explicit action (no re-verification)
          if (window.__sourceSelectedFromSavedReliable) {
            var resultDiv = document.getElementById('sidebarSourceResult');
            var domain = extractDomain(url);
            var sourceType = classifySource(domain) || { reliable: true, label: 'Likely reliable', reliability: 'Likely reliable' };
            var resultHTML = '';
            resultHTML += '<div class="sidebar-source-badge reliable">✓ ' + (sourceType.label || 'Likely reliable') + '</div>';
            resultHTML += '<p style="font-size: 12px; color: #72777d; margin: 0 0 8px 0;">' + (sourceType.reliability || 'Likely reliable') + ' • verified in Step 3</p>';
            resultHTML += '<div style="margin-top:8px; display:flex; gap:8px;">'
              + '<button class="sidebar-action-btn primary" id="sidebarGenerateBtn">Create draft from source</button>'
              + '<button class="sidebar-action-btn" id="sidebarCancelBtn">Cancel</button>'
              + '</div>';
            resultDiv.innerHTML = resultHTML;
            resultDiv.style.display = 'block';
            var gbtn = document.getElementById('sidebarGenerateBtn');
            var cbtn = document.getElementById('sidebarCancelBtn');
            if (gbtn) gbtn.addEventListener('click', function(){ generateSidebarDraft(url); });
            if (cbtn) cbtn.addEventListener('click', function(){ resetSidebarSource(); });
          }
        });
      });
      // No clear/remove controls to keep UI simple
    }

    // Generate draft in sidebar
    function generateSidebarDraft(url) {
      var domain = extractDomain(url);
      var sourceType = getSourceTypeForTemplate(domain);
      
      var templates = reliableSourcesData ? reliableSourcesData.draft_templates : null;
      var template = templates && templates[sourceType] ? templates[sourceType] : templates.default;
      
      // Create mock draft content
      var title = generateMockTitle(domain);
      var today = new Date().toLocaleDateString('en-US', {year: 'numeric', month: 'long', day: 'numeric'});
      
      var draftContent = template.stub
        .replace('[SOURCE]', domain.charAt(0).toUpperCase() + domain.slice(1))
        .replace('[TITLE]', title)
        .replace('[DATE]', today)
        .replace('[TOPIC]', 'this subject')
        .replace('[FIELD]', 'relevant field');
        
      var citation = template.citation
        .replace('[AUTHOR]', 'Author Name')
        .replace('[TITLE]', title)
        .replace('[SOURCE]', domain.charAt(0).toUpperCase() + domain.slice(1))
        .replace('[DATE]', today)
        .replace('[TODAY]', today)
        .replace('[URL]', url);
      
      var fullDraft = '== DRAFT: Needs editing ==\n\n' + 
                     draftContent + '\n\n' +
                     '⚠️ This is a draft stub. Please expand with your own analysis and additional sources before publishing.\n\n' +
                     citation;
      
      var previewDiv = document.getElementById('sidebarDraftPreview');
      var previewHTML = '';
      previewHTML += '<div class="sidebar-draft-content">' + fullDraft + '</div>';
      previewHTML += '<div class="sidebar-action-buttons">';
      previewHTML += '<button class="sidebar-action-btn primary" id="sidebarInsertBtn">Insert into article</button>';
      previewHTML += '<button class="sidebar-action-btn" id="sidebarCancelBtn">Cancel</button>';
      previewHTML += '</div>';
      
      previewDiv.innerHTML = previewHTML;
      previewDiv.style.display = 'block';
      
      // Bind action buttons
      var insertBtn = document.getElementById('sidebarInsertBtn');
      var cancelBtn = document.getElementById('sidebarCancelBtn');
      
      if (insertBtn) {
        insertBtn.addEventListener('click', function() {
          insertSidebarDraft(fullDraft);
        });
      }
      
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
          resetSidebarSource();
        });
      }
    }

    // Insert draft from sidebar into editor
    function insertSidebarDraft(draftText) {
      var editor = document.getElementById('editor');
      
      if (editor) {
        var currentContent = editor.innerHTML;
        var hasContent = currentContent.trim() !== '';
        
        var domain = extractDomain(document.getElementById('sidebarSourceUrl').value);
        var sourceType = classifySource(domain);
        var sectionTitle = 'Section title';
        
        // Create realistic Wikipedia content with references
        var content = 'This is where the content from the verified source would appear in the article. ';
        content += 'The information extracted from ' + domain + ' provides additional context and details that support the main article topic.<sup style="color: #0645ad;">[1]</sup> ';
        content += 'Key facts and data points from the source can be integrated here to enhance the encyclopedic coverage. ';
        content += 'This demonstrates how external sources contribute to comprehensive article development.<sup style="color: #0645ad;">[2]</sup>';
        
        // Get citation from original draft
        var lines = draftText.split('\n');
        var citation = '';
        for (var i = 0; i < lines.length; i++) {
          var line = lines[i].trim();
          if (line.startsWith('[1]')) {
            citation = line;
            break;
          }
        }
        
        // Create Wikipedia-style section with proper formatting
        var sectionHTML = '';
        sectionHTML += '<h2 id="Section_title" style="';
        sectionHTML += 'font-family: Georgia, serif; ';
        sectionHTML += 'font-size: 1.5em; ';
        sectionHTML += 'font-weight: normal; ';
        sectionHTML += 'margin: ' + (hasContent ? '2em' : '1em') + ' 0 0.25em 0; ';
        sectionHTML += 'padding: 0; ';
        sectionHTML += 'border-bottom: 1px solid #eaecf0; ';
        sectionHTML += 'padding-bottom: 0.25em;';
        sectionHTML += '">' + sectionTitle + '</h2>';
        
        // Add content paragraph with proper styling
        sectionHTML += '<p style="margin: 0.75em 0; line-height: 1.6;">' + content + '</p>';
        
        // Removed source notice to keep inserted sections clean
        
        // Check if References section already exists
        var referencesExists = currentContent.includes('<h2') && currentContent.includes('id="References"');
        
        if (!referencesExists) {
          // Add References section with cleaner markup
          sectionHTML += '<div class="references">';
          sectionHTML += '<h2 id="References">References</h2>';
          sectionHTML += '<ol>';
          if (citation) {
            var item1 = citation.substring(4); // drop leading "[1] "
            sectionHTML += '<li>' + item1 + '</li>';
            sectionHTML += '<li>Additional sources to be added...</li>';
          } else {
            var fallback = '\"Context and Development\". ' + (domain.charAt(0).toUpperCase() + domain.slice(1)) + '. Retrieved ' + new Date().toLocaleDateString('en-US', {year: 'numeric', month: 'long', day: 'numeric'}) + '.';
            sectionHTML += '<li>' + fallback + '</li>';
            sectionHTML += '<li>Additional sources to be added...</li>';
          }
          sectionHTML += '</ol>';
          sectionHTML += '</div>';
        }
        
        if (hasContent) {
          editor.innerHTML = currentContent + sectionHTML;
        } else {
          editor.innerHTML = sectionHTML;
        }
        
        // Clean up any extra BR tags or empty elements
        cleanupExtraBreaks();
        
        // No source notice; nothing additional to attach here
        
        editor.focus();
      }
      
      // Reset source area
      resetSidebarSource();
    }

    // (source notice behavior removed)

    // Reset sidebar source verification
    function resetSidebarSource() {
      var sourceUrl = document.getElementById('sidebarSourceUrl');
      var stepsDiv = document.getElementById('sidebarVerificationSteps');
      var resultDiv = document.getElementById('sidebarSourceResult');
      var previewDiv = document.getElementById('sidebarDraftPreview');
      
      if (sourceUrl) sourceUrl.value = '';
      if (stepsDiv) stepsDiv.style.display = 'none';
      if (resultDiv) resultDiv.style.display = 'none';
      if (previewDiv) previewDiv.style.display = 'none';
    }

    // Open source verification modal
    function openSourceModalDialog() {
      var backdrop = document.getElementById('sourceModalBackdrop');
      var sourceUrl = document.getElementById('sourceUrl');
      var checkBtn = document.getElementById('checkSourceBtn');
      var generateBtn = document.getElementById('generateDraftBtn');
      var insertBtn = document.getElementById('insertDraftBtn');
      var stepsDiv = document.getElementById('verificationSteps');
      var resultDiv = document.getElementById('sourceResult');
      var previewDiv = document.getElementById('draftPreview');
      
      // Reset modal state
      if (sourceUrl) sourceUrl.value = '';
      if (checkBtn) checkBtn.style.display = 'inline-block';
      if (generateBtn) generateBtn.style.display = 'none';
      if (insertBtn) insertBtn.style.display = 'none';
      if (stepsDiv) stepsDiv.style.display = 'none';
      if (resultDiv) resultDiv.style.display = 'none';
      if (previewDiv) previewDiv.style.display = 'none';
      
      backdrop.classList.add('open');
      backdrop.setAttribute('aria-hidden', 'false');
      
      // Focus on URL input
      setTimeout(function() {
        if (sourceUrl) sourceUrl.focus();
      }, 100);
    }

    // Close source verification modal
    function closeSourceModalDialog() {
      var backdrop = document.getElementById('sourceModalBackdrop');
      backdrop.classList.remove('open');
      backdrop.setAttribute('aria-hidden', 'true');
    }

    // Initialize source modal event handlers
    function initializeSourceModal() {
      var closeBtn = document.getElementById('closeSourceModal');
      var backdrop = document.getElementById('sourceModalBackdrop');
      var checkBtn = document.getElementById('checkSourceBtn');
      var generateBtn = document.getElementById('generateDraftBtn');
      var insertBtn = document.getElementById('insertDraftBtn');
      
      // Close button
      if (closeBtn) {
        closeBtn.addEventListener('click', closeSourceModalDialog);
      }
      
      // Backdrop click to close
      if (backdrop) {
        backdrop.addEventListener('click', function(e) {
          if (e.target === backdrop) {
            closeSourceModalDialog();
          }
        });
      }
      
      // Escape key to close
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && backdrop && backdrop.classList.contains('open')) {
          closeSourceModalDialog();
        }
      });
      
      // Check source button
      if (checkBtn) {
        checkBtn.addEventListener('click', checkSource);
      }
      
      // Generate draft button
      if (generateBtn) {
        generateBtn.addEventListener('click', generateDraft);
      }
      
      // Insert draft button
      if (insertBtn) {
        insertBtn.addEventListener('click', insertDraft);
      }
    }

    // Initialize suggestions and sources on page load
    Promise.all([loadSuggestions(), loadReliableSources()]).then(function() {
      updateGuideContent();
      initializeSourceModal();
    });

  </script>
</body>
</html>
