<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Article Creator ‚Äî Reference Chip Concept</title>
  <link rel="stylesheet" href="https://unpkg.com/@wikimedia/codex@2.3.0/dist/codex.style.css">
  <link rel="stylesheet" href="https://unpkg.com/@wikimedia/codex-design-tokens@2.3.0/theme-wikimedia-ui.css">
  <link rel="stylesheet" href="reading-styles.css">
  <style>
    .creator-wrap { max-width: 1100px; margin: 0 auto; padding: 16px 20px; }
    .editor-shell { border: 1px solid var(--border-color-subtle, #eaecf0); border-radius: 4px; background: #fff; padding: 16px; }
    .title-input { width: 100%; font-size: 18px; padding: 8px 0; border: none; border-bottom: 2px solid #a2a9b1; }
    .title-input:focus { outline: none; border-bottom-color: #36c; }
    .chip-row { display: flex; gap: 8px; align-items: center; margin: 12px 0; flex-wrap: wrap; }
    .chip { display: inline-flex; align-items: center; gap: 6px; padding: 4px 8px; border: 1px solid #a2a9b1; border-radius: 12px; font-size: 12px; cursor: pointer; background: #f8f9fa; }
    .chip.reference { border-color: #36c; color: #36c; background: #eef3ff; }
    .editor { min-height: 260px; outline: none; }
    .editor[contenteditable="true"]:empty:before { content: attr(data-placeholder); color: #72777d; }
    .verify-note { display: none; margin-top: 8px; font-size: 12px; color: #856404; background: #fff3cd; border: 1px solid #ffeaa7; padding: 6px 8px; border-radius: 4px; }
    .verify-note.show { display: block; }
    .ref-dialog-backdrop { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.4); z-index: 3000; }
    .ref-dialog { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: #fff; border: 1px solid #eaecf0; border-radius: 8px; width: 520px; max-width: 92vw; padding: 16px; box-shadow: 0 8px 24px rgba(0,0,0,.2); }
    .ref-row { margin-bottom: 12px; }
    .ref-row label { display: block; font-size: 13px; margin-bottom: 6px; color: #202122; }
    .ref-row input { width: 100%; height: 34px; border: 1px solid #c8ccd1; border-radius: 4px; padding: 6px 10px; font: inherit; }
    .ref-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
    .badge { display:inline-block; font-size:10px; padding:2px 6px; border-radius:10px; border:1px solid #c8ccd1; color:#72777d; }
    .badge.good { color:#14866d; border-color:#14866d; }
    .badge.warn { color:#ac6600; border-color:#ac6600; }
  
    .chip.guidance { border-color: #c8ccd1; background: #fff; }
    .ac-steps { max-width: 1100px; margin: 0 auto; }
    .ac-step { display: none; border: 1px solid var(--border-color-subtle, #eaecf0); background: #fff; border-radius: 6px; padding: 16px; }
    .ac-step.active { display: block; }
    .ac-step h3 { margin: 0 0 12px 0; font-size: 1.1rem; }
    
    /* Center Step 1 in viewport */
    #step1.ac-step {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: none;
      background: transparent;
      box-shadow: none;
      max-width: 600px;
      width: 90%;
      z-index: 100;
    }
    
    /* Responsive positioning for mobile with keyboard */
    @media (max-height: 600px) {
      #step1.ac-step {
        position: fixed;
        top: 30%;
        transform: translate(-50%, -30%);
      }
    }
    
    @media (max-width: 768px) {
      #step1.ac-step {
        width: 95%;
        padding: 20px;
      }
      
      /* Adjust for mobile keyboard */
      @media (max-height: 500px) {
        #step1.ac-step {
          top: 20%;
          transform: translate(-50%, -20%);
        }
      }
    }
    
    /* Center Step 2 in viewport */
    #step2.ac-step {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: none;
      background: transparent;
      box-shadow: none;
      max-width: 700px;
      width: 90%;
      z-index: 100;
    }
    
    /* Responsive positioning for Step 2 */
    @media (max-width: 768px) {
      #step2.ac-step {
        width: 95%;
        padding: 20px;
        top: 45%;
        transform: translate(-50%, -45%);
      }
    }
    
    .ac-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 12px; }
    .ac-actions .btn { height: 34px; padding: 0 12px; border: 1px solid #c8ccd1; border-radius: 4px; background: #fff; cursor: pointer; }
    .ac-actions .btn.primary { background: #36c; color: #fff; border-color: #36c; }
    .category-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 8px; margin: 8px 0 4px; }
    .category-item { border: 1px solid #c8ccd1; border-radius: 4px; padding: 10px; cursor: pointer; background: #fff; }
    .category-item:hover { background: #f8f9fa; }
    .category-item.selected { border-color: #36c; box-shadow: 0 0 0 2px #eaf3ff; }
    .hint { font-size: 12px; color: #72777d; margin-top: 6px; }
    /* Hide the VE chrome by default - show when Step 3 is active */
    .ve-in-step3 #veHeader,
    .ve-in-step3 #veToolbar {
      display: block !important;
    }
    
    /* Mobile-only: Hide header and show footer instead */
    @media (max-width: 768px) {
      .ve-in-step3 #veHeader {
        display: none !important;
      }
      
      .ve-in-step3 #veFooter {
        display: block !important;
      }
      
      /* Footer styling - mobile only */
      .ve-footer {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: #fff;
        border-top: 1px solid var(--border-color-subtle, #eaecf0);
        padding: 8px 16px;
        font-size: 12px;
        color: var(--color-subtle, #54595d);
        z-index: 10;
      }
      
      .ve-footer .status {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 1100px;
        margin: 0 auto;
      }
    }
    
    /* Clean layout for Step 3 */
    .ve-in-step3 .creator-wrap {
      max-width: none;
      padding: 0;
    }
    
    .ve-in-step3 #step3 {
      border: none;
      background: transparent;
      padding: 0;
    }
    
    .ve-in-step3 #editor {
      border: none;
      background: transparent;
      min-height: 400px;
      padding: 16px 0;
    }
    
    /* Primary button styling for publish/submit buttons */
    .btn.primary {
      background: #36c !important;
      color: #fff !important;
      border-color: #36c !important;
    }
    
    .btn.primary:hover {
      background: #2a4b8d !important;
      border-color: #2a4b8d !important;
    }
    
    /* Guide Me Sidebar */
    .guide-sidebar {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100vh;
      background: #fff;
      border-left: 1px solid var(--border-color-subtle, #eaecf0);
      box-shadow: -2px 0 8px rgba(0,0,0,0.1);
      z-index: 1000;
      transition: right 0.3s ease;
      overflow-y: auto;
    }
    
    .guide-sidebar.open {
      right: 0;
    }
    
    .guide-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color-subtle, #eaecf0);
      background: #f8f9fa;
    }
    
    .guide-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #202122;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #72777d;
      padding: 4px;
      border-radius: 4px;
    }
    
    .close-btn:hover {
      background: #eaecf0;
      color: #202122;
    }
    
    .guide-content {
      padding: 20px;
    }
    
    .guide-section {
      margin-bottom: 24px;
    }
    
    .guide-section h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
      color: #202122;
    }
    
    .guide-section ul {
      margin: 0;
      padding-left: 20px;
      list-style-type: disc;
    }
    
    .guide-section li {
      margin-bottom: 8px;
      font-size: 13px;
      line-height: 1.4;
      color: #54595d;
    }
    
    .guide-section li strong {
      color: #202122;
    }
    
    /* Mobile responsive */
    @media (max-width: 768px) {
      .guide-sidebar {
        display: none; /* Hide sidebar on mobile, use modal instead */
      }
    }
    
    /* Guide Me Modal Drawer (Mobile) */
    .guide-modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 2000;
    }
    
    .guide-modal-backdrop.open {
      display: block;
    }
    
    .guide-modal-drawer {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #fff;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
      max-height: 70vh;
      overflow-y: auto;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }
    
    .guide-modal-backdrop.open .guide-modal-drawer {
      transform: translateY(0);
    }
    
    .guide-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-color-subtle, #eaecf0);
      background: #f8f9fa;
      border-top-left-radius: 12px;
      border-top-right-radius: 12px;
    }
    
    .guide-modal-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #202122;
    }
    
    .guide-modal-content {
      padding: 20px;
    }
    
    /* Section suggestion buttons */
    .section-button {
      display: block;
      width: 100%;
      margin-bottom: 12px;
      padding: 12px 14px;
      border: 1px solid #c8ccd1;
      border-radius: 4px;
      background: #fff;
      color: #202122;
      text-align: left;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .section-button:hover {
      background: #f8f9fa;
      border-color: #a2a9b1;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .section-button.added {
      background: #eaf3ff;
      border-color: #36c;
      color: #36c;
      cursor: default;
    }
    
    .section-button.added::after {
      content: " ‚úì";
      float: right;
    }
    
    .section-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      display: block;
    }
    
    .section-description {
      font-size: 12px;
      color: #72777d;
      line-height: 1.3;
      display: block;
      margin-bottom: 6px;
    }
    
    /* Example dropdown */
    .examples-dropdown {
      position: relative;
      display: inline-block;
      width: 100%;
      margin-top: 4px;
    }
    
    .examples-toggle {
      background: #f8f9fa;
      border: 1px solid #c8ccd1;
      border-radius: 3px;
      padding: 4px 8px;
      font-size: 11px;
      color: #36c;
      cursor: pointer;
      text-decoration: none;
      display: inline-block;
    }
    
    .examples-toggle:hover {
      background: #eaecf0;
    }
    
    .examples-content {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: #fff;
      border: 1px solid #c8ccd1;
      border-radius: 3px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      z-index: 1000;
      padding: 8px;
      margin-top: 2px;
    }
    
    .examples-dropdown.open .examples-content {
      display: block;
    }
    
    .example-item {
      font-size: 11px;
      color: #54595d;
      margin-bottom: 4px;
      padding: 3px 0;
      border-bottom: 1px solid #eaecf0;
      font-style: italic;
    }
    
    .example-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }
    
    /* Mobile responsive dropdown */
    @media (max-width: 768px) {
      .examples-content {
        position: fixed;
        top: auto;
        bottom: 0;
        left: 0;
        right: 0;
        border-radius: 12px 12px 0 0;
        max-height: 50vh;
        overflow-y: auto;
      }
    }
    
    /* Source button styling */
    .source-button {
      display: flex;
      align-items: center;
      width: 100%;
      padding: 12px 14px;
      border: 1px solid #c8ccd1;
      border-radius: 4px;
      background: #f8f9fa;
      color: #202122;
      cursor: pointer;
      transition: all 0.2s ease;
      gap: 10px;
    }
    
    .source-button:hover {
      background: #eaecf0;
      border-color: #a2a9b1;
    }
    
    .source-button-icon {
      font-size: 16px;
    }
    
    .source-button-text {
      font-size: 13px;
      font-weight: 500;
    }
    
    /* Source modal styling */
    .source-modal-backdrop {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      z-index: 3000;
    }
    
    .source-modal-backdrop[aria-hidden="false"] {
      display: block;
    }
    
    .source-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #eaecf0;
      border-radius: 8px;
      width: 600px;
      max-width: 92vw;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
    }
    
    .source-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 20px;
      border-bottom: 1px solid #eaecf0;
      background: #f8f9fa;
    }
    
    .source-modal-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 600;
      color: #202122;
    }
    
    .source-modal-content {
      padding: 20px;
    }
    
    .source-input-section label {
      display: block;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
      color: #202122;
    }
    
    .source-input-section input {
      width: 100%;
      height: 36px;
      border: 1px solid #c8ccd1;
      border-radius: 4px;
      padding: 8px 12px;
      font: inherit;
      margin-bottom: 12px;
    }
    
    .source-note {
      font-size: 12px;
      color: #ac6600;
      background: #fef6e7;
      border: 1px solid #fc3;
      border-radius: 4px;
      padding: 8px 12px;
      margin-bottom: 20px;
    }
    
    .source-verification h4,
    .draft-preview h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
      color: #202122;
    }
    
    .verification-step {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
      font-size: 13px;
    }
    
    .step-icon {
      font-size: 14px;
      width: 16px;
    }
    
    .verification-step.completed .step-icon {
      color: #14866d;
    }
    
    .verification-step.completed .step-text {
      color: #14866d;
    }
    
    .source-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .source-badge.reliable {
      background: #d5fdf4;
      color: #14866d;
      border: 1px solid #14866d;
    }
    
    .source-badge.questionable {
      background: #fef6e7;
      color: #ac6600;
      border: 1px solid #fc3;
    }
    
    .reliability-note {
      font-size: 12px;
      color: #54595d;
    }
    
    .draft-warning {
      background: #fef6e7;
      border: 1px solid #fc3;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 12px;
      color: #ac6600;
      margin-bottom: 16px;
      font-weight: 600;
    }
    
    .draft-content {
      background: #f8f9fa;
      border: 1px solid #eaecf0;
      border-radius: 4px;
      padding: 16px;
      font-family: Georgia, serif;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    
    .source-modal-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      padding: 16px 20px;
      border-top: 1px solid #eaecf0;
      background: #f8f9fa;
    }
    
    .guide-note {
      font-size: 12px;
      color: #72777d;
      margin: 12px 0 16px 0;
      font-style: italic;
    }
    
    /* Sidebar source verification styles */
    .source-input-group {
      display: flex;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .source-url-input {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #a2a9b1;
      border-radius: 2px;
      font-size: 13px;
      font-family: inherit;
    }
    
    .source-url-input:focus {
      border-color: #36c;
      outline: none;
      box-shadow: inset 0 0 0 1px #36c;
    }
    
    .source-check-btn {
      padding: 8px 16px;
      background: #36c;
      color: white;
      border: 1px solid #36c;
      border-radius: 2px;
      font-size: 13px;
      cursor: pointer;
      white-space: nowrap;
    }
    
    .source-check-btn:hover {
      background: #2a4b8d;
      border-color: #2a4b8d;
    }
    
    .source-check-btn:disabled {
      background: #a2a9b1;
      border-color: #a2a9b1;
      cursor: not-allowed;
    }
    
    .source-warning {
      font-size: 12px;
      line-height: 1.4;
    }
    
    .sidebar-verification-step {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 0;
      font-size: 13px;
    }
    
    .sidebar-step-icon {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #eaecf0;
      color: #72777d;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      flex-shrink: 0;
    }
    
    .sidebar-step-icon.active {
      background: #36c;
      color: white;
    }
    
    .sidebar-step-icon.completed {
      background: #00af89;
      color: white;
    }
    
    .sidebar-source-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 2px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .sidebar-source-badge.reliable {
      background: #d5fdf4;
      color: #00af89;
      border: 1px solid #00af89;
    }
    
    .sidebar-source-badge.questionable {
      background: #fef6e7;
      color: #ac6600;
      border: 1px solid #fc3;
    }
    
    .sidebar-draft-content {
      background: #f8f9fa;
      border: 1px solid #eaecf0;
      border-radius: 2px;
      padding: 12px;
      font-size: 12px;
      line-height: 1.5;
      white-space: pre-wrap;
      margin-bottom: 12px;
      max-height: 200px;
      overflow-y: auto;
    }
    
    .sidebar-action-buttons {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }
    
    .sidebar-action-btn {
      padding: 6px 12px;
      border: 1px solid #a2a9b1;
      border-radius: 2px;
      background: white;
      color: #202122;
      font-size: 12px;
      cursor: pointer;
    }
    
    .sidebar-action-btn.primary {
      background: #36c;
      color: white;
      border-color: #36c;
    }
    
    .sidebar-action-btn:hover {
      background: #f8f9fa;
    }
    
    .sidebar-action-btn.primary:hover {
      background: #2a4b8d;
      border-color: #2a4b8d;
    }
    
    /* Hide modal on desktop */
    @media (min-width: 769px) {
      .guide-modal-backdrop {
        display: none !important;
      }
    }
  </style>
</head>
<body>

  <!-- Wikipedia-style header (hidden by default, shown in Step 3) -->
  <header class="container page-header" id="veHeader" role="banner" style="display: none;">
    <h1 class="firstHeading" id="veTitle">New Article</h1>
    <div class="page-tabs-wrapper">
      <nav class="ns-tabs" aria-label="Namespace tabs">
        <button class="ns-tab active">Article</button>
        <button class="ns-tab">Talk</button>
      </nav>
      <nav class="page-actions" aria-label="Page actions">
        <button class="action-tab">
          <span class="action-tab-text">Read</span>
          <span class="action-tab-icon cdx-icon" data-icon="cdxIconArticle"></span>
        </button>
        <button class="action-tab active">
          <span class="action-tab-text">Edit</span>
          <span class="action-tab-icon cdx-icon" data-icon="cdxIconEdit"></span>
        </button>
        <button class="action-tab">
          <span class="action-tab-text">View history</span>
          <span class="action-tab-icon cdx-icon" data-icon="cdxIconHistory"></span>
        </button>
        <button class="action-tab star">
          <span class="action-tab-text">‚≠ê</span>
          <span class="action-tab-icon cdx-icon" data-icon="cdxIconStar"></span>
        </button>
      </nav>
    </div>
  </header>

  <!-- VE toolbar (hidden by default, shown in Step 3) -->
  <div class="ve-strip" id="veToolbar" role="region" aria-label="Editing toolbar" style="display: none;">
    <div class="ve-bar">
      <!-- Mobile toolbar -->
      <div class="mobile-toolbar">
        <button class="btn" id="close" title="Close"><span class="cdx-icon" data-icon="cdxIconClose"></span></button>
        <button class="btn" id="undo" title="Undo"><span class="cdx-icon" data-icon="cdxIconUndo"></span></button>
        <div class="dropdown" id="dd-style-mobile">
          <span class="cdx-icon" data-icon="cdxIconTextStyle"></span>
          <span class="caret" aria-hidden="true"></span>
          <div class="menu" id="menu-style-mobile">
            <button data-style="bold">Bold</button>
            <button data-style="italic">Italic</button>
            <button data-style="underline">Underline</button>
            <button data-style="strike">Strikethrough</button>
            <button data-style="clean">Clear styling</button>
          </div>
        </div>
        <button class="btn" id="quote" title="Quote"><span class="cdx-icon" data-icon="cdxIconQuotes"></span></button>
        <button class="btn" id="btn-link-mobile" title="Add link"><span class="cdx-icon" data-icon="cdxIconLink"></span></button>
        <button class="btn" id="guideMeMobile" title="Get writing suggestions"><span style="font-size: 16px; filter: brightness(0.7);">‚ú®</span></button>
        <button class="btn submit-btn" id="submit" title="Submit" style="margin-left: auto;"><span class="cdx-icon" data-icon="cdxIconNext"></span></button>
      </div>

      <!-- Desktop toolbar -->
      <div class="desktop-toolbar">
        <div class="group tight">
          <button class="btn" id="undo-desktop" title="Undo"><span class="cdx-icon" data-icon="cdxIconUndo"></span></button>
          <button class="btn" id="redo" title="Redo"><span class="cdx-icon" data-icon="cdxIconRedo"></span></button>
        </div>
        <div class="group">
          <div class="dropdown" id="dd-paragraph">
            <span class="cdx-icon" data-icon="cdxIconTextHeading"></span>
            <span class="cdx-button__label">Paragraph</span>
            <span class="caret" aria-hidden="true"></span>
            <div class="menu" id="menu-paragraph">
              <button data-header="">Paragraph</button>
              <button data-header="1">Heading 1</button>
              <button data-header="2">Heading 2</button>
              <button data-header="3">Heading 3</button>
              <button data-header="4">Heading 4</button>
              <button data-header="5">Heading 5</button>
              <button data-header="6">Heading 6</button>
              <button data-header="code">Preformatted</button>
            </div>
          </div>
        </div>
        <div class="group">
          <div class="dropdown" id="dd-style">
            <span class="cdx-icon" data-icon="cdxIconTextStyle"></span>
            <span class="cdx-button__label">A</span>
            <span class="caret" aria-hidden="true"></span>
            <div class="menu" id="menu-style">
              <button data-style="bold">Bold</button>
              <button data-style="italic">Italic</button>
              <button data-style="underline">Underline</button>
              <button data-style="strike">Strikethrough</button>
              <button data-style="clean">Clear styling</button>
            </div>
          </div>
        </div>
        <div class="group tight">
          <button class="btn" data-cmd="ol" title="Numbered list"><span class="cdx-icon" data-icon="cdxIconListNumbered"></span></button>
          <button class="btn" data-cmd="ul" title="Bullet list"><span class="cdx-icon" data-icon="cdxIconListBullet"></span></button>
        </div>
        <div class="group">
          <button class="btn" id="btn-link" title="Add link">
            <span class="cdx-icon" data-icon="cdxIconLink"></span>
            <span class="cdx-button__label">Link</span>
          </button>
          <div class="dropdown" id="dd-cite">
            <span class="cdx-icon" data-icon="cdxIconReference"></span>
            <span class="cdx-button__label">Cite</span>
            <span class="caret"></span>
            <div class="menu" id="menu-cite">
              <button data-cite="web">Cite web‚Ä¶ (mock)</button>
              <button data-cite="book">Cite book‚Ä¶ (mock)</button>
              <button data-cite="news">Cite news‚Ä¶ (mock)</button>
            </div>
          </div>
          <div class="dropdown" id="dd-insert">
            <span class="cdx-icon" data-icon="cdxIconAdd"></span>
            <span class="cdx-button__label">Insert</span>
            <span class="caret"></span>
            <div class="menu" id="menu-insert">
              <button data-insert="image">Media‚Ä¶</button>
              <button data-insert="template">Template‚Ä¶ (mock)</button>
              <button data-insert="math">Math‚Ä¶ (mock)</button>
              <button data-insert="table">Table‚Ä¶ (mock)</button>
              <button data-insert="char">Special character‚Ä¶</button>
            </div>
          </div>
        </div>
        <div class="group tight">
          <button class="btn" id="addSectionBtn" title="Get writing suggestions"><span style="font-size: 16px; filter: brightness(0.7); margin-right: 6px;">‚ú®</span><span class="cdx-button__label">Guide me</span></button>
          <button class="btn" disabled title="Page options"><span class="cdx-icon" data-icon="cdxIconSettings"></span></button>
          <button class="btn" title="Help"><span class="cdx-icon" data-icon="cdxIconHelp"></span></button>
        </div>
        <div class="group" style="margin-left:auto;border-left:none;padding-right:0">
          <button class="btn publish-btn" id="publish" disabled>Publish</button>
        </div>
      </div>
    </div>
  </div>

  <main class="ve-content-wrap">
    <div class="surface">
      <div class="creator-wrap">
        <div class="ac-steps">
          <section class="ac-step active" id="step1">
            <h3>What article would you like to create?</h3>
            <input id="title" class="title-input" placeholder="e.g., Jane Doe / Example Software" aria-label="Proposed title">
            <div class="ac-actions">
              <button class="btn primary" id="toStep2" disabled>Continue</button>
            </div>
          </section>
          <section class="ac-step" id="step2">
            <h3>Assign a topic category</h3>
            <div class="category-list" id="categoryList">
              <div class="category-item" data-cat="person">Person / Biography</div>
              <div class="category-item" data-cat="place">Geographic Location</div>
              <div class="category-item" data-cat="species">Species / Biology</div>
              <div class="category-item" data-cat="organization">Organization</div>
              <div class="category-item" data-cat="academic">Academic / Concept</div>
              <div class="category-item" data-cat="creative">Creative Work</div>
              <div class="category-item" data-cat="event">Event</div>
            </div>
            <div class="hint">This helps us suggest the right structure and policies.</div>
            <div class="ac-actions">
              <button class="btn" id="backTo1">Back</button>
              <button class="btn primary" id="toStep3" disabled>Start editing</button>
            </div>
          </section>
          <section class="ac-step" id="step3">
            <div id="editor" class="editor" contenteditable="true" data-placeholder="Type the lead..."></div>
          </section>
        </div>
      </div>
      
    </div>
  </main>

  <!-- Guide Me Sidebar -->
  <div class="guide-sidebar" id="guideSidebar">
    <div class="guide-header">
      <h3>Writing guidance</h3>
      <button class="close-btn" id="closeSidebar" title="Close">√ó</button>
    </div>
    <div class="guide-content" id="guideContent">
      <!-- Content will be dynamically loaded here -->
    </div>
  </div>

  <!-- Guide Me Modal Drawer (Mobile) -->
  <div class="guide-modal-backdrop" id="guideModalBackdrop">
    <div class="guide-modal-drawer" id="guideModalDrawer">
      <div class="guide-modal-header">
        <h3>Writing guidance</h3>
        <button class="close-btn" id="closeModalDrawer" title="Close">√ó</button>
      </div>
      <div class="guide-modal-content" id="guideModalContent">
        <!-- Content will be dynamically loaded here -->
      </div>
    </div>
  </div>

  <!-- Footer status (shown only in Step 3) -->
  <footer class="ve-footer" id="veFooter" style="display: none;">
    <div class="status"><span>Changes are preview‚Äëonly in this demo.</span><span class="badge">Visual Editor</span></div>
  </footer>

  <!-- Source verification modal -->
  <div class="source-modal-backdrop" id="sourceModalBackdrop" aria-hidden="true">
    <div class="source-modal" role="dialog" aria-modal="true" aria-labelledby="sourceModalTitle">
      <div class="source-modal-header">
        <h3 id="sourceModalTitle">Add content from a reliable source</h3>
        <button class="close-btn" id="closeSourceModal" title="Close">√ó</button>
      </div>
      <div class="source-modal-content">
        <div class="source-input-section">
          <label for="sourceUrl">Source URL</label>
          <input type="url" id="sourceUrl" placeholder="https://example.com/article" />
          <div class="source-note">
            ‚ö†Ô∏è Note: This creates a DRAFT based on source metadata.<br>
            Always review and edit before publishing.
          </div>
        </div>
        
        <div class="source-verification" id="sourceVerification" style="display: none;">
          <h4>Source verification</h4>
          <div class="verification-steps" id="verificationSteps">
            <div class="verification-step" id="step1">
              <span class="step-icon">‚è≥</span>
              <span class="step-text">Checking domain...</span>
            </div>
            <div class="verification-step" id="step2">
              <span class="step-icon">‚è≥</span>
              <span class="step-text">Verifying reliability...</span>
            </div>
            <div class="verification-step" id="step3">
              <span class="step-icon">‚è≥</span>
              <span class="step-text">Checking HTTPS security...</span>
            </div>
          </div>
          <div class="source-result" id="sourceResult" style="display: none;">
            <div class="source-badge" id="sourceBadge"></div>
            <div class="reliability-note" id="reliabilityNote"></div>
          </div>
        </div>
        
        <div class="draft-preview" id="draftPreview" style="display: none;">
          <h4>Draft content preview</h4>
          <div class="draft-warning">
            ‚ö†Ô∏è DRAFT: This content requires human review and editing
          </div>
          <div class="draft-content" id="draftContent"></div>
        </div>
      </div>
      <div class="source-modal-actions">
        <button class="btn" id="cancelSource">Cancel</button>
        <button class="btn" id="checkSourceBtn">Check source</button>
        <button class="btn primary" id="generateDraftBtn" style="display: none;">Create draft from source</button>
        <button class="btn primary" id="insertDraftBtn" style="display: none;">Insert as draft</button>
      </div>
    </div>
  </div>

  <div class="ref-dialog-backdrop" id="refBackdrop" aria-hidden="true">
    <div class="ref-dialog" role="dialog" aria-modal="true" aria-labelledby="refTitle">
      <div class="ref-row"><strong id="refTitle">Add reference</strong> <span id="refHint" class="badge">unclassified</span></div>
      <div class="ref-row"><label for="refUrl">Source URL</label><input id="refUrl" type="url" placeholder="https://example.com/article"></div>
      <div class="ref-row"><label for="refTitleInput">Title (optional)</label><input id="refTitleInput" type="text" placeholder="Article title"></div>
      <div class="ref-actions">
        <button class="btn" id="refCancel">Cancel</button>
        <button class="btn primary" id="refInsert">Insert cite</button>
      </div>
    </div>
  </div>

  <script>
    // === Codex Icons via MW API ===
    async function loadCodexIcons(iconNames) {
      const url = 'https://www.mediawiki.org/w/api.php?action=query&list=codexicons&format=json&origin=*' +
        '&names=' + encodeURIComponent(iconNames.join('|'));
      const res = await fetch(url);
      const data = await res.json();
      const out = {};
      const map = data?.query?.codexicons || {};
      
      for (const k of Object.keys(map)) {
        const entry = map[k];
        const path = typeof entry === 'string' ? entry : (entry.ltr || entry.default || Object.values(entry.langCodeMap || {})[0] || '');
        out[k] = path;
      }
      return out;
    }

    // Apply icons on load
    (function applyIcons() {
      const nodes = Array.from(document.querySelectorAll('.cdx-icon[data-icon]'));
      const names = Array.from(new Set(nodes.map(n => n.getAttribute('data-icon'))));
      
      loadCodexIcons(names).then(paths => {
        nodes.forEach(n => {
          const name = n.getAttribute('data-icon');
          const p = paths[name];
          if (p) {
            n.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">' + p + '</svg>';
          }
        });
      }).catch(console.error);
    })();
    // Steps
    var titleInput=document.getElementById('title');
    var toStep2=document.getElementById('toStep2');
    var toStep3=document.getElementById('toStep3');
    var backTo1=document.getElementById('backTo1');
    var step1=document.getElementById('step1');
    var step2=document.getElementById('step2');
    var step3=document.getElementById('step3');
    var categoryList=document.getElementById('categoryList');
    var selectedCat=null;

    titleInput.addEventListener('input', function(){ toStep2.disabled = !(titleInput.value.trim().length>0); });
    toStep2.onclick=function(){ 
      step1.classList.remove('active'); 
      step2.classList.add('active'); 
      
      // Update Step 2 title with the entered topic
      var step2Title = step2.querySelector('h3');
      var userTopic = titleInput.value.trim();
      if (step2Title && userTopic) {
        step2Title.textContent = 'What is "' + userTopic + '"?';
      }
    };
    backTo1 && (backTo1.onclick=function(){ step2.classList.remove('active'); step1.classList.add('active'); });
    categoryList && categoryList.addEventListener('click', function(e){
      var item=e.target.closest('.category-item'); if(!item) return;
      Array.from(categoryList.querySelectorAll('.category-item')).forEach(function(n){n.classList.remove('selected');});
      item.classList.add('selected'); selectedCat=item.getAttribute('data-cat'); toStep3.disabled=false;
      
      // Update guide content when category changes
      setTimeout(updateGuideContent, 100);
    });
    toStep3 && (toStep3.onclick=function(){
      step2.classList.remove('active');
      step3.classList.add('active');
      
      // Activate VE interface
      document.body.classList.add('ve-in-step3');
      
      var ed = document.getElementById('editor');
      var t = titleInput.value.trim();
      var safeTitle = (t || 'Untitled').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      
      // Update VE header title
      var veTitle = document.getElementById('veTitle');
      if (veTitle) veTitle.textContent = safeTitle;
      
      // Initialize editor with just placeholder and cursor
      ed.innerHTML = '';
      ed.setAttribute('data-placeholder', 'Start writing about ' + safeTitle + '...');
      
      // Focus editor to show blinking cursor
      ed.focus();
      
      // Add input listener to activate publish/submit buttons when user starts typing
      ed.addEventListener('input', function() {
        var publishBtn = document.getElementById('publish');
        var submitBtn = document.getElementById('submit');
        
        if (ed.textContent.trim().length > 0) {
          // Desktop publish button
          if (publishBtn) {
            publishBtn.disabled = false;
            publishBtn.classList.add('primary');
            publishBtn.textContent = 'Publish changes';
          }
          
          // Mobile submit button  
          if (submitBtn) {
            submitBtn.classList.add('primary');
            submitBtn.style.background = '#36c';
            submitBtn.style.color = '#fff';
            submitBtn.style.borderColor = '#36c';
            // Make the icon white too
            var icon = submitBtn.querySelector('.cdx-icon svg');
            if (icon) icon.style.color = '#fff';
          }
        } else {
          // Reset buttons when content is empty
          if (publishBtn) {
            publishBtn.disabled = true;
            publishBtn.classList.remove('primary');
            publishBtn.textContent = 'Publish';
          }
          
          if (submitBtn) {
            submitBtn.classList.remove('primary');
            submitBtn.style.background = '';
            submitBtn.style.color = '';
            submitBtn.style.borderColor = '';
            // Reset icon color too
            var icon = submitBtn.querySelector('.cdx-icon svg');
            if (icon) icon.style.color = '';
          }
        }
      });
    });

    // Reference dialog
    var openBtn=null;
    var backdrop=document.getElementById('refBackdrop');
    var cancelBtn=document.getElementById('refCancel');
    var insertBtn=document.getElementById('refInsert');
    var urlInput=document.getElementById('refUrl');
    var hint=document.getElementById('refHint');
    var editor=document.getElementById('editor');
    var verify=document.getElementById('verify');
    var refBadges=document.getElementById('refBadges');
    function classify(url){ try{ var h=new URL(url).hostname; if(/\.(gov|gov\.[a-z]{2})$/i.test(h)) return {label:'gov',cls:'good'}; if(/\.(edu|ac\.[a-z]{2})$/i.test(h)) return {label:'edu',cls:'good'}; if(/(reuters|apnews|bbc|nytimes|guardian|bloomberg|washingtonpost|ft\.com)/i.test(h)) return {label:'news',cls:'good'}; if(/(prnewswire|businesswire|globenewswire|newswire|press)/i.test(h)) return {label:'press release',cls:'warn'}; return {label:'unclassified',cls:''}; }catch(e){ return {label:'unclassified',cls:''}; } }
    function openDialog(){ backdrop.style.display='block'; urlInput.focus(); }
    function closeDialog(){ backdrop.style.display='none'; }
    function bindRef(){ openBtn=document.getElementById("openRef"); if(openBtn){ openBtn.onclick=openDialog; }} bindRef(); cancelBtn.onclick=closeDialog; backdrop.addEventListener('click',function(e){ if(e.target===backdrop) closeDialog(); });
    urlInput.addEventListener('input',function(){ var c=classify(urlInput.value.trim()); hint.textContent=c.label; hint.className='badge '+(c.cls||''); });
    insertBtn.onclick=function(){ var url=urlInput.value.trim(); if(!url) return; if(document.activeElement!==editor) editor.focus(); document.execCommand('insertText', false, ' [1]'); var c=classify(url); refBadges.innerHTML='<span class="badge '+(c.cls||'')+'">'+c.label+'</span>'; closeDialog(); };

    // Guide Me functionality - Desktop Sidebar & Mobile Modal
    var guideSidebar = document.getElementById('guideSidebar');
    var guideModalBackdrop = document.getElementById('guideModalBackdrop');
    var addSectionBtn = document.getElementById('addSectionBtn');
    var guideMeMobileBtn = document.getElementById('guideMeMobile');
    var closeSidebarBtn = document.getElementById('closeSidebar');
    var closeModalBtn = document.getElementById('closeModalDrawer');
    var guideContent = document.getElementById('guideContent');
    var guideModalContent = document.getElementById('guideModalContent');
    var addedSections = [];
    var suggestionsData = null;

    // Function to check if we're on mobile
    function isMobile() {
      return window.innerWidth <= 768;
    }

    // Load suggestions data
    async function loadSuggestions() {
      try {
        const response = await fetch('article-creation-suggestions.json');
        suggestionsData = await response.json();
      } catch (error) {
        console.error('Failed to load suggestions:', error);
        suggestionsData = null;
      }
    }

    // Generate guide content based on selected category
    function generateGuideContent() {
      if (!selectedCat || !suggestionsData || !suggestionsData[selectedCat]) {
        return getDefaultGuideContent();
      }

      const categoryData = suggestionsData[selectedCat];
      let content = '<div class="guide-section">';
      content += '<h4>üìù Suggested sections</h4>';
      content += '<p class="guide-note">' + categoryData.note + '</p>';
      
      // Show all sections (only 3, no References)
      categoryData.sections.forEach(function(section, index) {
        const sectionName = typeof section === 'string' ? section : section.name;
        const sectionDesc = typeof section === 'string' ? '' : section.description;
        const sectionExamples = typeof section === 'string' ? [] : (section.examples || []);
        const isAdded = addedSections.indexOf(sectionName) !== -1;
        const className = isAdded ? 'section-button added' : 'section-button';
        
        content += '<button class="' + className + '" data-section="' + sectionName + '">';
        content += '<span class="section-name">' + sectionName + '</span>';
        if (sectionDesc) {
          content += '<span class="section-description">' + sectionDesc + '</span>';
        }
        
        // Add examples dropdown if examples exist
        if (sectionExamples.length > 0) {
          content += '<div class="examples-dropdown" data-section="' + sectionName + '">';
          content += '<span class="examples-toggle">See examples ‚Üì</span>';
          content += '<div class="examples-content">';
          sectionExamples.forEach(function(example) {
            content += '<div class="example-item">' + example + '</div>';
          });
          content += '</div>';
          content += '</div>';
        }
        
        content += '</button>';
      });

      content += '</div>';
      
      // Add source tool section
      content += '<div class="guide-section" style="margin-top: 24px; padding-top: 20px; border-top: 1px solid #eaecf0;">';
      content += '<h4>üì∞ Add from source</h4>';
      content += '<p class="guide-note">Helper for citing reliable sources</p>';
      content += '<div id="sourceVerificationArea">';
      content += '<div class="source-input-group">';
      content += '<input type="url" id="sidebarSourceUrl" placeholder="Enter source URL (e.g., bbc.com/article)" class="source-url-input">';
      content += '<button class="source-check-btn" id="sidebarCheckBtn">Check source</button>';
      content += '</div>';
      content += '<div class="source-warning" style="margin-top: 8px; padding: 8px; background: #fef6e7; border: 1px solid #fc3; border-radius: 2px; font-size: 12px; color: #ac6600;">';
      content += '‚ö†Ô∏è This creates a DRAFT based on source metadata. Always review and edit before publishing.';
      content += '</div>';
      content += '<div id="sidebarVerificationSteps" style="display: none; margin-top: 12px;"></div>';
      content += '<div id="sidebarSourceResult" style="display: none; margin-top: 12px;"></div>';
      content += '<div id="sidebarDraftPreview" style="display: none; margin-top: 12px;"></div>';
      content += '</div>';
      content += '</div>';
      
      return content;
    }

    // Default content when no category is selected
    function getDefaultGuideContent() {
      return '<div class="guide-section">' +
        '<h4>‚ú® Getting started</h4>' +
        '<ul>' +
        '<li>Start with a clear opening sentence that defines your topic</li>' +
        '<li>Include key facts in the first paragraph</li>' +
        '<li>Use reliable sources throughout</li>' +
        '</ul>' +
        '<p class="guide-note">Select a category in Step 2 to see specific section suggestions for your article type.</p>' +
        '</div>';
    }

    // Update guide content in both sidebar and modal
    function updateGuideContent() {
      const content = generateGuideContent();
      if (guideContent) guideContent.innerHTML = content;
      if (guideModalContent) guideModalContent.innerHTML = content;
      
      // Add click handlers to section buttons
      bindSectionButtons();
      
      // Bind source button
      bindSourceButton();
    }

    // Add section to editor
    function addSectionToEditor(sectionName) {
      if (addedSections.indexOf(sectionName) !== -1) return; // Already added
      
      var editor = document.getElementById('editor');
      if (!editor) return;

      // Add section to tracking
      addedSections.push(sectionName);

      // Create Wikipedia-style heading with proper styling
      var currentContent = editor.innerHTML;
      var hasContent = currentContent.trim() !== '';
      
      // Create section with Wikipedia-style formatting (no extra breaks)
      var sectionHTML = '';
      sectionHTML += '<h2 id="' + sectionName.replace(/\s+/g, '_') + '" style="';
      sectionHTML += 'font-family: Georgia, serif; ';
      sectionHTML += 'font-size: 1.5em; ';
      sectionHTML += 'font-weight: normal; ';
      sectionHTML += 'margin: ' + (hasContent ? '2em' : '1em') + ' 0 0.25em 0; '; // More top margin if content exists
      sectionHTML += 'padding: 0; ';
      sectionHTML += 'border-bottom: 1px solid #eaecf0; '; // Lighter gray separator
      sectionHTML += 'padding-bottom: 0.25em;';
      sectionHTML += '">' + sectionName + '</h2>';
      sectionHTML += '<p style="margin: 0.75em 0; line-height: 1.6; color: #72777d;" data-placeholder="Start writing about ' + sectionName.toLowerCase() + '...">&nbsp;</p>'; // Placeholder text
      
      if (hasContent) {
        editor.innerHTML = currentContent + sectionHTML;
      } else {
        editor.innerHTML = sectionHTML;
      }

      // Position cursor in the new paragraph with blinking cursor
      editor.focus();
      var range = document.createRange();
      var sel = window.getSelection();
      var paragraphs = editor.querySelectorAll('p');
      var lastP = paragraphs[paragraphs.length - 1];
      
      if (lastP) {
        // Clear the non-breaking space, show placeholder, and position cursor
        lastP.innerHTML = '';
        lastP.setAttribute('data-placeholder', 'Start writing about ' + sectionName.toLowerCase() + '...');
        
        // Add CSS for placeholder if not already present
        if (!document.getElementById('placeholder-style')) {
          var style = document.createElement('style');
          style.id = 'placeholder-style';
          style.textContent = 'p[data-placeholder]:empty:before { content: attr(data-placeholder); color: #a2a9b1; font-style: italic; }';
          document.head.appendChild(style);
        }
        
        range.setStart(lastP, 0);
        range.collapse(true);
        sel.removeAllRanges();
        sel.addRange(range);
      }

      // Update content to show new state
      updateGuideContent();
    }

    // Bind click handlers to section buttons and dropdowns
    function bindSectionButtons() {
      var buttons = document.querySelectorAll('.section-button:not(.added)');
      buttons.forEach(function(button) {
        button.addEventListener('click', function(e) {
          // Don't add section if clicking on dropdown
          if (e.target.closest('.examples-dropdown')) {
            e.stopPropagation();
            return;
          }
          var sectionName = this.getAttribute('data-section');
          addSectionToEditor(sectionName);
        });
      });
      
      // Bind dropdown toggles
      var toggles = document.querySelectorAll('.examples-toggle');
      toggles.forEach(function(toggle) {
        toggle.addEventListener('click', function(e) {
          e.stopPropagation();
          var dropdown = this.closest('.examples-dropdown');
          
          // Close other dropdowns
          document.querySelectorAll('.examples-dropdown.open').forEach(function(openDropdown) {
            if (openDropdown !== dropdown) {
              openDropdown.classList.remove('open');
            }
          });
          
          // Toggle current dropdown
          dropdown.classList.toggle('open');
        });
      });
      
      // Close dropdowns when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.examples-dropdown')) {
          document.querySelectorAll('.examples-dropdown.open').forEach(function(dropdown) {
            dropdown.classList.remove('open');
          });
        }
      });
    }

    // Function to show guide interface
    function showGuide() {
      // Update content before showing
      updateGuideContent();
      
      if (isMobile()) {
        guideModalBackdrop.classList.add('open');
      } else {
        guideSidebar.classList.add('open');
      }
    }

    // Function to hide guide interface
    function hideGuide() {
      guideSidebar.classList.remove('open');
      guideModalBackdrop.classList.remove('open');
    }

    // Desktop Guide me button
    if (addSectionBtn) {
      addSectionBtn.addEventListener('click', showGuide);
    }

    // Mobile Guide me button
    if (guideMeMobileBtn) {
      guideMeMobileBtn.addEventListener('click', showGuide);
    }

    // Close buttons
    if (closeSidebarBtn) {
      closeSidebarBtn.addEventListener('click', hideGuide);
    }
    if (closeModalBtn) {
      closeModalBtn.addEventListener('click', hideGuide);
    }

    // Hide sidebar when clicking outside of it (desktop only)
    document.addEventListener('click', function(e) {
      if (!isMobile() && guideSidebar.classList.contains('open') && 
          !guideSidebar.contains(e.target) && 
          !addSectionBtn.contains(e.target)) {
        hideGuide();
      }
    });

    // Hide modal when clicking backdrop (mobile only)
    if (guideModalBackdrop) {
      guideModalBackdrop.addEventListener('click', function(e) {
        if (e.target === guideModalBackdrop) {
          hideGuide();
        }
      });
    }

    // Source verification functionality
    var reliableSourcesData = null;
    var sourceModalBackdrop = document.getElementById('sourceModalBackdrop');
    var sourceUrl = document.getElementById('sourceUrl');
    var checkSourceBtn = document.getElementById('checkSourceBtn');
    var generateDraftBtn = document.getElementById('generateDraftBtn');
    var insertDraftBtn = document.getElementById('insertDraftBtn');
    var closeSourceModal = document.getElementById('closeSourceModal');
    var cancelSource = document.getElementById('cancelSource');
    
    // Load reliable sources data
    async function loadReliableSources() {
      try {
        const response = await fetch('reliable-sources.json');
        reliableSourcesData = await response.json();
      } catch (error) {
        console.error('Failed to load reliable sources:', error);
        reliableSourcesData = null;
      }
    }
    
    // Open source modal
    function openSourceModal() {
      sourceModalBackdrop.setAttribute('aria-hidden', 'false');
      sourceUrl.focus();
      resetSourceModal();
    }
    
    // Close source modal
    function closeSourceModalDialog() {
      sourceModalBackdrop.setAttribute('aria-hidden', 'true');
      resetSourceModal();
    }
    
    // Reset modal to initial state
    function resetSourceModal() {
      sourceUrl.value = '';
      document.getElementById('sourceVerification').style.display = 'none';
      document.getElementById('draftPreview').style.display = 'none';
      checkSourceBtn.style.display = 'inline-block';
      generateDraftBtn.style.display = 'none';
      insertDraftBtn.style.display = 'none';
    }
    
    // Check source reliability
    function checkSource() {
      var url = sourceUrl.value.trim();
      if (!url) return;
      
      // Show verification section
      document.getElementById('sourceVerification').style.display = 'block';
      checkSourceBtn.style.display = 'none';
      
      // Simulate verification steps
      performVerificationSteps(url);
    }
    
    // Simulate verification animation
    function performVerificationSteps(url) {
      var steps = ['step1', 'step2'];
      var currentStep = 0;
      
      function processStep() {
        if (currentStep < steps.length) {
          var stepElement = document.getElementById(steps[currentStep]);
          var icon = stepElement.querySelector('.step-icon');
          var text = stepElement.querySelector('.step-text');
          
          // Update icon to checkmark and mark as completed
          setTimeout(function() {
            icon.textContent = '‚úì';
            stepElement.classList.add('completed');
            
            // Update text based on step
            if (currentStep === 0) {
              text.textContent = 'Domain verified: ' + extractDomain(url);
            } else if (currentStep === 1) {
              text.textContent = 'Source reliability checked';
            }
            
            currentStep++;
            if (currentStep < steps.length) {
              setTimeout(processStep, 800);
            } else {
              setTimeout(showSourceResult, 500);
            }
          }, 1000);
        }
      }
      
      processStep();
    }
    
    // Show source verification result
    function showSourceResult() {
      var url = sourceUrl.value.trim();
      var domain = extractDomain(url);
      var sourceType = classifySource(domain);
      
      var resultDiv = document.getElementById('sourceResult');
      var badgeDiv = document.getElementById('sourceBadge');
      var noteDiv = document.getElementById('reliabilityNote');
      
      if (sourceType.reliable) {
        badgeDiv.className = 'source-badge reliable';
        badgeDiv.textContent = '‚úì ' + sourceType.label;
        noteDiv.textContent = sourceType.reliability;
      } else {
        badgeDiv.className = 'source-badge questionable';
        badgeDiv.textContent = '‚ö†Ô∏è ' + sourceType.label;
        noteDiv.textContent = sourceType.warning;
      }
      
      resultDiv.style.display = 'block';
      generateDraftBtn.style.display = 'inline-block';
    }
    
    // Extract domain from URL
    function extractDomain(url) {
      try {
        return new URL(url).hostname.replace('www.', '');
      } catch (e) {
        return url.split('/')[0];
      }
    }
    
    // Classify source based on domain
    function classifySource(domain) {
      if (!reliableSourcesData) {
        return {reliable: true, label: 'External source', reliability: 'Source checking available'};
      }
      
      var sources = reliableSourcesData.approved_sources;
      
      // Check each source category
      for (var category in sources) {
        var categoryData = sources[category];
        
        // Check domains
        if (categoryData.domains && categoryData.domains.some(d => domain.includes(d))) {
          return {
            reliable: true,
            label: categoryData.label,
            reliability: categoryData.reliability
          };
        }
        
        // Check suffixes
        if (categoryData.suffixes && categoryData.suffixes.some(s => domain.endsWith(s))) {
          return {
            reliable: true,
            label: categoryData.label,
            reliability: categoryData.reliability
          };
        }
      }
      
      // Check questionable sources
      var questionable = reliableSourcesData.questionable_sources;
      if (questionable.domains && questionable.domains.some(d => domain.includes(d))) {
        return {
          reliable: false,
          label: questionable.label,
          warning: questionable.warning
        };
      }
      
      // Default to external source
      return {
        reliable: true,
        label: 'External source',
        reliability: 'Source information extracted'
      };
    }
    
    // Generate draft content
    function generateDraft() {
      var url = sourceUrl.value.trim();
      var domain = extractDomain(url);
      var sourceType = getSourceTypeForTemplate(domain);
      
      var templates = reliableSourcesData ? reliableSourcesData.draft_templates : null;
      var template = templates && templates[sourceType] ? templates[sourceType] : templates.default;
      
      // Create mock draft content
      var title = generateMockTitle(domain);
      var today = new Date().toLocaleDateString('en-US', {year: 'numeric', month: 'long', day: 'numeric'});
      
      var draftContent = template.stub
        .replace('[SOURCE]', domain.charAt(0).toUpperCase() + domain.slice(1))
        .replace('[TITLE]', title)
        .replace('[DATE]', today)
        .replace('[TOPIC]', 'this subject')
        .replace('[FIELD]', 'relevant field');
        
      var citation = template.citation
        .replace('[AUTHOR]', 'Author Name')
        .replace('[TITLE]', title)
        .replace('[SOURCE]', domain.charAt(0).toUpperCase() + domain.slice(1))
        .replace('[DATE]', today)
        .replace('[TODAY]', today)
        .replace('[URL]', url);
      
      var fullDraft = '== DRAFT: Needs editing ==\n\n' + 
                     draftContent + '\n\n' +
                     '‚ö†Ô∏è This is a draft stub. Please expand with your own analysis and additional sources before publishing.\n\n' +
                     citation;
      
      document.getElementById('draftContent').textContent = fullDraft;
      document.getElementById('draftPreview').style.display = 'block';
      generateDraftBtn.style.display = 'none';
      insertDraftBtn.style.display = 'inline-block';
    }
    
    // Generate mock title based on domain
    function generateMockTitle(domain) {
      var titles = [
        'Recent Developments in Subject Area',
        'Analysis of Current Topic',
        'Overview of Related Field',
        'Background Information on Subject',
        'Context and Development'
      ];
      return titles[Math.floor(Math.random() * titles.length)];
    }
    
    // Get source type for template
    function getSourceTypeForTemplate(domain) {
      if (!reliableSourcesData) return 'default';
      
      var sources = reliableSourcesData.approved_sources;
      for (var category in sources) {
        var categoryData = sources[category];
        if (categoryData.domains && categoryData.domains.some(d => domain.includes(d))) {
          return category;
        }
        if (categoryData.suffixes && categoryData.suffixes.some(s => domain.endsWith(s))) {
          return category;
        }
      }
      return 'default';
    }
    
    // Insert draft into editor
    function insertDraft() {
      var draftText = document.getElementById('draftContent').textContent;
      var editor = document.getElementById('editor');
      
      if (editor) {
        var currentContent = editor.innerHTML;
        var draftHTML = draftText.replace(/\n/g, '<br>');
        
        if (currentContent.trim() === '') {
          editor.innerHTML = '<div style="margin-bottom: 2em;">' + draftHTML + '</div>';
        } else {
          editor.innerHTML = currentContent + '<div style="margin-top: 2em;">' + draftHTML + '</div>';
        }
        
        editor.focus();
      }
      
      closeSourceModalDialog();
    }

    // Bind source button click handlers for sidebar
    function bindSourceButton() {
      var checkBtn = document.getElementById('sidebarCheckBtn');
      if (checkBtn) {
        checkBtn.addEventListener('click', function() {
          checkSidebarSource();
        });
      }
    }

    // Check source in sidebar
    function checkSidebarSource() {
      var sourceUrl = document.getElementById('sidebarSourceUrl');
      var checkBtn = document.getElementById('sidebarCheckBtn');
      
      if (!sourceUrl || !sourceUrl.value.trim()) {
        return;
      }
      
      // Disable button and show loading
      checkBtn.disabled = true;
      checkBtn.textContent = 'Checking...';
      
      // Show verification steps
      performSidebarVerificationSteps(sourceUrl.value.trim());
    }

    // Perform verification steps in sidebar
    function performSidebarVerificationSteps(url) {
      var stepsDiv = document.getElementById('sidebarVerificationSteps');
      var steps = [
        'Checking domain...',
        'Verifying source reliability...'
      ];
      
      var stepsHTML = '';
      steps.forEach(function(step, index) {
        stepsHTML += '<div class="sidebar-verification-step" id="sidebarStep' + index + '">';
        stepsHTML += '<div class="sidebar-step-icon" id="sidebarStepIcon' + index + '">' + (index + 1) + '</div>';
        stepsHTML += '<span class="sidebar-step-text" id="sidebarStepText' + index + '">' + step + '</span>';
        stepsHTML += '</div>';
      });
      
      stepsDiv.innerHTML = stepsHTML;
      stepsDiv.style.display = 'block';
      
      var currentStep = 0;
      
      function processStep() {
        if (currentStep < steps.length) {
          var stepElement = document.getElementById('sidebarStep' + currentStep);
          var icon = document.getElementById('sidebarStepIcon' + currentStep);
          var text = document.getElementById('sidebarStepText' + currentStep);
          
          // Mark current step as active
          icon.classList.add('active');
          
          // Update icon to checkmark and mark as completed
          setTimeout(function() {
            icon.textContent = '‚úì';
            icon.classList.remove('active');
            icon.classList.add('completed');
            
            // Update text based on step
            if (currentStep === 0) {
              text.textContent = 'Domain verified: ' + extractDomain(url);
            } else if (currentStep === 1) {
              text.textContent = 'Source reliability checked';
            }
            
            currentStep++;
            if (currentStep < steps.length) {
              setTimeout(processStep, 800);
            } else {
              setTimeout(showSidebarSourceResult, 500);
            }
          }, 1000);
        }
      }
      
      processStep();
    }

    // Show source verification result in sidebar
    function showSidebarSourceResult() {
      var sourceUrl = document.getElementById('sidebarSourceUrl');
      var checkBtn = document.getElementById('sidebarCheckBtn');
      var resultDiv = document.getElementById('sidebarSourceResult');
      
      var url = sourceUrl.value.trim();
      var domain = extractDomain(url);
      var sourceType = classifySource(domain);
      
      var resultHTML = '';
      if (sourceType.reliable) {
        resultHTML += '<div class="sidebar-source-badge reliable">‚úì ' + sourceType.label + '</div>';
        resultHTML += '<p style="font-size: 12px; color: #72777d; margin: 0 0 8px 0;">' + sourceType.reliability + '</p>';
      } else {
        resultHTML += '<div class="sidebar-source-badge questionable">‚ö†Ô∏è ' + sourceType.label + '</div>';
        resultHTML += '<p style="font-size: 12px; color: #72777d; margin: 0 0 8px 0;">' + sourceType.warning + '</p>';
      }
      
      resultHTML += '<div class="sidebar-action-buttons">';
      resultHTML += '<button class="sidebar-action-btn primary" id="sidebarGenerateBtn">Generate draft</button>';
      resultHTML += '</div>';
      
      resultDiv.innerHTML = resultHTML;
      resultDiv.style.display = 'block';
      
      // Re-enable check button
      checkBtn.disabled = false;
      checkBtn.textContent = 'Check source';
      
      // Bind generate button
      var generateBtn = document.getElementById('sidebarGenerateBtn');
      if (generateBtn) {
        generateBtn.addEventListener('click', function() {
          generateSidebarDraft(url);
        });
      }
    }

    // Generate draft in sidebar
    function generateSidebarDraft(url) {
      var domain = extractDomain(url);
      var sourceType = getSourceTypeForTemplate(domain);
      
      var templates = reliableSourcesData ? reliableSourcesData.draft_templates : null;
      var template = templates && templates[sourceType] ? templates[sourceType] : templates.default;
      
      // Create mock draft content
      var title = generateMockTitle(domain);
      var today = new Date().toLocaleDateString('en-US', {year: 'numeric', month: 'long', day: 'numeric'});
      
      var draftContent = template.stub
        .replace('[SOURCE]', domain.charAt(0).toUpperCase() + domain.slice(1))
        .replace('[TITLE]', title)
        .replace('[DATE]', today)
        .replace('[TOPIC]', 'this subject')
        .replace('[FIELD]', 'relevant field');
        
      var citation = template.citation
        .replace('[AUTHOR]', 'Author Name')
        .replace('[TITLE]', title)
        .replace('[SOURCE]', domain.charAt(0).toUpperCase() + domain.slice(1))
        .replace('[DATE]', today)
        .replace('[TODAY]', today)
        .replace('[URL]', url);
      
      var fullDraft = '== DRAFT: Needs editing ==\n\n' + 
                     draftContent + '\n\n' +
                     '‚ö†Ô∏è This is a draft stub. Please expand with your own analysis and additional sources before publishing.\n\n' +
                     citation;
      
      var previewDiv = document.getElementById('sidebarDraftPreview');
      var previewHTML = '';
      previewHTML += '<div class="sidebar-draft-content">' + fullDraft + '</div>';
      previewHTML += '<div class="sidebar-action-buttons">';
      previewHTML += '<button class="sidebar-action-btn primary" id="sidebarInsertBtn">Insert into article</button>';
      previewHTML += '<button class="sidebar-action-btn" id="sidebarCancelBtn">Cancel</button>';
      previewHTML += '</div>';
      
      previewDiv.innerHTML = previewHTML;
      previewDiv.style.display = 'block';
      
      // Bind action buttons
      var insertBtn = document.getElementById('sidebarInsertBtn');
      var cancelBtn = document.getElementById('sidebarCancelBtn');
      
      if (insertBtn) {
        insertBtn.addEventListener('click', function() {
          insertSidebarDraft(fullDraft);
        });
      }
      
      if (cancelBtn) {
        cancelBtn.addEventListener('click', function() {
          resetSidebarSource();
        });
      }
    }

    // Insert draft from sidebar into editor
    function insertSidebarDraft(draftText) {
      var editor = document.getElementById('editor');
      
      if (editor) {
        var currentContent = editor.innerHTML;
        var hasContent = currentContent.trim() !== '';
        
        var domain = extractDomain(document.getElementById('sidebarSourceUrl').value);
        var sourceType = classifySource(domain);
        var sectionTitle = 'Section title';
        
        // Create realistic Wikipedia content with references
        var content = 'This is where the content from the verified source would appear in the article. ';
        content += 'The information extracted from ' + domain + ' provides additional context and details that support the main article topic.<sup style="color: #0645ad;">[1]</sup> ';
        content += 'Key facts and data points from the source can be integrated here to enhance the encyclopedic coverage. ';
        content += 'This demonstrates how external sources contribute to comprehensive article development.<sup style="color: #0645ad;">[2]</sup>';
        
        // Get citation from original draft
        var lines = draftText.split('\n');
        var citation = '';
        for (var i = 0; i < lines.length; i++) {
          var line = lines[i].trim();
          if (line.startsWith('[1]')) {
            citation = line;
            break;
          }
        }
        
        // Create Wikipedia-style section with proper formatting
        var sectionHTML = '';
        sectionHTML += '<h2 id="Section_title" style="';
        sectionHTML += 'font-family: Georgia, serif; ';
        sectionHTML += 'font-size: 1.5em; ';
        sectionHTML += 'font-weight: normal; ';
        sectionHTML += 'margin: ' + (hasContent ? '2em' : '1em') + ' 0 0.25em 0; ';
        sectionHTML += 'padding: 0; ';
        sectionHTML += 'border-bottom: 1px solid #eaecf0; ';
        sectionHTML += 'padding-bottom: 0.25em;';
        sectionHTML += '">' + sectionTitle + '</h2>';
        
        // Add content paragraph with proper styling
        sectionHTML += '<p style="margin: 0.75em 0; line-height: 1.6;">' + content + '</p>';
        
        // Add minimal draft notice
        sectionHTML += '<p style="margin: 0.5em 0; font-size: 0.85em; color: #a2a9b1; font-style: italic;">Draft content ‚Ä¢ Expand with analysis</p>';
        
        // Add References section as proper Wikipedia section
        sectionHTML += '<h2 id="References" style="';
        sectionHTML += 'font-family: Georgia, serif; ';
        sectionHTML += 'font-size: 1.5em; ';
        sectionHTML += 'font-weight: normal; ';
        sectionHTML += 'margin: 2em 0 0.25em 0; ';
        sectionHTML += 'padding: 0; ';
        sectionHTML += 'border-bottom: 1px solid #eaecf0; ';
        sectionHTML += 'padding-bottom: 0.25em;';
        sectionHTML += '">References</h2>';
        
        // Add citation if exists
        if (citation) {
          sectionHTML += '<div style="margin: 0.75em 0; font-size: 0.9em;">';
          sectionHTML += '<p style="margin: 0.25em 0;">1. ' + citation.substring(4) + '</p>'; // Remove [1] prefix
          sectionHTML += '<p style="margin: 0.25em 0;">2. Additional sources to be added...</p>';
          sectionHTML += '</div>';
        }
        
        if (hasContent) {
          editor.innerHTML = currentContent + sectionHTML;
        } else {
          editor.innerHTML = sectionHTML;
        }
        
        editor.focus();
      }
      
      // Reset source area
      resetSidebarSource();
    }

    // Reset sidebar source verification
    function resetSidebarSource() {
      var sourceUrl = document.getElementById('sidebarSourceUrl');
      var stepsDiv = document.getElementById('sidebarVerificationSteps');
      var resultDiv = document.getElementById('sidebarSourceResult');
      var previewDiv = document.getElementById('sidebarDraftPreview');
      
      if (sourceUrl) sourceUrl.value = '';
      if (stepsDiv) stepsDiv.style.display = 'none';
      if (resultDiv) resultDiv.style.display = 'none';
      if (previewDiv) previewDiv.style.display = 'none';
    }

    // Open source verification modal
    function openSourceModalDialog() {
      var backdrop = document.getElementById('sourceModalBackdrop');
      var sourceUrl = document.getElementById('sourceUrl');
      var checkBtn = document.getElementById('checkSourceBtn');
      var generateBtn = document.getElementById('generateDraftBtn');
      var insertBtn = document.getElementById('insertDraftBtn');
      var stepsDiv = document.getElementById('verificationSteps');
      var resultDiv = document.getElementById('sourceResult');
      var previewDiv = document.getElementById('draftPreview');
      
      // Reset modal state
      if (sourceUrl) sourceUrl.value = '';
      if (checkBtn) checkBtn.style.display = 'inline-block';
      if (generateBtn) generateBtn.style.display = 'none';
      if (insertBtn) insertBtn.style.display = 'none';
      if (stepsDiv) stepsDiv.style.display = 'none';
      if (resultDiv) resultDiv.style.display = 'none';
      if (previewDiv) previewDiv.style.display = 'none';
      
      backdrop.classList.add('open');
      backdrop.setAttribute('aria-hidden', 'false');
      
      // Focus on URL input
      setTimeout(function() {
        if (sourceUrl) sourceUrl.focus();
      }, 100);
    }

    // Close source verification modal
    function closeSourceModalDialog() {
      var backdrop = document.getElementById('sourceModalBackdrop');
      backdrop.classList.remove('open');
      backdrop.setAttribute('aria-hidden', 'true');
    }

    // Initialize source modal event handlers
    function initializeSourceModal() {
      var closeBtn = document.getElementById('closeSourceModal');
      var backdrop = document.getElementById('sourceModalBackdrop');
      var checkBtn = document.getElementById('checkSourceBtn');
      var generateBtn = document.getElementById('generateDraftBtn');
      var insertBtn = document.getElementById('insertDraftBtn');
      
      // Close button
      if (closeBtn) {
        closeBtn.addEventListener('click', closeSourceModalDialog);
      }
      
      // Backdrop click to close
      if (backdrop) {
        backdrop.addEventListener('click', function(e) {
          if (e.target === backdrop) {
            closeSourceModalDialog();
          }
        });
      }
      
      // Escape key to close
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && backdrop && backdrop.classList.contains('open')) {
          closeSourceModalDialog();
        }
      });
      
      // Check source button
      if (checkBtn) {
        checkBtn.addEventListener('click', checkSource);
      }
      
      // Generate draft button
      if (generateBtn) {
        generateBtn.addEventListener('click', generateDraft);
      }
      
      // Insert draft button
      if (insertBtn) {
        insertBtn.addEventListener('click', insertDraft);
      }
    }

    // Initialize suggestions and sources on page load
    Promise.all([loadSuggestions(), loadReliableSources()]).then(function() {
      updateGuideContent();
      initializeSourceModal();
    });

  </script>
</body>
</html>
